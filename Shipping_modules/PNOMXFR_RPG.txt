     H/TITLE Exc HPB RIN Gen Split  XF Execute external functio
     H            Y
     Z* CRTRPGPGM
     Z* CVTOPT(*DATETIME)
      *
     H* SYNOPSIS :
     H*  Perform user function
     H*  As defined by action diagram
      *
     H* Generated by CA 2E release 8.6 (1547)
     H* Function type : Execute external function
      *
     H* Company       : OMS Development Model
     H* System        : OMS Development Model
     H* User name     : ISRCENT
     H* Date          : 05/26/20  Time  : 12:59:39
     H* Copyright     : OMS Development Model
      *
      *================================================================
     M* Maintenance   :
      *================================================================
     FPMDACPLEIF  E           K        DISK
      * RSQ : COA Batch Header RIN      Co/ULSD CMP/BATCH/S/Sc(D
      *
     I@DACPED
      * COA Batch Header RIN      Co/ULSD CMP/BATCH/S/Sc(D
      * Renamed input format fields
     I              DAAIC3                          WAAIC3
     I              DAL6T1                          WAL6T1
     I              DAI3NY                          WAI3NY
     I              DAJYNY                          WAJYNY
     I              DAQ1NY                          WAQ1NY
     I              DAMUT1                          WAMUT1
     I              DAJZNY                          WAJZNY
     I              DAJ0NY                          WAJ0NY
     I              DAJ2NY                          WAJ2NY
     I              DARIDT                          WARIDT
     I              DAC5TM                          WAC5TM
     I              DAMVT1                          WAMVT1
     I              DAMWT1                          WAMWT1
     I              DARINT                          WARINT
     I              DARJDT                          WARJDT
     I              DAC6TM                          WAC6TM
     I              DAC4NB                          WAC4NB
     I              DADPNB                          WADPNB
     I              DAUENB                          WAUENB
     I              DARZNB                          WARZNB
     I              DANGT1                          WANGT1
     I              DARMNB                          WARMNB
     I              DARKDT                          WARKDT
     I              DAC7TM                          WAC7TM
     I              DARINS                          WARINS
     I              DAMXT1                          WAMXT1
     I              DAG3ST                          WAG3ST
     I              DAQWNY                          WAQWNY
     I              DAL0AA                          WAL0AA
     I              DAMAT1                          WAMAT1
     I              DATDNA                          WATDNA
     I              DACWC3                          WACWC3
     I              DAQXNY                          WAQXNY
     I              DAQZNY                          WAQZNY
     I              DAQ0NY                          WAQ0NY
     I              DALVTX                          WALVTX
     I              DANYT1                          WANYT1
     I              DAG5ST                          WAG5ST
     I              DAG7ST                          WAG7ST
     I              DATFDT                          WATFDT
     I              DATGDT                          WATGDT
     I              DAWIT1                          WAWIT1
     I              DAQYNY                          WAQYNY
     I              DAL7T1                          WAL7T1
     I              DAR8NY                          WAR8NY
     I              DAR0NY                          WAR0NY
     I              DAI7AA                          WAI7AA
     I              DAMXAA                          WAMXAA
     I              DAMSAA                          WAMSAA
     I              DAR7NY                          WAR7NY
     I              DAHEPR                          WAHEPR
     I              DAHFPR                          WAHFPR
     I              DAWVT1                          WAWVT1
     I              DAW0T1                          WAW0T1
     I              DAR5NY                          WAR5NY
     I              DAW1T1                          WAW1T1
     I              DAR6NY                          WAR6NY
     I              DAJ1ST                          WAJ1ST
     I              DAKHST                          WAKHST
     I              DATWDT                          WATWDT
     I              DADUTM                          WADUTM
     I              DAKGST                          WAKGST
     I              DATVDT                          WATVDT
     I              DADTTM                          WADTTM
     I              DAR9NY                          WAR9NY
     I              DASQNY                          WASQNY
     I              DABHR3                          WABHR3
     I              DASRNY                          WASRNY
     I              DAW7T1                          WAW7T1
     I              DAW8T1                          WAW8T1
     I              DAT2DT                          WAT2DT
     I              DASXNY                          WASXNY
     I              DASYNY                          WASYNY
     I              DASZNY                          WASZNY
     I              DAVSST                          WAVSST
     I              DAMJDT                          WAMJDT
     I              DABETM                          WABETM
     I              DACCVN                          WACCVN
     I              DACDVN                          WACDVN
     I              DAMKDT                          WAMKDT
     I              DABFTM                          WABFTM
     I              DACEVN                          WACEVN
     I              DACFVN                          WACFVN
      *
      /EJECT
      * Data structures:
     IPGMDS     ESDSY2PGDSP
      * Modified Program data structure
     IJBDTTM      DS
      * Job date/time
     I                                        1   70##JDT
     I                                        1   10##JCC
     I                                        2   30##JYY
     I                                        4   50##JMM
     I                                        6   70##JDD
     I                                        8  130##JTM
     I                                        8   90##JHH
     I                                       10  110##JNN
     I                                       12  130##JSS
      /EJECT
      * Parameter declarations
     IP1PARM      DS
      * FLD: COA Batch Header RIN
      * I :  Company Number
     I                                    P   1   20P1AIC3
      * I :  COA ULSD Company #
     I                                        3   6 P1L6T1
      * I :  COA Batch Number
     I                                    P   7   90P1I3NY
      * I :  COA Batch Header RIN Seq
     I                                    P  10  120P1JYNY
      * I :  COA Batch Header RIN
     I                                       13  50 P1MUT1
      * I :  COA RIN SSSSSSSS
     I                                    P  51  550P1JZNY
      * I :  COA RIN EEEEEEEE
     I                                    P  56  600P1J0NY
      * B :  COA RIN Volume in Gallons
     I                                    P  61  650P1J2NY
      * B :  COA RIN Gallons Sold
     I                                    P  66  700P1QWNY
      * B :  COA BHR Net Galls to Sell
     I                                    P  71  740P1TFDT
      * B :  COA RIN Quantity
     I                                    P  75  780P1R0NY
      * I :  COA BHR RINs to Sell Sep
     I                                    P  79  820P1SYNY
     IP2PARM      DS
      * O :  COA Batch RIN
     I                                        1  38 P2MTT1
     IP3PARM      DS
      * B :  COA RIN SSSSSSSS  New usr
     I                                    P   1   50P3Q9NY
     IP4PARM      DS
      * B :  COA RIN EEEEEEEE  New usr
     I                                    P   1   50P4RANY
     IP5PARM      DS
      * B :  COA RIN Volume New usr
     I                                    P   1   50P5RBNY
     IP6PARM      DS
      * I :  Quantity 7.0 USR
     I                                    P   1   40P6TQTC
     IP7PARM      DS
      * N :  USR Description 16
     I                                        1  16 P7OFNA
     IP8PARM      DS
      * I :  COA RIN Equivalence Valu#
     I                                    P   1   51P8J3NY
     IP9PARM      DS
      * B :  COA Batch RIN Volume new
     I                                    P   1   40P9SPNY
      /EJECT
      *****************************************************************
      * Entry parameters
     C           *ENTRY    PLIST
     C                     PARM           P0RTN   7
     C           P1AIC3    PARM           WP0001  30       Company Number
     C           P1L6T1    PARM           WP0002  4        COA ULSD Compan
     C           P1I3NY    PARM           WP0003  50       COA Batch Numbe
     C           P1JYNY    PARM           WP0004  50       COA Batch Heade
     C           P1MUT1    PARM           WP0005 38        COA Batch Heade
     C           P1JZNY    PARM           WP0006  80       COA RIN SSSSSSS
     C           P1J0NY    PARM           WP0007  80       COA RIN EEEEEEE
     C           P1J2NY    PARM P1J2NY    WP0008  80       COA RIN Volume
     C           P1QWNY    PARM P1QWNY    WP0009  80       COA RIN Gallons
     C           P1TFDT    PARM P1TFDT    WP0010  70       COA BHR Net Gal
     C           P1R0NY    PARM P1R0NY    WP0011  70       COA RIN Quantit
     C           P1SYNY    PARM           WP0012  70       COA BHR RINs to
     C           P2MTT1    PARM P2MTT1    WP0013 38        COA Batch RIN
     C           P3Q9NY    PARM P3Q9NY    WP0014  80       COA RIN SSSSSSS
     C           P4RANY    PARM P4RANY    WP0015  80       COA RIN EEEEEEE
     C           P5RBNY    PARM P5RBNY    WP0016  80       COA RIN Volume
     C           P6TQTC    PARM           WP0017  70       Quantity 7.0 US
     C           P8J3NY    PARM           WP0018  81       COA RIN Equival
     C           P9SPNY    PARM P9SPNY    WP0019  70       COA Batch RIN V
      *****************************************************************
      * Initialize
     C                     EXSR ZZINIT
      *
      * Exc HPB RIN Gen Split  XF
      * S16475 RMC 5/26/2020
      *              ALSO CHECK FOR 'TRB' IN Rtv Last Bt/Seq f/spl RT
      * P00579 RMC 5/13/2010 EMTS:Output rin qty and batch volume
      *                      EMTS:input equiv value
      * FP1322 Calc New RINs ssss and eeee and volume from the BUY RIN be
      * RIN Multiplier = Nbr of RINS left on BUY RIN/net gals left on the
      * RIN Volume being Sold = RIN Multiplier * net gallons to be sold
      * SEL RIN SSSSSSS= last SEL RINs EEEEEEEE+1 or if none, orig RINs S
      * SEL RIN EEEEEEE= SEL RINs SSSSSSSS + RINS sold
      * For each SEL, use whats left to be sold when deriving the multipl
      * Rins left to be sold = RIN Volume - RIN Gallons sold - sold unass
      * Net gallons to be sold  -> in BUY batch rin rcd, reduce w/each sa
      * Calc RIN Multiplier  and * quantity being sold
     C           P1J2NY    SUB  P1QWNY    YL0001           COA RIN Volume
     C                     SUB  P1SYNY    YL0001           COA RIN Volume
      * added this chk for 0 before divide           7-10-15 RMC
      * CASE: PAR.COA BHR Net Galls to Sell is Greater than zero
     C           P1TFDT    IFGT *ZERO                      *IF
      * Compute: new rin vol
      * PAR.COA RIN Volume New usr =
      *    *COMPUTE ((x1 / x2)*x3)
      * x1    : LCL.COA RIN Volume in Gallons
      * /     : PGM.*Synon (17,7) work field *
      * x2    : PAR.COA BHR Net Galls to Sell
      * *     : PGM.*Synon (15,0) work field *Rounded
      * x3    : PAR.Quantity 7.0 USR
     C           YL0001    DIV  P1TFDT    W0WD01           *Synon (17,7) w
     C           W0WD01    MULT P6TQTC    W0WJ00    H      *Synon (15,0) w
     C                     Z-ADDW0WJ00    P5RBNY           COA RIN Volume
     C                     ELSE
      * CASE: *OTHERWISE
     C                     Z-ADD*ZERO     P5RBNY           COA RIN Volume
     C                     END                             *FI
      * Get new SEL Rins SSSSSSSS
      * Rtv Last Bt/Seq f/spl RT - COA Batch Header RIN  * 
     C                     EXSR SARVGN
      * Add new SEL rins volume to get its EEEEEEEE
     C           YL0002    ADD  P5RBNY    YL0003           COA RIN EEEEEEE
      * Sub 1 for inclusive   -- 7-10-15 RMC if EEEE > SSSSS ...maybe the
      * CASE: LCL.COA RIN EEEEEEEE  New usr GT LCL.COA RIN SSSSSSSS  New
     C           YL0003    IFGT YL0002                     *IF
     C                     SUB  1         YL0003           COA RIN EEEEEEE
     C                     END                             *FI
      * Format new rin with SSSSSSSS and EEEEEEEE
     C                     MOVELP1MUT1    P2MTT1           COA Batch RIN
     C                     MOVEL*BLANK    YL0004           Generic Heading
     C                     MOVELYL0002    YL0004           Generic Heading
     C                     MOVEL*BLANK    YL0005           Generic Heading
     C                     MOVELYL0003    YL0005           Generic Heading
     C                     Z-ADD*ZERO     ZQ      50
     C           YL0004    CAT  YL0005:ZQ P7OFNA    P      USR Description
      * *Move-Right - /UT User Source  * 
     C                     MOVE P7OFNA    P2MTT1
     C                     Z-ADDYL0002    P3Q9NY           COA RIN SSSSSSS
     C                     Z-ADDYL0003    P4RANY           COA RIN EEEEEEE
     C                     ADD  P5RBNY    P1QWNY           COA RIN Gallons
     C                     SUB  P6TQTC    P1TFDT           COA BHR Net Gal
     C                     Z-ADDP5RBNY    P1R0NY           COA RIN Quantit
      * CASE: PAR.COA RIN Equivalence Valu# is Zero
     C           P8J3NY    IFEQ *ZERO                      *IF
     C                     Z-ADD1.5       YL0006           COA RIN Equival
     C                     ELSE
      * CASE: *OTHERWISE
     C                     Z-ADDP8J3NY    YL0006           COA RIN Equival
     C                     END                             *FI
     C           P1R0NY    DIV  YL0006    P9SPNY    H      COA Batch RIN V
      *----------------------------------------------------------------
      * Exit program
     C           AAEXIT    TAG
     C                     MOVEL*BLANK    P0RTN
     C                     EXSR ZYEXPG
      *================================================================
      /EJECT
     CSR         SARVGN    BEGSR
      *================================================================
      * Rtv Last Bt/Seq f/spl RT - COA Batch Header RIN  * 
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * Declare restrictor key work fields
     C           *LIKE     DEFN WAAIC3    WQSA01           Company Number
     C           *LIKE     DEFN WAL6T1    WQSA02           COA ULSD Compan
     C           *LIKE     DEFN WAI3NY    WQSA03           COA Batch Numbe
     C           *LIKE     DEFN WAJYNY    WQSA04           COA Batch Heade
      * Define keylist
     C           KRSSA     KLIST
     C                     KFLD           WQSA01           Company Number
     C                     KFLD           WQSA02           COA ULSD Compan
     C                     KFLD           WQSA03           COA Batch Numbe
     C                     KFLD           WQSA04           COA Batch Heade
      * Setup key
     C                     Z-ADDP1AIC3    WQSA01           Company Number
     C                     MOVELP1L6T1    WQSA02           COA ULSD Compan
     C                     Z-ADDP1I3NY    WQSA03           COA Batch Numbe
     C                     Z-ADDP1JYNY    WQSA04           COA Batch Heade
      * Establish starting position
     C           KRSSA     SETLL@DACPED                    *
     C           KRSSA     READE@DACPED                  90*
      * Data record not found
     C   90                MOVEL'USR3855' W0RTN   7
     C           *IN90     DOWEQ'0'
      * USER: Process Data record
      * If the last RIN for the batch/seq is a SEL rec, then the next
      * SEL will start with this rcds EEEEEEEE+1
      * If the last RIN for the batch/seq is the BUY rec, then the 1st
      * SEL will start with this rcds SSSSSSSS
      * CASE: DB1.COA RIN SSSSSSSS is GT 00000000
     C           WAJZNY    IFGT 0                          *IF
      * CASE:
      *  - c1ORc2
      *   |- c1    : DB1.RFS Transaction Type is Sold or Delivered
      *   |- c2    : DB1.RFS Transaction Type is Transfer BUY
      *   '-
     C           WAI7AA    IFEQ 'SEL'                      *IF
     C           WAI7AA    OREQ 'TRB'                      *OR
      * RMC Added TRB type too
     C           WAJ0NY    ADD  1         YL0002           COA RIN SSSSSSS
     C                     GOTO SAEXIT                     *QUIT
     C                     ELSE
      * CASE: DB1.RFS Transaction Type is Buy
     C           WAI7AA    IFEQ 'BUY'                      *IF
     C                     Z-ADDWAJZNY    YL0002           COA RIN SSSSSSS
     C                     GOTO SAEXIT                     *QUIT
     C                     END                             *FI
     C                     END                             *FI
     C                     END                             *FI
     C           KRSSA     READE@DACPED                  90*
     C                     ENDDO
      *================================================================
     CSR         SAEXIT    ENDSR
      /EJECT
     CSR         ZXEXPG    BEGSR
      *================================================================
      * Exit program: Normal
      *================================================================
     C                     EXSR ZYEXPG
      *================================================================
     CSR         ZXEXIT    ENDSR
      /EJECT
     CSR         ZYEXPG    BEGSR
      *================================================================
      * Exit program: Direct
      *================================================================
      * Terminate program
     C                     SETON                     LR
      *
      * Exit program
     C                     RETRN
      *
      *================================================================
     CSR         ZYEXIT    ENDSR
      /EJECT
     CSR         ZZINIT    BEGSR
      *================================================================
      * Initialisation
      *================================================================
     C           W0ICL     IFEQ *BLANK
     C                     MOVEL'Y'       W0ICL   1        *Initial call
     C                     ELSE
     C                     MOVEL'N'       W0ICL
     C                     END
     C                     MOVE *BLANK    P0RTN
     C                     MOVE *BLANK    W0RTN   7
     C                     MOVEL*BLANK    W0RSL   1
     C                     MOVEL*BLANK    W0RSF   1
     C                     MOVEL*ZEROS    W0RTW   90
     C                     MOVEL'400'     W0ENV   3
      * Clear all neither parameters
     C                     MOVEL*BLANK    P7OFNA           USR Description
      *
      * Retrieve job attributes
     C                     CALL 'Y2RTJCR'
     C                     PARM           PGMDS
      * Setup job date/time
     C                     Z-ADD##SD7     ##JDT
     C                     TIME           ##JTM
      * Update screen time
     C                     TIME           ##TME   60
      * Initialize renamed input format fields
     C                     Z-ADD*ZERO     WAAIC3           Company Number
     C                     Z-ADD*ZERO     WAI3NY           COA Batch Numbe
     C                     Z-ADD*ZERO     WAJYNY           COA Batch Heade
     C                     Z-ADD*ZERO     WAQ1NY           COA Batch Hdr R
     C                     Z-ADD*ZERO     WAJZNY           COA RIN SSSSSSS
     C                     Z-ADD*ZERO     WAJ0NY           COA RIN EEEEEEE
     C                     Z-ADD*ZERO     WAJ2NY           COA RIN Volume
     C                     Z-ADD*ZERO     WARIDT           COA RIN Transac
     C                     Z-ADD*ZERO     WAC5TM           COA RIN Transac
     C                     Z-ADD*ZERO     WARJDT           COA Retired RIN
     C                     Z-ADD*ZERO     WAC6TM           COA Retired RIN
     C                     Z-ADD*ZERO     WAC4NB           Order Number
     C                     Z-ADD*ZERO     WADPNB           Order Sequence
     C                     Z-ADD*ZERO     WAUENB           Order Secondary
     C                     Z-ADD*ZERO     WARZNB           Case Sequence N
     C                     Z-ADD*ZERO     WARMNB           Load ID
     C                     Z-ADD*ZERO     WARKDT           COA Date of 1st
     C                     Z-ADD*ZERO     WAC7TM           COA RIN Unused
     C                     Z-ADD*ZERO     WAQWNY           COA RIN Gallons
     C                     Z-ADD*ZERO     WACWC3           COA Shipping Co
     C                     Z-ADD*ZERO     WAQXNY           COA Ref Load Id
     C                     Z-ADD*ZERO     WAQZNY           COA Reference B
     C                     Z-ADD*ZERO     WAQ0NY           COA Reference B
     C                     Z-ADD*ZERO     WATFDT           COA BHR Net Gal
     C                     Z-ADD*ZERO     WATGDT           COA BHR Unused
     C                     Z-ADD*ZERO     WAQYNY           COA BHR Loadout
     C                     Z-ADD*ZERO     WAR8NY           COA Batch RIN V
     C                     Z-ADD*ZERO     WAR0NY           COA RIN Quantit
     C                     Z-ADD*ZERO     WAR7NY           COA BHR RIN Gen
     C                     Z-ADD*ZERO     WAHEPR           COA BHR RIN Pri
     C                     Z-ADD*ZERO     WAHFPR           COA BHR Gallon
     C                     Z-ADD*ZERO     WAR5NY           COA RIN Support
     C                     Z-ADD*ZERO     WAR6NY           COA RIN Support
     C                     Z-ADD*ZERO     WATWDT           COA GEN EMTS Da
     C                     Z-ADD*ZERO     WADUTM           COA GEN EMTS Ti
     C                     Z-ADD*ZERO     WATVDT           COA RIN EMTS Da
     C                     Z-ADD*ZERO     WADTTM           COA RIN EMTS Ti
     C                     Z-ADD*ZERO     WAR9NY           COA EMTS PTD Nb
     C                     Z-ADD*ZERO     WASQNY           COA EMTS Batch
     C                     Z-ADD*ZERO     WASRNY           COA BHR Unused
     C                     Z-ADD*ZERO     WAT2DT           COA BHR Unused
     C                     Z-ADD*ZERO     WASXNY           COA BHR Equiv V
     C                     Z-ADD*ZERO     WASYNY           COA BHR RINs to
     C                     Z-ADD*ZERO     WASZNY           COA Unassgnd Tx
     C                     Z-ADD*ZERO     WAMJDT           Create Date
     C                     Z-ADD*ZERO     WABETM           Create Time
     C                     Z-ADD*ZERO     WAMKDT           Change Date
     C                     Z-ADD*ZERO     WABFTM           Change Time
      * Define *Synon program work fields
     C                     Z-ADD*ZEROS    W0WD01 177       *Synon (17,7) w
     C                     Z-ADD*ZEROS    W0WJ00 150       *Synon (15,0) w
     C                     MOVEL'N'       W0PMT   1
      * Define local work field COA RIN Volume in Gallons
     C                     Z-ADD*ZERO     YL0001  80
      * Define local work field COA RIN SSSSSSSS  New usr
     C                     Z-ADD*ZERO     YL0002  80
      * Define local work field COA RIN EEEEEEEE  New usr
     C                     Z-ADD*ZERO     YL0003  80
      * Define local work field Generic Heading 1
     C                     MOVEL*BLANK    YL0004  8
      * Define local work field Generic Heading 2
     C                     MOVEL*BLANK    YL0005  8
      * Define local work field COA RIN Equivalence Valu#
     C                     Z-ADD*ZERO     YL0006  81
      *================================================================
     CSR         ZZEXIT    ENDSR
