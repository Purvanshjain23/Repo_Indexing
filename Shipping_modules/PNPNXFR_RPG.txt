     H/TITLE BLD SSI Download       XF Execute external functio
     H            Y
     Z* CRTRPGPGM
     Z* CVTOPT(*DATETIME)
      *
     H* SYNOPSIS :
     H*  Perform user function
     H*  As defined by action diagram
      *
     H* Generated by AllFusion 2E release 8.1SP2 (1250)
     H* Function type : Execute external function
      *
     H* Company       : OMS Development Model
     H* System        : OMS Development Model
     H* User name     : ISLBUSE
     H* Date          : 08/11/09  Time  : 11:39:44
     H* Copyright     : OMS Development Model
      *
      *================================================================
     M* Maintenance   :
      *================================================================
     FPMERREL1IF  E           K        DISK
      * RTV : SSI Control               Retrieval index
      *
     FCAABREL1IF  E           K        DISK
      * RTV : Company Name and Address  Retrieval index       V
      *
     FOMFFREL0IF  E           K        DISK
      * RTV : Carrier                   Retrieval index
      *
     FPMERREL0IF  E           K        DISK                      A
      * UPD : SSI Control               Update index
      *
     E                    YDOW        7  1               *Days of week
     I@ERREW9
      * SSI Control               Retrieval index
      * Renamed input format fields
     I              ERRQT1                          WARQT1
     I              ERRNT1                          WARNT1
     I              ERRRT1                          WARRT1
     I              ERNFNY                          WANFNY
     I              ERRTT1                          WARTT1
     I              ERRMT1                          WARMT1
     I              ERROT1                          WAROT1
     I              ERRPT1                          WARPT1
     I              ERRST1                          WARST1
     I              ERSTTR                          WASTTR
      *
     I@ABREAK
      * Company Name and Address  Retrieval index       V
      * Renamed input format fields
     I              ABAIC3                          WBAIC3
     I              ABADTX                          WBADTX
     I              ABACNA                          WBACNA
     I              ABADNA                          WBADNA
     I              ABAENA                          WBAENA
     I              ABAJNA                          WBAJNA
     I              ABBTTX                          WBBTTX
     I              ABBVTX                          WBBVTX
     I              ABBWTX                          WBBWTX
     I              ABA2NA                          WBA2NA
     I              ABABTX                          WBABTX
     I              ABBGCD                          WBBGCD
     I              ABKXCD                          WBKXCD
     I              ABUVST                          WBUVST
     I              ABUWST                          WBUWST
     I              ABUXST                          WBUXST
     I              ABVSST                          WBVSST
     I              ABAATM                          WBAATM
     I              ABAYNA                          WBAYNA
     I              ABA0NA                          WBA0NA
     I              ABAXDT                          WBAXDT
      *
     I@FFREBF
      * Carrier                   Retrieval index
      * Renamed input format fields
     I              FFBZNA                          WCBZNA
     I              FFADTX                          WCADTX
     I              FFACNA                          WCACNA
     I              FFADNA                          WCADNA
     I              FFAENA                          WCAENA
     I              FFAJNA                          WCAJNA
     I              FFBTTX                          WCBTTX
     I              FFEZNB                          WCEZNB
     I              FFBGCD                          WCBGCD
     I              FFEEDT                          WCEEDT
     I              FFDUTX                          WCDUTX
     I              FFNRVA                          WCNRVA
     I              FFNSVA                          WCNSVA
     I              FFNTVA                          WCNTVA
     I              FFNUVA                          WCNUVA
     I              FFP1ST                          WCP1ST
     I              FFDVTX                          WCDVTX
     I              FFDWTX                          WCDWTX
     I              FFLVCD                          WCLVCD
     I              FFS8NB                          WCS8NB
     I              FFS9NB                          WCS9NB
     I              FFNMVA                          WCNMVA
     I              FFNOVA                          WCNOVA
     I              FFNPVA                          WCNPVA
     I              FFNQVA                          WCNQVA
     I              FFMFCD                          WCMFCD
     I              FFQXNB                          WCQXNB
     I              FFQ1NB                          WCQ1NB
     I              FFMRNG                          WCMRNG
     I              FFMRNE                          WCMRNE
     I              FFRFNB                          WCRFNB
     I              FFMREG                          WCMREG
     I              FFBQPR                          WCBQPR
     I              FFBRPR                          WCBRPR
     I              FFBSPR                          WCBSPR
     I              FFBTPR                          WCBTPR
     I              FFBUPR                          WCBUPR
     I              FFBVPR                          WCBVPR
     I              FFDJWG                          WCDJWG
     I              FFDKWG                          WCDKWG
     I              FFDLWG                          WCDLWG
     I              FFDMWG                          WCDMWG
     I              FFDNWG                          WCDNWG
     I              FFDOWG                          WCDOWG
     I              FFB2PR                          WCB2PR
     I              FFB3PR                          WCB3PR
     I              FFB4PR                          WCB4PR
     I              FFB5PR                          WCB5PR
     I              FFB6PR                          WCB6PR
     I              FFB7PR                          WCB7PR
     I              FFAAC7                          WCAAC7
     I              FFCOFI                          WCCOFI
     I              FFK6TX                          WCK6TX
     I              FFOCNA                          WCOCNA
     I              FFODNA                          WCODNA
     I              FFW7CD                          WCW7CD
     I              FFK7TX                          WCK7TX
     I              FFTENO                          WCTENO
     I              FFK8TX                          WCK8TX
     I              FFAOFC                          WCAOFC
     I              FFAOLI                          WCAOLI
     I              FFKHDT                          WCKHDT
     I              FFUNUS                          WCUNUS
     I              FFUNU2                          WCUNU2
     I              FFUNU3                          WCUNU3
     I              FFUVST                          WCUVST
     I              FFUWST                          WCUWST
     I              FFUXST                          WCUXST
     I              FFVSST                          WCVSST
     I              FFAATM                          WCAATM
     I              FFAYNA                          WCAYNA
     I              FFA0NA                          WCA0NA
     I              FFAXDT                          WCAXDT
      *
     I@ERREW8
      * SSI Control               Update index
      * Renamed input format fields
     I              ERRQT1                          WDRQT1
     I              ERRNT1                          WDRNT1
     I              ERRRT1                          WDRRT1
     I              ERNFNY                          WDNFNY
     I              ERRTT1                          WDRTT1
     I              ERRMT1                          WDRMT1
     I              ERROT1                          WDROT1
     I              ERRPT1                          WDRPT1
     I              ERRST1                          WDRST1
     I              ERSTTR                          WDSTTR
      *
      /EJECT
      * Data structures:
     IPGMDS     ESDSY2PGDSP
      * Modified Program data structure
     IJBDTTM      DS
      * Job date/time
     I                                        1   70##JDT
     I                                        1   10##JCC
     I                                        2   30##JYY
     I                                        4   50##JMM
     I                                        6   70##JDD
     I                                        8  130##JTM
     I                                        8   90##JHH
     I                                       10  110##JNN
     I                                       12  130##JSS
      /EJECT
     IXDINT       DS
      * Internal date
     I                                        1   70XDINDT
     I                                        1   30XDINYY
     I                                        4   50XDINMM
     I                                        6   70XDINDD
      /EJECT
     IXD2T        DS
      * Internal date
     I                                        1   70XDINT2
     I                                        1   30XDINY2
     I                                        4   50XDINM2
     I                                        6   70XDIND2
     IQPMER1    E DSPMERREL0
      * UPD : SSI Control               Update index
      * Renamed input format fields
     I              ERRQT1                          WDRQT1
     I              ERRNT1                          WDRNT1
     I              ERRRT1                          WDRRT1
     I              ERNFNY                          WDNFNY
     I              ERRTT1                          WDRTT1
     I              ERRMT1                          WDRMT1
     I              ERROT1                          WDROT1
     I              ERRPT1                          WDRPT1
     I              ERRST1                          WDRST1
     I              ERSTTR                          WDSTTR
      *
      /EJECT
      * Parameter declarations
     IP1PARM      DS
      * FLD: Load Header
      * I :  Load ID
     I                                    P   1   40P1RMNB
      * I :  Carrier Code
     I                                        5   7 P1BZNA
     IP2PARM      DS
      * FLD: SSI Control
      * N :  SSI SOR Sequence ID
     I                                        1   9 P2RQT1
      * N :  SSI SOR Identifier
     I                                       10  16 P2RNT1
      * N :  SSI EOT Identifier
     I                                       17  20 P2RRT1
      * N :  SSI Sequence Number 7,0
     I                                    P  21  240P2NFNY
      * N :  SSI SOR SCAC
     I                                       25  28 P2RTT1
      * N :  SSI Trading Partner Name
     I                                       29  53 P2RMT1
      * N :  SSI SOR Date 8,0 alpha
     I                                       54  61 P2ROT1
      * N :  SSI SOR Time 4,0 alpha
     I                                       62  65 P2RPT1
      * N :  SSI EOT Record Count
     I                                       66  70 P2RST1
      * N :  SSI Transmission Status
     I                                       71  71 P2STTR
     IP3PARM      DS
      * N :  SSI Control Data Record
     I                                        1  57 P3S7T1
     IP4PARM      DS
      * FLD: *Arrays
      * N :  Order Number 1  PASS  USR
     I                                    P   1   85P4AJAE
     IP5PARM      DS
      * N :  Count USR
     I                                    P   1   30P5CNTU
     IP6PARM      DS
      * I :  SSI Add, Chg, Delete flag
     I                                        1   2 P6AHST
     I            DS
     I                                        1 132 ZAMSDA
      /EJECT
      *****************************************************************
      * Entry parameters
     C           *ENTRY    PLIST
     C                     PARM           P0RTN   7
     C           P1RMNB    PARM           WP0001  70       Load ID
     C           P1BZNA    PARM           WP0002  3        Carrier Code
     C           P6AHST    PARM           WP0003  2        SSI Add, Chg, D
      *****************************************************************
      * Initialize
     C                     EXSR ZZINIT
      *
      * BLD SSI Download       XF
      * Rtv & Incr 9.0 number  XF - Company Values  * 
     C                     CALL 'PMPMXFR'              90  Rtv & Incr 9.0
     C                     PARM *BLANK    W0RTN   7
     C                     PARM 360       WQ0001  30       Company Number
     C                     PARM 'SSISEQID'WQ0002 10        Company Value C
     C           WUM8NB    PARM WUM8NB    WQ0003 155       System Value Nu
      *
      *
     C           *IN90     IFEQ '1'
      * Call to program ended in error
     C                     MOVEL'Y2U0032' W0RTN
     C                     MOVEL*BLANKS   W0CLPG 10
     C                     MOVEL'PMPMXFR' W0CLPG
      * Send message '*Error occured on CALL...'
     C                     MOVEL'Y2U0032' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     MOVELW0CLPG    ZAMSDA           Message data
     C                     EXSR ZASNMS
     C                     END
      * Error detected?
     C           W0RTN     IFNE *BLANK
     C                     SETON                     99    *
     C                     END
     C                     Z-ADDWUM8NB    WUMRNY           WFSH Sequence N
     C                     MOVEL*BLANK    WUD6T1           Text USR 9
     C                     MOVELWUMRNY    WUD6T1           Text USR 9
     C                     MOVELWUD6T1    P2RQT1           SSI SOR Sequenc
      * RTV SSI Control Info   RT - SSI Control  * 
     C                     EXSR SARVGN
      * CRT SSI Control        CR - SSI Control  * 
     C                     EXSR SDCRRC
     C                     Z-ADD*ZERO     WUCNTU           Count USR
      * ** Create all the SSI records for this load ID
      * ** (this is the function that does all the work)
      * RTV CRT SSI Load HeaderXF - Load Header  * 
     C                     CALL 'PPGHXFR'              90  RTV CRT SSI Loa
     C                     PARM *BLANK    W0RTN   7
     C                     PARM P1RMNB    WQ0004  70       Load ID
     C                     PARM P1BZNA    WQ0005  3        Carrier Code
     C                     PARM P2RQT1    WQ0006  9        SSI SOR Sequenc
     C                     PARM P2RNT1    WQ0007  7        SSI SOR Identif
     C                     PARM P2NFNY    WQ0008  70       SSI Sequence Nu
     C                     PARM P2RTT1    WQ0009  4        SSI SOR SCAC
     C                     PARM P2RMT1    WQ0010 25        SSI Trading Par
     C                     PARM P2ROT1    WQ0011  8        SSI SOR Date 8,
     C                     PARM P2RPT1    WQ0012  4        SSI SOR Time 4,
     C           WUCNTU    PARM WUCNTU    WQ0013  50       Count USR
     C                     PARM P6AHST    WQ0014  2        SSI Add, Chg, D
      *
      *
     C           *IN90     IFEQ '1'
      * Call to program ended in error
     C                     MOVEL'Y2U0032' W0RTN
     C                     MOVEL*BLANKS   W0CLPG 10
     C                     MOVEL'PPGHXFR' W0CLPG
      * Send message '*Error occured on CALL...'
     C                     MOVEL'Y2U0032' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     MOVELW0CLPG    ZAMSDA           Message data
     C                     EXSR ZASNMS
     C                     END
      * Error detected?
     C           W0RTN     IFNE *BLANK
     C                     SETON                     99    *
     C                     END
     C                     MOVEL*BLANK    WUY7TX           Text USR 5
     C                     MOVELWUCNTU    WUY7TX           Text USR 5
     C                     MOVELWUY7TX    P2RST1           SSI EOT Record
     C                     ADD  1         P2NFNY           SSI Sequence Nu
      * CRT SSI Control EOT recCR - SSI Control  * 
     C                     EXSR SECRRC
      *----------------------------------------------------------------
      * Exit program
     C           AAEXIT    TAG
     C                     MOVEL*BLANK    P0RTN
     C                     EXSR ZYEXPG
      *================================================================
      /EJECT
     CSR         SARVGN    BEGSR
      *================================================================
      * RTV SSI Control Info   RT - SSI Control  * 
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * USER: Initialize routine
      * ***** Change Log and Comments
     C                     EXSR UASUBR                     ***** Change Lo
      * Declare restrictor key work fields
     C           *LIKE     DEFN WARQT1    WQSA01           SSI SOR Sequenc
      * Define keylist
     C           KRSSA     KLIST
     C                     KFLD           WQSA01           SSI SOR Sequenc
      * Setup key
     C                     MOVELP2RQT1    WQSA01           SSI SOR Sequenc
      * Establish starting position
     C           KRSSA     SETLL@ERREW9                    *
     C           KRSSA     READE@ERREW9                  90*
     C           *IN90     IFEQ '1'
      * Data record not found
     C                     MOVEL'USR4054' W0RTN   7
      * USER: Processing if Data record not found
     C                     MOVEL'#SSI204' P2RNT1           SSI SOR Identif
      * RTV Company Name Only  RT - Company Name and Address  * 
     C                     EXSR SBRVGN
      * RTV Name, Status       RT - Carrier  * 
     C                     EXSR SCRVGN
     C                     MOVELWUPAT1    P2RTT1           SSI SOR SCAC
     C                     Z-ADD##JDT     WUAXDT           Job Date
      *
     C                     MOVEL*BLANK    WN0001  8        Date (Char-8) U
     C                     MOVEL*BLANK    WN0002  4        Year Alpha (YYY
     C                     MOVEL*BLANK    WN0003  2        Month (Char) US
     C                     MOVEL*BLANK    WN0004  2        Day   (Char) US
      *
      * CNV cyymmdd to yyyymmdd
      * LCL.Year Code = PAR.Date In  (7,0) USR *YEAR
     C           WUAXDT    ADD  1000000   XDINDT
     C           1800      ADD  XDINYY    YL0001
      * LCL.Month NBR USR = PAR.Date In  (7,0) USR *MONTH
     C           WUAXDT    ADD  1000000   XDINDT
     C                     Z-ADDXDINMM    YL0002
      * LCL.Day of Month USR = PAR.Date In  (7,0) USR *DAY OF MONTH
     C           WUAXDT    ADD  1000000   XDINDT
     C                     EXSR XCVTA
     C                     Z-ADDXDAY1     XDAY2   60
     C                     Z-ADD0         XDINDD
     C                     EXSR XCVTA
     C                     MOVEL'1'       XDSEL   1
     C                     MOVEL'1111111' XDCDW   7
     C                     EXSR XDOWS
     C                     MOVEL'NONE'    WUDLN  10
     C                     EXSR XDUDY
     C                     MOVE XDURR     YL0003
     C                     MOVEL*BLANK    WN0002           Year Alpha (YYY
     C                     MOVELYL0001    WN0002           Year Alpha (YYY
     C                     MOVELYL0002    WN0003           Month (Char) US
     C                     MOVELYL0003    WN0004           Day   (Char) US
     C                     Z-ADD*ZERO     ZQ      50
     C           WN0002    CAT  WN0003:ZQ WN0001    P      Date (Char-8) U
     C                     Z-ADD*ZERO     ZQ      50
     C           WN0001    CAT  WN0004:ZQ WN0001    P      Date (Char-8) U
     C                     MOVE WN0001    WUMLNX           Date Out (8,0)
     C                     MOVEL*BLANK    P2ROT1           SSI SOR Date 8,
     C                     MOVELWUMLNX    P2ROT1           SSI SOR Date 8,
     C                     Z-ADD##JTM     WUAPTM           Time
     C                     MOVELWUAPTM    P2RPT1           SSI SOR Time 4,
     C                     Z-ADD1         P2NFNY           SSI Sequence Nu
     C                     GOTO SAEXIT
     C                     ENDIF
      *
     C           *IN90     DOWEQ'0'
      * USER: Process Data record
     C           WANFNY    ADD  1         P2NFNY           SSI Sequence Nu
     C                     MOVEL'Y2U0003' W0RTN            *Return code
     C           KRSSA     READE@ERREW9                  90*
     C                     ENDDO
      *================================================================
     CSR         SAEXIT    ENDSR
      /EJECT
     CSR         SBRVGN    BEGSR
      *================================================================
      * RTV Company Name Only  RT - Company Name and Address  * 
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * Define keylist
     C           KRSSB     KLIST
     C                     KFLD           WBAIC3           Company Number
      * Setup key
     C                     Z-ADD360       WBAIC3           Company Number
      * Establish starting position
     C           KRSSB     CHAIN@ABREAK              90    *
      * Data record not found
     C   90                MOVEL'USR0003' W0RTN   7
     C           *IN90     IFEQ '0'
      * USER: Process Data record
      * PAR = DB1 By name
     C                     MOVELWBADTX    P2RMT1           Name
     C                     ENDIF
      *================================================================
     CSR         SBEXIT    ENDSR
      /EJECT
     CSR         SCRVGN    BEGSR
      *================================================================
      * RTV Name, Status       RT - Carrier  * 
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * Define keylist
     C           KRSSC     KLIST
     C                     KFLD           WCBZNA           Carrier Code
      * Setup key
     C                     MOVELP1BZNA    WCBZNA           Carrier Code
      * Establish starting position
     C           KRSSC     CHAIN@FFREBF              90    *
     C           *IN90     IFEQ '1'
      * Data record not found
     C                     MOVEL'USR1180' W0RTN   7
      * USER: Processing if Data record not found
      * PAR = CON By name
     C                     MOVEL*BLANK    WUPAT1           Name
     C                     GOTO SCEXIT
     C                     ENDIF
      *
     C           *IN90     IFEQ '0'
      * USER: Process Data record
      * PAR = DB1 By name
     C                     MOVELWCADTX    WUPAT1           Name
     C                     ENDIF
      *================================================================
     CSR         SCEXIT    ENDSR
      /EJECT
     CSR         SDCRRC    BEGSR
      *================================================================
      * CRT SSI Control        CR - SSI Control  * 
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * Move all fields to @ERREW8
     C                     MOVELP2RQT1    WDRQT1           SSI SOR Sequenc
     C                     MOVELP2RNT1    WDRNT1           SSI SOR Identif
     C                     MOVELP2RRT1    WDRRT1           SSI EOT Identif
     C                     Z-ADDP2NFNY    WDNFNY           SSI Sequence Nu
     C                     MOVELP2RTT1    WDRTT1           SSI SOR SCAC
     C                     MOVELP2RMT1    WDRMT1           SSI Trading Par
     C                     MOVELP2ROT1    WDROT1           SSI SOR Date 8,
     C                     MOVELP2RPT1    WDRPT1           SSI SOR Time 4,
     C                     MOVELP2RST1    WDRST1           SSI EOT Record
     C                     MOVELP2STTR    WDSTTR           SSI Transmissio
      *
     C           KLCRSD    KLIST
     C                     KFLD           WDRQT1           SSI SOR Sequenc
     C                     KFLD           WDRNT1           SSI SOR Identif
     C                     KFLD           WDRRT1           SSI EOT Identif
     C                     KFLD           WDNFNY           SSI Sequence Nu
      * Check for duplicate primary key
     C           KLCRSD    SETLL@ERREW8                  90*
     C           *IN90     IFEQ '1'
     C                     MOVEL'USR4055' W0RTN   7
      * Send message 'SSI Control            EX'
     C                     MOVEL'USR4055' ZAMSID
     C                     EXSR ZASNMS
     C                     GOTO SDEXIT
     C                     ENDIF
      *
     C                     WRITE@ERREW8                91  *
      *
     C           *IN91     IFEQ '1'
      * Write error detected
     C                     MOVEL'Y2U0004' W0RTN   7
     C                     ELSE
     C                     ENDIF
      *================================================================
     CSR         SDEXIT    ENDSR
      /EJECT
     CSR         SECRRC    BEGSR
      *================================================================
      * CRT SSI Control EOT recCR - SSI Control  * 
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * Move all fields to @ERREW8
     C                     MOVELP2RQT1    WDRQT1           SSI SOR Sequenc
     C                     MOVELP2RNT1    WDRNT1           SSI SOR Identif
     C                     MOVEL'#EOT'    WDRRT1           SSI EOT Identif
     C                     Z-ADDP2NFNY    WDNFNY           SSI Sequence Nu
     C                     MOVEL*BLANK    WDRTT1           SSI SOR SCAC
     C                     MOVEL*BLANK    WDRMT1           SSI Trading Par
     C                     MOVELP2ROT1    WDROT1           SSI SOR Date 8,
     C                     MOVELP2RPT1    WDRPT1           SSI SOR Time 4,
     C                     MOVELP2RST1    WDRST1           SSI EOT Record
     C                     MOVEL'N'       WDSTTR           SSI Transmissio
      *
     C           KLCRSE    KLIST
     C                     KFLD           WDRQT1           SSI SOR Sequenc
     C                     KFLD           WDRNT1           SSI SOR Identif
     C                     KFLD           WDRRT1           SSI EOT Identif
     C                     KFLD           WDNFNY           SSI Sequence Nu
      * Check for duplicate primary key
     C           KLCRSE    SETLL@ERREW8                  90*
     C           *IN90     IFEQ '1'
     C                     MOVEL'USR4055' W0RTN   7
      * Send message 'SSI Control            EX'
     C                     MOVEL'USR4055' ZAMSID
     C                     EXSR ZASNMS
     C                     GOTO SEEXIT
     C                     ENDIF
      *
     C                     WRITE@ERREW8                91  *
      *
     C           *IN91     IFEQ '1'
      * Write error detected
     C                     MOVEL'Y2U0004' W0RTN   7
     C                     ELSE
     C                     ENDIF
      *================================================================
     CSR         SEEXIT    ENDSR
      /EJECT
     CSR         UASUBR    BEGSR
      *================================================================
      * ***** Change Log and Comments
      *================================================================
      * ** A record with the new control record should not be found.
      * ** All calcs are done in Data record not found section
      *================================================================
     CSR         UAEXIT    ENDSR
      /EJECT
     CSR         XCVTA     BEGSR
      *================================================================
      * Convert date to absolute day (from 01/01/01)
      *================================================================
      * Absolute day =
      * 365*(YY-1)+(YY-1)/4 (past years w/extra days of leap ones) ...
     C           XDINYY    SUB  1         XDWK1   80
     C           XDWK1     MULT 365.25    XDAY1   60
     C           XDWK1     IFGE 300
     C                     SUB  2         XDAY1
     C                     ELSE
     C           XDWK1     IFGE 100
     C                     SUB  1         XDAY1
     C                     END
     C                     END
      * (from the beginning of the year to the beginning of the month:)
     C           XDINMM    SUB  1         XDWK1
     C           XDINMM    IFLT 3
      *     ...+31*(MM-1) (for January-February) ...
     C                     MULT 31        XDWK1
     C                     ADD  XDWK1     XDAY1
     C                     ELSE
      *     ...+30*(MM-1) (for March-December) ...
     C                     MULT 30        XDWK1
     C                     ADD  XDWK1     XDAY1
      *         ...-2 (for preceding February) ...
     C                     SUB  2         XDAY1
     C           XDINYY    IFNE 100
     C           XDINYY    ANDNE300
      *         ...+1 (for preceding February, if leap year) ...
     C           XDINYY    DIV  4         XDWK1
     C                     MVR            XDWK1
     C           XDWK1     IFEQ 0
     C                     ADD  1         XDAY1
     C                     END
     C                     END
     C           XDINMM    IFLT 8
      *         ...+MM/2 (preceding 31-sts for March-July) ...
     C           XDINMM    MULT .5        XDWK1
     C                     ADD  XDWK1     XDAY1
     C                     ELSE
      *         ...+(MM+1)/2 (same for August-December) ...
     C           XDINMM    ADD  1         XDWK1
     C                     MULT .5        XDWK1
     C                     ADD  XDWK1     XDAY1
     C                     END
     C                     END
      * ...+DD (days in the month up to the ending date)
     C                     ADD  XDINDD    XDAY1
      *================================================================
     CSR         XCVTAE    ENDSR
      /EJECT
     CSR         XDOWS     BEGSR
      *================================================================
      * Setup days of week array
      *================================================================
     C                     MOVEAXDCDW     YDOW
     C                     Z-ADD0         XDWSL   10
     C                     Z-ADD1         YY
     C           YY        DOWLE7
     C           YDOW,YY   IFEQ XDSEL
     C                     ADD  1         XDWSL
     C                     END
     C                     ADD  1         YY
     C                     END
      *================================================================
     CSR         XDOWSE    ENDSR
      /EJECT
     CSR         XDUDY     BEGSR
      *================================================================
      * Calculate duration, *DAYS
      *================================================================
     C           XDAY1     IFLT 1
     C           XDAY2     ORLT 1
     C                     Z-ADD0         XDURR
     C                     MOVEL'Y2U0006' W0RTN   7
     C                     GOTO XDUDYE
     C                     END
     C           XDAY1     IFGE XDAY2
      * From date2 to date1
     C                     Z-ADDXDAY2     XABEG   60
     C                     Z-ADDXDAY1     XAEND   60
     C                     ELSE
      * From date1 to date2
     C                     Z-ADDXDAY1     XABEG   60
     C                     Z-ADDXDAY2     XAEND   60
     C                     END
     C           XDWSL     IFEQ 0
      * None days of week selected
     C                     Z-ADD0         XDURR
     C                     GOTO XDUDYC
     C                     END
     C           XAEND     SUB  XABEG     XDURR   80
     C           XDWSL     IFEQ 7
      * All days of week selected
     C                     GOTO XDUDYC
     C                     END
      * Some days of week selected
     C                     DIV  7         XDURR
     C                     MVR            XDLSW   10
     C                     MULT XDWSL     XDURR
     C           XDLSW     IFNE 0
      * Determine day of week of the beginning date
     C           XABEG     ADD  3         YY      60
     C                     DIV  7         YY
     C                     MVR            YY
      * Loop: Increment the date by the last week
     C           XDLSW     DOWGT0
      * Increment the day of week
     C                     ADD  1         YY
     C                     SUB  1         XDLSW
      * Put day of week into the range 1-7
     C           YY        IFEQ 8
     C                     Z-ADD1         YY
     C                     END
      * Selected day of the last week has been processed
     C           YDOW,YY   IFEQ XDSEL
      * Increment duration
     C                     ADD  1         XDURR
     C                     END
      * End of loop
     C                     END
     C                     END
     C           XDUDYC    TAG
     C           XDURR     IFEQ 0
      * Return Code: Unable to calculate duration
     C                     MOVEL'Y2U0060' W0RTN   7
     C                     ELSE
     C                     MOVEL*BLANK    W0RTN   7
     C                     END
      *================================================================
     CSR         XDUDYE    ENDSR
      /EJECT
     CSR         ZASNMS    BEGSR
      *================================================================
      * Send message to program's message queue
      *================================================================
     C           ZAPGMQ    IFEQ *BLANK
     C                     MOVEL##PGM     ZAPGMQ
     C                     END
      * If no message file specified, use default
     C           ZAMSGF    IFEQ *BLANK
     C                     MOVELZADFMF    ZAMSGF
     C                     END
     C                     CALL 'Y2SNMGC'
     C                     PARM           ZAPGMQ 10        Program queue
     C                     PARM           ZAPGRL  5        Rel queue
     C                     PARM           ZAMSID  7        Message ID
     C                     PARM           ZAMSGF 10        Message file
     C                     PARM           ZAMSDA           Message data
     C                     PARM           ZAMSTP  7        Message type
      * Clear all fields for default mechanism next time
     C                     MOVEL*BLANK    ZAPGMQ
     C                     MOVEL*BLANK    ZAPGRL
     C                     MOVEL*BLANK    ZAMSID
     C                     MOVEL*BLANK    ZAMSGF
     C                     MOVEL*BLANK    ZAMSDA
     C                     MOVEL*BLANK    ZAMSTP
      *================================================================
     CSR         ZAEXIT    ENDSR
      /EJECT
     CSR         ZXEXPG    BEGSR
      *================================================================
      * Exit program: Normal
      *================================================================
     C                     EXSR ZYEXPG
      *================================================================
     CSR         ZXEXIT    ENDSR
      /EJECT
     CSR         ZYEXPG    BEGSR
      *================================================================
      * Exit program: Direct
      *================================================================
      * Terminate program
     C                     SETON                     LR
      *
      * Exit program
     C                     RETRN
      *
      *================================================================
     CSR         ZYEXIT    ENDSR
      /EJECT
     CSR         ZZINIT    BEGSR
      *================================================================
      * Initialisation
      *================================================================
     C           W0ICL     IFEQ *BLANK
     C                     MOVEL'Y'       W0ICL   1        *Initial call
     C                     ELSE
     C                     MOVEL'N'       W0ICL
     C                     END
     C                     MOVE *BLANK    P0RTN
     C                     MOVE *BLANK    W0RTN   7
     C                     MOVEL*BLANK    W0RSL   1
     C                     MOVEL*BLANK    W0RSF   1
     C                     MOVEL*ZEROS    W0RTW   90
     C                     MOVEL'400'     W0ENV   3
      * Clear all neither parameters
     C                     MOVEL*BLANK    P2RQT1           SSI SOR Sequenc
     C                     MOVEL*BLANK    P2RNT1           SSI SOR Identif
     C                     MOVEL*BLANK    P2RRT1           SSI EOT Identif
     C                     Z-ADD*ZERO     P2NFNY           SSI Sequence Nu
     C                     MOVEL*BLANK    P2RTT1           SSI SOR SCAC
     C                     MOVEL*BLANK    P2RMT1           SSI Trading Par
     C                     MOVEL*BLANK    P2ROT1           SSI SOR Date 8,
     C                     MOVEL*BLANK    P2RPT1           SSI SOR Time 4,
     C                     MOVEL*BLANK    P2RST1           SSI EOT Record
     C                     MOVEL*BLANK    P2STTR           SSI Transmissio
     C                     MOVEL*BLANK    P3S7T1           SSI Control Dat
     C                     Z-ADD*ZERO     P4AJAE           Order Number 1
     C                     Z-ADD*ZERO     P5CNTU           Count USR
      *
      * Retrieve job attributes
     C                     CALL 'Y2RTJCR'
     C                     PARM           PGMDS
      * Setup job date/time
     C                     Z-ADD##SD7     ##JDT
     C                     TIME           ##JTM
      * Update screen time
     C                     TIME           ##TME   60
      * Define work field System Value Numeric
     C                     Z-ADD*ZERO     WUM8NB 155
      * Define work field WFSH Sequence Number
     C                     Z-ADD*ZERO     WUMRNY  90
      * Define work field Text USR 9
     C                     MOVEL*BLANK    WUD6T1  9
      * Initialize renamed input format fields
     C                     Z-ADD*ZERO     WANFNY           SSI Sequence Nu
      * Initialize renamed input format fields
     C                     Z-ADD*ZERO     WBAIC3           Company Number
     C                     Z-ADD*ZERO     WBAATM           Job Time
     C                     Z-ADD*ZERO     WBAXDT           Job Date
      * Define work field SCAC Code
     C                     MOVEL*BLANK    WUPAT1  4
      * Initialize renamed input format fields
     C                     Z-ADD*ZERO     WCEZNB           Telephone Numbe
     C                     Z-ADD*ZERO     WCEEDT           Carrier Last Us
     C                     Z-ADD*ZERO     WCNRVA           Pallet Balance
     C                     Z-ADD*ZERO     WCNSVA           Long hook balan
     C                     Z-ADD*ZERO     WCNTVA           Short hook bala
     C                     Z-ADD*ZERO     WCNUVA           Tub Balance
     C                     Z-ADD*ZERO     WCS8NB           Home Phone
     C                     Z-ADD*ZERO     WCS9NB           Other Phone
     C                     Z-ADD*ZERO     WCNMVA           Flat Rate
     C                     Z-ADD*ZERO     WCNOVA           Rate Per Pound
     C                     Z-ADD*ZERO     WCNPVA           Unused Rate Per
     C                     Z-ADD*ZERO     WCNQVA           Miscellaneous C
     C                     Z-ADD*ZERO     WCQXNB           Unused Mile Ran
     C                     Z-ADD*ZERO     WCQ1NB           Unused Mile Ran
     C                     Z-ADD*ZERO     WCMRNG           Unused Mile Ran
     C                     Z-ADD*ZERO     WCMRNE           Unused Mile Ran
     C                     Z-ADD*ZERO     WCRFNB           Unused Mile Ran
     C                     Z-ADD*ZERO     WCMREG           Unused Mile Ran
     C                     Z-ADD*ZERO     WCBQPR           Unused Mile Rat
     C                     Z-ADD*ZERO     WCBRPR           Unused Mile Rat
     C                     Z-ADD*ZERO     WCBSPR           Unused Mile Rat
     C                     Z-ADD*ZERO     WCBTPR           Unused Mile Rat
     C                     Z-ADD*ZERO     WCBUPR           Unused Mile Rat
     C                     Z-ADD*ZERO     WCBVPR           Unused Mile Rat
     C                     Z-ADD*ZERO     WCDJWG           Unused Weight R
     C                     Z-ADD*ZERO     WCDKWG           Unused Weight R
     C                     Z-ADD*ZERO     WCDLWG           Unused Weight R
     C                     Z-ADD*ZERO     WCDMWG           Unused Weight R
     C                     Z-ADD*ZERO     WCDNWG           Unused Weight R
     C                     Z-ADD*ZERO     WCDOWG           Unused Weight R
     C                     Z-ADD*ZERO     WCB2PR           Unused Weight R
     C                     Z-ADD*ZERO     WCB3PR           Unused Weight R
     C                     Z-ADD*ZERO     WCB4PR           Unused Weight R
     C                     Z-ADD*ZERO     WCB5PR           Unused Weight R
     C                     Z-ADD*ZERO     WCB6PR           Unused Weight R
     C                     Z-ADD*ZERO     WCB7PR           Unused Weight R
     C                     Z-ADD*ZERO     WCAAC7           Contact Number
     C                     Z-ADD*ZERO     WCTENO           Carrier Unused
     C                     Z-ADD*ZERO     WCAOFC           Amount of Cargo
     C                     Z-ADD*ZERO     WCAOLI           Amount of Liabi
     C                     Z-ADD*ZERO     WCKHDT           Date of Expirat
     C                     Z-ADD*ZERO     WCAATM           Job Time
     C                     Z-ADD*ZERO     WCAXDT           Job Date
      * Define work field Job Date
     C                     Z-ADD*ZERO     WUAXDT  70
      * Define work field Date 8.0 USR
     C                     Z-ADD*ZERO     WUMLNX  80
      * Define work field Time
     C                     Z-ADD*ZERO     WUAPTM  60
      * Obtain default message file
     C           *NAMVAR   DEFN CAMGFLA   ZADFMF 10
     C                     IN   ZADFMF
      * Define work field Count USR
     C                     Z-ADD*ZERO     WUCNTU  50
      * Define work field Text USR 5
     C                     MOVEL*BLANK    WUY7TX  5
     C                     MOVEL'N'       W0PMT   1
      * Define null work field Record Status
     C                     MOVEL*BLANK    YN0001  1
      * Define local work field Year Code
     C                     Z-ADD*ZERO     YL0001  40
      * Define local work field Month NBR USR
     C                     Z-ADD*ZERO     YL0002  20
      * Define local work field Day of Month USR
     C                     Z-ADD*ZERO     YL0003  20
      *================================================================
     CSR         ZZEXIT    ENDSR
