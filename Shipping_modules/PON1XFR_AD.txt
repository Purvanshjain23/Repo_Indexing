// ?------------------------------------------------------------------------------------------------
// ?Synon action diagram for PON1XFR
// ?Date: 14.08.2025 Time: 03:38:17
// ?------------------------------------------------------------------------------------------------

//?Execute user function

// Call program RTV System Date/Time   UP.
CALL PROGRAM(RTV System Date/Time   UP) ('PDGFUPC');
PARAMETER(LCL.Current_System_Date);
PARAMETER(LCL.Current_System_Time);

//?RMC 11/29/05 send msg to dist list based on load str co in RTV
EXECUTE FUNCTION(Rtv Late Billd Email  RT) TYPE(RTVOBJ) FILE(OMFJCPP)           AC1637800;
PARAMETER(LCL.Current_System_Date);
PARAMETER(LCL.Current_System_Time);
PARAMETER(LCL.DL_List_ID);
{
 //?USER: Initialize routine

 // WRK.Time = CON.070000
 WRK.Time = 070000;

 //?USER: Process Data record

 //?Send the msg once per load when:
 //?1)Load Finished & not billed, and it's 45+ minutes after load finished tim
 //?Do not send message when loads are loaded ahead of time:
 //?1)Sched Ship = Sys Date, Load Fin = Sys Date, Load fin time < 7am &
 //?   system time < 7am
 //?********
 CASE;

 // IF DB1.Late Billing Email Flag is Yes
 IF DB1.Late_Billing_Email_Flag = 'Y';

 // IF *OTHERWISE
 IF *OTHERWISE;

 // WRK.Load Finished Time = DB1.Load Finished Time + CON.45 *MINUTES
 WRK.Load_Finished_Time = TIMEINCR(DB1.Load_Finished_Time 45 'MN');

 //?Increment the day if 45 minutes passes midnight
 CASE;

 // IF WRK.Load Finished Time LT DB1.Load Finished Time
 IF WRK.Load_Finished_Time < DB1.Load_Finished_Time;

 // WRK.Load Finished Date = DB1.Load Finished Date + CON.1 *DAYS
 WRK.Load_Finished_Date = DATEINCR(DB1.Load_Finished_Date 1 'DY' 1111111 'NONE' 'N' 1);

 //?Increment the day if 45 minutes passes midnight
 // IF *OTHERWISE
 IF *OTHERWISE;

 // WRK.Load Finished Date = DB1.Load Finished Date
 WRK.Load_Finished_Date = DB1.Load_Finished_Date;

 ENDIF;

 CASE;

 // IF DB1.Scheduled Ship Date EQ PAR.Current System Date
 IF DB1.Scheduled_Ship_Date = PAR.Current_System_Date;

 // AND DB1.Load Finished Date EQ PAR.Current System Date
 AND DB1.Load_Finished_Date = PAR.Current_System_Date;

 // AND DB1.Load Finished Time LT WRK.Time
 AND DB1.Load_Finished_Time < WRK.Time;

 // AND PAR.Current System Time LT WRK.Time
 AND PAR.Current_System_Time < WRK.Time;

 // IF *OTHERWISE
 IF *OTHERWISE;

 CASE;

 // IF WRK.Load Finished Date EQ PAR.Current System Date
 IF ( WRK.Load_Finished_Date = PAR.Current_System_Date;

 // AND PAR.Current System Time GT WRK.Load Finished Time
 AND PAR.Current_System_Time > WRK.Load_Finished_Time );

 // OR WRK.Load Finished Date LT PAR.Current System Date
 OR WRK.Load_Finished_Date < PAR.Current_System_Date;

 //?Send email to distribution list -- as of 11/29/05 based on load start co
 EXECUTE FUNCTION(RTV Alpha Value        RT) TYPE(RTVOBJ) FILE(PDKMREP)          AC1381513;
 PARAMETER(DB1.Company_Number);
 PARAMETER('LATEBLLMSG');
 PARAMETER(LCL.System_Value_Alpha);
 {
  //?USER: Processing if Data record not found

  // PGM.*Return code = CND.*Record does not exist
  PGM.*Return_code = 'Y2U0005';

  //?USER: Process Data record

  MOVE *ALL (To: PAR From: DB1);

 }

 // LCL.DL List ID = LCL.System Value Alpha
 LCL.DL_List_ID = LCL.System_Value_Alpha;

 // Retrieve message - 'Load &1 finished but not yet billed.'
 WRK.Office_Message_USR = RTVMSG(USR3092);
 PARAMETER(DB1.Load_ID);

 // Call program SND Pager Msg (MPLUS) UP.
 CALL PROGRAM(SND Pager Msg (MPLUS) UP) ('POMSUPC');
 PARAMETER(LCL.DL_List_ID);
 PARAMETER(WRK.Office_Message_USR);

 //?Update flag to Y so it's only sent once per load.
 EXECUTE FUNCTION(CHG Late Billed Flag   CH) TYPE(CHGOBJ) FILE(OMFJCPP)          AC1638431;
 PARAMETER(DB1.Load_ID);
 PARAMETER('Y');
 {
  //?USER: Processing before Data update

  EXECUTE FUNCTION(Set Date/Time Stamp.PgmIF) TYPE(EXCINTFUN)                     AC1425284;
  PARAMETER(DB1.Job_Time);
  PARAMETER(DB1.User_Id);
  PARAMETER(DB1.Job_Name);
  PARAMETER(DB1.Job_Date);
  {
   //?Execute internal function

   // PAR.Job Time = JOB.*Job time
   PAR.Job_Time = JOB.*Job_time;

   // PAR.User Id = JOB.*USER
   PAR.User_Id = JOB.*USER;

   // PAR.Job Name = JOB.*PROGRAM
   PAR.Job_Name = JOB.*PROGRAM;

   // PAR.Job Date = JOB.*Job date
   PAR.Job_Date = JOB.*Job_date;

  }

 }

 ENDIF;

 ENDIF;

 ENDIF;

}


