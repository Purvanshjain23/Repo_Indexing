/********************************************************************/
/*                                                                  */
/*  SYNOPSIS - PRINT PROGRAM AND EMAIL ACKNOWLEDGEMENTS           */
/*             TO SELECTED RECIPIENTS                             */
/*                                                                  */
/*  SYSTEM    - ORDER MANAGEMENT SYSTEM                             */
/*  PROGRAM   - PRINT/EMAIL ACKN                                    */
/*  DATE      - 05/08/2013                                          */
/*                                                                  */
/*      PARAMETERS RECEIVED:                                        */
/*                                                                  */
/*          &COMPNYN    - COMPANY NUMBER - BLANK FOR ALL            */
/*          &FRMORDN    - FROM ORDER                                */
/*          &OUTQ       - OUTPUT QUEUE                              */
/*          &HOLD       - HOLD PRINT                                */
/*          &SAVE       - SAVE PRINT                                */
/*          &COPYN      - NUMBER OF COPIES                          */
/*          &EMLBUY     - EMAIL BUYER  Y/N STS                      */
/*          &EMLREG     - EMAIL REGIONAL SALES  Y/N STS             */
/*          &EMLBROK    - BROKER EMAIL ADDRESS                      */
/********************************************************************/
/* DN  12/16/20 R16637 - AS400 CONSIGNEE BLOCK WI 423               */
/*     REMOVED THE PAGE ROTATION OF 90 DEGREES. PDKOPFR PRTFIL WAS  */
/*     CHANGED TO USE DEVTYPE FROM '*SCS' TO '*AFPDS' & PAGE WIDTH  */
/*     FROM 95 TO 132.                                              */
/* 08/06/24 SANTOSH TASK:SR3012312  CM PROJECT: S312312             */
/*     PARAMETER &EMLBROK IS RECEIVED AND PRTFIL PDKOPFR IS EMAILED */
/*     TO BROKER.                                                   */
/* PIO 09/19/24 REPLACE OPNQRYF WITH OPNSQLF IN OPBFCPP FILE        */
/*              ADDED NEEDED OVRDBF AROUND THE COMMAND              */
/*              CHANGE *AND TO AND, *EQ TO =, *GE TO >=, *LE TO <=, */
/*              *GT TO > IN &E                                      */
/*‚12/30/24 Jagdish TASK:SR3020046  CM PROJECT: S020046             */
/*‚                 Build email for publishing customer terms &     */
/*‚                 conditions.                                     */
/*‚                 Add BCC for audit purpose                       */
/*‚04/16/25 Shefali TASK:SR3020798  CM PROJECT: S020798             */
/*‚                 Passed parameter to PDKOPFR for email addresses */
/*‚                 of Salesperson for the order as Blank           */
/*‚05/02/25 Shefali TASK:SR3029516  CM PROJECT: S029516             */
/*‚ (Tag S029516)   Length of parameter to PDKOPFR for email addr   */
/*‚                 of Salesperson is changed to 50 from 1000       */
/********************************************************************/

/* S312312 - START */
/* PBIQUPC:    PGM        PARM(&COMPNYN &FRMORDN &TOORDN &CUSTN &SLSRTE +
                          &EMLBUY &EMLREG)                              */

  PBIQUPC:    PGM        PARM(&COMPNYN &FRMORDN &TOORDN &CUSTN &SLSRTE +
                          &EMLBUY &EMLREG &EMLBROK)
/* S312312 - END */

/* PARMS                                                                      */
        DCL    &COMPNYN    *DEC                  /* Company Number (Passed)   */
        DCL    &COPYN      *DEC                  /* No. of Copies             */
        DCL    &OUTQ       *CHAR   (10)          /* Output Queue              */
        DCL    &HOLD       *CHAR   (4)           /* Hold Status               */
        DCL    &SAVE       *CHAR   (4)           /* Save Status               */
        DCL    &NIGHTQ     *CHAR   (10)          /* Night Job Queue           */
        DCL    &PGMO       *CHAR    10           /*  PRINTER FILE  */
        DCL    &EMLREG     *CHAR   (1)           /* Email REGIONAL SALES      */
        DCL    &EMLBUY     *CHAR   (1)           /* Email BUYER               */
        DCL    &BUYADD     *CHAR   (50)          /* EMAIL Address BUYER       */
        DCL    &REGADD     *CHAR   (50)          /* EMAIL Address REGIONAL    */
        DCL    &CUSTN      *DEC                  /* SHIP TO CUST              */
        DCL    &SLSRTE     *CHAR (3)             /* REG SLS RT#               */
        DCL    &CUST       *DEC   (7 0)          /* SHIP TO CUST              */
/* S312312 - START */
        DCL    &EMLBROK    *CHAR  (50)           /* BROKER EMAIL ID        */
/* S312312 - END   */

        DCL    &B          *CHAR    30           /*  QRY-SEL CO.#  */
        DCL    &C          *CHAR    30           /*  QRY-SEL ORDER TYPE */
        DCL    &CC         *CHAR    30           /*  QRY-SEL ORDER TYPE */
        DCL    &CCC        *CHAR    30           /*  QRY-SEL ORDER TYPE */
        DCL    &D          *CHAR    25           /*  QRY-EXPORT SALES  */
        DCL    &DD         *CHAR    30           /*  QRY-SEL ENTRY DATE  */
        DCL    &DDD        *CHAR    50           /*  QRY-SEL REQ. SHIP DATE  */
        DCL    &DDDD       *CHAR    30           /*  QRY-SEL ACT. SHIP DATE  */
        DCL    &DDDDD      *CHAR    30           /*  QRY-SEL SHPPING METHOD  */
 /*PIO*/DCL    &F          *CHAR   100
 /*PIO  DCL    &E          *CHAR   275     */
 /*PIO*/DCL    &E          *CHAR   375           /*  QRY COMPLETE SEL. */
        DCL    &COMMAND    *CHAR   (512)
        DCL    &SOFLAG     *CHAR   (1)           /* WAREHOUSE                 */
        DCL    &WHSE1      *CHAR   (3)           /* WAREHOUSE                 */
        DCL    &WHSE2      *CHAR   (3)           /* WAREHOUSE                 */
        DCL    &WHSE3      *CHAR   (3)           /* WAREHOUSE                 */
        DCL    &WHSE4      *CHAR   (3)           /* WAREHOUSE                 */
        DCL    &WHSE5      *CHAR   (3)           /* WAREHOUSE                 */
        DCL    &WHSE6      *CHAR   (3)           /* WAREHOUSE                 */
        DCL    &WHSE7      *CHAR   (3)           /* WAREHOUSE                 */
        DCL    &WHSE8      *CHAR   (3)           /* WAREHOUSE                 */
        DCL    &WHSE9      *CHAR   (3)           /* WAREHOUSE                 */
        DCL    &WHSE10     *CHAR   (3)           /* WAREHOUSE                 */
        DCL    VAR(&BILLTYP) TYPE(*CHAR) LEN(1) VALUE('1') +
                                                 /* BILLING TYP          */
 /* S020798 - Declaring field passed as parameter to PDKOPFR                  */
 /*     DCL    &DISTLST    *CHAR   (1000)        /* WAREHOUSE                 */
 /* S029516 - Length of the field &DISTLST is changed from 1000 to 50         */
        DCL    &DISTLST    *CHAR   (50)          /* Salesperson Email address */

/* INTERNAL FIELDS                                                            */
        DCL    &COPY       *DEC    (2 0)         /* Number of copies          */
        DCL    &COMPANY    *DEC    (3 0)         /* Company Number            */
/* Name of the distriubtion list that will be used                 */
        DCL    &DISTNME    *CHAR   (60)
        DCL    &EDESC      *CHAR   (50)          /* Email Description         */
        DCL    &ITDESC     *CHAR   (30)          /* Internal desc title       */
        DCL    &COMMAND    *CHAR   (512)         /* FOR PRT OVERRIDE          */

/* OPENQRYF FIELDS                                                            */
        DCL    &COMPA      *CHAR    3            /* ACK COMPLETE              */
        DCL    &FRMORDN    *DEC                  /* FROM ORDER                */
        DCL    &FRMORD     *DEC    (7 0)         /* FROM ORDER                */
        DCL    &FRMORDA    *CHAR    7            /* FROM ORDER                */
        DCL    &TOORDN    *DEC                  /* FROM ORDER                */
        DCL    &TOORD     *DEC    (7 0)         /* FROM ORDER                */
        DCL    &TOORDA    *CHAR    7            /* FROM ORDER                */

        DCL    &BLK50      *CHAR    50           /* BLANKS                    */
/*‚S020046 - START */
             DCL        VAR(&COMVAL) TYPE(*CHAR) LEN(10) +
                          VALUE('AUDITEMAIL')
             DCL        VAR(&EMAILID) TYPE(*CHAR) LEN(50) VALUE(' ')
             DCL        VAR(&SUBJECT) TYPE(*CHAR) LEN(256)
             DCL        VAR(&EMLMSG) TYPE(*CHAR) LEN(500)
/*‚S020046 - END   */

/********************************************************************/
/* CHANGE VARIABLES FOR USE IN PROGRAM                              */
/********************************************************************/
             CHGVAR     VAR(&PGMO) VALUE(PDKOPFR$)
             CHGVAR     VAR(&COMPANY) VALUE(&COMPNYN)
             CHGVAR     VAR(&COMPA) VALUE(&COMPANY)
             CHGVAR     VAR(&CUST) VALUE(&CUSTN)
             CHGVAR     VAR(&FRMORD) VALUE(&FRMORDN)
             CHGVAR     VAR(&FRMORDA) VALUE(&FRMORD)
             CHGVAR     VAR(&TOORD) VALUE(&TOORDN)
             CHGVAR     VAR(&TOORDA) VALUE(&TOORD)
/*‚S020046 - START Get email distribution list*/
             CALL       PGM(POMTXFR) PARM((' ') (&COMPANY) (&COMVAL) +
                          (&EMAILID))
/*‚S020046 - END   */

 /************************************************************************/
/*  DO IF EMAIL EXISTS FOR A SELECTION                                    */
 /************************************************************************/
 BUYR:       IF         COND(&EMLBUY *EQ 'Y') THEN(DO)
             CALL       PGM(PBIRXFR) PARM(' ' &CUST   &BUYADD)
             ENDDO

REGN:        IF         COND(&EMLREG *EQ 'Y') THEN(DO)
             CALL       PGM(PBISXFR) PARM(' ' &SLSRTE  &REGADD)
             ENDDO
/* S312312 Adding new condition check for field &EMLBROK */
/* IF         COND((&BUYADD *NE &BLK50) *OR (&REGADD *NE &BLK50)) THEN(DO) */
             IF         COND((&BUYADD *NE &BLK50) *OR (&REGADD *NE +
                          &BLK50) *OR (&EMLBROK *NE &BLK50)) THEN(DO)

/*********************************************************************/
/*   CREATE OPEN QUERY FILE TO BE USED TO SELECT ACKS.               */
/*********************************************************************/
/*  IF CO. NUMBER SELECTED  */
             IF         COND(&COMPA *NE '000') THEN(DO)
   /*PIO     CHGVAR     VAR(&B) VALUE('BEAIC3 *EQ ' *CAT &COMPA)   */
   /*PIO*/   CHGVAR     VAR(&B) VALUE('BEAIC3  =  ' *CAT &COMPA)
             ENDDO

/*  IF FROM ORDER IS ENTERED */

             IF         COND(&FRMORDA *NE '0000000') THEN(DO)
   /*PIO     CHGVAR     VAR(&CC) VALUE('*AND BEC4NB *GE ' *CAT &FRMORDA) */
   /*PIO*/   CHGVAR     VAR(&CC) VALUE(' AND BEC4NB  >= ' *CAT &FRMORDA)
             ENDDO
/*  IF TO ORDER IS ENTERED */
             IF         COND(&TOORDA *NE '0000000') THEN(DO)
  /*PIO      CHGVAR     VAR(&CCC) VALUE('*AND BEC4NB *LE ' *CAT &TOORDA) */
  /*PIO*/    CHGVAR     VAR(&CCC) VALUE(' AND BEC4NB <=  ' *CAT &TOORDA)
             ENDDO

 /*PIO*/    CHGVAR    VAR(&F) VALUE(' AND BEGJST = "N" AND ' *CAT +
                       ' BEGWST IN ("L","A","C","R","E","H","I")')

 /**************************/
    /*PIO    CHGVAR     VAR(&E) VALUE(&B *BCAT &C *BCAT &CC *BCAT &CCC) */
    /*PIO*/  CHGVAR     VAR(&E) VALUE(&B *BCAT &C *BCAT &CC *BCAT &CCC *BCAT &F)

   /*PIO     OVRDBF     FILE(OPBFCPLN) SHARE(*YES)  +
             OPNQRYF    FILE((OPBFCPLN)) +          +
                        QRYSLT(&E) +                +
                        KEYFLD((BEAIC3) (BEC4NB)) + +
                        SEQONLY(*YES 1)            */

    /*PIO*/    OVRDBF     FILE(OPBFCPP) TOFILE(OPBFCPP) LVLCHK(*NO)
               OPNSQLF    SQL('SELECT * FROM OPBFCPP WHERE  ' *BCAT &E +
                            *BCAT ' ORDER BY BEAIC3 ASC, BEC4NB ASC, +
                            BEBKC7 ASC') OPNID(OPBFCPLN) OPTION(*ALL) +
                            SEQONLY(*NO) RCDFMT(@BFCPYX) +
                            ALWCPY(*IFRQD) /*PIO*/
    /*PIO*/    OVRDBF     FILE(OPBFCPLN) TOFILE(OPBFCPP) LVLCHK(*NO) +
                             OVRSCOPE(*JOB) SHARE(*YES) OPNSCOPE(*JOB)



/********************************************************************/
/* OVERRIDE PRINTER FILE TO QPRINT2                                */
/********************************************************************/
    /* R16637 DN 12/16/20-Removed Page Rotation. */
         /*  OVRPRTF    FILE(PDKOPFR$) PAGRTT(90) OUTQ(QPRINT2) */
             OVRPRTF    FILE(PDKOPFR$) OUTQ(QPRINT2)

/*********************************************************************/
/*   CALL PRINT PROGRAM -
/*********************************************************************/
             CALL       PGM(PDKOPFR) PARM(' ' &COMPANY &BILLTYP +
                          &WHSE1 &WHSE2 &WHSE3 &WHSE4 &WHSE5 &WHSE6 +
                          &WHSE7 &WHSE8 &WHSE9 &WHSE10 &SOFLAG &DISTLST)
/* S020798                &WHSE7 &WHSE8 &WHSE9 &WHSE10 &SOFLAG)      */

/*********************************************************************/
/*   CLOSE OPEN QUERY FILE -
/*********************************************************************/
             CLOF       OPNID(OPBFCPLN)
   /*PIO     DLTOVR     FILE(OPBFCPLN)   */
             DLTOVR     FILE(OPBFCPLN) LVL(*JOB) /*PIO*/
/*********************************************************************/
             CHGVAR     VAR(&EDESC) VALUE(&BLK50)
             CHGVAR     VAR(&ITDESC)  VALUE('Acknowledgement for Order')
             CHGVAR     VAR(&EDESC) VALUE(&ITDESC *BCAT &FRMORDA )
      ENDDO
/*********************************************************************/
/* Email BUYER                                                       */
/*********************************************************************/
/*‚S020046 - START */
/*‚Build email for publishing customer terms & conditions */
             CALL       PGM(PVI7XFR) PARM((' ') (&COMPANY) (&FRMORD) +
                          (&TOORD) (&SUBJECT) (&EMLMSG))
/*‚S020046 - END   */

             IF         COND(&BUYADD *NE &BLK50) THEN(DO)

/*‚S020046 - START */
             IF         COND(&EMAILID *NE ' ') THEN(DO)
             CHGVAR     VAR(&BUYADD) VALUE(%TRIM(&BUYADD) || ',' || +
                          ' (bcc) ' || &EMAILID)
             ENDDO
             ESEND/ESNDMAIL RECIPIENT(&BUYADD) SUBJECT(&SUBJECT) +
                          MSG(&EMLMSG) ATTLIST((* *PDF *N PDKOPFR$))
/*           ESEND/ESNDMAIL RECIPIENT(&BUYADD) SUBJECT(&EDESC) + */
/*                        ATTLIST((* *PDF *N PDKOPFR$))          */
/*‚S020046 - END   */
             ENDDO

/*********************************************************************/
/* Email REGIONAL SALES MGR                                          */
/*********************************************************************/

             IF         COND(&REGADD *NE &BLK50) THEN(DO)

/*‚S020046 - START */
/*           ESEND/ESNDMAIL RECIPIENT(&REGADD) SUBJECT(&EDESC) + */
/*                        ATTLIST((* *PDF *N PDKOPFR$))          */
             CHGVAR     VAR(&REGADD) VALUE(%TRIM(&REGADD) || ',' || +
                          ' (bcc) ' || &EMAILID)
             ESEND/ESNDMAIL RECIPIENT(&REGADD) SUBJECT(&SUBJECT) +
                          MSG(&EMLMSG) ATTLIST((* *PDF *N PDKOPFR$))
/*‚S020046 - END   */
             ENDDO

/* S312312 - START */
/*********************************************************************/
/* Email Broker                                                      */
/*********************************************************************/

             IF         COND(&EMLBROK *NE &BLK50) THEN(DO)

/*‚S020046 - START */
/*           ESEND/ESNDMAIL RECIPIENT(&EMLBROK) SUBJECT(&EDESC) +  */
/*                        ATTLIST((* *PDF *N PDKOPFR$))            */
             CHGVAR     VAR(&EMLBROK) VALUE(%TRIM(&EMLBROK) || ',' +
                          || ' (bcc) ' || &EMAILID)
             ESEND/ESNDMAIL RECIPIENT(&EMLBROK) SUBJECT(&SUBJECT) +
                          MSG(&EMLMSG) ATTLIST((* *PDF *N PDKOPFR$))
/*‚S020046 - END   */
             ENDDO
/* S312312 - END   */

/*********************************************************************/

 END:        ENDPGM
