     H/TITLE Cnv Upd Alloc Method  XF  Execute external functio
     H DATFMT(*YMD) DATEDIT(*YMD) DEBUG(*YES)
     Z* CRTBNDRPG
     Z* DFTACTGRP(*NO) BNDDIR(YBNDDIR) DBGVIEW(*SOURCE)
     Z* CVTOPT(*DATETIME) ACTGRP(*CALLER) OPTIMIZE(*BASIC)
      *
     H* SYNOPSIS :
     H*  Perform user function
     H*  As defined by action diagram
      *
     H* Generated by CA 2E release 8.6 (1547)
     H* Function type : Execute external function
     H* Object type   : *PGM
      *
     H* Company       : OMS Development Model
     H* System        : OMS Development Model
     H* User name     : ISDNGUY
     H* Date          : 01/23/18  Time  : 15:58:58
     H* Copyright     : OMS Development Model
      *
      *================================================================
     M* Maintenance   :
      *================================================================
     Fallocmthd if   e           k disk
     FPMFDREL4  IF   E           K DISK
      * RSQ : Company Item Ext          Item/Co
      *
     FPMFDREL0  UF   E           K DISK
      * UPD : Company Item Ext          Update index
      *
      /EJECT
      * Data structures:
     D PGMDS         ESDS                  EXTNAME(Y2PGDSP)
      * Modified Program data structure
     D JBDTTM          DS
      * Job date/time
     D  ##JDT                  1      7  0
     D  ##JCC                  1      1  0
     D  ##JYY                  2      3  0
     D  ##JMM                  4      5  0
     D  ##JDD                  6      7  0
     D  ##JTM                  8     13  0
     D  ##JHH                  8      9  0
     D  ##JNN                 10     11  0
     D  ##JSS                 12     13  0
     D QPMFD1        E DS                  EXTNAME(PMFDREL0)
      * UPD : Company Item Ext          Update index
      * Renamed input format fields
     D  WBAIC3       E                     EXTFLD(FDAIC3)
     D  WBHGCD       E                     EXTFLD(FDHGCD)
     D  WBD0ST       E                     EXTFLD(FDD0ST)
     D  WBD2ST       E                     EXTFLD(FDD2ST)
     D  WBD6ST       E                     EXTFLD(FDD6ST)
     D  WBWESP       E                     EXTFLD(FDWESP)
     D  WBEDST       E                     EXTFLD(FDEDST)
     D  WBEFST       E                     EXTFLD(FDEFST)
     D  WBEHST       E                     EXTFLD(FDEHST)
     D  WBEMST       E                     EXTFLD(FDEMST)
     D  WBENST       E                     EXTFLD(FDENST)
     D  WBEOST       E                     EXTFLD(FDEOST)
     D  WBEPST       E                     EXTFLD(FDEPST)
     D  WBEQST       E                     EXTFLD(FDEQST)
     D  WBOQNY       E                     EXTFLD(FDOQNY)
     D  WBORNY       E                     EXTFLD(FDORNY)
     D  WBS2DT       E                     EXTFLD(FDS2DT)
     D  WBUFT1       E                     EXTFLD(FDUFT1)
     D  WBKUAA       E                     EXTFLD(FDKUAA)
     D  WBVSST       E                     EXTFLD(FDVSST)
     D  WBMJDT       E                     EXTFLD(FDMJDT)
     D  WBBETM       E                     EXTFLD(FDBETM)
     D  WBCCVN       E                     EXTFLD(FDCCVN)
     D  WBCDVN       E                     EXTFLD(FDCDVN)
     D  WBMKDT       E                     EXTFLD(FDMKDT)
     D  WBBFTM       E                     EXTFLD(FDBFTM)
     D  WBCEVN       E                     EXTFLD(FDCEVN)
     D  WBCFVN       E                     EXTFLD(FDCFVN)
      *
     D YARDCS          DS           124
      * Message data for message Y2U0009.
     D MD0009          DS
     D  MDPGM                  1     10
     D  MDACP                 11     20
     D  MDFMT                 21     30
     D  MDACT                 31     34
     D  MDLBL                 35     40
      *
      * Declared stand-alone variables
     D  P0RTN          S              7
     D  W0ICL          S              1
     D  W0RTN          S              7
     D  W0RSL          S              1
     D  W0RSF          S              1
     D  W0RTW          S              9  0
     D  W0ENV          S              3
     D  ##TME          S              6  0
     D  WQSA01         S                   LIKE(WAHGCD)
     D  WN0001         S              1
     D  WN0002         S              1
     D  WN0003         S              1
     D  WN0004         S              1
     D  WN0005         S              1
     D  WN0006         S              1
     D  WN0007         S              1
     D  WN0008         S              1
     D  WN0009         S              1
     D  WN0010         S              2
     D  WN0011         S              2
     D  WN0012         S             11  2
     D  WN0013         S             11  0
     D  WN0014         S              7  0
     D  WN0015         S             25
     D  WN0016         S              6
     D  WN0017         S              1
     D  WN0018         S              7  0
     D  WN0019         S              6  0
     D  WN0020         S             10
     D  WN0021         S             10
     D  WN0022         S              7  0
     D  WN0023         S              6  0
     D  WN0024         S             10
     D  WN0025         S             10
     D  YARDC          S              1
     D  ZAPGMQ         S             10
     D  ZAPGRL         S              5
     D  ZAMSID         S              7
     D  ZAMSGF         S             10
     D  ZAMSTP         S              7
     D  YILE           S              1
     D  W0PMT          S              1
      /EJECT
      * Parameter declarations
     D P1PARM          DS
      * N :  Item Code
     D  P1HGCD                 1      4P 0
     D                 DS
     D  ZAMSDA                 1    132
     I@FDRECU
      * Company Item Ext          Item/Co
      * Renamed input format fields
     I              FDAIC3                      WAAIC3
     I              FDHGCD                      WAHGCD
     I              FDD0ST                      WAD0ST
     I              FDD2ST                      WAD2ST
     I              FDD6ST                      WAD6ST
     I              FDWESP                      WAWESP
     I              FDEDST                      WAEDST
     I              FDEFST                      WAEFST
     I              FDEHST                      WAEHST
     I              FDEMST                      WAEMST
     I              FDENST                      WAENST
     I              FDEOST                      WAEOST
     I              FDEPST                      WAEPST
     I              FDEQST                      WAEQST
     I              FDOQNY                      WAOQNY
     I              FDORNY                      WAORNY
     I              FDS2DT                      WAS2DT
     I              FDUFT1                      WAUFT1
     I              FDKUAA                      WAKUAA
     I              FDVSST                      WAVSST
     I              FDMJDT                      WAMJDT
     I              FDBETM                      WABETM
     I              FDCCVN                      WACCVN
     I              FDCDVN                      WACDVN
     I              FDMKDT                      WAMKDT
     I              FDBFTM                      WABFTM
     I              FDCEVN                      WACEVN
     I              FDCFVN                      WACFVN
      *
     I@FDREAO
      * Company Item Ext          Update index
      * Renamed input format fields
     I              FDAIC3                      WBAIC3
     I              FDHGCD                      WBHGCD
     I              FDD0ST                      WBD0ST
     I              FDD2ST                      WBD2ST
     I              FDD6ST                      WBD6ST
     I              FDWESP                      WBWESP
     I              FDEDST                      WBEDST
     I              FDEFST                      WBEFST
     I              FDEHST                      WBEHST
     I              FDEMST                      WBEMST
     I              FDENST                      WBENST
     I              FDEOST                      WBEOST
     I              FDEPST                      WBEPST
     I              FDEQST                      WBEQST
     I              FDOQNY                      WBOQNY
     I              FDORNY                      WBORNY
     I              FDS2DT                      WBS2DT
     I              FDUFT1                      WBUFT1
     I              FDKUAA                      WBKUAA
     I              FDVSST                      WBVSST
     I              FDMJDT                      WBMJDT
     I              FDBETM                      WBBETM
     I              FDCCVN                      WBCCVN
     I              FDCDVN                      WBCDVN
     I              FDMKDT                      WBMKDT
     I              FDBFTM                      WBBFTM
     I              FDCEVN                      WBCEVN
     I              FDCFVN                      WBCFVN
      *
      /EJECT
      *****************************************************************
      * Entry parameters
     C     *ENTRY        PLIST
     C                   PARM                    P0RTN
      *****************************************************************
      * Initialize
     C                   EXSR      ZZINIT
      *
      * Cnv Upd Alloc Method  XF
      * Cnv Read ALLOCMTHD-BegUS - Company Item Ext  * 
      *
      *
     C                   dow       not %eof(allocmthd)
     C                   read      allocmthd
      *
     C                   eval      P1HGCD = AMITEM                              Item Code
      *
      * Cnv Upd Alloc Method  RT - Company Item Ext  * 
     C                   EXSR      SARVGN
      * Cnv Read ALLOCMTHD-EndUS - Company Item Ext  * 
      *
     C                   enddo                                                  dow not %eof
      *
      *----------------------------------------------------------------
      * Exit program
     C     AAEXIT        TAG
     C                   EVAL      P0RTN = ' '
     C                   EXSR      ZYEXPG
      *================================================================
      /EJECT
     CSR   SARVGN        BEGSR
      *================================================================
      * Cnv Upd Alloc Method  RT - Company Item Ext  * 
      *================================================================
     C                   EVAL      W0RTN = ' '
      * Declare restrictor key work fields
      * Define keylist
     C     KRSSA         KLIST
     C                   KFLD                    WQSA01                         Item Code
      * Setup key
     C                   Z-ADD     P1HGCD        WQSA01                         Item Code
      * Establish starting position
     C     KRSSA         SETLL     @FDRECU                                      *
     C     KRSSA         READE     @FDRECU                                90    *
      * Data record not found
     C   90              MOVEL     'USR4125'     W0RTN
      * USER: Process Data record
      * Chg Allocation Mtd Sts CH - Company Item Ext  * 
     C                   DOW       NOT *IN90
     C                   EXSR      SBCHRC
     C     KRSSA         READE     @FDRECU                                90    *
     C                   ENDDO
      *================================================================
     CSR   SAEXIT        ENDSR
      /EJECT
     CSR   SBCHRC        BEGSR
      *================================================================
      * Chg Allocation Mtd Sts CH - Company Item Ext  * 
      *================================================================
      *
     C                   EVAL      WN0001 = ' '                                 Produce on Sund
     C                   EVAL      WN0002 = ' '                                 Produce on Mond
     C                   EVAL      WN0003 = ' '                                 Produce on Tues
     C                   EVAL      WN0004 = ' '                                 Produce on Wedn
     C                   EVAL      WN0005 = ' '                                 Produce on Thur
     C                   EVAL      WN0006 = ' '                                 Produce on Frid
     C                   EVAL      WN0007 = ' '                                 Produce on Satu
     C                   EVAL      WN0008 = ' '                                 Plan Production
     C                   EVAL      WN0009 = ' '                                 Adjust Credit P
     C                   EVAL      WN0010 = ' '                                 CIE Use Age Day
     C                   EVAL      WN0011 = ' '                                 CIE MPR Report
     C                   Z-ADD     *ZERO         WN0012                         CIE Unused Numb
     C                   Z-ADD     *ZERO         WN0013                         CIE Unused Numb
     C                   Z-ADD     *ZERO         WN0014                         CIE Unused Date
     C                   EVAL      WN0015 = ' '                                 CIE TPM Equipme
     C                   EVAL      WN0016 = ' '                                 CIE Capacity Co
     C                   EVAL      WN0017 = ' '                                 Record Status
     C                   Z-ADD     *ZERO         WN0018                         Create Date
     C                   Z-ADD     *ZERO         WN0019                         Create Time
     C                   EVAL      WN0020 = ' '                                 Create User
     C                   EVAL      WN0021 = ' '                                 Create Program
     C                   Z-ADD     *ZERO         WN0022                         Change Date
     C                   Z-ADD     *ZERO         WN0023                         Change Time
     C                   EVAL      WN0024 = ' '                                 Change User
     C                   EVAL      WN0025 = ' '                                 Change Program
      *
     C                   EVAL      W0RTN = ' '
      * Set PGM.*Record Data Changed flag
     C                   EVALR     YARDC = ' '
      *
      * Move key fields to @FDREAO
     C                   Z-ADD     WAAIC3        WBAIC3                         Company Number
     C                   Z-ADD     P1HGCD        WBHGCD                         Item Code
      *
     C     KLCHSB        KLIST
     C                   KFLD                    WBAIC3                         Company Number
     C                   KFLD                    WBHGCD                         Item Code
     C     KLCHSB        CHAIN     @FDREAO                            9091      *
      *
      * Record not found
     C                   IF        *IN90
     C                   MOVEL     'Y2U0009'     W0RTN
     C                   MOVEL     ##PGM         MDPGM
     C                   MOVEL     'PMFDREL0'    MDACP
     C                   MOVEL     '@FDREAO'     MDFMT
     C                   MOVEL     '*CHG'        MDACT
      * Record not found label: LBL001.
     C                   MOVEL     'LBL001'      MDLBL
      * Send message '*Record no longer on file'
     C                   MOVEL     'Y2U0009'     ZAMSID
     C                   MOVEL     'Y2USRMSG'    ZAMSGF
     C                   MOVEL     MD0009        ZAMSDA                         Message data
     C                   EXSR      ZASNMS
     C                   EVAL      MD0009 = ' '
     C                   GOTO      SBEXIT
     C                   ENDIF
      *
      * Record locked
     C                   IF        *IN91
     C                   MOVEL     'Y2U0004'     W0RTN
      * Send message '*Database operation error'
     C                   MOVEL     'Y2U0004'     ZAMSID
     C                   MOVEL     'Y2USRMSG'    ZAMSGF
     C                   EXSR      ZASNMS
     C                   GOTO      SBEXIT
     C                   ENDIF
      *
      * Store record data for null update check
     C                   MOVE      QPMFD1        YARDCS
      * Move non-key fields to @FDREAO
     C                   MOVEL(P)  'F'           WBENST                         Allocation Meth
      *
      * Set PGM.*Record Data Changed flag
     C                   IF        QPMFD1 <> YARDCS AND
     C                             YARDC <> 'N'
     C                   MOVE      'Y'           YARDC
     C                   ENDIF
      * USER: Processing before Data update
      * Set Chg Date/Time      IF
     C                   Z-ADD     ##JDT         WBMKDT                         Change Date
     C                   Z-ADD     ##JTM         WBBFTM                         Change Time
     C                   MOVEL     ##USR         WBCEVN                         Change User
     C                   MOVEL     ##PGM         WBCFVN                         Change Program
      * Set PGM.*Record Data Changed flag
     C                   IF        QPMFD1 <> YARDCS AND
     C                             YARDC <> 'N'
     C                   MOVE      'Y'           YARDC
     C                   ENDIF
      * If changed update record otherwise release record
     C                   IF        YARDC = 'Y'
     C                   UPDATE    @FDREAO                              91      *
     C                   ELSE
      * Release record lock
     C                   UNLOCK    PMFDREL0                             91      *
     C                   ENDIF
      * Change error detected
     C                   IF        *IN91
     C                   MOVEL     'Y2U0004'     W0RTN
     C                   ELSE
      *
      * DBF change successful
     C                   ENDIF
      *================================================================
     CSR   SBEXIT        ENDSR
      /EJECT
     CSR   ZASNMS        BEGSR
      *================================================================
      * Send message to program's message queue
      *================================================================
     C                   IF        ZAPGMQ = ' '
     C                   MOVEL     ##PGM         ZAPGMQ
     C                   END
     C                   CALL      'Y2SNMGC'
     C                   PARM                    ZAPGMQ                         Program queue
     C                   PARM                    ZAPGRL                         Rel queue
     C                   PARM                    ZAMSID                         Message ID
     C                   PARM                    ZAMSGF                         Message file
     C                   PARM                    ZAMSDA                         Message data
     C                   PARM                    ZAMSTP                         Message type
     C                   PARM      'Y'           YILE
      * Clear all fields for default mechanism next time
     C                   EVAL      ZAPGMQ = ' '
     C                   EVAL      ZAPGRL = ' '
     C                   EVAL      ZAMSID = ' '
     C                   EVAL      ZAMSGF = ' '
     C                   EVAL      ZAMSDA = ' '
     C                   EVAL      ZAMSTP = ' '
      *================================================================
     CSR   ZAEXIT        ENDSR
      /EJECT
     CSR   ZXEXPG        BEGSR
      *================================================================
      * Exit program: Normal
      *================================================================
     C                   EXSR      ZYEXPG
      *================================================================
     CSR   ZXEXIT        ENDSR
      /EJECT
     CSR   ZYEXPG        BEGSR
      *================================================================
      * Exit program: Direct
      *================================================================
      * Terminate program
     C                   SETON                                        LR
      *
      * Exit program
     C                   RETURN
      *
      *================================================================
     CSR   ZYEXIT        ENDSR
      /EJECT
     CSR   ZZINIT        BEGSR
      *================================================================
      * Initialisation
      *================================================================
     C                   IF        W0ICL = ' '
     C                   MOVEL     'Y'           W0ICL                          *Initial call
     C                   ELSE
     C                   MOVEL     'N'           W0ICL
     C                   END
     C                   EVALR     P0RTN = ' '
     C                   EVALR     W0RTN = ' '
     C                   EVAL      W0RSL = ' '
     C                   EVAL      W0RSF = ' '
     C                   MOVEL     *ZEROS        W0RTW
     C                   MOVEL     '400'         W0ENV
      * Clear all neither parameters
     C                   Z-ADD     *ZERO         P1HGCD                         Item Code
      *
      * Retrieve job attributes
     C                   CALL      'Y2RTJCR'
     C                   PARM                    PGMDS
      * Setup job date/time
     C                   Z-ADD     ##SD7         ##JDT
     C                   TIME                    ##JTM
      * Update screen time
     C                   TIME                    ##TME
      * Initialize renamed input format fields
     C                   Z-ADD     *ZERO         WAAIC3                         Company Number
     C                   Z-ADD     *ZERO         WAHGCD                         Item Code
     C                   Z-ADD     *ZERO         WAOQNY                         CIE Unused Numb
     C                   Z-ADD     *ZERO         WAORNY                         CIE Unused Numb
     C                   Z-ADD     *ZERO         WAS2DT                         CIE Unused Date
     C                   Z-ADD     *ZERO         WAMJDT                         Create Date
     C                   Z-ADD     *ZERO         WABETM                         Create Time
     C                   Z-ADD     *ZERO         WAMKDT                         Change Date
     C                   Z-ADD     *ZERO         WABFTM                         Change Time
     C                   MOVEL     'N'           W0PMT
      *================================================================
     CSR   ZZEXIT        ENDSR
