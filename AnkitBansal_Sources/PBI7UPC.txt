/*********************************************************************/
/* PROGRAM    : PBI7UPC                                             */
/* TITLE      : EXECUTE THE ORDCHG    SQL AND EMAIL TO RECIPS          */
/* DATE       : 06/18/2013                                           */
/* Description: EXECUTE THE SQL ORDCHG AND EMAIL TO RECIP IN THE   */
/*                EMAIL PARM                                       */
/*                                                                   */
/*  Parameters:                                                      */
/*  Usage   Field       Field Description                            */
/*  -----   ---------   ------------------------------------------   */
/*    I     &EADDR      EMAIL ADDRESS TO SEND TO                     */
/*********************************************************************/
/* Modifications:                                                    */
/*-------------------------------------------------------------------*/
/*   Date     Pgmr     Description                                   */
/* -------- ---------- --------------------------------------------  */
/*********************************************************************/
 PBI7UPC:    PGM        PARM(&RETURN &RPTTME)
/*-------------------------------------------------------------------*/
/* Declare Variables                                                 */
/*-------------------------------------------------------------------*/
             DCL        VAR(&RETURN)   TYPE(*CHAR) LEN(7)

             DCL        VAR(&RPTTME) TYPE(*CHAR) LEN(1)
             DCL        VAR(&FDATE) TYPE(*DEC) LEN(7 0)
             DCL        VAR(&FDATED) TYPE(*DEC)
             DCL        VAR(&TIME) TYPE(*CHAR) LEN(6)
             DCL        VAR(&FDATEA) TYPE(*CHAR) LEN(7)
             DCL        VAR(&EADDR) TYPE(*CHAR) LEN(50)
             DCL        VAR(&CURTIME) TYPE(*DEC) LEN(6 0)

/* ERROR MESSAGE FIELDS                                                       */
             DCL        VAR(&MSG)   TYPE(*CHAR) LEN(512)
             DCL        VAR(&MSGID) TYPE(*CHAR) LEN(7)
             DCL        VAR(&MSGL)  TYPE(*DEC) LEN(5 0)
             DCL        VAR(&MSG2)  TYPE(*CHAR) LEN(512)

/*-------------------------------------------------------------------*/
/*-------------------------------------------------------------------*/
/* EXECUTE THE COMMAND AND MONITOR FOR ERRORS                        */
/*-------------------------------------------------------------------*/
             ADDLIBLE   LIB(ESEND)
             MONMSG     MSGID(CPF2103 CPF9999)
/*-------------------------------------------------------------------*/
/* DETERMINE FROM DATE/TIME                                           */
/*-------------------------------------------------------------------*/
   /* GET LAST BUSINESS DAY AND PUT 2PM IN THE TIME                          */
   IF COND(&RPTTME *EQ '1') THEN(DO)
             CALL       PGM(PBI8XFR) PARM(&RETURN &FDATE)
             CHGVAR &FDATEA VALUE(&FDATE)
             CHGVAR     VAR(&TIME) VALUE('140000')
     ENDDO

   /* GET CURRENT DATE AND PUT 6AM IN THE TIME                          */
   IF COND(&RPTTME *EQ '2') THEN(DO)
             CALL       PGM(PDGFUPC) PARM(&FDATED &CURTIME)
             CHGVAR &FDATE  VALUE(&FDATED)
             CHGVAR &FDATEA VALUE(&FDATE)
             CHGVAR     VAR(&TIME) VALUE('060000')
     ENDDO

/* GET DIST LIST                                */
CALL POMTXFR ('' X'360F' 'SLSORDCHG' &EADDR)

             IF         COND(&EADDR *GT '          ') THEN(DO)
             EXECUTE    VIEW(ORDCHG) PCFMT(*XLS) RECIPIENT(&EADDR) +
                          EMLMSG('Change Log: CANORD ORDQTY') +
                          SETVAR((&FDATE  &FDATEA)  +
                          (&TIME &TIME))
             GOTO       CMDLBL(ENDPGM)
             ENDDO

/*----------------------RECEIVE MESSAGES----------------------------*/

 MSGTRAP:    RCVMSG     MSGTYPE(*EXCP) MSGDTA(&MSG) MSGDTALEN(&MSGL) +
                          MSGID(&MSGID)
             MONMSG     MSGID(CPF0000) EXEC(GOTO CMDLBL(ENDPGM))

             SNDPGMMSG  MSGID(&MSGID) MSGF(QCPFMSG) MSGDTA(%SST(&MSG +
                          1 &MSGL)) MSGTYPE(*ESCAPE)
             MONMSG     MSGID(CPF0000)

 ENDPGM:     RMVLIBLE   LIB(ESEND)
             MONMSG     MSGID(CPF0000)

             ENDPGM
