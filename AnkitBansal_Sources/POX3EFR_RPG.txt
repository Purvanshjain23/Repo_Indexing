     H/TITLE Edt WP Dumped Date/Tm EF  Edit file
     H            Y
     Z* CRTRPGPGM
     Z* CVTOPT(*DATETIME)
      *
     H* SYNOPSIS :
     H* - Maintain database file using subfile display
     H* - Existing records may be updated
     H* - Key changes are not allowed
     H* - New records cannot be added
      *
     H* Generated by  : 2E  Version:  1135
     H* Function type : Edit file
      *
     H* Company       : OMS Development Model         lopment-
     H* System        : OMS Development Model
     H* User name     : ISPPATE
     H* Date          : 11/29/05  Time  : 16:57:26
     H* Copyright     : OMS Development Model         lopment-
      *
      *================================================================
     M* Maintenance   :
      *================================================================
     FPOX3EFR#CF  E                    WORKSTN
     F                                        ##RR  KSFILE #SFLRCD
     F                                              KINFDS INFDS#
      * DSP: Edt WP Dumped Date/Tm EF  Edit file
      *
     FPOB2CPL8IF  E           K        DISK
     F                                              KINFDS INFDS1
      * RSQ : Product Trace             Co/Prd/PDt/Tim/Shf/S,Sl
      *
     FPOB2CPL1IF  E           K        DISK
      * RTV : Product Trace             Retrieval index
      *
     FCAABREL1IF  E           K        DISK
      * RTV : Company Name and Address  Retrieval index       V
      *
     FCADRREL1IF  E           K        DISK
      * RTV : User Profile Control      Retrieval index       NV
      *
     FCADTREL1IF  E           K        DISK
      * RTV : Application Profile       Retrieval index       NV
      *
     FPOB2CPL0UF  E           K        DISK
      * UPD : Product Trace             Update index
      *
      * Days in month for date validation
     E                    @XD    12  12  2 0
     E                    J7          7  1
     E                    K7          7  1
      * RIGHT JUSTIFY INPUT FIELD
     E                    #L7         7  1
     E                    #L3         3  1
      * Long constants
     E                    @CN#    1   1  6   @CN    25
     E                    YDOW        7  1               *Days of week
     I@B2CPMQ
      * Product Trace             Retrieval index
      * Renamed input format fields
     I              B2AIC3                          WAAIC3
     I              B2PFNX                          WAPFNX
     I              B2AADX                          WAAADX
     I              B2B9TM                          WAB9TM
     I              B2ADDX                          WAADDX
     I              B2ABDX                          WAABDX
     I              B2CATM                          WACATM
     I              B2MNSX                          WAMNSX
     I              B2JOWG                          WAJOWG
     I              B2JPWG                          WAJPWG
     I              B2MOSX                          WAMOSX
     I              B2DNAA                          WADNAA
     I              B2PGNX                          WAPGNX
     I              B2BTT1                          WABTT1
     I              B2D7C7                          WAD7C7
     I              B2PYNA                          WAPYNA
     I              B2PZNA                          WAPZNA
     I              B2MPSX                          WAMPSX
     I              B2CCT1                          WACCT1
     I              B2PHNX                          WAPHNX
     I              B2MQSX                          WAMQSX
     I              B2DOAA                          WADOAA
     I              B2BUT1                          WABUT1
     I              B2DYAA                          WADYAA
     I              B2BVT1                          WABVT1
     I              B2DPAA                          WADPAA
     I              B2DQAA                          WADQAA
     I              B2BZT1                          WABZT1
     I              B2BWT1                          WABWT1
     I              B2DRAA                          WADRAA
     I              B2B9T1                          WAB9T1
     I              B2DSAA                          WADSAA
     I              B2B8T1                          WAB8T1
     I              B2D4AA                          WAD4AA
     I              B2EPAA                          WAEPAA
     I              B2EQAA                          WAEQAA
     I              B2ERAA                          WAERAA
     I              B2ESAA                          WAESAA
     I              B2PNSX                          WAPNSX
     I              B2UFNX                          WAUFNX
     I              B2UGNX                          WAUGNX
     I              B2UHNX                          WAUHNX
     I              B2AGDX                          WAAGDX
     I              B2CGTM                          WACGTM
     I              B2POSX                          WAPOSX
     I              B2PPSX                          WAPPSX
     I              B2UINX                          WAUINX
     I              B2UJNX                          WAUJNX
     I              B2UKNX                          WAUKNX
     I              B2ULNX                          WAULNX
     I              B2PRSX                          WAPRSX
     I              B2PSSX                          WAPSSX
     I              B2AATM                          WAAATM
     I              B2AYNA                          WAAYNA
     I              B2A0NA                          WAA0NA
     I              B2AXDT                          WAAXDT
      *
      /EJECT
      * Data structures:
     IPGMDS     ESDSY2PGDSP
      * Modified Program data structure
     IJBDTTM      DS
      * Job date/time
     I                                        1   70##JDT
     I                                        1   10##JCC
     I                                        2   30##JYY
     I                                        4   50##JMM
     I                                        6   70##JDD
     I                                        8  130##JTM
     I                                        8   90##JHH
     I                                       10  110##JNN
     I                                       12  130##JSS
      * ABO DEFINE LARGE STRING FOR CL CMD
     IYARTCM      DS                            512
     I                                        1   1 DUMMY1
     IINFDS#    E DSY2I#DSP
      * Display file information data structure
      *
     IINFDS1    E DSY2I1DSP
      * File information data structure
      *
     I@1DBRC    E DSPOB2CPL0
      * UPD : Product Trace             Update index
      * Current/previous master file format fields for change control
      *
      /EJECT
     IXDEX        DS
      * External date
     I                                        1   80XDEXDT
     I                                        1   40XDEY01
     I                                        1   20XDEX01
     I                                        3   40XDEX02
     I                                        5   80XDEY02
     I                                        5   60XDEX03
     I                                        7   80XDEX04
      /EJECT
     IXDI8T       DS
      * Internal date
     I                                        1   80XDI8DT
     I                                        1   40XDI8CY
     I                                        1   10XDI8CC
     I                                        2   40XDI8YY
     I                                        5   60XDI8MM
     I                                        7   80XDI8DD
      /EJECT
     IXTCK        DS
      * Time: hours, minutes, seconds
     I                                        1   60XTTIM
     I                                        1   20XTHH
     I                                        3   40XTNN
     I                                        5   60XTSS
     IYARDCS      DS                            434
      * Message data for message Y2U0009.
     IMD0009      DS
     I                                        1  10 MDPGM
     I                                       11  20 MDACP
     I                                       21  30 MDFMT
     I                                       31  34 MDACT
     I                                       35  40 MDLBL
      /EJECT
     IXDINT       DS
      * Internal date
     I                                        1   70XDINDT
     I                                        1   30XDINYY
     I                                        4   50XDINMM
     I                                        6   70XDINDD
      /EJECT
     IXD2T        DS
      * Internal date
     I                                        1   70XDINT2
     I                                        1   30XDINY2
     I                                        4   50XDINM2
     I                                        6   70XDIND2
      /EJECT
      * Parameter declarations
     IP1PARM      DS                             21
      * KEY: Product Trace             Co/Prd/PDt/Tim/Shf/S,Sl
     IP2PARM      DS
      * FLD: *Arrays
      * N :  PRT Description
     I                                        1  25 P2G3TX
      * N :  PRT Printer Device
     I                                       26  35 P2WRST
      * N :  PRT Hold Output Sts
     I                                       36  39 P2WSST
      * N :  PRT Save Output Sts
     I                                       40  43 P2WTST
      * N :  PRT Number of Copies
     I                                       44  450P2DYNB
      * N :  PRT Night Queue Run Sts
     I                                       46  46 P2WUST
      * N :  PRT Night Queue
     I                                       47  56 P2BVVN
      * N :  System Value Numeric
     I                                    P  57  645P2M8NB
      * Submit job processing data structures.
     I#SRQS       DS                           3000
     I                                        1   1 #SDMY1
     I#SSTR       DS                           3000
     I                                        1   1 #SDMY2
     I#SWRK       DS                           3000
     I                                        1   1 #SDMY3
     I#SMRG       DS                            256
     I                                        1   1 #SDMY4
     I            DS
     I I            'CMD(CALL PGM('           1  13 #SCLL
     I I            'PARM('                  14  18 #SPRM
     I I            ')'                      19  19 #SPRN
     I I            '          '             20  29 #SPRG
      * Submit job command strings.
     I            DS
     I I            'SBMJOB     JOB(PRTWI-    1 256 #S0001
     I              'PEXC) JOBD(*USRPRF) '
     I            DS
     I                                        1 132 ZAMSDA
      * Message data for 'CD7 Non numeric data'
      * Message data for 'Invalid Serial Nbr Range'
      * Message data for 'Please enter all fields.'
      * Message data for 'Serial Nbr not found.'
      * PT From FG Serial Nbr
     I                                    P   1   50ZA0001
      * Message data for 'Serial Nbr not found.'
      * PT From FG Serial Nbr
     I                                    P   1   50ZA0002
      * Message data for 'Enter Prod Date to dsply'
      /EJECT
      *****************************************************************
      * Entry parameters
     C           *ENTRY    PLIST
     C                     PARM           P0RTN   7
     C                     PARM           P1PARM           KEY: Product Tr
      *****************************************************************
      * Initialize
     C                     EXSR ZZINIT
      *
     C                     DO   *HIVAL
      * Initialise and load subfile page
     C                     EXSR BAIZSF
     C                     MOVEL'N'       W0RSF   1
      * Display screen until reload requested
     C           W0RSF     DOWEQ'N'
      * Display screen
     C                     EXSR CAEXFM
      * Process response
      * Cancel & exit program
     C   03                CAS            ZXEXPG
      * HOME: Request subfile reload
     C   30                CAS            FBRQRL
      * Display next SFL page
     C   27                CAS            BBLDSF
      * Process screen input
     C                     CAS            DAPR##
     C                     END
      *
     C                     END
     C                     END
      *****************************************************************
      /EJECT
     CSR         BAIZSF    BEGSR
      *================================================================
      * Initialise & load subfile page
      *================================================================
      * Clear subfile
     C                     SETON                     80
     C                     WRITE#SFLCTL
     C                     SETOF                     80
      * Reset no of records in subfile
     C                     Z-ADD*ZERO     ##RRMX  50 81     SETOF 81
     C           YPMTFD    IFEQ *BLANKS
      * USER: Initialize subfile header
      * CASE: CTL.PT WIP Used/Not Used Sts EQ WRK.Blank for 4           U
     C           #CPPSX    IFEQ WUOTTX                     *IF
     C                     MOVEL'N'       #CPPSX           PT WIP Used/Not
     C                     MOVEL'N'       YL0001           PT WIP Used/Not
     C                     END                             *FI
     C                     END
      *................................................................
      * Position file
     C           *LIKE     DEFN #2D7C7    WZD7C7
     C                     MOVEL#2D7C7    WZD7C7           PT Product Code
     C           *LIKE     DEFN #2AADX    WZAADX
     C                     MOVEL#2AADX    WZAADX           PT Prod Date YY
     C           *LIKE     DEFN #2B9TM    WZB9TM
     C                     MOVEL#2B9TM    WZB9TM           PT Production T
     C           *LIKE     DEFN #2MOSX    WZMOSX
     C                     MOVEL#2MOSX    WZMOSX           PT Shift Number
     C           *LIKE     DEFN #2PFNX    WZPFNX
     C                     MOVEL#2PFNX    WZPFNX           PT Serial Numbe
     C           KPOS      KLIST
     C                     KFLD           B2AIC3           Company Number
     C                     KFLD           B2D7C7           PT Product Code
     C                     KFLD           B2AADX           PT Prod Date YY
     C                     KFLD           B2B9TM           PT Production T
     C                     KFLD           B2MOSX           PT Shift Number
     C                     KFLD           B2PFNX           PT Serial Numbe
      * Setup key
     C                     Z-ADD#2AIC3    B2AIC3
     C                     Z-ADD#2D7C7    B2D7C7
     C                     Z-ADD#2AADX    B2AADX
     C                     Z-ADD#2B9TM    B2B9TM
     C                     MOVEL#2MOSX    B2MOSX
     C                     Z-ADD#2PFNX    B2PFNX
      * 82=EOF
     C           KPOS      SETLL@B2CPR2              82    *
      * 82=EOF
     C  N82                READ @B2CPR2                9182*
      * Load subfile page
     C                     EXSR BBLDSF
      *................................................................
      * If no records found, display error message
     C   82      ##RR      IFEQ *ZERO                      IF
      * Send message '*No data to display'
     C                     MOVEL'Y2U0008' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     EXSR ZASNMS
     C                     END
      *
      *================================================================
     CSR         BAEXIT    ENDSR
      /EJECT
     CSR         BBLDSF    BEGSR
      *================================================================
      * Load subfile page
      *================================================================
     C                     SETOF                     84    No SFLNXTCHG
      * Re-establish fields in read-ahead record
     C   27                DO
     C  N82                READP@B2CPR2                  90*
     C  N82                READ @B2CPR2                  90*
     C                     END
      *
      * Setof record error indicators
     C                     MOVE *ALL'0'   WKIND0  2
     C                     MOVE *ALL'1'   WKIND1  2
      * Start at previous highest record in SFL
     C                     Z-ADD##RRMX    ##RR    50
     C                     Z-ADD*ZERO     ##RROK  50
      * Set required pages based on *Set Cursor or *Subfile Pages
     C           W0RR0     IFGT 0
     C           W0RR0     DIV  ##SFPG    ##SPG   30
     C                     MVR            ##SLIN  30
     C           ##SLIN    IFGT 0
     C                     ADD  1         ##SPG
     C                     END
     C           W0SPG     IFGT ##SPG
     C                     Z-ADDW0SPG     ##SPG
     C                     END
     C                     ELSE
     C                     Z-ADDW0SPG     ##SPG
     C                     END
      * Compute lines required based on pages
     C           ##SPG     MULT ##SFPG    ##SFLN  90
     C           ##SFLN    IFGT 999
     C                     Z-ADD999       ##SFLN
     C                     END
      *................................................................
      * Load next subfile page
     C  N82      ##RROK    DOWLT##SFLN                     DO
     C                     ADD  1         ##RR
     C                     MOVEAWKIND0    *IN,43
     C                     SETOF                     87    *
      * Clear subfile fields
     C                     EXSR MAIZ#1
      * Load SFL fields
     C                     EXSR MBFL#1
      * Record will be selected unless overridden
     C                     MOVEL'Y'       W0RSL   1
      * USER: Initialize subfile record (existing record)
      * Sel Rej or Not Used
      * CASE: CTL.PT WIP Used/Not Used Sts is Rejected
     C           #CPPSX    IFEQ 'R'                        *IF
      * CASE: DB1.PT WIP Used/Not Used Sts is Not Rejected
     C           B2PPSX    IFEQ 'N'                        *IF
     C           B2PPSX    OREQ 'Y'
     C                     MOVEL'N'       W0RSL            *Record selecte
     C                     END                             *FI
     C                     ELSE
      * CASE: *OTHERWISE
      * CASE: DB1.PT WIP Used/Not Used Sts is Not Used
     C           B2PPSX    IFEQ 'N'                        *IF
     C                     ELSE
      * CASE: *OTHERWISE
     C                     MOVEL'N'       W0RSL            *Record selecte
     C                     END                             *FI
     C                     END                             *FI
      * Sel Product Code
      * CASE: CTL.PT Product Code is Entered
     C           #2D7C7    IFNE *ZERO                      *IF
      * CASE: DB1.PT Product Code NE CTL.PT Product Code
     C           B2D7C7    IFNE #2D7C7                     *IF
     C                     MOVEL'N'       W0RSL            *Record selecte
     C                     END                             *FI
     C                     END                             *FI
      * Sel Prod date
      * CASE: CTL.PT Prod Date YYYYMMDD is Entered
     C           #2AADX    IFGT *ZERO                      *IF
      * CASE: DB1.PT Prod Date YYYYMMDD NE CTL.PT Prod Date YYYYMMDD
     C           B2AADX    IFNE #2AADX                     *IF
     C                     MOVEL'N'       W0RSL            *Record selecte
     C                     END                             *FI
     C                     END                             *FI
      * Sel Prod time
      * CASE: CTL.PT Production Time is Entered
     C           #2B9TM    IFGT *ZERO                      *IF
      * CASE: DB1.PT Production Time LT CTL.PT Production Time
     C           B2B9TM    IFLT #2B9TM                     *IF
     C                     MOVEL'N'       W0RSL            *Record selecte
     C                     END                             *FI
     C                     END                             *FI
      * Sel Serial Number
      * CASE: CTL.PT Serial Number is Entered
     C           #2PFNX    IFGT *ZERO                      *IF
      * CASE: DB1.PT Serial Number NE CTL.PT Serial Number
     C           B2PFNX    IFNE #2PFNX                     *IF
     C                     MOVEL'N'       W0RSL            *Record selecte
     C                     END                             *FI
     C                     END                             *FI
      * Sel Shift Number
      * CASE: CTL.PT Shift Number is *ALL values
     C           #2MOSX    IFEQ '1'                        *IF
     C           #2MOSX    OREQ '2'
      * CASE: DB1.PT Shift Number NE CTL.PT Shift Number
     C           B2MOSX    IFNE #2MOSX                     *IF
     C                     MOVEL'N'       W0RSL            *Record selecte
     C                     END                             *FI
     C                     END                             *FI
      * Sel Weight
      * CASE: CTL.PT Gross Weight is Entered
     C           #CJPWG    IFGT *ZERO                      *IF
      * CASE: DB1.PT Gross Weight NE CTL.PT Gross Weight
     C           B2JPWG    IFNE #CJPWG                     *IF
     C                     MOVEL'N'       W0RSL            *Record selecte
     C                     END                             *FI
     C                     END                             *FI
     C                     Z-ADD#1AGDX    #RAHDX           WIP Dump/Produc
     C                     Z-ADD#1CGTM    #RCITM           WIP Dump/Produc
     C           B2CGTM    DIV  100       #RT4TM           USR Time 4.0
     C                     MOVEL#1POSX    #RPUSX           WIP Dump/Produc
     C                     MOVEL#1PPSX    #RPVSX           WIP Used/Not Us
     C                     Z-ADD#1UINX    #RUMNX           From FG Serial
     C                     Z-ADD#1UJNX    #RUNNX           To FG Serial Nb
      * (RI) prod date if over 3 days old and no dumped data and not used
      * CASE:
      *  - c1ANDc2ANDc3
      *   |- c1    : RCD.PT Prod Date YYYYMMDD LT LCL.PT Prod Date YYYYMM
      *   |- c2    : RCD.PT WIP Dump/Production Dt is Not Entered
      *   |- c3    : RCD.PT WIP Used/Not Used Sts is Not Used
      *   '-
     C                     MOVEL'0'       Y0CX01  1
     C           #1AADX    IFLT YL0002                     *IF
     C           #1AGDX    IFEQ *ZERO                      *IF
     C           #1PPSX    IFEQ 'N'                        *IF
     C                     MOVEL'1'       Y0CX01
     C                     END                             *FI
     C                     END                             *FI
     C                     END                             *FI
     C           Y0CX01    IFEQ '1'                        *IF
     C                     MOVEL'Y'       #RB8ST           Status - Y or N
     C                     ELSE
      * CASE: *OTHERWISE
     C                     MOVEL'N'       #RB8ST           Status - Y or N
     C                     END                             *FI
      * If record dropped...
     C                     SUB  1         ##RR
     C           W0RSL     CABNE'Y'       BB020
     C                     ADD  1         ##RR
      * Validate subfile record and calculate derived fields
     C                     EXSR DFV2RC
      * Convert fields to external form
     C                     EXSR MNCV#1
      * Output to subfile
     C                     ADD  1         ##RROK     81    *
      * If SFLRCD invalid, note that errors present
     C   98N99             SETON                     99    *
      * Set screen conditioning indicators
     C                     EXSR GADSA1
     C                     WRITE#SFLRCD
     C           BB020     TAG
      * 82=EOF
     C                     READ @B2CPR2                  82*
     C  N82                END
      *................................................................
      * Save highest SFL record load can continue at end point
     C           ##RR      IFGT ##RRMX
      * Calculate top line
     C           ##RROK    DIV  ##SFPG    ##SPG
     C                     MVR            ##SLIN
     C           ##SLIN    IFGT 0
     C           ##RR      SUB  ##SLIN    ##SFRC
     C                     ELSE
     C           ##RR      SUB  ##SFPG    ##SFRC
     C                     END
     C                     ADD  1         ##SFRC
     C                     Z-ADD##RR      ##RRMX
     C                     END
      *================================================================
     CSR         BBEXIT    ENDSR
      /EJECT
     CSR         CAEXFM    BEGSR
      *================================================================
      * Display screen and process HELP requests
      *================================================================
      * Convert fields to external form
     C  N30N27             EXSR MOCV#2
      * Set screen conditioning indicators
     C                     EXSR GBDSA2
      * Update screen time
     C                     TIME           ##TME
     C           W0HLP     DOUEQ'N'
     C                     MOVEL'N'       W0HLP   1
     C                     MOVE *IN04     YPMT04  1
     C                     MOVE *IN25     HELP25  1
     C                     MOVE *ALL'0'   ##OFF  30
     C                     MOVEA##OFF     *IN,1
     C                     MOVE YPMT04    *IN04
     C                     MOVE HELP25    *IN25
      * Set cursor by *SET CURSOR data
     C           YSETCS    IFEQ 'Y'
     C                     EXSR Y0SET
     C                     END
     C                     WRITE#MSGCTL
     C                     WRITE#CMDTXT1
     C                     EXFMT#SFLCTL
      * Maintain subfile position where possible
     C           @#SFRC    IFGT *ZERO
     C                     Z-ADD@#SFRC    ##SFRC
     C                     END
      * Test cursor
     C                     EXSR Y8TST
      * Check if prompt requested
     C                     EXSR ZDVPMT
      * Clear set cursor DDS indicator
     C           WCSRLC    IFEQ 'OFF'
     C                     SETOF                     94    *
     C                     END
     C                     MOVE *BLANK    WCSRLC
      * If help requested, display help text
     C   25                EXSR ZHHPKY
     C                     END
      * Update job time
     C                     TIME           ##JTM
      * Clear messages from program message queue
     C                     CALL 'Y2CLMSC'
     C                     PARM ##PGM     ZAPGMQ 10
     C                     PARM '*SAME'   ZAPGRL  5
      * Reset first message only flag
     C                     MOVEL'Y'       ZAFSMS  1      99*
     C           YSETCS    IFEQ 'Y'
     C                     EXSR Y9CLR
     C                     END
      *================================================================
     CSR         CAEXIT    ENDSR
      /EJECT
     CSR         DAPR##    BEGSR
      *================================================================
      * Process screen input
      *================================================================
      *
      * Validate PT WIP Dump/Production Dt
      * External date
     C                     Z-ADDVCAGDX    XDEXDT
      * Check date
     C                     EXSR XDC84
     C           W0RTN     IFNE *BLANK
     C                     SETON                     9933  *
     C                     END
     C                     Z-ADDXDI8DT    #CAGDX
      * Validate PT WIP Dump/Production Sh
     C                     MOVEL*BLANK    W0RTN
      * Name search required?
     C           '#CPOSX'  IFEQ YPMTFD
      * PT WIP Dump/Production Sh
     C                     MOVEL#CPOSX    W0INVL 25
      * Set current value in drop down list.
     C                     MOVEL*ZEROS    ZFPOSX
     C                     SELEC
     C           W0INVL    WHEQ '1'                        1
     C                     Z-ADD1         ZFPOSX
     C           W0INVL    WHEQ '2'                        2
     C                     Z-ADD2         ZFPOSX
     C                     ENDSL
     C                     EXFMTZEPOSX
      * Set selected value from drop down list.
     C                     MOVEL*BLANKS   W0INVL
     C                     SELEC
     C           ZFPOSX    WHEQ 1
     C                     MOVEL'1'       W0INVL           1
     C           ZFPOSX    WHEQ 2
     C                     MOVEL'2'       W0INVL           2
     C                     ENDSL
     C                     SETOF                     90    *
     C                     MOVELW0INVL    #CPOSX
      * Defer confirm
     C                     MOVEL'Y'       W0DCF   1
     C                     MOVEL'*DONE'   YPMTFD
     C                     END
      *
      * Validate PT WIP Used/Not Used Sts
     C                     MOVEL*BLANK    W0RTN
      * Name search required?
     C           '#CPPSX'  IFEQ YPMTFD
      * PT WIP Used/Not Used Sts
     C                     MOVEL#CPPSX    W0INVL 25
      * Set current value in drop down list.
     C                     MOVEL*ZEROS    ZFPPSX
     C                     SELEC
     C           W0INVL    WHEQ 'N'                        N
     C                     Z-ADD1         ZFPPSX
     C           W0INVL    WHEQ 'R'                        R
     C                     Z-ADD2         ZFPPSX
     C                     ENDSL
     C                     EXFMTZEPPSX
      * Set selected value from drop down list.
     C                     MOVEL*BLANKS   W0INVL
     C                     SELEC
     C           ZFPPSX    WHEQ 1
     C                     MOVEL'N'       W0INVL           N
     C           ZFPPSX    WHEQ 2
     C                     MOVEL'R'       W0INVL           R
     C                     ENDSL
     C                     SETOF                     90    *
     C                     MOVELW0INVL    #CPPSX
      * Defer confirm
     C                     MOVEL'Y'       W0DCF   1
     C                     MOVEL'*DONE'   YPMTFD
     C                     END
      *
      * If error, exit
     C           *IN99     CABEQ'1'       DAEXIT
      *................................................................
      * Validate PT Product Code and convert to internal.
      * CD7 Ext/Int
     C                     MOVELV2D7C7    WUI3ST           USR First Posit
     C                     MOVEL*BLANK    W0RTN            *Return code
      * CASE: WRK.USR First Position is Search request
     C           WUI3ST    IFEQ '?'                        *IF
     C                     ELSE
      * CASE: *OTHERWISE
     C                     MOVELV2D7C7    WUEOCD           CD7 Ext Numeric
      * CD7 Ext/Int EXCUSRSRC - *Field attribute types  * 
     C                     MOVE *BLANKS   JUSTC7  7
     C                     MOVEA*BLANKS   K7
     C                     Z-ADD7         C       30
     C                     Z-ADD7         D       30
      * FIELD LOADED TO WRK CONTEXT BY INTERNAL FUNCTION
     C                     MOVEAWUEOCD    J7
     C                     MOVE *BLANKS   W0RTN
     C                     DO   7
     C           J7,C      IFNE ' '
     C                     MOVEAJ7,C      K7,D
     C                     SUB  1         D
     C                     END
     C                     SUB  1         C
     C                     END
     C                     MOVEAK7        JUSTC7
      * TEST FOR INVALID DATA IN FIELD
     C                     MOVE JUSTC7    TEST7   1
     C           TEST7     IFGT '?'
     C           TEST7     ANDLT'0'
     C                     MOVE 'USR0752' W0RTN
     C                     ELSE
     C                     MOVE *IN60     HLDIN   1
     C                     TESTN          JUSTC7     606060
     C           *IN60     IFEQ '0'
     C                     MOVE 'USR0752' W0RTN
     C                     END
     C                     END
     C                     MOVE JUSTC7    WUEOCD
     C                     MOVE HLDIN     *IN60
      * CASE: PGM.*Return code is CD3 Non numeric data
     C           W0RTN     IFEQ 'USR0752'                  *IF
      * Setup message data for message
      * Send message 'CD7 Non numeric data'
     C                     MOVEL'USR0802' ZAMSID
     C                     EXSR ZASNMS
     C                     SETON                     99    *
      *
     C                     Z-ADD*ZERO     #2D7C7           CD7 Int Numeric
     C                     ELSE
      * CASE: *OTHERWISE
     C                     MOVE WUEOCD    #2D7C7           CD7 Int Numeric
     C                     END                             *FI
     C                     END                             *FI
      * Validate PT Prod Date YYYYMMDD
      * External date
     C                     Z-ADDV2AADX    XDEXDT
      * Check date
     C                     EXSR XDC84
     C           W0RTN     IFNE *BLANK
     C                     SETON                     9937  *
     C                     END
     C                     Z-ADDXDI8DT    #2AADX
      * Validate PT Production Time
     C                     Z-ADD#2B9TM    XTTIM
      * Check time
     C                     EXSR XTCKTM
     C           W0RTN     IFNE *BLANK
     C                     SETON                     9938  *
     C                     END
      * Validate PT Shift Number
     C                     MOVEL*BLANK    W0RTN
      * Name search required?
     C           '#2MOSX'  IFEQ YPMTFD
      * PT Shift Number
     C                     MOVEL#2MOSX    W0INVL 25
      * Set current value in drop down list.
     C                     MOVEL*ZEROS    ZFMOSX
     C                     SELEC
     C           W0INVL    WHEQ '1'                        1
     C                     Z-ADD1         ZFMOSX
     C           W0INVL    WHEQ '2'                        2
     C                     Z-ADD2         ZFMOSX
     C                     ENDSL
     C                     EXFMTZEMOSX
      * Set selected value from drop down list.
     C                     MOVEL*BLANKS   W0INVL
     C                     SELEC
     C           ZFMOSX    WHEQ 1
     C                     MOVEL'1'       W0INVL           1
     C           ZFMOSX    WHEQ 2
     C                     MOVEL'2'       W0INVL           2
     C                     ENDSL
     C                     SETOF                     90    *
     C                     MOVELW0INVL    #2MOSX
      * Defer confirm
     C                     MOVEL'Y'       W0DCF   1
     C                     MOVEL'*DONE'   YPMTFD
     C                     END
      *
      * If error, exit
     C           *IN99     CABEQ'1'       DAEXIT
      *................................................................
      * Change of position specified
     C           YPMTFD    IFEQ *BLANKS
     C           WZD7C7    CASNE#2D7C7    FBRQRL           PT Product Code
     C           WZAADX    CASNE#2AADX    FBRQRL           PT Prod Date YY
     C           WZB9TM    CASNE#2B9TM    FBRQRL           PT Production T
     C           WZMOSX    CASNE#2MOSX    FBRQRL           PT Shift Number
     C           WZPFNX    CASNE#2PFNX    FBRQRL           PT Serial Numbe
     C                     END
     C                     END
     C           YPMTFD    IFEQ *BLANKS
      * USER: Validate subfile control
     C           #CHMNX    MULT 100       #CCGTM           PT WIP Dump/Pro
      * CTL product changed
      * CASE: CTL.PT Product Code NE LCL.PT Product Code
     C           #2D7C7    IFNE YL0003                     *IF
     C                     Z-ADD#2D7C7    YL0003           PT Product Code
     C                     MOVEL'Y'       W0RSF            *Reload subfile
     C                     END                             *FI
      * CTL Serial changed
      * CASE: CTL.PT Serial Number NE LCL.PT Serial Number
     C           #2PFNX    IFNE YL0004                     *IF
     C                     Z-ADD#2PFNX    YL0004           PT Serial Numbe
     C                     MOVEL'Y'       W0RSF            *Reload subfile
     C                     END                             *FI
      * CTL Weight changed
      * CASE: CTL.PT Gross Weight NE LCL.PT Gross Weight
     C           #CJPWG    IFNE YL0005                     *IF
     C                     Z-ADD#CJPWG    YL0005           PT Gross Weight
     C                     MOVEL'Y'       W0RSF            *Reload subfile
     C                     END                             *FI
      * CTL Wip Sts changed
      * CASE: CTL.PT WIP Used/Not Used Sts NE LCL.PT WIP Used/Not Used St
     C           #CPPSX    IFNE YL0001                     *IF
     C                     MOVEL#CPPSX    YL0001           PT WIP Used/Not
     C                     MOVEL'Y'       W0RSF            *Reload subfile
     C                     END                             *FI
      * VAL: Serial Nbr range
      * CASE: CTL.PT From FG Serial Nbr GT CTL.PT To FG Serial Nbr
     C           #CUINX    IFGT #CUJNX                     *IF
      * Setup message data for message
      * Send message 'Invalid Serial Nbr Range'
     C                     MOVEL'USR3281' ZAMSID
     C                     EXSR ZASNMS
     C                     SETON                     993132*
      *
     C                     END                             *FI
      * CTL: Enter all fields or none
      * CASE:
      *  - (c1ORc2ORc3ORc4ORc5)AND(c6ORc7ORc8ORc9ORc10)
      *   |- c1    : CTL.PT From FG Serial Nbr is Not Entered
      *   |- c2    : CTL.PT To FG Serial Nbr is Not Entered
      *   |- c3    : CTL.PT WIP Dump/Production Dt is Not Entered
      *   |- c4    : CTL.PT WIP Dump/Production Tm is Not Entered
      *   |- c5    : CTL.PT WIP Dump/Production Sh EQ WRK.Blank for 4
      *   |- c6    : CTL.PT From FG Serial Nbr is Entered
      *   |- c7    : CTL.PT To FG Serial Nbr is Entered
      *   |- c8    : CTL.PT WIP Dump/Production Dt is Entered
      *   |- c9    : CTL.PT WIP Dump/Production Tm is Entered
      *   |- c10   : CTL.PT WIP Dump/Production Sh is *ALL values
      *   '-
     C                     MOVEL'0'       Y0CX01  1
     C                     MOVEL'0'       Y0CX02  1
     C           #CUINX    IFEQ *ZERO                      *IF
     C           #CUJNX    OREQ *ZERO                      *OR
     C           #CAGDX    OREQ *ZERO                      *OR
     C           #CCGTM    OREQ *ZERO                      *OR
     C           #CPOSX    OREQ WUOTTX                     *OR
     C                     MOVEL'1'       Y0CX02
     C                     END                             *FI
     C           Y0CX02    IFEQ '1'                        *IF
     C                     MOVEL'0'       Y0CX02  1
     C           #CUINX    IFGT *ZERO                      *IF
     C           #CUJNX    ORGT *ZERO                      *OR
     C           #CAGDX    ORGT *ZERO                      *OR
     C           #CCGTM    ORGT *ZERO                      *OR
     C           #CPOSX    OREQ '1'                        *OR
     C           #CPOSX    OREQ '2'
     C                     MOVEL'1'       Y0CX02
     C                     END                             *FI
     C           Y0CX02    IFEQ '1'                        *IF
     C                     MOVEL'1'       Y0CX01
     C                     END                             *FI
     C                     END                             *FI
     C           Y0CX01    IFEQ '1'                        *IF
      * Setup message data for message
      * Send message 'Please enter all fields.'
     C                     MOVEL'USR3282' ZAMSID
     C                     EXSR ZASNMS
     C                     SETON                     993132*
     C                     SETON                     3335  *
      *
     C                     END                             *FI
      * VAL: From serial
      * CASE: CTL.PT From FG Serial Nbr is Entered
     C           #CUINX    IFGT *ZERO                      *IF
      * Val Product Trc f/FG  RT - Product Trace  * 
      * Move input parameters to subroutine local variables.
     C                     Z-ADD#2AIC3    WL0001           Company Number
     C                     Z-ADD#CUINX    WL0002           PT Serial Numbe
     C                     MOVELYL0006    WL0003    P      *Return code
     C                     EXSR SARVGN
      * Move subroutine local variables to output parameters.
     C                     MOVELWL0003    YL0006    P      *Return code
      * CASE: LCL.*Return code is *Normal
     C           YL0006    IFEQ *BLANK                     *IF
     C                     ELSE
      * CASE: *OTHERWISE
      * Setup message data for message
     C                     Z-ADD#CUINX    ZA0001           PT From FG Seri
      * Send message 'Serial Nbr not found.'
     C                     MOVEL'USR3283' ZAMSID
     C                     EXSR ZASNMS
     C                     SETON                     9931  *
      *
     C                     END                             *FI
     C                     END                             *FI
      * VAL: to serial
      * CASE: CTL.PT To FG Serial Nbr is Entered
     C           #CUJNX    IFGT *ZERO                      *IF
      * Val Product Trc f/FG  RT - Product Trace  * 
      * Move input parameters to subroutine local variables.
     C                     Z-ADD#2AIC3    WL0001           Company Number
     C                     Z-ADD#CUJNX    WL0002           PT Serial Numbe
     C                     MOVELYL0006    WL0003    P      *Return code
     C                     EXSR SARVGN
      * Move subroutine local variables to output parameters.
     C                     MOVELWL0003    YL0006    P      *Return code
      * CASE: LCL.*Return code is *Normal
     C           YL0006    IFEQ *BLANK                     *IF
     C                     ELSE
      * CASE: *OTHERWISE
      * Setup message data for message
     C                     Z-ADD#CUJNX    ZA0002           PT To FG Serial
      * Send message 'Serial Nbr not found.'
     C                     MOVEL'USR3283' ZAMSID
     C                     EXSR ZASNMS
     C                     SETON                     9932  *
      *
     C                     END                             *FI
     C                     END                             *FI
      * F5=Refresh
      * CASE: CTL.*CMD key is CF05
     C           *IN05     IFEQ '1'                        *IF
     C                     MOVEL'N'       #CPPSX           PT WIP Used/Not
     C                     MOVEL'Y'       W0RSF            *Reload subfile
     C                     END                             *FI
      * Display Rejects
      * CASE: CTL.PT WIP Used/Not Used Sts is Rejected
     C           #CPPSX    IFEQ 'R'                        *IF
      * CASE: CTL.PT Prod Date YYYYMMDD is Not Entered
     C           #2AADX    IFEQ *ZERO                      *IF
      * Setup message data for message
      * Send message 'Enter Prod Date to dsply'
     C                     MOVEL'USR3284' ZAMSID
     C                     EXSR ZASNMS
     C                     SETON                     9937  *
      *
     C                     ELSE
      * CASE: *OTHERWISE
     C                     MOVEL'Y'       W0RSF            *Reload subfile
     C                     END                             *FI
     C                     END                             *FI
      * F8=Submit (to update FG Serials with dump data)
      * CASE: CTL.*CMD key is CF08
     C           *IN08     IFEQ '1'                        *IF
      * Ext WIP-FG Serial Upd XF - Product Trace  * 
     C                     CALL 'POYMXFR'              90  Ext WIP-FG Seri
     C                     PARM *BLANK    W0RTN   7
     C                     PARM #2AIC3    WQ0001  30       Company Number
     C                     PARM #CCGTM    WQ0002  60       PT WIP Dump/Pro
      *
      *
     C           *IN90     IFEQ '1'
      * Call to program ended in error
     C                     MOVEL'Y2U0032' W0RTN
     C                     MOVEL*BLANKS   W0CLPG 10
     C                     MOVEL'POYMXFR' W0CLPG
      * Send message '*Error occured on CALL...'
     C                     MOVEL'Y2U0032' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     MOVELW0CLPG    ZAMSDA           Message data
     C                     EXSR ZASNMS
     C                     END
      * Error detected?
     C           W0RTN     IFNE *BLANK
     C                     SETON                     99    *
     C                     END
     C                     MOVEL'Y'       W0RSF            *Reload subfile
     C                     END                             *FI
      * F21=Print exceptions (wips over 3 days old and not dumped)
      * CASE: CTL.*CMD key is CF21
     C           *IN21     IFEQ '1'                        *IF
     C                     MOVEL'N'       P2WUST           PRT Night Queue
      * PMT Print Option  WEB PV - Print Options  * 
     C                     CALL 'POT2PVR'              90  PMT Print Optio
     C                     PARM *BLANK    W0RTN   7
     C                     PARM @CN,01    WQ0003 25        PRT Description
     C           P2WRST    PARM P2WRST    WQ0004 10        PRT Printer Dev
     C           P2WSST    PARM P2WSST    WQ0005  4        PRT Hold Output
     C           P2WTST    PARM P2WTST    WQ0006  4        PRT Save Output
     C           P2DYNB    PARM P2DYNB    WQ0007  20       PRT Number of C
     C           P2WUST    PARM P2WUST    WQ0008  1        PRT Night Queue
     C           P2BVVN    PARM P2BVVN    WQ0009 10        PRT Night Queue
     C                     PARM 'I/C'     WQ0010  6        Application Cod
      *
      *
     C           *IN90     IFEQ '1'
      * Call to program ended in error
     C                     MOVEL'Y2U0032' W0RTN
     C                     MOVEL*BLANKS   W0CLPG 10
     C                     MOVEL'POT2PVR' W0CLPG
      * Send message '*Error occured on CALL...'
     C                     MOVEL'Y2U0032' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     MOVELW0CLPG    ZAMSDA           Message data
     C                     EXSR ZASNMS
     C                     END
      * Error detected?
     C           W0RTN     IFNE *BLANK
     C                     SETON                     99    *
     C                     END
     C                     Z-ADDP2DYNB    P2M8NB           System Value Nu
      * Submit job for Print
      * CASE: PGM.*Return code is *User QUIT requested
     C           W0RTN     IFEQ 'Y2U9999'                  *IF
     C                     ELSE
      * CASE: *OTHERWISE
      * SBMJOB: PMT Pass for WIP ExcptUP - /UT User Programs  * 
      *
     C                     MOVEL*BLANK    W0RTN
      * Build call string for processing in batch.
     C                     MOVEL#S0001    #SRQS     P
     C           #SRQS     CAT  #SCLL:1   #SRQS            Call command
     C                     MOVEL'POYPUPC '#SPRG     P      Load pgm name
     C           #SRQS     CAT  #SPRG:0   #SRQS            Add pgm name
     C           #SRQS     CAT  #SPRN:0   #SRQS            Parenthesis
      *................................................................
      * Build parameters string.
     C           #SRQS     CAT  #SPRM:1   #SRQS            Parameters
      *
     C                     MOVELWUH3TX    #SSTR     P      Return Code Usr
     C                     CALL 'Y2BLSJR'
     C                     PARM           W0RTN
     C                     PARM           #SSTR
     C                     PARM 'A'       #STYP   1
     C                     PARM 7         #SLEN   50
     C                     PARM           #SDEC   10
     C                     PARM           #SRQS
      *
     C                     MOVELP2WRST    #SSTR     P      PRT Printer Dev
     C                     CALL 'Y2BLSJR'
     C                     PARM           W0RTN
     C                     PARM           #SSTR
     C                     PARM 'A'       #STYP   1
     C                     PARM 10        #SLEN   50
     C                     PARM           #SDEC   10
     C                     PARM           #SRQS
      *
     C                     MOVELP2WSST    #SSTR     P      PRT Hold Output
     C                     CALL 'Y2BLSJR'
     C                     PARM           W0RTN
     C                     PARM           #SSTR
     C                     PARM 'A'       #STYP   1
     C                     PARM 4         #SLEN   50
     C                     PARM           #SDEC   10
     C                     PARM           #SRQS
      *
     C                     MOVELP2WTST    #SSTR     P      PRT Save Output
     C                     CALL 'Y2BLSJR'
     C                     PARM           W0RTN
     C                     PARM           #SSTR
     C                     PARM 'A'       #STYP   1
     C                     PARM 4         #SLEN   50
     C                     PARM           #SDEC   10
     C                     PARM           #SRQS
      *
     C                     Z-ADDP2M8NB    #SPAK  309       System Value Nu
     C                     MOVEL#SPAK     #SSTR     P
     C                     CALL 'Y2BLSJR'
     C                     PARM           W0RTN
     C                     PARM           #SSTR
     C                     PARM 'P'       #STYP   1
     C                     PARM 15        #SLEN   50
     C                     PARM 5         #SDEC   10
     C                     PARM           #SRQS
      *
     C                     Z-ADD#2AIC3    #SPAK  309       Company Number
     C                     MOVEL#SPAK     #SSTR     P
     C                     CALL 'Y2BLSJR'
     C                     PARM           W0RTN
     C                     PARM           #SSTR
     C                     PARM 'P'       #STYP   1
     C                     PARM 3         #SLEN   50
     C                     PARM 0         #SDEC   10
     C                     PARM           #SRQS
      *
     C           #SRQS     CAT  #SPRN:0   #SRQS            Parenthesis
      *................................................................
     C           #SRQS     CAT  #SPRN:0   #SRQS            Parenthesis
      *
     C           W0RTN     IFNE *BLANK
      * Build of submit job string ended in error.
     C                     MOVEL'Y2U0065' W0RTN
     C                     MOVEL'POYPUPC 'W0CLPG 10 P
      * Send message '*Error occured on SBMJOB'
     C                     MOVEL'Y2U0065' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     MOVELW0CLPG    ZAMSDA           Message data
     C                     EXSR ZASNMS
     C                     ELSE
      *
     C           W0SJO     IFNE *BLANK
      * Merge variable submit job overrides.
     C                     CALL 'Y2MGRQR'              90  *
     C                     PARM #SRQS     #SWRK
     C                     PARM W0SJO     #SMRG
     C  N90                MOVEL#SWRK     #SRQS     P
     C                     MOVE *BLANK    W0SJO
     C                     END
      * Submit request.
     C                     CALL 'Y2CMEXC'              90  *
     C                     PARM           #SRQS
     C                     PARM 3000      #SRQL  155
     C                     PARM           W0JVN  10
     C                     PARM           W0JUN  10
     C                     PARM           W0JNB   6
     C                     END
      *
      *
     C           *IN90     IFEQ '1'
      * Call to program ended in error
     C                     MOVEL'Y2U0032' W0RTN
     C                     MOVEL*BLANKS   W0CLPG 10
     C                     MOVEL'POYPUPC' W0CLPG
      * Send message '*Error occured on CALL...'
     C                     MOVEL'Y2U0032' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     MOVELW0CLPG    ZAMSDA           Message data
     C                     EXSR ZASNMS
     C                     SETON                     99    *
     C                     END
      * CASE: WRK.Return Code Usr is *Blank
     C           WUH3TX    IFEQ *BLANK                     *IF
      * Send message 'Print has been Submitted'
     C                     MOVEL'USR1832' ZAMSID
     C                     MOVEL'*INFO  ' ZAMSTP           Message type
     C                     EXSR ZASNMS
      *
     C                     END                             *FI
     C                     END                             *FI
     C                     END                             *FI
     C                     END
      * Quit if reload requested
     C           W0RSF     CABEQ'Y'       DAEXIT
      *
     C   81                DO
      * No data entered as yet
     C                     MOVEL'N'       WKIPIN  1
      * Confirm/update is not deferred
     C                     MOVEL'N'       W0DCF   1
      * Process subfile records
     C                     EXSR DBPRSF
      * If error, exit
     C           *IN99     CABEQ'1'       DAEXIT
     C           YPMTFD    CABNE*BLANKS   DAEXIT
      * Defer confirm/update requested
     C           W0DCF     CABEQ'Y'       DAEXIT
      * If data entered
     C           WKIPIN    IFEQ 'Y'
      * Update DBF from subfile
     C                     EXSR EAPRSF
      * If error during update, exit:
     C           *IN99     CABEQ'1'       DAEXIT
     C                     END                             WKIPIN
     C                     END
      *================================================================
     CSR         DAEXIT    ENDSR
      /EJECT
     CSR         DBPRSF    BEGSR
      *================================================================
      * Process modified subfile record
      *================================================================
      * Read first changed slf record
     C           YAFSCH    IFNE *ZERO
     C           YAFSCH    CHAIN#SFLRCD              92    *
     C                     ELSE
     C                     READC#SFLRCD                  92*
     C                     END
     C           *IN92     DOWEQ'0'
     C                     EXSR DCPRSR
      * Convert fields to external form
     C                     EXSR MNCV#1
     C                     SETOF                     87    *
      * Set screen conditioning indicators
     C                     EXSR GADSA1
     C                     UPDAT#SFLRCD
     C                     READC#SFLRCD                  92*
     C                     END
      *================================================================
     CSR         DBEXIT    ENDSR
      /EJECT
     CSR         DCPRSR    BEGSR
      *================================================================
      * Process subfile record
      *================================================================
      * Set off error indicators
     C                     MOVEAWKIND0    *IN,43
      * No errors
     C                     SETOF                     98
      * Data entered
     C                     MOVEL'Y'       WKIPIN
      * SFLNXTCHG
     C                     SETON                     84
      * Validate subfile record
     C                     EXSR DEV1RC
      * If SFLRCD invalid, note the fact
     C   98N99             Z-ADD##RR      ##SFRC     99    *
      *================================================================
     CSR         DCEXIT    ENDSR
      /EJECT
     CSR         DEV1RC    BEGSR
      *================================================================
      * Validate subfile record
      *================================================================
      * Validate WIP Used/Not Used Sts USR
     C                     MOVEL*BLANK    W0RTN
      * Name search required?
     C           '#RPVSX'  IFEQ YPMTFD
     C           ##RR      ANDEQYPMRRN
      * WIP Used/Not Used Sts USR
     C                     MOVEL#RPVSX    W0INVL 25
      * Set current value in drop down list.
     C                     MOVEL*ZEROS    ZHPVSX
     C                     SELEC
     C           W0INVL    WHEQ 'N'                        N
     C                     Z-ADD1         ZHPVSX
     C           W0INVL    WHEQ 'R'                        R
     C                     Z-ADD2         ZHPVSX
     C                     ENDSL
      * Window width
     C                     Z-ADD13        YWWDWD
      * Window depth
     C                     Z-ADD2         YWWDDP
      * Window reference corner
     C                     MOVEL'*TL  '   YWWDCR
      * Window start row
     C                     Z-ADD12        YWWDRW
     C                     ADD  YZSFDL    YWWDRW
      * Window start column
     C                     Z-ADD55        YWWDCL
      * Retrieve window location
     C                     EXSR ZURTLC
      * Window start row
     C                     Z-ADDYWWDRW    ZG01RW
      * Window start column
     C                     Z-ADDYWWDCL    ZG01CL
     C                     EXFMTZGPVSX
      * Set selected value from drop down list.
     C                     MOVEL*BLANKS   W0INVL
     C                     SELEC
     C           ZHPVSX    WHEQ 1
     C                     MOVEL'N'       W0INVL           N
     C           ZHPVSX    WHEQ 2
     C                     MOVEL'R'       W0INVL           R
     C                     ENDSL
     C                     SETOF                     90    *
     C                     MOVELW0INVL    #RPVSX
      * Defer confirm
     C                     MOVEL'Y'       W0DCF   1
     C                     MOVEL'*DONE'   YPMTFD
     C                     END
      *
      * Validate subfile record relations
     C                     EXSR DFV2RC
      * WIP Used/Not Used Sts USR required
     C           #RPVSX    IFEQ *BLANK                     IF
     C           YPMTFD    ANDEQ*BLANKS
     C                     SETON                     9843  *
      * Send message '*Value required'
     C                     MOVEL'Y2U0001' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     EXSR ZASNMS
     C                     END                             FI
      *================================================================
     CSR         DEEXIT    ENDSR
      /EJECT
     CSR         DFV2RC    BEGSR
      *================================================================
      * Validate subfile record relations
      *================================================================
      * Check reference to Company Name and Address
     C                     EXSR VACKRL
     C           W0RTN     IFNE *BLANK
     C           YPMTFD    ANDEQ*BLANK
     C                     SETON                     98    *
     C                     END
     C           YPMTFD    IFEQ *BLANKS
      * USER: Validate subfile record relations
      * CASE: RCD.USR Time 4.0 is Entered
     C           #RT4TM    IFNE 0                          *IF
     C                     Z-ADD#CAGDX    #1AGDX           PT WIP Dump/Pro
     C           #RT4TM    MULT 100       #1CGTM           PT WIP Dump/Pro
     C                     MOVEL#CPOSX    #1POSX           PT WIP Dump/Pro
     C                     Z-ADD#CUINX    #1UINX           PT From FG Seri
     C                     Z-ADD#CUJNX    #1UJNX           PT To FG Serial
     C                     ELSE
      * CASE: *OTHERWISE
      * Unselect = blank out dumped fields
      * CASE: RCD.PT WIP Dump/Production Tm is Entered
     C           #1CGTM    IFGT *ZERO                      *IF
     C                     Z-ADD*ZERO     #1AGDX           PT WIP Dump/Pro
     C                     Z-ADD*ZERO     #1CGTM           PT WIP Dump/Pro
     C                     MOVELWUOTTX    #1POSX           PT WIP Dump/Pro
     C                     Z-ADD*ZERO     #1UINX           PT From FG Seri
     C                     Z-ADD*ZERO     #1UJNX           PT To FG Serial
     C                     END                             *FI
     C                     END                             *FI
     C                     MOVEL#RPVSX    #1PPSX           PT WIP Used/Not
     C                     END
      *================================================================
     CSR         DFEXIT    ENDSR
      /EJECT
     CSR         EAPRSF    BEGSR
      *================================================================
      * Update DBF from subfile
      *================================================================
      * Initialise subfile reload flag
     C                     MOVEL'N'       W0RSF
      * Process all modified subfile records
     C                     READC#SFLRCD                  92*
     C           *IN92     DOWEQ'0'
      * Process modified subfile record
     C                     EXSR EBPRSR
      * Convert fields to external form
     C                     EXSR MNCV#1
      * Set screen conditioning indicators
     C                     EXSR GADSA1
     C                     UPDAT#SFLRCD
     C                     READC#SFLRCD                  92*
     C                     END
      * If any errors, cancel reload
     C           *IN99     IFEQ '1'
     C                     MOVEL'N'       W0RSF   1
     C                     END
      *================================================================
     CSR         EAEXIT    ENDSR
      /EJECT
     CSR         EBPRSR    BEGSR
      *================================================================
      * Process modified subfile record
      *================================================================
      * Set off error indicators
     C                     MOVEAWKIND0    *IN,43
     C                     SETOF                     98
      *
      * Process change request
     C                     EXSR EECHRQ
      * If error occurred on update, note the fact
     C           *IN98     IFEQ '1'
     C           *IN99     IFEQ '0'
     C                     Z-ADD##RR      ##SFRC     99    *
     C                     END
     C                     ELSE
      * USER: Extra processing after DBF update
     C                     MOVEL'Y'       W0RSF            *Reload subfile
     C                     END
      *================================================================
     CSR         EBEXIT    ENDSR
      /EJECT
     CSR         EECHRQ    BEGSR
      *================================================================
      * Process update request
      *================================================================
      * USER: Change DBF record
      * Chg Product Trace All CH - Product Trace  * 
     C                     EXSR SBCHRC
     C           W0RTN     IFNE *BLANK
      * Data update error
      * Screen errors
     C                     MOVEAWKIND1    *IN,43
      * Format error
     C                     SETON                     98    *
      * Enable entry
     C                     SETOF                     87    *
      * SFLNXTCHG
     C                     SETON                     84    *
      * Reset subfile record if changed record
     C           W0RTN     CASEQ'Y2U0007' MBFL#1           IF
     C                     END
     C                     ELSE
      * DBF update successful
      * Enable entry
     C                     SETOF                     87    *
      * No SFLNXTCHG
     C                     SETOF                     84    *
     C                     END
      *================================================================
     CSR         EEEXIT    ENDSR
      /EJECT
     CSR         FBRQRL    BEGSR
      *================================================================
      * Request subfile reload
      *================================================================
     C                     MOVEL'Y'       W0RSF
      *================================================================
     CSR         FBEXIT    ENDSR
      /EJECT
     CSR         GADSA1    BEGSR
      *================================================================
      * Set display attributes for Subfile record
      *================================================================
     C           W0PMD     COMP 'ADD'                    89*
      * Protect keys if change mode or updated record
     C                     SETON                     88    *
     C   89N87             SETOF                     88    *
     C                     MOVEL'0'       *IN79
     C           #RB8ST    IFEQ 'Y'                        *IF
     C                     MOVEL'1'       *IN79
     C                     END                             *FI
      *================================================================
     CSR         GAEXIT    ENDSR
      /EJECT
     CSR         GBDSA2    BEGSR
      *================================================================
      * Set display attributes for Subfile control
      *================================================================
     C           W0PMD     COMP 'ADD'                    89*
      *================================================================
     CSR         GBEXIT    ENDSR
      /EJECT
     CSR         MAIZ#1    BEGSR
      *================================================================
      * Initialise subfile record
      *================================================================
      * Previous values
     C                     MOVEL*BLANK    #1DBRC
     C                     Z-ADD*ZERO     #1ADDX           PT Label Date Y
     C                     Z-ADD*ZERO     #1ABDX           PT Offset Prod
     C                     Z-ADD*ZERO     #1CATM           PT Offset Prod
     C                     MOVEL*BLANK    #1MNSX           PT Inventory St
     C                     Z-ADD*ZERO     #1JOWG           PT Net Weight
     C                     MOVEL*BLANK    #1DNAA           PT Warehouse ID
     C                     Z-ADD*ZERO     #1PGNX           PT Order Number
     C                     MOVEL*BLANK    #1BTT1           PT Pallet Numbe
     C                     MOVEL*BLANK    #RB8ST           Status - Y or N
     C                     Z-ADD*ZERO     #1AIC3           Company Number
     C                     MOVEL*BLANK    #1PYNA           PT Item Label L
     C                     MOVEL*BLANK    #1PZNA           PT Item Label L
     C                     MOVEL*BLANK    #1MPSX           PT Fresh/Frozen
     C                     MOVEL*BLANK    #1CCT1           PT Item Picture
     C                     Z-ADD*ZERO     #1PHNX           PT Tattoo Numbe
     C                     MOVEL*BLANK    #1MQSX           PT Source Type
     C                     MOVEL*BLANK    #1DOAA           PT Source Code
     C                     MOVEL*BLANK    #1BUT1           PT Source Code
     C                     MOVEL*BLANK    #1DYAA           PT Producer/Cel
     C                     MOVEL*BLANK    #1BVT1           PT Producer/Cel
     C                     MOVEL*BLANK    #1DPAA           PT Producer/Far
     C                     MOVEL*BLANK    #1DQAA           PT Producer Loc
     C                     MOVEL*BLANK    #1BZT1           PT Producer/Far
     C                     MOVEL*BLANK    #1BWT1           PT Producer/Far
     C                     MOVEL*BLANK    #1DRAA           PT Producer/Far
     C                     MOVEL*BLANK    #1B9T1           PT Producer/Far
     C                     MOVEL*BLANK    #1DSAA           PT Genetic Code
     C                     MOVEL*BLANK    #1B8T1           PT Genetic Desc
     C                     MOVEL*BLANK    #1D4AA           PT Gender Code
     C                     MOVEL*BLANK    #1EPAA           PT Producer/Far
     C                     MOVEL*BLANK    #1EQAA           PT Producer/Far
     C                     MOVEL*BLANK    #1ERAA           PT Producer/Far
     C                     MOVEL*BLANK    #1ESAA           PT Producer/Far
     C                     MOVEL*BLANK    #1PNSX           PT Item Type Co
     C                     Z-ADD*ZERO     #1UFNX           PT Item Str Cla
     C                     Z-ADD*ZERO     #1UGNX           PT Item Str Gro
     C                     Z-ADD*ZERO     #1UHNX           PT Item Str Typ
     C                     Z-ADD*ZERO     #1AGDX           PT WIP Dump/Pro
     C                     Z-ADD*ZERO     #1CGTM           PT WIP Dump/Pro
     C                     MOVEL*BLANK    #1POSX           PT WIP Dump/Pro
     C                     MOVEL*BLANK    #1PPSX           PT WIP Used/Not
     C                     Z-ADD*ZERO     #RCITM           WIP Dump/Produc
     C                     Z-ADD*ZERO     #RUNNX           To FG Serial Nb
     C                     Z-ADD*ZERO     #1UINX           PT From FG Seri
     C                     Z-ADD*ZERO     #1UJNX           PT To FG Serial
     C                     Z-ADD*ZERO     #RAHDX           WIP Dump/Produc
     C                     MOVEL*BLANK    #RPUSX           WIP Dump/Produc
     C                     Z-ADD*ZERO     #1UKNX           PT Unused Nbr 3
     C                     Z-ADD*ZERO     #1ULNX           PT Unused Nbr 4
     C                     MOVEL*BLANK    #1PRSX           PT Incl in Prod
     C                     MOVEL*BLANK    #1PSSX           PT Unused Sts 4
     C                     Z-ADD*ZERO     #1AATM           Job Time
     C                     MOVEL*BLANK    #1AYNA           User Id
     C                     MOVEL*BLANK    #1A0NA           Job Name
     C                     Z-ADD*ZERO     #1AXDT           Job Date
     C                     Z-ADD*ZERO     #1D7C7           PT Product Code
      * Clear external version also
     C                     MOVEL*BLANK    V1D7C7
     C                     Z-ADD*ZERO     #1AADX           PT Prod Date YY
      * Clear external version also
     C                     Z-ADD*ZERO     V1AADX
     C                     Z-ADD*ZERO     #1B9TM           PT Production T
     C                     MOVEL*BLANK    #1MOSX           PT Shift Number
     C                     Z-ADD*ZERO     #1PFNX           PT Serial Numbe
     C                     Z-ADD*ZERO     #1JPWG           PT Gross Weight
     C                     MOVEL*BLANK    #RPVSX           WIP Used/Not Us
     C                     Z-ADD*ZERO     #RT4TM           USR Time 4.0
     C                     Z-ADD*ZERO     #RUMNX           From FG Serial
      *================================================================
     CSR         MAEXIT    ENDSR
      /EJECT
     CSR         MBFL#1    BEGSR
      *================================================================
      * Move @B2CPR2 fields to subfile
      *================================================================
     C                     Z-ADDB2ADDX    #1ADDX           PT Label Date Y
     C                     Z-ADDB2ABDX    #1ABDX           PT Offset Prod
     C                     Z-ADDB2CATM    #1CATM           PT Offset Prod
     C                     MOVELB2MNSX    #1MNSX           PT Inventory St
     C                     Z-ADDB2JOWG    #1JOWG           PT Net Weight
     C                     MOVELB2DNAA    #1DNAA           PT Warehouse ID
     C                     Z-ADDB2PGNX    #1PGNX           PT Order Number
     C                     MOVELB2BTT1    #1BTT1           PT Pallet Numbe
     C                     Z-ADDB2AIC3    #1AIC3           Company Number
     C                     MOVELB2PYNA    #1PYNA           PT Item Label L
     C                     MOVELB2PZNA    #1PZNA           PT Item Label L
     C                     MOVELB2MPSX    #1MPSX           PT Fresh/Frozen
     C                     MOVELB2CCT1    #1CCT1           PT Item Picture
     C                     Z-ADDB2PHNX    #1PHNX           PT Tattoo Numbe
     C                     MOVELB2MQSX    #1MQSX           PT Source Type
     C                     MOVELB2DOAA    #1DOAA           PT Source Code
     C                     MOVELB2BUT1    #1BUT1           PT Source Code
     C                     MOVELB2DYAA    #1DYAA           PT Producer/Cel
     C                     MOVELB2BVT1    #1BVT1           PT Producer/Cel
     C                     MOVELB2DPAA    #1DPAA           PT Producer/Far
     C                     MOVELB2DQAA    #1DQAA           PT Producer Loc
     C                     MOVELB2BZT1    #1BZT1           PT Producer/Far
     C                     MOVELB2BWT1    #1BWT1           PT Producer/Far
     C                     MOVELB2DRAA    #1DRAA           PT Producer/Far
     C                     MOVELB2B9T1    #1B9T1           PT Producer/Far
     C                     MOVELB2DSAA    #1DSAA           PT Genetic Code
     C                     MOVELB2B8T1    #1B8T1           PT Genetic Desc
     C                     MOVELB2D4AA    #1D4AA           PT Gender Code
     C                     MOVELB2EPAA    #1EPAA           PT Producer/Far
     C                     MOVELB2EQAA    #1EQAA           PT Producer/Far
     C                     MOVELB2ERAA    #1ERAA           PT Producer/Far
     C                     MOVELB2ESAA    #1ESAA           PT Producer/Far
     C                     MOVELB2PNSX    #1PNSX           PT Item Type Co
     C                     Z-ADDB2UFNX    #1UFNX           PT Item Str Cla
     C                     Z-ADDB2UGNX    #1UGNX           PT Item Str Gro
     C                     Z-ADDB2UHNX    #1UHNX           PT Item Str Typ
     C                     Z-ADDB2AGDX    #1AGDX           PT WIP Dump/Pro
     C                     Z-ADDB2CGTM    #1CGTM           PT WIP Dump/Pro
     C                     MOVELB2POSX    #1POSX           PT WIP Dump/Pro
     C                     MOVELB2PPSX    #1PPSX           PT WIP Used/Not
     C                     Z-ADDB2UINX    #1UINX           PT From FG Seri
     C                     Z-ADDB2UJNX    #1UJNX           PT To FG Serial
     C                     Z-ADDB2UKNX    #1UKNX           PT Unused Nbr 3
     C                     Z-ADDB2ULNX    #1ULNX           PT Unused Nbr 4
     C                     MOVELB2PRSX    #1PRSX           PT Incl in Prod
     C                     MOVELB2PSSX    #1PSSX           PT Unused Sts 4
     C                     Z-ADDB2AATM    #1AATM           Job Time
     C                     MOVELB2AYNA    #1AYNA           User Id
     C                     MOVELB2A0NA    #1A0NA           Job Name
     C                     Z-ADDB2AXDT    #1AXDT           Job Date
     C                     Z-ADDB2D7C7    #1D7C7           PT Product Code
     C                     Z-ADDB2AADX    #1AADX           PT Prod Date YY
     C                     Z-ADDB2B9TM    #1B9TM           PT Production T
     C                     MOVELB2MOSX    #1MOSX           PT Shift Number
     C                     Z-ADDB2PFNX    #1PFNX           PT Serial Numbe
     C                     Z-ADDB2JPWG    #1JPWG           PT Gross Weight
      * Hold current record image for change detection
     C                     MOVEL@1DBRC    #1DBRC
      *================================================================
     CSR         MBEXIT    ENDSR
      /EJECT
     CSR         MEIZ#2    BEGSR
      *================================================================
      * Initialise subfile control
      *================================================================
     C                     Z-ADD*ZERO     #CCGTM           PT WIP Dump/Pro
     C                     Z-ADD*ZERO     #CDDNB           Number of Credi
     C                     Z-ADD*ZERO     #2AIC3           Company Number
      * Clear external version also
     C                     MOVEL*BLANK    V2AIC3
     C                     Z-ADD*ZERO     #CUINX           PT From FG Seri
     C                     Z-ADD*ZERO     #CUJNX           PT To FG Serial
     C                     Z-ADD*ZERO     #CAGDX           PT WIP Dump/Pro
      * Clear external version also
     C                     Z-ADD*ZERO     VCAGDX
     C                     Z-ADD*ZERO     #CHMNX           USR From Time 4
     C                     MOVEL*BLANK    #CPOSX           PT WIP Dump/Pro
     C                     Z-ADD*ZERO     #2D7C7           PT Product Code
      * Clear external version also
     C                     MOVEL*BLANK    V2D7C7
     C                     Z-ADD*ZERO     #2AADX           PT Prod Date YY
      * Clear external version also
     C                     Z-ADD*ZERO     V2AADX
     C                     Z-ADD*ZERO     #2B9TM           PT Production T
     C                     MOVEL*BLANK    #2MOSX           PT Shift Number
     C                     Z-ADD*ZERO     #2PFNX           PT Serial Numbe
     C                     Z-ADD*ZERO     #CJPWG           PT Gross Weight
     C                     MOVEL*BLANK    #CPPSX           PT WIP Used/Not
     C                     Z-ADD*ZERO     #CT4TM           USR Time 4.0
     C                     Z-ADD*ZERO     #CQTYX           Number of Carca
      *================================================================
     CSR         MEEXIT    ENDSR
      /EJECT
     CSR         MNCV#1    BEGSR
      *================================================================
      * Convert subfile fields into external form
      *================================================================
      * Convert PT Product Code to external.
      * CD7 Int/Ext
      * CASE: PAR.CD7 Int Numeric Key is not equal zero
     C           #1D7C7    IFNE *ZERO                      *IF
     C                     MOVEL*BLANK    WUEOCD           CD7 Ext Numeric
     C                     MOVEL#1D7C7    WUEOCD           CD7 Ext Numeric
      * CD7 Int/Ext EXCUSRSRC - *Field attribute types  * 
     C                     MOVEAWUEOCD    #L7              EDIT ARRAY
     C                     Z-ADD1         #E      30
     C                     MOVE *IN61     UUIN61  1
     C                     SETOF                     61
     C                     DO   7
     C           #L7,#E    IFEQ '0'                        ZERO VALUE
     C           *IN61     IFEQ '0'
     C                     MOVE ' '       #L7,#E
     C                     ADD  1         #E
     C                     END
     C                     ELSE
     C                     SETON                     61
     C                     END
     C                     END
     C                     MOVEA#L7       WUEOCD
     C                     MOVE UUIN61    *IN61
     C                     MOVELWUEOCD    V1D7C7           CD7 Ext Numeric
     C                     ELSE
      * CASE: *OTHERWISE
     C                     MOVEL*BLANK    V1D7C7           CD7 Ext Numeric
     C                     END                             *FI
      * Convert PT Prod Date YYYYMMDD to display format
      * Convert date
     C                     Z-ADD#1AADX    XDI8DT
     C                     EXSR XDV84T
     C                     Z-ADDXDEXDT    V1AADX
      *================================================================
     CSR         MNEXIT    ENDSR
      /EJECT
     CSR         MOCV#2    BEGSR
      *================================================================
      * Convert control fields into external form
      *================================================================
      * Convert Company Number to external.
      * CD3 Int/Ext
      * CASE: PAR.CD3 Int Numeric Key is not equal zero
     C           #2AIC3    IFNE *ZERO                      *IF
     C                     MOVEL*BLANK    WUDMCD           CD3 Ext Numeric
     C                     MOVEL#2AIC3    WUDMCD           CD3 Ext Numeric
      * CD3 Int/Ext EXCUSRSRC - *Field attribute types  * 
     C                     MOVEAWUDMCD    #L3              EDIT ARRAY
     C                     Z-ADD1         #E      30
     C                     MOVE *IN61     UUIN61  1
     C                     SETOF                     61
     C                     DO   3
     C           #L3,#E    IFEQ '0'                        ZERO VALUE
     C           *IN61     IFEQ '0'
     C                     MOVE ' '       #L3,#E
     C                     ADD  1         #E
     C                     END
     C                     ELSE
     C                     SETON                     61
     C                     END
     C                     END
     C                     MOVEA#L3       WUDMCD
     C                     MOVE UUIN61    *IN61
     C                     MOVELWUDMCD    V2AIC3           CD3 Ext Numeric
     C                     ELSE
      * CASE: *OTHERWISE
     C                     MOVEL*BLANK    V2AIC3           CD3 Ext Numeric
     C                     END                             *FI
      * Convert PT WIP Dump/Production Dt to display format
      * Convert date
     C                     Z-ADD#CAGDX    XDI8DT
     C                     EXSR XDV84T
     C                     Z-ADDXDEXDT    VCAGDX
      * Convert PT Product Code to external.
      * CD7 Int/Ext
      * CASE: PAR.CD7 Int Numeric Key is not equal zero
     C           #2D7C7    IFNE *ZERO                      *IF
     C                     MOVEL*BLANK    WUEOCD           CD7 Ext Numeric
     C                     MOVEL#2D7C7    WUEOCD           CD7 Ext Numeric
      * CD7 Int/Ext EXCUSRSRC - *Field attribute types  * 
     C                     MOVEAWUEOCD    #L7              EDIT ARRAY
     C                     Z-ADD1         #E      30
     C                     MOVE *IN61     UUIN61  1
     C                     SETOF                     61
     C                     DO   7
     C           #L7,#E    IFEQ '0'                        ZERO VALUE
     C           *IN61     IFEQ '0'
     C                     MOVE ' '       #L7,#E
     C                     ADD  1         #E
     C                     END
     C                     ELSE
     C                     SETON                     61
     C                     END
     C                     END
     C                     MOVEA#L7       WUEOCD
     C                     MOVE UUIN61    *IN61
     C                     MOVELWUEOCD    V2D7C7           CD7 Ext Numeric
     C                     ELSE
      * CASE: *OTHERWISE
     C                     MOVEL*BLANK    V2D7C7           CD7 Ext Numeric
     C                     END                             *FI
      * Convert PT Prod Date YYYYMMDD to display format
      * Convert date
     C                     Z-ADD#2AADX    XDI8DT
     C                     EXSR XDV84T
     C                     Z-ADDXDEXDT    V2AADX
      *================================================================
     CSR         MOEXIT    ENDSR
      /EJECT
     CSR         SARVGN    BEGSR
      *================================================================
      * Val Product Trc f/FG  RT - Product Trace  * 
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * Declare restrictor key work fields
     C           *LIKE     DEFN WAAIC3    WQSA01           Company Number
     C           *LIKE     DEFN WAPFNX    WQSA02           PT Serial Numbe
      * Define keylist
     C           KRSSA     KLIST
     C                     KFLD           WQSA01           Company Number
     C                     KFLD           WQSA02           PT Serial Numbe
      * Setup key
     C                     Z-ADDWL0001    WQSA01           Company Number
     C                     Z-ADDWL0002    WQSA02           PT Serial Numbe
      * Establish starting position
     C           KRSSA     SETLL@B2CPMQ                    *
     C           KRSSA     READE@B2CPMQ                  90*
     C           *IN90     IFEQ '1'
      * Data record not found
     C                     MOVEL'USR3144' W0RTN   7
      * USER: Processing if Data record not found
     C                     MOVEL'Y2U0005' WL0003           *Return code
     C                     GOTO SAEXIT
     C                     ENDIF
      *
     C           *IN90     DOWEQ'0'
      * USER: Process Data record
     C                     MOVEL*BLANK    WL0003           *Return code
     C           KRSSA     READE@B2CPMQ                  90*
     C                     ENDDO
      *================================================================
     CSR         SAEXIT    ENDSR
      /EJECT
     CSR         SBCHRC    BEGSR
      *================================================================
      * Chg Product Trace All CH - Product Trace  * 
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * Set PGM.*Record Data Changed flag
     C                     MOVE *BLANK    YARDC   1
      *
      * Move key fields to @B2CPMP
     C                     Z-ADD#1AIC3    B2AIC3           Company Number
     C                     Z-ADD#1PFNX    B2PFNX           PT Serial Numbe
     C                     Z-ADD#1AADX    B2AADX           PT Prod Date YY
     C                     Z-ADD#1B9TM    B2B9TM           PT Production T
      *
     C           KLCHSB    KLIST
     C                     KFLD           B2AIC3           Company Number
     C                     KFLD           B2PFNX           PT Serial Numbe
     C                     KFLD           B2AADX           PT Prod Date YY
     C                     KFLD           B2B9TM           PT Production T
     C           KLCHSB    CHAIN@B2CPMP              9091  *
      *
     C           *IN90     IFEQ '1'
      * Record not found
     C                     MOVEL'Y2U0009' W0RTN   7
     C                     MOVEL##PGM     MDPGM
     C                     MOVEL'POB2CPL0'MDACP
     C                     MOVEL'@B2CPMP' MDFMT
     C                     MOVEL'*CHG'    MDACT
      * Record not found label: LBL001.
     C                     MOVEL'LBL001'  MDLBL
      * Send message '*Record no longer on file'
     C                     MOVEL'Y2U0009' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     MOVELMD0009    ZAMSDA           Message data
     C                     EXSR ZASNMS
     C                     MOVEL*BLANKS   MD0009
     C                     GOTO SBEXIT
     C                     ENDIF
      *
     C           *IN91     IFEQ '1'
      * Record locked
     C                     MOVEL'Y2U0004' W0RTN   7
      * Send message '*Database operation error'
     C                     MOVEL'Y2U0004' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     EXSR ZASNMS
     C                     GOTO SBEXIT
     C                     ENDIF
      *
      * Check for changed record
     C           #1DBRC    IFNE @1DBRC                     IF
     C                     MOVEL'Y2U0007' W0RTN   7
      * Send message '*Update not accepted'
     C                     MOVEL'Y2U0007' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     EXSR ZASNMS
      * Release record lock
     C                     UNLCKPOB2CPL0               91  *
     C                     GOTO SBEXIT
     C                     ENDIF                           FI #1DBRC
      * Store record data for null update check
     C                     MOVE @1DBRC    YARDCS
      * Move non-key fields to @B2CPMP
     C                     Z-ADD#1ADDX    B2ADDX           PT Label Date Y
     C                     Z-ADD#1ABDX    B2ABDX           PT Offset Prod
     C                     Z-ADD#1CATM    B2CATM           PT Offset Prod
     C                     MOVEL#1MNSX    B2MNSX    P      PT Inventory St
     C                     Z-ADD#1JOWG    B2JOWG           PT Net Weight
     C                     Z-ADD#1JPWG    B2JPWG           PT Gross Weight
     C                     MOVEL#1MOSX    B2MOSX    P      PT Shift Number
     C                     MOVEL#1DNAA    B2DNAA    P      PT Warehouse ID
     C                     Z-ADD#1PGNX    B2PGNX           PT Order Number
     C                     MOVEL#1BTT1    B2BTT1    P      PT Pallet Numbe
     C                     Z-ADD#1D7C7    B2D7C7           PT Product Code
     C                     MOVEL#1PYNA    B2PYNA    P      PT Item Label L
     C                     MOVEL#1PZNA    B2PZNA    P      PT Item Label L
     C                     MOVEL#1MPSX    B2MPSX    P      PT Fresh/Frozen
     C                     MOVEL#1CCT1    B2CCT1    P      PT Item Picture
     C                     Z-ADD#1PHNX    B2PHNX           PT Tattoo Numbe
     C                     MOVEL#1MQSX    B2MQSX    P      PT Source Type
     C                     MOVEL#1DOAA    B2DOAA    P      PT Source Code
     C                     MOVEL#1BUT1    B2BUT1    P      PT Source Code
     C                     MOVEL#1DYAA    B2DYAA    P      PT Producer/Cel
     C                     MOVEL#1BVT1    B2BVT1    P      PT Producer/Cel
     C                     MOVEL#1DPAA    B2DPAA    P      PT Producer/Far
     C                     MOVEL#1DQAA    B2DQAA    P      PT Producer Loc
     C                     MOVEL#1BZT1    B2BZT1    P      PT Producer/Far
     C                     MOVEL#1BWT1    B2BWT1    P      PT Producer/Far
     C                     MOVEL#1DRAA    B2DRAA    P      PT Producer/Far
     C                     MOVEL#1B9T1    B2B9T1    P      PT Producer/Far
     C                     MOVEL#1DSAA    B2DSAA    P      PT Genetic Code
     C                     MOVEL#1B8T1    B2B8T1    P      PT Genetic Desc
     C                     MOVEL#1D4AA    B2D4AA    P      PT Gender Code
     C                     MOVEL#1EPAA    B2EPAA    P      PT Producer/Far
     C                     MOVEL#1EQAA    B2EQAA    P      PT Producer/Far
     C                     MOVEL#1ERAA    B2ERAA    P      PT Producer/Far
     C                     MOVEL#1ESAA    B2ESAA    P      PT Producer/Far
     C                     MOVEL#1PNSX    B2PNSX    P      PT Item Type Co
     C                     Z-ADD#1UFNX    B2UFNX           PT Item Str Cla
     C                     Z-ADD#1UGNX    B2UGNX           PT Item Str Gro
     C                     Z-ADD#1UHNX    B2UHNX           PT Item Str Typ
     C                     Z-ADD#1AGDX    B2AGDX           PT WIP Dump/Pro
     C                     Z-ADD#1CGTM    B2CGTM           PT WIP Dump/Pro
     C                     MOVEL#1POSX    B2POSX    P      PT WIP Dump/Pro
     C                     MOVEL#1PPSX    B2PPSX    P      PT WIP Used/Not
     C                     Z-ADD#1UINX    B2UINX           PT From FG Seri
     C                     Z-ADD#1UJNX    B2UJNX           PT To FG Serial
     C                     Z-ADD#1UKNX    B2UKNX           PT Unused Nbr 3
     C                     Z-ADD#1ULNX    B2ULNX           PT Unused Nbr 4
     C                     MOVEL#1PRSX    B2PRSX    P      PT Incl in Prod
     C                     MOVEL#1PSSX    B2PSSX    P      PT Unused Sts 4
     C                     Z-ADD#1AATM    B2AATM           Job Time
     C                     MOVEL#1AYNA    B2AYNA    P      User Id
     C                     MOVEL#1A0NA    B2A0NA    P      Job Name
     C                     Z-ADD#1AXDT    B2AXDT           Job Date
      *
      * Set PGM.*Record Data Changed flag
     C           @1DBRC    IFNE YARDCS
     C           YARDC     ANDNE'N'
     C                     MOVE 'Y'       YARDC
     C                     ENDIF
      * USER: Processing before Data update
      * Set Record Stamp CHGOB IF
     C                     Z-ADD##JTM     B2AATM           Job Time
     C                     MOVEL##USR     B2AYNA           User Id
     C                     MOVEL##JOB     B2A0NA           Job Name
     C                     Z-ADD##JDT     B2AXDT           Job Date
      * Set PGM.*Record Data Changed flag
     C           @1DBRC    IFNE YARDCS
     C           YARDC     ANDNE'N'
     C                     MOVE 'Y'       YARDC
     C                     ENDIF
      * If changed update record otherwise release record
     C           YARDC     IFEQ 'Y'
     C                     UPDAT@B2CPMP                91  *
     C                     ELSE
      * Release record lock
     C                     UNLCKPOB2CPL0               91  *
     C                     ENDIF
     C           *IN91     IFEQ '1'
      * Change error detected
     C                     MOVEL'Y2U0004' W0RTN   7
     C                     ELSE
      *
      * Update saved record image
     C                     MOVEL@1DBRC    #1DBRC
      * DBF change successful
     C                     ENDIF
      *================================================================
     CSR         SBEXIT    ENDSR
      /EJECT
     CSR         SCRVGN    BEGSR
      *================================================================
      * Rtv Profile Model     RT - User Profile Control  * 
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * Define keylist
     C           KRSSC     KLIST
     C                     KFLD           DRAJVN           User Profile Na
      * Setup key
     C                     MOVEL##USR     DRAJVN           User Profile Na
      * Establish starting position
     C           KRSSC     CHAIN@DRRETH              90    *
     C           *IN90     IFEQ '1'
      * Data record not found
     C                     MOVEL'USR0763' W0RTN   7
      * USER: Processing if Data record not found
      * PAR = CON By name
     C                     MOVEL*BLANK    WN0001           User Code Model
     C                     GOTO SCEXIT
     C                     ENDIF
      *
     C           *IN90     IFEQ '0'
      * USER: Process Data record
      * PAR = DB1 By name
     C                     MOVELDRBUVN    WN0001           User Code Model
     C                     ENDIF
      *================================================================
     CSR         SCEXIT    ENDSR
      /EJECT
     CSR         SDRVGN    BEGSR
      *================================================================
      * RTV Appl. Default Co   RT - Application Profile  * 
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * Define keylist
     C           KRSSD     KLIST
     C                     KFLD           DTAJVN           User Profile Na
     C                     KFLD           DTDNCD           Application Cod
      * Setup key
     C                     MOVELWL0004    DTAJVN           User Profile Na
     C                     MOVELWL0005    DTDNCD           Application Cod
      * Establish starting position
     C           KRSSD     CHAIN@DTRETE              90    *
     C           *IN90     IFEQ '1'
      * Data record not found
     C                     MOVEL'USR0767' W0RTN   7
      * USER: Processing if Data record not found
      * PAR = CON By name
     C                     Z-ADD*ZERO     WL0006           Company Number
     C                     GOTO SDEXIT
     C                     ENDIF
      *
     C           *IN90     IFEQ '0'
      * USER: Process Data record
      * PAR = DB1 By name
     C                     Z-ADDDTAIC3    WL0006           Company Number
     C                     ENDIF
      *================================================================
     CSR         SDEXIT    ENDSR
      /EJECT
     CSR         VACKRL    BEGSR
      *================================================================
      * Check reference to Company Name and Address
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * Name search required?
     C           YPMTFD    IFEQ '#1AIC3'
     C           ##RR      ANDEQYPMRRN
     W* Y2W0053 - One or more arguments defaulted to available contexts
      * Field '(RCD) #1AIC3' defaulted for 'Company Number'.
     C                     CALL 'PDL7SRR'              90  SEL Co - Rtn 0
     C                     PARM *BLANK    W0RTN   7
     C           #1AIC3    PARM #1AIC3    WQ0011  30       Company Number
      *
      *
     C           *IN90     IFEQ '1'
      * Call to program ended in error
     C                     MOVEL'Y2U0032' W0RTN
     C                     MOVEL*BLANKS   W0CLPG 10
     C                     MOVEL'PDL7SRR' W0CLPG
      * Send message '*Error occured on CALL...'
     C                     MOVEL'Y2U0032' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     MOVELW0CLPG    ZAMSDA           Message data
     C                     EXSR ZASNMS
     C                     END
      * Error detected?
     C           W0RTN     IFNE *BLANK
     C           W0RTN     ANDNE'Y2U0016'
     C                     SETON                     98    *
     C                     END
      *
     C           #1AIC3    IFNE *ZERO                      Company Number
     C           YPMTFD    ANDNE*BLANK
     C           W0RTN     ANDEQ*BLANK
     C                     MOVEL'*DONE'   YPMTFD
     C                     END
      * Defer confirm
     C                     MOVEL'Y'       W0DCF   1
      * No value selected, exit
     C           W0RTN     IFNE *BLANK
     C           YPMTFD    ANDEQ*BLANK
     C                     GOTO VAEXIT
     C                     END
     C                     END
      *................................................................
      * If all low order keys not entered, exit
     C           #1AIC3    IFEQ *ZERO                      Company Number
     C                     GOTO VAEXIT
     C                     END
      *
     C           KLVAAB    KLIST
     C                     KFLD           ABAIC3           Company Number
      * Setup key
     C                     Z-ADD#1AIC3    ABAIC3
     C           KLVAAB    CHAIN@ABREAK              9091  *
     C           *IN90     IFEQ '0'
      * Record found - move back any virtuals
     C                     GOTO VAEXIT
     C                     END
     C           YPMTFD    IFNE *BLANK
     C                     SETOF                     9091
     C                     GOTO VAEXIT
     C                     END
      * Send message 'Company Name and Addre NF'
     C                     MOVEL'USR0003' ZAMSID
     C                     EXSR ZASNMS
     C                     MOVEL'USR0003' W0RTN
      *================================================================
     CSR         VAEXIT    ENDSR
      /EJECT
     CSR         XCVFA     BEGSR
      *================================================================
      * Convert absolute day to date
      *================================================================
     C           XDAY1     IFGT 109267
     C                     ADD  2         XDAY1
     C                     ELSE
     C           XDAY1     IFGT 36218
     C                     ADD  1         XDAY1
     C                     END
     C                     END
      * Full years (up to the date)
     C           XDAY1     DIV  365.25    XDWK1   80
     C                     MVR            XDWK3   71
     C                     Z-ADDXDWK1     XDINYY
     C           XDWK3     IFEQ 0
      * The date is the end of a year
     C                     Z-ADD12        XDINMM
     C                     Z-ADD31        XDINDD
     C                     ELSE
      * Year days up to the date
     C           XDWK1     MULT 365.25    XDWK2   60
     C                     SUB  XDWK2     XDAY1
     C                     ADD  1         XDINYY
      * Leap year ?
     C           XDINYY    DIV  4         XDWK1
     C                     MVR            XDWK1
      * March 1 (relative day of the year)
     C           XDWK1     IFEQ 0
     C                     Z-ADD60        XDWK1
     C                     ELSE
     C                     Z-ADD59        XDWK1
     C                     END
      * Define date base month and offset day -
     C           XDAY1     IFLE XDWK1
      *  - January (thru February)
     C                     Z-ADD1         XDINMM
     C                     ELSE
     C                     SUB  XDWK1     XDAY1
     C           XDAY1     IFLE 153
      *  - March (thru July)
     C                     Z-ADD3         XDINMM
     C                     ELSE
      *  - August (thru December)
     C                     Z-ADD8         XDINMM
     C                     SUB  153       XDAY1
     C                     END
      * Calculate 2 month base and offset day
     C           XDAY1     SUB  1         XDWK1
     C                     DIV  61        XDWK1
     C                     MVR            XDAY1
     C                     ADD  1         XDAY1
     C                     MULT 2         XDWK1
     C                     ADD  XDWK1     XDINMM
     C                     END
      * Calculate date increment,
     C           XDAY1     IFGT 31
     C                     ADD  1         XDINMM
     C                     SUB  31        XDAY1
     C                     END
     C                     Z-ADDXDAY1     XDINDD
     C                     END
      *================================================================
     CSR         XCVFAE    ENDSR
      /EJECT
     CSR         XCVTA     BEGSR
      *================================================================
      * Convert date to absolute day (from 01/01/01)
      *================================================================
      * Absolute day =
      * 365*(YY-1)+(YY-1)/4 (past years w/extra days of leap ones) ...
     C           XDINYY    SUB  1         XDWK1   80
     C           XDWK1     MULT 365.25    XDAY1   60
     C           XDWK1     IFGE 300
     C                     SUB  2         XDAY1
     C                     ELSE
     C           XDWK1     IFGE 100
     C                     SUB  1         XDAY1
     C                     END
     C                     END
      * (from the beginning of the year to the beginning of the month:)
     C           XDINMM    SUB  1         XDWK1
     C           XDINMM    IFLT 3
      *     ...+31*(MM-1) (for January-February) ...
     C                     MULT 31        XDWK1
     C                     ADD  XDWK1     XDAY1
     C                     ELSE
      *     ...+30*(MM-1) (for March-December) ...
     C                     MULT 30        XDWK1
     C                     ADD  XDWK1     XDAY1
      *         ...-2 (for preceding February) ...
     C                     SUB  2         XDAY1
     C           XDINYY    IFNE 100
     C           XDINYY    ANDNE300
      *         ...+1 (for preceding February, if leap year) ...
     C           XDINYY    DIV  4         XDWK1
     C                     MVR            XDWK1
     C           XDWK1     IFEQ 0
     C                     ADD  1         XDAY1
     C                     END
     C                     END
     C           XDINMM    IFLT 8
      *         ...+MM/2 (preceding 31-sts for March-July) ...
     C           XDINMM    MULT .5        XDWK1
     C                     ADD  XDWK1     XDAY1
     C                     ELSE
      *         ...+(MM+1)/2 (same for August-December) ...
     C           XDINMM    ADD  1         XDWK1
     C                     MULT .5        XDWK1
     C                     ADD  XDWK1     XDAY1
     C                     END
     C                     END
      * ...+DD (days in the month up to the ending date)
     C                     ADD  XDINDD    XDAY1
      *================================================================
     CSR         XCVTAE    ENDSR
      /EJECT
     CSR         XDADY     BEGSR
      *================================================================
      * Calculate date increment, *DAYS
      *================================================================
     C           XDURR     IFEQ 0
     C           XDWSL     OREQ 0
      * None days of week selected
     C                     Z-ADDXDAY2     XDAY1
     C           XDURR     IFNE *ZERO
      * Return Code: Unable to increment date.
     C                     MOVEL'Y2U0059' W0RTN   7
     C                     ENDIF
     C                     GOTO XDADYE
     C                     ENDIF
     C           XDWSL     IFEQ 7
      * All days of week selected
     C           XDAY2     ADD  XDURR     XDAY1
     C                     GOTO XDADYM
     C                     ENDIF
      * Some days of week selected
     C           XDURR     IFGE 0
     C                     Z-ADD1         XDSTP   10
     C                     ELSE
     C                     Z-ADD-1        XDSTP
     C                     ENDIF
      * Get number of full weeks in the duration
     C           XDURR     DIV  XDWSL     XDWNB   60
      * Isolate the last week
     C                     MVR            XDLSW   10
     C           XDLSW     IFEQ 0
     C           XDWSL     MULT XDSTP     XDLSW
     C                     SUB  XDSTP     XDWNB
     C                     ENDIF
      * Increment the date by the full weeks
     C           XDWNB     MULT 7         XDWK1   80
     C           XDAY2     ADD  XDWK1     XDAY1   60
      * Determine day of week of the beginning date
     C           XDAY2     ADD  3         YY      60
     C                     DIV  7         YY
     C                     MVR            YY
     C           YY        IFEQ 0
     C                     Z-ADD7         YY
     C                     ENDIF
      * Loop: Increment the date by the last week
     C           XDLSW     DOWNE0
      * Increment the date
     C                     ADD  XDSTP     XDAY1
      * Increment the day of week
     C                     ADD  XDSTP     YY
      * Put day of week into the range 1-7
     C           YY        IFEQ 0
     C                     Z-ADD7         YY
     C                     ELSE
     C           YY        IFEQ 8
     C                     Z-ADD1         YY
     C                     ELSE
     C           YY        IFEQ -1
     C                     Z-ADD6         YY
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C           YDOW,YY   IFEQ XDSEL
      * Selected day of the last week has been processed
     C                     SUB  XDSTP     XDLSW
     C                     ENDIF
      * End of loop
     C                     ENDDO
     C           XDADYM    TAG
     C           XDINDD    IFLT 1
     C                     Z-ADD1         XDINDD
     C                     MOVEL'Y2U0006' W0RTN   7
     C                     ENDIF
      *================================================================
     CSR         XDADYE    ENDSR
      /EJECT
     CSR         XDC84     BEGSR
      *================================================================
      * Validate external date format
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
     C                     Z-ADD*ZERO     XDI8DT
      * If external date is zero, do not check
     C           XDEXDT    CABEQ*ZERO     XDC84E
      *................................................................
      * Map external to internal according to date format
     C           XDDTFM    IFEQ 'DMY'
     C                     Z-ADDXDEX01    XDI8DD           DD
     C                     Z-ADDXDEX02    XDI8MM           MM
     C           XDEY02    DIV  1000      XDI8CC           Y
     C                     Z-ADDXDEY02    XDI8YY            YYY
     C                     ELSE
     C           XDDTFM    IFEQ 'MDY'
     C                     Z-ADDXDEX01    XDI8MM           MM
     C                     Z-ADDXDEX02    XDI8DD           DD
     C           XDEY02    DIV  1000      XDI8CC           Y
     C                     Z-ADDXDEY02    XDI8YY            YYY
     C                     ELSE
     C           XDEY01    DIV  1000      XDI8CC           Y
     C                     Z-ADDXDEY01    XDI8YY            YYY
     C                     Z-ADDXDEX03    XDI8MM           MM
     C                     Z-ADDXDEX04    XDI8DD           DD
     C                     END
     C                     END
     C           YPMTFD    CABNE*BLANK    XDC84E
     C           XDDTFM    IFEQ 'YMD'
      *................................................................
     C           XDEY01    IFGE 2200
     C           XDI8DT    ORNE *ZERO
     C           XDEY01    ANDLT1801
     C                     GOTO XDC84M
     C                     END
     C                     ELSE
      *................................................................
     C           XDEY02    IFGE 2200
     C           XDI8DT    ORNE *ZERO
     C           XDEY02    ANDLT1801
     C                     GOTO XDC84M
     C                     END
     C                     END
      *................................................................
      * Check months in range 1 to 12
     C           XDI8MM    CABLT1         XDC84M
     C           XDI8MM    CABGT12        XDC84M
      *................................................................
      * Check days in range 1 to maximum for month
     C           XDI8DD    CABLT1         XDC84M
     C           XDI8DD    CABGT@XD,XDI8MMXDC84M
      *................................................................
      * Special case: leap year
     C           XDI8MM    IFEQ 2
     C           XDI8YY    IFNE 900
     C           XDI8YY    ANDNE100
     C           XDI8YY    DIV  4         XDWK1   80
     C                     MVR            XDWK1
     C                     ELSE
     C                     Z-ADD1         XDWK1
     C                     END
      * Year is not leap
     C           XDWK1     IFNE *ZERO
     C           XDI8DD    CABGT28        XDC84M
     C                     END
     C                     END
     C                     GOTO XDC84E
      *................................................................
      * Send error message
     C           XDC84M    TAG
      * Send message '*Invalid date'
     C                     MOVEL'Y2U0006' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     EXSR ZASNMS
     C                     MOVEL'Y2U0006' W0RTN
      * Disable time portion if timestamp is validated
     C                     Z-ADD*ZERO     XTTIM
      *================================================================
     CSR         XDC84E    ENDSR
      /EJECT
     CSR         XDOWS     BEGSR
      *================================================================
      * Setup days of week array
      *================================================================
     C                     MOVEAXDCDW     YDOW
     C                     Z-ADD0         XDWSL   10
     C                     Z-ADD1         YY
     C           YY        DOWLE7
     C           YDOW,YY   IFEQ XDSEL
     C                     ADD  1         XDWSL
     C                     END
     C                     ADD  1         YY
     C                     END
      *================================================================
     CSR         XDOWSE    ENDSR
      /EJECT
     CSR         XDV84T    BEGSR
      *================================================================
      * Convert internal to external date format
      *================================================================
      * Map according to date format
     C           XDDTFM    IFEQ 'DMY'
     C                     Z-ADDXDI8DD    XDEX01           DD
     C                     Z-ADDXDI8MM    XDEX02           MM
     C           1000      MULT XDI8CC    XDEY02           Y
     C                     ADD  XDI8YY    XDEY02            YYY
     C                     ELSE
     C           XDDTFM    IFEQ 'MDY'
     C                     Z-ADDXDI8MM    XDEX01           MM
     C                     Z-ADDXDI8DD    XDEX02           DD
     C           1000      MULT XDI8CC    XDEY02           Y
     C                     ADD  XDI8YY    XDEY02            YYY
     C                     ELSE
      * YMD format
     C           1000      MULT XDI8CC    XDEY01           Y
     C                     ADD  XDI8YY    XDEY01            YYY
     C                     Z-ADDXDI8MM    XDEX03           MM
     C                     Z-ADDXDI8DD    XDEX04           DD
     C                     END
     C                     END
      *================================================================
     CSR         XDV84E    ENDSR
      /EJECT
     CSR         XTCKTM    BEGSR
      *================================================================
      * Validate time format
      *================================================================
      * If time is zero, do not check
     C           XTTIM     CABEQ*ZERO     XTCKTE
     C                     MOVEL*BLANK    W0RTN   7
     C           YPMTFD    CABNE*BLANK    XTCKTE
      *
      * Check hours in range 0 to 23
      * Check minutes in range 0 to 59
      * Check seconds in range 0 to 59
     C           XTHH      IFLT *ZERO
     C           XTHH      ORGT 23
     C           XTNN      ORLT *ZERO
     C           XTNN      ORGT 59
     C           XTSS      ORLT *ZERO
     C           XTSS      ORGT 59
      * Send error message
      * Send message '*Invalid time'
     C                     MOVEL'Y2U0019' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     EXSR ZASNMS
     C                     MOVEL'Y2U0019' W0RTN
     C                     END
      *================================================================
     CSR         XTCKTE    ENDSR
      /EJECT
     CSR         Y0SET     BEGSR
      *================================================================
      * Set cursor by *SET CURSOR data
      *================================================================
      *================================================================
     CSR         Y0EXIT    ENDSR
      /EJECT
     CSR         Y8TST     BEGSR
      *================================================================
      * Test cursor
      *================================================================
     C                     Z-ADD@#RWCL    ZINPOS  50
     C           ZINPOS    DIV  256       W0CRW
     C                     MVR            W0CCL
      *================================================================
     CSR         Y8EXIT    ENDSR
      /EJECT
     CSR         Y9CLR     BEGSR
      *================================================================
      * Clear *SET CURSOR data
      *================================================================
      *================================================================
     CSR         Y9EXIT    ENDSR
      /EJECT
     CSR         ZASNMS    BEGSR
      *================================================================
      * Send message to program's message queue
      *================================================================
     C           ZAPGMQ    IFEQ *BLANK
     C                     MOVEL##PGM     ZAPGMQ
     C                     END
      * If no message file specified, use default
     C           ZAMSGF    IFEQ *BLANK
     C                     MOVELZADFMF    ZAMSGF
     C                     END
     C                     CALL 'Y2SNMGC'
     C                     PARM           ZAPGMQ 10        Program queue
     C                     PARM           ZAPGRL  5        Rel queue
     C                     PARM           ZAMSID  7        Message ID
     C                     PARM           ZAMSGF 10        Message file
     C                     PARM           ZAMSDA           Message data
     C                     PARM           ZAMSTP  7        Message type
      * Clear all fields for default mechanism next time
     C                     MOVEL*BLANK    ZAPGMQ
     C                     MOVEL*BLANK    ZAPGRL
     C                     MOVEL*BLANK    ZAMSID
     C                     MOVEL*BLANK    ZAMSGF
     C                     MOVEL*BLANK    ZAMSDA
     C                     MOVEL*BLANK    ZAMSTP
      *================================================================
     CSR         ZAEXIT    ENDSR
      /EJECT
     CSR         ZDVPMT    BEGSR
      *================================================================
      * Process prompt request
      *================================================================
      *
      * Initialise prompt workfields
     C                     MOVEL*BLANK    YPMTFD 10
     C                     Z-ADD*ZERO     YAFSCH  40
     C                     Z-ADD*ZERO     YPMRRN  40
      *
     C           *IN04     IFEQ '1'
      *
      * Extract cursor row and column
     C           @#RWCL    DIV  256       ZHCSRW  50
     C                     MVR            ZHCSCL  50
      *
      * Save cursor position for redisplay
     C                     Z-ADDZHCSRW    ZZCSRW  30       Row
     C                     Z-ADDZHCSCL    ZZCSCL  30       Column
      *
      * Save sfl rrn at top of page
     C                     Z-ADD@#SFRC    Y#SFRC  40
      *
      * Initialise sfl workfields
     C                     Z-ADD012       ZHSTRW  40
     C                     Z-ADD023       ZHNDRW  40
     C                     Z-ADD001       ZHRLEN  40
     C                     Z-ADD*ZERO     ZHF4RW  40
     C                     Z-ADD*ZERO     ZHWK1#  40
      *
      * Resolve prompt row number on sfl
     C           ZHCSRW    IFGE ZHSTRW
     C           ZHCSRW    ANDLEZHNDRW
     C           ZHCSRW    SUB  ZHSTRW    ZHWK1#
     C           ZHWK1#    DIV  ZHRLEN    ZHWK1#
     C           ZHWK1#    ADD  Y#SFRC    YPMRRN
     C                     Z-ADDZHWK1#    YZSFDL  40
     C           ZHWK1#    MULT ZHRLEN    ZHWK1#
     C           ZHCSRW    SUB  ZHWK1#    ZHF4RW
      *
     C           YPMRRN    IFGT *ZERO
      * Chain to sfl record
     C           YPMRRN    CHAIN#SFLRCD              92    *
     C           *IN92     IFEQ '0'
      * Set screen conditioning indicators
     C                     EXSR GADSA1
     C                     ELSE
     C                     Z-ADD*ZERO     YPMRRN
     C                     END
     C                     END
     C                     END
      *
     C           ZHCSRW    IFEQ 006
     C           ZHCSCL    ANDEQ070
     C           @#DFMT    ANDEQ'#SFLCTL'
     C                     MOVEL'#CPOSX'  YPMTFD           PT WIP Dump/Pro
     C                     END
      *
     C           ZHCSRW    IFEQ 011
     C           ZHCSCL    ANDEQ033
     C           @#DFMT    ANDEQ'#SFLCTL'
     C                     MOVEL'#2MOSX'  YPMTFD           PT Shift Number
     C                     END
      *
     C           ZHCSRW    IFEQ 011
     C           ZHCSCL    ANDEQ055
     C           @#DFMT    ANDEQ'#SFLCTL'
     C                     MOVEL'#CPPSX'  YPMTFD           PT WIP Used/Not
     C                     END
      *
     C           ZHF4RW    IFEQ 012
     C           ZHCSCL    ANDEQ055
     C                     MOVEL'#RPVSX'  YPMTFD           WIP Used/Not Us
     C                     END
      *
     C           YPMTFD    IFEQ *BLANK
      * Error if user defined prompting is not specified.
     C           W0PMT     IFEQ 'N'
     C                     MOVEL'*NONE'   YPMTFD
     C                     MOVEL'Y'       W0HLP   1
     C                     MOVEL'Y'       ZAFSMS
      * Send error message.
     C                     MOVEL'Y2U0101' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     EXSR ZASNMS
     C                     END
     C                     END
      *
      * Save first changed  rrn
     C           ZHCSRW    IFGE ZHSTRW
     C           ZHCSRW    ANDLEZHNDRW
     C           YPMTFD    ANDNE'*NONE'
      *
     C           ##RR      IFNE *ZERO
     C                     READC#SFLRCD                  92*
     C           *IN92     IFEQ '0'
     C                     Z-ADD##RR      YAFSCH
     C                     SETON                     84    *
     C                     UPDAT#SFLRCD
     C                     END
     C                     END
      *
      * Calculate rrn for prompt slf record
     C           ZHCSRW    SUB  ZHSTRW    ZHWK1#
     C           ZHWK1#    DIV  ZHRLEN    ZHWK1#
     C           ZHWK1#    ADD  Y#SFRC    YPMRRN
      *
      * Chain to sfl record
     C           YPMRRN    CHAIN#SFLRCD              92    *
     C           *IN92     IFEQ '0'
     C                     SETON                     84    *
     C                     UPDAT#SFLRCD
     C                     ELSE
     C                     Z-ADD*ZERO     YPMRRN
     C                     END
      *
      * Test first changed rrn/prompt rrn
     C           YAFSCH    IFEQ *ZERO
     C                     Z-ADDYPMRRN    YAFSCH
     C                     END
      *
      * If prompt rrn < first changed rrn
     C           YPMRRN    IFNE *ZERO
     C           YPMRRN    ANDLTYAFSCH
     C                     Z-ADDYPMRRN    YAFSCH
     C                     END
      *
     C                     END
      *
     C                     END
      *================================================================
     CSR         ZDEXIT    ENDSR
      /EJECT
     CSR         ZHHPKY    BEGSR
      *================================================================
      * Display HELP text
      *================================================================
      * Signal help request
     C                     MOVEL'Y'       W0HLP   1
      *
      * Extract cursor row and column
     C           @#RWCL    DIV  256       ZHCSRW  50       Row
     C                     MVR            ZHCSCL  50       Column
      *
      * Save cursor position for redisplay
     C                     Z-ADDZHCSRW    ZZCSRW  30       Row
     C                     Z-ADDZHCSCL    ZZCSCL  30       Column
      *
      *
     C                     CALL 'YDDSHPR'
     C                     PARM ##PGM     W0HPMB 10        Help text sourc
     C                     PARM *BLANK    YYHPFL 10        Help text file
     C                     PARM *BLANK    YYHPLB 10        Help text libra
     C                     PARM           W0RTN   7
     C                     PARM '*CSRLOC' YYHLVN 10        Help label
     C                     PARM '*NORMAL' YYUSOP 10        Options
     C                     PARM ZHCSRW    YYRW    50       Row
     C                     PARM ZHCSCL    YYCL    50       Column
     C                     PARM *ZERO     YYLGCT  50       # of grps
     C                     PARM *BLANK    YYLGVN 10        Label grps
      *
      * Clear set cursor DDS indicator
     C  N94                MOVEL'OFF'     WCSRLC
     C  N94                SETON                     94    *
      *================================================================
     CSR         ZHEXIT    ENDSR
      /EJECT
     CSR         ZURTLC    BEGSR
      *================================================================
      * Retrieve window location
      *================================================================
      *
      * Set up parameters to API
      *
      * Return code
     C                     MOVEL*BLANKS   W0RTN
      * Retrieval Function
     C                     MOVEL*BLANKS   YWRTFN
     C                     MOVEL'*WDWLOC' YWRTFN
      *
     C                     SETOF                       90  *
      *
     C                     CALL 'YWRTLCI'              90  *
     C                     PARM           YWRTFN 10        Retrieval Funct
     C                     PARM           YWWDWD  30       Window width
     C                     PARM           YWWDDP  30       Window depth
     C                     PARM           YWWDCR  5        Window referenc
     C                     PARM           YWWDRW  30       *Window start r
     C                     PARM           YWWDCL  30       *Window start c
     C                     PARM           W0RTN            Return code
      * If error on call to API - default window location to top left cor
     C           *IN90     IFEQ '1'
     C           W0RTN     ORNE *BLANKS
     C                     Z-ADD2         YWWDRW           *Window start r
     C                     Z-ADD2         YWWDCL           *Window start c
     C                     END
      *
      *================================================================
     CSR         ZUEXIT    ENDSR
      /EJECT
     CSR         ZXEXPG    BEGSR
      *================================================================
      * Exit program: Normal
      *================================================================
     C                     MOVEL*BLANK    P0RTN
     C                     EXSR ZYEXPG
      *================================================================
     CSR         ZXEXIT    ENDSR
      /EJECT
     CSR         ZYEXPG    BEGSR
      *================================================================
      * Exit program: Direct
      *================================================================
      * Terminate program
     C                     SETON                     LR
      *
      * Exit program
     C                     RETRN
      *
      *================================================================
     CSR         ZYEXIT    ENDSR
      /EJECT
     CSR         ZZINIT    BEGSR
      *================================================================
      * Initialisation
      *================================================================
     C           W0ICL     IFEQ *BLANK
     C                     MOVEL'Y'       W0ICL   1        *Initial call
     C                     ELSE
     C                     MOVEL'N'       W0ICL
     C                     END
     C                     MOVE *BLANK    P0RTN
     C                     MOVE *BLANK    W0RTN   7
     C                     MOVEL*BLANK    W0RSL   1
     C                     MOVEL*BLANK    W0RSF   1
     C                     MOVEL*ZEROS    W0RTW   90
     C                     MOVEL'400'     W0ENV   3
      * Clear all neither parameters
     C                     MOVEL*BLANK    P2G3TX           PRT Description
     C                     MOVEL*BLANK    P2WRST           PRT Printer Dev
     C                     MOVEL*BLANK    P2WSST           PRT Hold Output
     C                     MOVEL*BLANK    P2WTST           PRT Save Output
     C                     Z-ADD*ZERO     P2DYNB           PRT Number of C
     C                     MOVEL*BLANK    P2WUST           PRT Night Queue
     C                     MOVEL*BLANK    P2BVVN           PRT Night Queue
     C                     Z-ADD*ZERO     P2M8NB           System Value Nu
      *
      * Retrieve job attributes
     C                     CALL 'Y2RTJCR'
     C                     PARM           PGMDS
      * Setup job date/time
     C                     Z-ADD##SD7     ##JDT
     C                     TIME           ##JTM
      * Update screen time
     C                     TIME           ##TME   60
      * Define work field Blank for 4           USR
     C                     MOVEL*BLANK    WUOTTX  4
      * Define work field USR First Position
     C                     MOVEL*BLANK    WUI3ST  1
      * Define work field CD7 Ext Numeric Key
     C                     MOVEL*BLANK    WUEOCD  7
      * Obtain default message file
     C           *NAMVAR   DEFN CAMGFLA   ZADFMF 10
     C                     IN   ZADFMF
      * Initialize renamed input format fields
     C                     Z-ADD*ZERO     WAAIC3           Company Number
     C                     Z-ADD*ZERO     WAPFNX           PT Serial Numbe
     C                     Z-ADD*ZERO     WAAADX           PT Prod Date YY
     C                     Z-ADD*ZERO     WAB9TM           PT Production T
     C                     Z-ADD*ZERO     WAADDX           PT Label Date Y
     C                     Z-ADD*ZERO     WAABDX           PT Offset Prod
     C                     Z-ADD*ZERO     WACATM           PT Offset Prod
     C                     Z-ADD*ZERO     WAJOWG           PT Net Weight
     C                     Z-ADD*ZERO     WAJPWG           PT Gross Weight
     C                     Z-ADD*ZERO     WAPGNX           PT Order Number
     C                     Z-ADD*ZERO     WAD7C7           PT Product Code
     C                     Z-ADD*ZERO     WAPHNX           PT Tattoo Numbe
     C                     Z-ADD*ZERO     WAUFNX           PT Item Str Cla
     C                     Z-ADD*ZERO     WAUGNX           PT Item Str Gro
     C                     Z-ADD*ZERO     WAUHNX           PT Item Str Typ
     C                     Z-ADD*ZERO     WAAGDX           PT WIP Dump/Pro
     C                     Z-ADD*ZERO     WACGTM           PT WIP Dump/Pro
     C                     Z-ADD*ZERO     WAUINX           PT From FG Seri
     C                     Z-ADD*ZERO     WAUJNX           PT To FG Serial
     C                     Z-ADD*ZERO     WAUKNX           PT Unused Nbr 3
     C                     Z-ADD*ZERO     WAULNX           PT Unused Nbr 4
     C                     Z-ADD*ZERO     WAAATM           Job Time
     C                     Z-ADD*ZERO     WAAXDT           Job Date
      * Define work field Return Code Usr
     C                     MOVEL*BLANK    WUH3TX  7
      * Define work field CD3 Ext Numeric Key
     C                     MOVEL*BLANK    WUDMCD  3
      * Define work field Label Date
     C                     Z-ADD*ZERO     WUK7DT  70
      * Define work field Year Code
     C                     Z-ADD*ZERO     WUAYNX  40
      * Flag no *SET CURSOR in the program
     C                     MOVE 'N'       YSETCS  1
     C                     MOVE *BLANK    WCSRLC  3
      * Define *Synon program work fields
     C                     MOVEL*BLANKS   W0CFL  10        *Cursor field
     C                     Z-ADD*ZEROS    W0CRW   50       *Cursor row
     C                     Z-ADD*ZEROS    W0CCL   50       *Cursor column
      * Move main file information to JOB context
     C                     MOVE @1FFL     ZZFFL  10        Main file name
     C                     MOVE @1FLB     ZZFLB  10        Main file lib
     C                     MOVE @1FMB     ZZFMB  10        Main file mbr
     C                     MOVE ZZFFL     @1FFL
     C                     MOVE ZZFLB     @1FLB
     C                     MOVE ZZFMB     @1FMB
     C                     CALL 'Y2QLVNR'
     C                     PARM           ZZFFL  10
     C                     PARM           ZZFLB  10
     C                     PARM           ZZFQL  21        LIBRARY/FILE
      * Dummy move for compiler
     C                     MOVE '0'       @CN#,1
     C                     MOVEL'N'       W0PMT   1
      *
     C                     MOVEL*BLANK    W0SJO 132        *Sbmjob overrid
      * Define local variables for subroutine SARVGN.
     C                     Z-ADD*ZERO     WL0001  30
     C                     Z-ADD*ZERO     WL0002  80
     C                     MOVEL*BLANK    WL0003  7
      * Define local variables for subroutine SDRVGN.
     C                     MOVEL*BLANK    WL0004 10
     C                     MOVEL*BLANK    WL0005  6
     C                     Z-ADD*ZERO     WL0006  30
      * Define local work field PT WIP Used/Not Used Sts
     C                     MOVEL*BLANK    YL0001  1
      * Define local work field PT Prod Date YYYYMMDD
     C                     Z-ADD*ZERO     YL0002  80
      * Define local work field PT Product Code
     C                     Z-ADD*ZERO     YL0003  70
      * Define local work field PT Serial Number
     C                     Z-ADD*ZERO     YL0004  80
      * Define local work field PT Gross Weight
     C                     Z-ADD*ZERO     YL0005  51
      * Define local work field *Return code
     C                     MOVEL*BLANK    YL0006  7
      * Define local work field Year Alpha (YYYY) USR
     C                     MOVEL*BLANK    YL0007  4
      * Define local work field Month/Year NBR        USR
     C                     Z-ADD*ZERO     YL0008  40
      * Define local work field Text USR 4
     C                     MOVEL*BLANK    YL0009  4
      * Define local work field AS Label Date YYYYMMDD
     C                     MOVEL*BLANK    YL0010  8
      * Obtain system date format
     C           *NAMVAR   DEFN Y2DTFMA   XDDTFM  3
     C                     IN   XDDTFM
      * *DTAARA = *COMPANY N
     C           *NAMVAR   DEFN YYCOTXA   ##CMP
     C                     IN   *NAMVAR
      *................................................................
      *
     C                     Z-ADD12        ##SFPG  30       SFLPAG
     C                     Z-ADD1         ##SFRC
      * Maximum record number
     C                     Z-ADD*ZERO     ##RRMX
      * Scan limit
     C                     Z-ADD500       W0SLM   50
      * Subfile pages
     C                     Z-ADD1         W0SPG   30
      * Processed Subfile record
     C                     Z-ADD0         W0RR0   40
      *................................................................
      * Set to *CHANGE mode
     C                     MOVEL'CHG'     W0PMD   3
     C                     MOVEL*BLANK    W0GRP   1
      * USER: Initialize program
      *
     C                     MOVEL*BLANK    WN0001 10        User Code Model
      *
      * RTV default Company    IF
      * Rtv Profile Model     RT - User Profile Control  * 
     C                     EXSR SCRVGN
      * CASE: PAR.User Code Model is equal to blank
     C           WN0001    IFEQ *BLANK                     *IF
      * RTV Appl. Default Co   RT - Application Profile  * 
      * Move input parameters to subroutine local variables.
     C                     MOVEL##USR     WL0004    P      User Profile Na
     C                     MOVEL'P/S'     WL0005    P      Application Cod
     C                     EXSR SDRVGN
      * Move subroutine local variables to output parameters.
     C                     Z-ADDWL0006    #2AIC3           Company Number
     C                     ELSE
      * CASE: *OTHERWISE
      * RTV Appl. Default Co   RT - Application Profile  * 
      * Move input parameters to subroutine local variables.
     C                     MOVELWN0001    WL0004    P      User Profile Na
     C                     MOVEL'P/S'     WL0005    P      Application Cod
     C                     EXSR SDRVGN
      * Move subroutine local variables to output parameters.
     C                     Z-ADDWL0006    #2AIC3           Company Number
     C                     END                             *FI
      * WRK.Label Date = JOB.*Job date + CON.-3 *DAYS
     C           ##JDT     ADD  1000000   XDINDT
     C                     EXSR XCVTA
     C                     Z-ADDXDAY1     XDAY2   60
     C                     Z-ADD-3        XDURR   80
     C                     MOVEL'1'       XDSEL   1
     C                     MOVEL'1111111' XDCDW   7
     C                     EXSR XDOWS
     C                     EXSR XDADY
     C                     EXSR XCVFA
     C           XDINDT    IFLT 010101
     C           XDINDT    ORGT 4000000
     C                     Z-ADD*ZERO     WUK7DT
     C                     ELSE
     C           XDINDT    SUB  1000000   WUK7DT
     C                     END
      * WRK.Year Code = WRK.Label Date *YEAR
     C           WUK7DT    ADD  1000000   XDINDT
     C           1800      ADD  XDINYY    WUAYNX
     C                     MOVELWUAYNX    YL0007           Year Alpha (YYY
      * LCL.Month/Year NBR        USR = WRK.Label Date
     C                     Z-ADDWUK7DT    YL0008           Month/Year NBR
     C                     MOVELYL0008    YL0009           Text USR 4
     C                     Z-ADD*ZERO     ZQ      50
     C           YL0007    CAT  YL0009:ZQ YL0010    P      AS Label Date Y
     C                     MOVE YL0010    YL0002           PT Prod Date YY
      * * Options *
      * Initialise subfile control
     C                     EXSR MEIZ#2
      *================================================================
     CSR         ZZEXIT    ENDSR
** @XD
312931303130313130313031
** @CN
00001 WIP Exceptions Report
