/********************************************************************/
/*                                                                  */
/*  SYNOPSIS - CL PROGRAM FOR PRINTING WEEKLY PACKAGING VAR RPT    */
/*                                                                  */
/*  SYSTEM    - INVENTORY MANAGEMENT                                */
/*  DATE      - 10/20/02                                            */
/*                                                                  */
/*      PARAMETERS RECEIVED:                                        */
/*         &COMPNYN       -  PASSED COMPANY NUMBER                  */
/*         &RCDSTS        -  PASSED RECORD STATUS                   */
/*         &APPLIC        -  APPLICATION CODE                       */
/*         &OUTQ          -  OUTPUT QUEUE                           */
/*         &HOLD          -  HOLD STATUS                            */
/*         &SAVE          -  SAVE STATUS                            */
/*         &COPYN         -  PASSED NUMBER OF COPIES                */
/*         &NIGHTQ        -  NIGHT JOB QUEUE                        */
/********************************************************************/
/* RMC   6/18/03  ADDED EMAIL ADDRESS PARM                         */
/* RMC   1/02/04  ADDED EMAIL VARIANCE DOWNLOAD FILE PARM &DWNLD    */
/* RMC   2/03/05  MADE EMAIL ADDR 50 LONG, FROM 2 FIELDS BECAUSE OF */
/*                CL LIMITS                                    */
/* RMC   3/10/08  BUILD WORKF FIRST WITH FG ITEMS RR/AP/A TOTALS THEN */
/*                READ THAT IN THE PRTF, TO SPEED UP PROCESSING       */
/* RMC   3/12/08  ADDED &AFTPRD PARM: WILL BE "N" HERE MEANING TO ACCUM */
/*                ALL TRANS FOUND FOR THE PRODUCTION DATE RANGE      */
/********************************************************************/
 PDEAUPR:    PGM        PARM(&RETURN &COMPNYN &RPTTYP &RPTSEQ &XFDATE +
           &XTDATE &CLASS &OUTQ &HOLD &SAVE &COPYN &DWNLD &EMAIL1 &EMAIL2)
        DCL    &RETURN     *CHAR   (7)           /* Return Code               */
        DCL    &COMPNYN     *CHAR (15)
        DCL    &XFDATE       *CHAR  (07)
        DCL    &XTDATE       *CHAR  (07)
        DCL    &RPTTYP      *CHAR  (1)
        DCL    &RPTSEQ      *CHAR  (1)
        DCL    &AFTPRD      *CHAR  (1)
        DCL    &CLASS       *CHAR  (03)
        DCL    &OUTQ        *CHAR  (10)
        DCL    &HOLD        *CHAR  (04)
        DCL    &SAVE        *CHAR  (04)
        DCL    &COPYN       *CHAR  (15)
        DCL    &NIGHTQ      *CHAR  (10)
        DCL    &DWNLD       *CHAR  (1)
        DCL    &EMAIL1      *CHAR  (25)
        DCL    &EMAIL2      *CHAR  (25)
        DCL    &AFTPRD      *CHAR  (1)    /* ACCUM TRANS AFT PROD DATE ONLY */
        DCL    &EMAIL       *CHAR  (50)
        DCL    &COMMAND     *CHAR  (512)
        DCL     &DATA     *CHAR   10              /* DATA FILES      */
        DCL     &DATAH    *CHAR   10              /* HIST FILES      */

        DCL    &COMPANY     *DEC   (3 0)
        DCL    &COPY        *DEC   (2 0)
        DCL    &FDATE       *DEC   (7 0)
        DCL    &TDATE       *DEC   (7 0)
        DCL    &SEL       *CHAR    (1500)         /*  FOR PASSING    */

/* CONVERT PARAMETERS TO REQUIRED SIZE FOR PRINT FUNCTION                  */

             CHGVAR     VAR(&COMPANY)  VALUE(&COMPNYN)
             CHGVAR     VAR(&COPY)     VALUE(&COPYN)
             CHGVAR     VAR(&FDATE)    VALUE(&XFDATE)
             CHGVAR     VAR(&TDATE)    VALUE(&XTDATE)

             ADDLIBLE   LIB(ESEND)
             MONMSG CPF0000

/* -----------------------------------------------------------------------*/
/*   BUILD WORKFILE WITH FG TRANSACTION TOTALS FOR : RR/AP/A     */
/* -----------------------------------------------------------------------*/
             CALL      PGM(CAQXXFR) PARM(' ' &DATA &DATAH)
             CRTDUPOBJ  OBJ(PMALCPP) FROMLIB(&DATA) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)
             CRTDUPOBJ  OBJ(PMALCPL0) FROMLIB(&DATA) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)
             CRTDUPOBJ  OBJ(PMALCPL1) FROMLIB(&DATA) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)
             CRTDUPOBJ  OBJ(PMALCPL2) FROMLIB(&DATA) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)

             CHGVAR     VAR(&AFTPRD) VALUE('N') /*  accum ALL    +
                          TRANSactions that EXIST FOR PROD  +
                          DATE RANGE */

             CALL PMSTXFR ('' &COMPANY &FDATE &TDATE &AFTPRD)

/* -----------------------------------------------------------------------*/
/*************  REPORT BY GROUP CATEGORY  ********************/

SEQ1:        IF         COND(&RPTSEQ *EQ '1') THEN(DO)
             SBDPRTOVR  CMDVAR(&COMMAND) FILE(POSOPFR$) +
                          OUTQ(&OUTQ) COPIES(&COPY) HOLD(&HOLD) +
                          SAVE(&SAVE)
             CALL       PGM(QCMDEXC) PARM(&COMMAND 512)

             CALL       PGM(POSOPFR) PARM(' ' &COMPANY &CLASS +
                          &RPTTYP &FDATE &TDATE)
             IF         COND(&EMAIL1 *NE ' ') THEN(DO)
             CHGVAR &EMAIL VALUE(&EMAIL1 *CAT &EMAIL2)
             ESNDMAIL   RECIPIENT(&EMAIL) +
                          SUBJECT(VARIANCE) ATTLIST((* *PDF *N +
                          POSOPFR$))
             ENDDO
             ENDDO
/*************  REPORT BY PACKAGING TYPE  ********************/

 SEQ2:       IF         COND(&RPTSEQ *EQ '2') THEN(DO)

             CALL      PGM(CAQXXFR) PARM(' ' &DATA &DATAH)
             CRTDUPOBJ  OBJ(PPAECPP) FROMLIB(&DATA) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)
             CRTDUPOBJ  OBJ(PPAECPL0) FROMLIB(&DATA) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)
             CRTDUPOBJ  OBJ(PPAECPL1) FROMLIB(&DATA) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)

             SBDPRTOVR  CMDVAR(&COMMAND) FILE(POS1PFR$) +
                          OUTQ(&OUTQ) COPIES(&COPY) HOLD(&HOLD) +
                          SAVE(&SAVE)
             CALL       PGM(QCMDEXC) PARM(&COMMAND 512)

             CALL       PGM(POS1PFR) PARM(' ' &COMPANY &CLASS +
                          &RPTTYP &FDATE &TDATE &DWNLD)
             IF         COND(&EMAIL1 *NE ' ') THEN(DO)
       /*    IF         COND(&DWNLD *NE 'Y') THEN(DO)    */
             CHGVAR &EMAIL VALUE(&EMAIL1 *CAT &EMAIL2)
             ESNDMAIL   RECIPIENT(&EMAIL) SUBJECT('Variance Report') +
                          ATTLIST((* *PDF *N POS1PFR$))
         /*  ENDDO     */
             IF         COND(&DWNLD *EQ 'Y') THEN(DO)
             CHGVAR     VAR(&SEL) VALUE('SELECT   AEAIC3 +
                          COLHDG("Co"), WEEK(CVTDATE(AEELDT,cymd)) +
                          COLHDG("Week") NAME(WEEK) LEN(2,0), +
 CVTDATE(AEELDT,CYMD) COLHDG("From Prod" "Date") NAME(FDATE), +
 CVTDATE(AEPWDT,CYMD) COLHDG("To Prod" "Date") NAME(TDATE), +
                          AEBRAA COLHDG("MP2 Item"), AEXITX  +
                          COLHDG("Desc"),   AEU0NX COLHDG("Usage +
                          Var"), AEEIVL COLHDG("Dollar Var") FROM +
                          PPAECPP GROUP BY AEAIC3, WEEK, FDATE, TDATE, AEBRAA, +
                          AEXITX, AEU0NX, AEEIVL  ORDER BY AEAIC3, +
                          WEEK, AEBRAA')
             EXECUTE    SQL(&SEL) MBROPT(*REPLACE) NBRRCDS(*ALL) +
                          PCFMT(*XLS) RECIPIENT(&EMAIL) +
                          EMLMSG('Variance Download')

             ENDDO
             ENDDO
             ENDDO
ENDPGM:     ENDPGM
