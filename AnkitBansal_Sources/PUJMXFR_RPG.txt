     H/TITLE Cnv Upd fm DPSUBCLASS XF  Execute external functio
     H DATFMT(*YMD) DATEDIT(*YMD) DEBUG(*YES)
     Z* CRTBNDRPG
     Z* DFTACTGRP(*NO) BNDDIR(YBNDDIR) DBGVIEW(*SOURCE)
     Z* CVTOPT(*DATETIME) ACTGRP(*CALLER) OPTIMIZE(*BASIC)
      *
     H* SYNOPSIS :
     H*  Perform user function
     H*  As defined by action diagram
      *
     H* Generated by CA 2E release 8.6 (1547)
     H* Function type : Execute external function
     H* Object type   : *PGM
      *
     H* Company       : OMS Development Model
     H* System        : OMS Development Model
     H* User name     : ISDNGUY
     H* Date          : 09/18/18  Time  : 13:28:07
     H* Copyright     : OMS Development Model
      *
      *================================================================
     M* Maintenance   :
      *================================================================
     Fdpsubclassif   e           k disk                                         DPSUBCLASS Upload
     FPBBNREL1  IF   E           K DISK
      * RTV : DP Product                Retrieval index
      *
     FPBBUREL1  IF   E           K DISK
      * RTV : DP Product Attributes     Retrieval index
      *
     FPBBNREL0  UF   E           K DISK
      * UPD : DP Product                Update index
      *
     FPBBUREL0  IF A E           K DISK
      * UPD : DP Product Attributes     Update index
      *
      /EJECT
      * Data structures:
     D PGMDS         ESDS                  EXTNAME(Y2PGDSP)
      * Modified Program data structure
     D JBDTTM          DS
      * Job date/time
     D  ##JDT                  1      7  0
     D  ##JCC                  1      1  0
     D  ##JYY                  2      3  0
     D  ##JMM                  4      5  0
     D  ##JDD                  6      7  0
     D  ##JTM                  8     13  0
     D  ##JHH                  8      9  0
     D  ##JNN                 10     11  0
     D  ##JSS                 12     13  0
     D QPBBN1        E DS                  EXTNAME(PBBNREL0)
      * UPD : DP Product                Update index
      * Renamed input format fields
     D  WBTAAA       E                     EXTFLD(BNTAAA)
     D  WBTBAA       E                     EXTFLD(BNTBAA)
     D  WBFWC7       E                     EXTFLD(BNFWC7)
     D  WBUYNA       E                     EXTFLD(BNUYNA)
     D  WBZVNY       E                     EXTFLD(BNZVNY)
     D  WBZWNY       E                     EXTFLD(BNZWNY)
     D  WBCFU1       E                     EXTFLD(BNCFU1)
     D  WBTCAA       E                     EXTFLD(BNTCAA)
     D  WBCGU1       E                     EXTFLD(BNCGU1)
     D  WBCHU1       E                     EXTFLD(BNCHU1)
     D  WBCIU1       E                     EXTFLD(BNCIU1)
     D  WBCJU1       E                     EXTFLD(BNCJU1)
     D  WBXTAA       E                     EXTFLD(BNXTAA)
     D  WBAFNB       E                     EXTFLD(BNAFNB)
     D  WBAGNB       E                     EXTFLD(BNAGNB)
     D  WBADSC       E                     EXTFLD(BNADSC)
     D  WBS9AA       E                     EXTFLD(BNS9AA)
     D  WBANDX       E                     EXTFLD(BNANDX)
      *
     D YARDCS          DS           455
      * Message data for message Y2U0009.
     D MD0009          DS
     D  MDPGM                  1     10
     D  MDACP                 11     20
     D  MDFMT                 21     30
     D  MDACT                 31     34
     D  MDLBL                 35     40
     D QPBBU1        E DS                  EXTNAME(PBBUREL0)
      * UPD : DP Product Attributes     Update index
      * Renamed input format fields
     D  WDAZSC       E                     EXTFLD(BUAZSC)
     D  WDTJAA       E                     EXTFLD(BUTJAA)
     D  WDA0SC       E                     EXTFLD(BUA0SC)
     D  WDVSST       E                     EXTFLD(BUVSST)
     D  WDMJDT       E                     EXTFLD(BUMJDT)
     D  WDBETM       E                     EXTFLD(BUBETM)
     D  WDCCVN       E                     EXTFLD(BUCCVN)
     D  WDCDVN       E                     EXTFLD(BUCDVN)
     D  WDMKDT       E                     EXTFLD(BUMKDT)
     D  WDBFTM       E                     EXTFLD(BUBFTM)
     D  WDCEVN       E                     EXTFLD(BUCEVN)
     D  WDCFVN       E                     EXTFLD(BUCFVN)
      *
      *
      * Declared stand-alone variables
     D  P0RTN          S              7
     D  W0ICL          S              1
     D  W0RTN          S              7
     D  W0RSL          S              1
     D  W0RSF          S              1
     D  W0RTW          S              9  0
     D  W0ENV          S              3
     D  ##TME          S              6  0
     D  YARDC          S              1
     D  WQ0001         S             14  0
     D  W0CLPG         S             10
     D  YL0001         S             10
     D  YL0002         S              1
     D  ZADFMF         S             10
     D  ZAPGMQ         S             10
     D  ZAPGRL         S              5
     D  ZAMSID         S              7
     D  ZAMSGF         S             10
     D  ZAMSTP         S              7
     D  YILE           S              1
     D  W0PMT          S              1
      /EJECT
      * Parameter declarations
     D P1PARM          DS
      * FLD: DP Product
      * N :  DP Product
     D  P1FWC7                 1      4P 0
      * N :  DP Sub Class
     D  P1XTAA                 5     54
     D                 DS
     D  ZAMSDA                 1    132
     I@BNRESY
      * DP Product                Retrieval index
      * Renamed input format fields
     I              BNTAAA                      WATAAA
     I              BNTBAA                      WATBAA
     I              BNFWC7                      WAFWC7
     I              BNUYNA                      WAUYNA
     I              BNZVNY                      WAZVNY
     I              BNZWNY                      WAZWNY
     I              BNCFU1                      WACFU1
     I              BNTCAA                      WATCAA
     I              BNCGU1                      WACGU1
     I              BNCHU1                      WACHU1
     I              BNCIU1                      WACIU1
     I              BNCJU1                      WACJU1
     I              BNXTAA                      WAXTAA
     I              BNAFNB                      WAAFNB
     I              BNAGNB                      WAAGNB
     I              BNADSC                      WAADSC
     I              BNS9AA                      WAS9AA
     I              BNANDX                      WAANDX
      *
     I@BNRESX
      * DP Product                Update index
      * Renamed input format fields
     I              BNTAAA                      WBTAAA
     I              BNTBAA                      WBTBAA
     I              BNFWC7                      WBFWC7
     I              BNUYNA                      WBUYNA
     I              BNZVNY                      WBZVNY
     I              BNZWNY                      WBZWNY
     I              BNCFU1                      WBCFU1
     I              BNTCAA                      WBTCAA
     I              BNCGU1                      WBCGU1
     I              BNCHU1                      WBCHU1
     I              BNCIU1                      WBCIU1
     I              BNCJU1                      WBCJU1
     I              BNXTAA                      WBXTAA
     I              BNAFNB                      WBAFNB
     I              BNAGNB                      WBAGNB
     I              BNADSC                      WBADSC
     I              BNS9AA                      WBS9AA
     I              BNANDX                      WBANDX
      *
     I@BURETS
      * DP Product Attributes     Retrieval index
      * Renamed input format fields
     I              BUAZSC                      WCAZSC
     I              BUTJAA                      WCTJAA
     I              BUA0SC                      WCA0SC
     I              BUVSST                      WCVSST
     I              BUMJDT                      WCMJDT
     I              BUBETM                      WCBETM
     I              BUCCVN                      WCCCVN
     I              BUCDVN                      WCCDVN
     I              BUMKDT                      WCMKDT
     I              BUBFTM                      WCBFTM
     I              BUCEVN                      WCCEVN
     I              BUCFVN                      WCCFVN
      *
     I@BURETR
      * DP Product Attributes     Update index
      * Renamed input format fields
     I              BUAZSC                      WDAZSC
     I              BUTJAA                      WDTJAA
     I              BUA0SC                      WDA0SC
     I              BUVSST                      WDVSST
     I              BUMJDT                      WDMJDT
     I              BUBETM                      WDBETM
     I              BUCCVN                      WDCCVN
     I              BUCDVN                      WDCDVN
     I              BUMKDT                      WDMKDT
     I              BUBFTM                      WDBFTM
     I              BUCEVN                      WDCEVN
     I              BUCFVN                      WDCFVN
      *
      /EJECT
      *****************************************************************
      * Entry parameters
     C     *ENTRY        PLIST
     C                   PARM                    P0RTN
      *****************************************************************
      * Initialize
     C                   EXSR      ZZINIT
      *
      * Cnv Upd fm DPSUBCLASS XF
      * Cnv Read DPSUBCLASS   US - DP Product  * 
      *
      *
     C                   read      dpsubclass
     C                   dow       not %eof(dpsubclass)
      *
     C                   eval      P1FWC7 = CLSITM                              Item Code
     C                   eval      P1XTAA = CLSATN                              Sub Class Attr Name
      *
      * Update DP Product & DP Product Attributes Files.
      * Cnv Upd fm DPSUBCLASS RT - DP Product  * 
     C                   EXSR      SARVGN
      * Cnv EndDo DPSUBCLASS  US - DP Product  * 
      *
     C                   read      dpsubclass
     C                   enddo                                                  dow not %eof
      *
      *----------------------------------------------------------------
      * Exit program
     C     AAEXIT        TAG
     C                   EVAL      P0RTN = ' '
     C                   EXSR      ZYEXPG
      *================================================================
      /EJECT
     CSR   SARVGN        BEGSR
      *================================================================
      * Cnv Upd fm DPSUBCLASS RT - DP Product  * 
      *================================================================
     C                   EVAL      W0RTN = ' '
      * Define keylist
     C     KRSSA         KLIST
     C                   KFLD                    WATAAA                         DP Profile
     C                   KFLD                    WATBAA                         DP Scenario
     C                   KFLD                    WAFWC7                         DP Product
      * Setup key
     C                   EVALR     WATAAA = ' '                                 DP Profile
     C                   MOVEL     'Demand'      WATAAA                         DP Profile
     C                   EVALR     WATBAA = ' '                                 DP Scenario
     C                   MOVEL     'Base'        WATBAA                         DP Scenario
     C                   Z-ADD     P1FWC7        WAFWC7                         DP Product
      * Establish starting position
     C     KRSSA         CHAIN     @BNRESY                            90        *
      * Data record not found
     C   90              MOVEL     'USR4728'     W0RTN
      * USER: Process Data record
      * Chg Dp Product        CH - DP Product  * 
     C                   IF        NOT *IN90
     C                   EXSR      SBCHRC
      * Cnv Upd fm DPSUBCLASS RT - DP Product Attributes  * 
     C                   EXSR      SCRVGN
     C                   ENDIF
      *================================================================
     CSR   SAEXIT        ENDSR
      /EJECT
     CSR   SBCHRC        BEGSR
      *================================================================
      * Chg Dp Product        CH - DP Product  * 
      *================================================================
     C                   EVAL      W0RTN = ' '
      * Set PGM.*Record Data Changed flag
     C                   EVALR     YARDC = ' '
      *
      * Move key fields to @BNRESX
     C                   MOVEL(P)  WATAAA        WBTAAA                         DP Profile
     C                   MOVEL(P)  WATBAA        WBTBAA                         DP Scenario
     C                   Z-ADD     WAFWC7        WBFWC7                         DP Product
      *
     C     KLCHSB        KLIST
     C                   KFLD                    WBTAAA                         DP Profile
     C                   KFLD                    WBTBAA                         DP Scenario
     C                   KFLD                    WBFWC7                         DP Product
     C     KLCHSB        CHAIN     @BNRESX                            9091      *
      *
      * Record not found
     C                   IF        *IN90
     C                   MOVEL     'Y2U0009'     W0RTN
     C                   MOVEL     ##PGM         MDPGM
     C                   MOVEL     'PBBNREL0'    MDACP
     C                   MOVEL     '@BNRESX'     MDFMT
     C                   MOVEL     '*CHG'        MDACT
      * Record not found label: LBL001.
     C                   MOVEL     'LBL001'      MDLBL
      * Send message '*Record no longer on file'
     C                   MOVEL     'Y2U0009'     ZAMSID
     C                   MOVEL     'Y2USRMSG'    ZAMSGF
     C                   MOVEL     MD0009        ZAMSDA                         Message data
     C                   EXSR      ZASNMS
     C                   EVAL      MD0009 = ' '
     C                   GOTO      SBEXIT
     C                   ENDIF
      *
      * Record locked
     C                   IF        *IN91
     C                   MOVEL     'Y2U0004'     W0RTN
      * Send message '*Database operation error'
     C                   MOVEL     'Y2U0004'     ZAMSID
     C                   MOVEL     'Y2USRMSG'    ZAMSGF
     C                   EXSR      ZASNMS
     C                   GOTO      SBEXIT
     C                   ENDIF
      *
      * Store record data for null update check
     C                   MOVE      QPBBN1        YARDCS
      * Move non-key fields to @BNRESX
     C                   MOVEL(P)  WAUYNA        WBUYNA                         DP Product Desc
     C                   Z-ADD     WAZVNY        WBZVNY                         DP Sell Price
     C                   Z-ADD     WAZWNY        WBZWNY                         DP Standard Cos
     C                   MOVEL(P)  WACFU1        WBCFU1                         DP Product Type
     C                   MOVEL(P)  WATCAA        WBTCAA                         DP Base Unit of
     C                   MOVEL(P)  WACGU1        WBCGU1                         DP Product Grou
     C                   MOVEL(P)  WACHU1        WBCHU1                         DP Product Clas
     C                   MOVEL(P)  WACIU1        WBCIU1                         DP Product Form
     C                   MOVEL(P)  WACJU1        WBCJU1                         DP Product Bran
     C                   MOVEL(P)  P1XTAA        WBXTAA                         DP Sub Class
     C                   Z-ADD     WAAFNB        WBAFNB                         DP Total Pieces
     C                   Z-ADD     WAAGNB        WBAGNB                         DP Unit Weight
     C                   MOVEL(P)  WAADSC        WBADSC                         DP Record Statu
     C                   MOVEL(P)  WAS9AA        WBS9AA                         DP System of Re
     C                   Z-ADD     WAANDX        WBANDX                         DP Date Time St
      *
      * Set PGM.*Record Data Changed flag
     C                   IF        QPBBN1 <> YARDCS AND
     C                             YARDC <> 'N'
     C                   MOVE      'Y'           YARDC
     C                   ENDIF
      * USER: Processing before Data update
      * RTV Sys Dt yyyymmddtm UP - /UT User Programs  * 
     C                   CALL      'PBN2UPC'                            90      RTV Sys Dt yyyy
     C     WBANDX        PARM      *ZERO         WQ0001                         DP Date Time St
      *
      * Call to program ended in error
     C                   IF        *IN90
     C                   MOVEL     'Y2U0032'     W0RTN
     C                   EVAL      W0CLPG = ' '
     C                   MOVEL     'PBN2UPC'     W0CLPG
      * Send message '*Error occured on CALL...'
     C                   MOVEL     'Y2U0032'     ZAMSID
     C                   MOVEL     'Y2USRMSG'    ZAMSGF
     C                   MOVEL     W0CLPG        ZAMSDA                         Message data
     C                   EXSR      ZASNMS
     C                   SETON                                        99        *
     C                   END
      * Set PGM.*Record Data Changed flag
     C                   IF        QPBBN1 <> YARDCS AND
     C                             YARDC <> 'N'
     C                   MOVE      'Y'           YARDC
     C                   ENDIF
      * If changed update record otherwise release record
     C                   IF        YARDC = 'Y'
     C                   UPDATE    @BNRESX                              91      *
     C                   ELSE
      * Release record lock
     C                   UNLOCK    PBBNREL0                             91      *
     C                   ENDIF
      * Change error detected
     C                   IF        *IN91
     C                   MOVEL     'Y2U0004'     W0RTN
     C                   ELSE
      *
      * DBF change successful
     C                   ENDIF
      *================================================================
     CSR   SBEXIT        ENDSR
      /EJECT
     CSR   SCRVGN        BEGSR
      *================================================================
      * Cnv Upd fm DPSUBCLASS RT - DP Product Attributes  * 
      *================================================================
     C                   EVAL      W0RTN = ' '
      * Define keylist
     C     KRSSC         KLIST
     C                   KFLD                    WCAZSC                         DP Attribute Ty
     C                   KFLD                    WCTJAA                         DP Attribute Na
      * Setup key
     C                   MOVEL     'S'           WCAZSC                         DP Attribute Ty
     C                   MOVEL     P1XTAA        WCTJAA                         DP Attribute Na
      * Establish starting position
     C     KRSSC         CHAIN     @BURETS                            90        *
      * Data record not found
     C                   IF        *IN90
     C                   MOVEL     'USR4753'     W0RTN
      * USER: Processing if Data record not found
      * Crt DP Product Attr   CR - DP Product Attributes  * 
     C                   EXSR      SDCRRC
     C                   GOTO      SCEXIT
     C                   ENDIF
      *
      *================================================================
     CSR   SCEXIT        ENDSR
      /EJECT
     CSR   SDCRRC        BEGSR
      *================================================================
      * Crt DP Product Attr   CR - DP Product Attributes  * 
      *================================================================
     C                   EVAL      W0RTN = ' '
      * Move all fields to @BURETR
     C                   MOVEL     'S'           WDAZSC                         DP Attribute Ty
     C                   MOVEL     P1XTAA        WDTJAA                         DP Attribute Na
     C                   MOVEL     YL0001        WDA0SC                         DP Unused
     C                   MOVEL     YL0002        WDVSST                         Record Status
     C                   Z-ADD     ##JDT         WDMJDT                         Create Date
     C                   Z-ADD     ##JTM         WDBETM                         Create Time
     C                   MOVEL     ##USR         WDCCVN                         Create User
     C                   MOVEL     ##PGM         WDCDVN                         Create Program
     C                   Z-ADD     0             WDMKDT                         Change Date
     C                   Z-ADD     0             WDBFTM                         Change Time
     C                   EVAL      WDCEVN = ' '                                 Change User
     C                   EVAL      WDCFVN = ' '                                 Change Program
      *
      * USER: Processing before Data update
      * Set Crt Date/Time      IF
      * *** Set RECORD STATUS field. ***
     C                   MOVEL     'A'           WDVSST                         Record Status
      * *** Set CREATE fields. ***
     C                   Z-ADD     ##JDT         WDMJDT                         Create Date
     C                   Z-ADD     ##JTM         WDBETM                         Create Time
     C                   MOVEL     ##USR         WDCCVN                         Create User
     C                   MOVEL     ##PGM         WDCDVN                         Create Program
      * *** Set CHANGE fields. ***
     C                   Z-ADD     0             WDMKDT                         Change Date
     C                   Z-ADD     0             WDBFTM                         Change Time
     C                   EVAL      WDCEVN = ' '                                 Change User
     C                   EVAL      WDCFVN = ' '                                 Change Program
     C     KLCRSD        KLIST
     C                   KFLD                    WDAZSC                         DP Attribute Ty
     C                   KFLD                    WDTJAA                         DP Attribute Na
      * Check for duplicate primary key
     C     KLCRSD        SETLL     @BURETR                                90    *
     C                   IF        *IN90
     C                   MOVEL     'USR4754'     W0RTN
      * Send message 'DP Product Attributes  EX'
     C                   MOVEL     'USR4754'     ZAMSID
     C                   EXSR      ZASNMS
     C                   GOTO      SDEXIT
     C                   ENDIF
      *
     C                   WRITE     @BURETR                              91      *
      *
      * Write error detected
     C                   IF        *IN91
     C                   MOVEL     'Y2U0004'     W0RTN
     C                   ELSE
     C                   ENDIF
      *================================================================
     CSR   SDEXIT        ENDSR
      /EJECT
     CSR   ZASNMS        BEGSR
      *================================================================
      * Send message to program's message queue
      *================================================================
     C                   IF        ZAPGMQ = ' '
     C                   MOVEL     ##PGM         ZAPGMQ
     C                   END
      * If no message file specified, use default
     C                   IF        ZAMSGF = ' '
     C                   MOVEL     ZADFMF        ZAMSGF
     C                   END
     C                   CALL      'Y2SNMGC'
     C                   PARM                    ZAPGMQ                         Program queue
     C                   PARM                    ZAPGRL                         Rel queue
     C                   PARM                    ZAMSID                         Message ID
     C                   PARM                    ZAMSGF                         Message file
     C                   PARM                    ZAMSDA                         Message data
     C                   PARM                    ZAMSTP                         Message type
     C                   PARM      'Y'           YILE
      * Clear all fields for default mechanism next time
     C                   EVAL      ZAPGMQ = ' '
     C                   EVAL      ZAPGRL = ' '
     C                   EVAL      ZAMSID = ' '
     C                   EVAL      ZAMSGF = ' '
     C                   EVAL      ZAMSDA = ' '
     C                   EVAL      ZAMSTP = ' '
      *================================================================
     CSR   ZAEXIT        ENDSR
      /EJECT
     CSR   ZXEXPG        BEGSR
      *================================================================
      * Exit program: Normal
      *================================================================
     C                   EXSR      ZYEXPG
      *================================================================
     CSR   ZXEXIT        ENDSR
      /EJECT
     CSR   ZYEXPG        BEGSR
      *================================================================
      * Exit program: Direct
      *================================================================
      * Terminate program
     C                   SETON                                        LR
      *
      * Exit program
     C                   RETURN
      *
      *================================================================
     CSR   ZYEXIT        ENDSR
      /EJECT
     CSR   ZZINIT        BEGSR
      *================================================================
      * Initialisation
      *================================================================
     C                   IF        W0ICL = ' '
     C                   MOVEL     'Y'           W0ICL                          *Initial call
     C                   ELSE
     C                   MOVEL     'N'           W0ICL
     C                   END
     C                   EVALR     P0RTN = ' '
     C                   EVALR     W0RTN = ' '
     C                   EVAL      W0RSL = ' '
     C                   EVAL      W0RSF = ' '
     C                   MOVEL     *ZEROS        W0RTW
     C                   MOVEL     '400'         W0ENV
      * Clear all neither parameters
     C                   Z-ADD     *ZERO         P1FWC7                         DP Product
     C                   EVAL      P1XTAA = ' '                                 DP Sub Class
      *
      * Retrieve job attributes
     C                   CALL      'Y2RTJCR'
     C                   PARM                    PGMDS
      * Setup job date/time
     C                   Z-ADD     ##SD7         ##JDT
     C                   TIME                    ##JTM
      * Update screen time
     C                   TIME                    ##TME
      * Initialize renamed input format fields
     C                   Z-ADD     *ZERO         WAFWC7                         DP Product
     C                   Z-ADD     *ZERO         WAZVNY                         DP Sell Price
     C                   Z-ADD     *ZERO         WAZWNY                         DP Standard Cos
     C                   Z-ADD     *ZERO         WAAFNB                         DP Total Pieces
     C                   Z-ADD     *ZERO         WAAGNB                         DP Unit Weight
     C                   Z-ADD     *ZERO         WAANDX                         DP Date Time St
      * Initialize renamed input format fields
     C                   Z-ADD     *ZERO         WCMJDT                         Create Date
     C                   Z-ADD     *ZERO         WCBETM                         Create Time
     C                   Z-ADD     *ZERO         WCMKDT                         Change Date
     C                   Z-ADD     *ZERO         WCBFTM                         Change Time
      * Obtain default message file
     C     *DTAARA       DEFINE    CAMGFLA       ZADFMF
     C                   IN        ZADFMF
     C                   MOVEL     'N'           W0PMT
      * Define local work field DP Unused
     C                   EVAL      YL0001 = ' '
      * Define local work field Record Status
     C                   EVAL      YL0002 = ' '
      *================================================================
     CSR   ZZEXIT        ENDSR
