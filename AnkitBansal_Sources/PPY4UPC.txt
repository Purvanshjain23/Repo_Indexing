/********************************************************************/
/*                                                                  */
/*  PROGRAM  - PPY4UPC                                              */
/*  SYNOPSIS - PRINT PROGRAM WITH SELECTIONS FOR LATE DELIVERY RPT. */
/*             COMPANY, DATES, LOAD, CARRIER, LATE REASON,          */
/*             EXCLUDE EXPORT                                       */
/*                                                                  */
/*             THIS PROGRAM IS CALLED FROM PDUCUPC WHICH SUBMITS    */
/*             USING A VARIABLE &PGM. SOME OF THE PARMS ARE USED    */
/*             HERE AND SOME IN ONE OF THE OTHER TWO PROGRAMS.      */
/*                                                                  */
/*  SYSTEM    - TRAFFIC SYSTEM                                      */
/*  PROGRAM   - PRINT LATE DELIVERY REPORT BY REQUESTED DELIVERY    */
/*              DATE                                                */
/*  DATE      - 06/30/2006                                          */
/*                                                                  */
/*  PARAMETERS RECEIVED:                                            */
/*                                                                  */
/*    &COMPNYN    - COMPANY NUMBER - BLANK FOR ALL                  */
/*    &FRMDATN    - FROM REQUESTED DELIVERY DATE                    */
/*    &THRDATN    - THROUGH REQUESTED DELIVERY DATE                 */
/*    &QTR        - QUARTER                                         */
/*    &YEARN      - YEAR                                            */
/*    &LOADN      - LOAD NUMBER                                     */
/*    &CARRIER    - CARRIER CODE                                    */
/*    &CUST       - CARRIER CODE                                    */
/*    &LOADT      - LOAD TYPE                                       */
/*    &OUTQ       - OUTPUT QUEUE                                    */
/*    &HOLD       - HOLD PRINT                                      */
/*    &SAVE       - SAVE PRINT                                      */
/*    &COPYN      - NUMBER OF COPIES                                */
/*    &NIGHTQ     - NIGHT OUTPUT QUEUE                              */
/*    &SELRPT     - REPORT SELECTION TYPE                           */
/*    &UOM        - UNIT OF MEASURE                                 */
/*    &OTRGROUP   - ON TIME REASON CODE GROUP CODE                  */
/*    &EXPORTYN   - INCLUDE EXPORTS ON THE REPORT - YES OR NO       */
/*    &OTREAS     - ON TIME REASON CODE                             */
/*    &OTRDEPT    - ON TIME REASON DEPARTMENT CODE                  */
/*    &EMAIL      - EMAIL ADDRESS                                   */
/********************************************************************/
/*  LJB 8/25/2006 ADDED ON TIME REASON AND ON TIME DEPARTMENT       */
/*                CODES TO PARMS AND PASS TO CALLED PROGRAMS        */
/*  LJB 04/16/2015 ADDED OPTIONAL EMAIL ADDRESS                     */
/*  RMC 02/13/2020 PASS IN XLS FLAG, AND EMAIL XLS IF NOT EMAIL NOT '' */
/*                 AND THIS XLS FLAG IS YES, ELSE EMAIL THE RPT PDF  */
/* PIO 07/17/23  REPLACE OPNQRYF WITH OPNSQLF FOR OMFJCPP FILE       */
/*               ADDED NEEDED OVRDBF AROUND THE COMMAND.             */
/*               CHANGE *AND TO AND, *EQ TO =, *GE TO >=, *LE TO <=,*/
/*               *GT TO > IN &D                                      */
/********************************************************************/
 PPY4UPC:    PGM        PARM(&COMPNYN &FRMDATN &THRDATN &LOADN &QTR +
                          &YEARN &SALESP &CUST &CARRIER &LOADT +
                          &OUTQ &HOLD &SAVE &COPYN &NIGHTQ &SELRPT +
                          &UOM &OTRGROUP &EXPORTYN &OTREAS &OTRDEPT +
                   &EMXLS &EMAIL1 &EMAIL2)

/* PARMS                                                            */
        DCL    &COMPNYN    *DEC           /* COMPANY NUMBER (PASSED)*/
        DCL    &FRMDATN    *DEC           /* FROM SHIP DATE (PASSED)*/
        DCL    &THRDATN    *DEC           /* THRU SHIP DATE (PASSED)*/
        DCL    &LOADN      *DEC           /* LOAD NUMBER    (PASSED)*/
        DCL    &QTR        *CHAR   (1)    /* QUARTER                */
        DCL    &YEARN      *DEC           /* YEAR           (PASSED)*/
        DCL    &CUST       *DEC           /* CUST           (PASSED)*/
        DCL    &SALESP     *CHAR   (3)    /* SALESPERSON            */
        DCL    &CARRIER    *CHAR   (3)    /* CARRIER CODE           */
        DCL    &LOADT      *CHAR   (1)    /* LOAD TYPE              */
        DCL    &COPYN      *DEC           /* NO. OF COPIES          */
        DCL    &OUTQ       *CHAR   (10)   /* OUTPUT QUEUE           */
        DCL    &HOLD       *CHAR   (4)    /* HOLD STATUS            */
        DCL    &SAVE       *CHAR   (4)    /* SAVE STATUS            */
        DCL    &NIGHTQ     *CHAR   (10)   /* NIGHT JOB QUEUE        */
        DCL    &SELRPT     *CHAR   (1)    /* REPORT SELECTION       */
        DCL    &OTRGROUP   *CHAR   (1)    /* ON TIME REASON GROUP   */
        DCL    &PRTFO      *CHAR   (8)    /* PRINTER FILE NAME      */
        DCL    &UOM        *CHAR   (2)    /* UNIT OF MEASURE        */
        DCL    &EXPORTYN   *CHAR   (2)    /* EXCLUDE EXPORTS Y/N    */
        DCL    &OTREAS     *CHAR   (3)    /* ON TIME REASON CODE    */
        DCL    &OTRDEPT    *CHAR   (2)    /* ON TIME REASON DEPT    */
        DCL    &EMXLS      *CHAR   (1)  /* EMAIL XLS VERSION 2-13-20  */
        DCL    &EMAIL      *CHAR   (50)   /* EMAIL ADDRESS          */
        DCL    &EMAIL1     *CHAR   (25)   /* EMAIL ADDRESS          */
        DCL    &EMAIL2     *CHAR   (25)   /* EMAIL ADDRESS          */

/* INTERNAL FIELDS                                                  */
        DCL    &COPY       *DEC    (2 0)  /* NUMBER OF COPIES       */
        DCL    &COMPANY    *DEC    (3 0)  /* COMPANY NUMBER         */
        DCL    &FRMDAT     *DEC    (7 0)  /* FROM DATE              */
        DCL    &THRDAT     *DEC    (7 0)  /* THRU DATE              */
        DCL    &LOAD       *DEC    (7 0)  /* LOAD NUMBER            */
        DCL    &USER       *CHAR   (10)  /* USER PROFILE            */
        DCL    &GRPPRF     *CHAR   (10)  /* GROUP PROFILE           */

/* OPENQRYF FIELDS                                                  */
        DCL    &COMPA      *CHAR    3     /* ACK COMPLETE           */
        DCL    &FRMDATA    *CHAR    7     /* FROM DATE (PASSED)     */
        DCL    &THRDATA    *CHAR    7     /* THRU DATE (PASSED)     */

        DCL     &A        *CHAR   40              /* QRY FROM DATE  */
        DCL     &B        *CHAR   50              /* QRY TO DATE    */
        DCL     &C        *CHAR   50              /* QRY COMPANY    */
        DCL     &D        *CHAR  120              /* QRY ALL        */

/*------------------------------------------------------------------*/
/* CHANGE VARIABLES FOR USE IN PROGRAM                              */
/*------------------------------------------------------------------*/
             MONMSG     MSGID(CPF0000)
             RTVJOBA    USER(&USER)
             RTVUSRPRF  USRPRF(&USER) GRPPRF(&GRPPRF)

             CHGVAR     VAR(&COMPANY) VALUE(&COMPNYN)
             CHGVAR     VAR(&COMPA) VALUE(&COMPANY)
             CHGVAR     VAR(&FRMDAT) VALUE(&FRMDATN)
             CHGVAR     VAR(&FRMDATA) VALUE(&FRMDAT)
             CHGVAR     VAR(&THRDAT) VALUE(&THRDATN)
             CHGVAR     VAR(&THRDATA) VALUE(&THRDAT)
             CHGVAR     VAR(&LOAD) VALUE(&LOADN)
             CHGVAR     VAR(&COPY) VALUE(&COPYN)

/*------------------------------------------------------------------*/
/* STORES THE COUNTS FOR SUMMARY PERCENTAGES (BOTTOM OF REPORT)     */
/*------------------------------------------------------------------*/
             CRTDUPOBJ  OBJ(PPB6CPP) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)
             CRTDUPOBJ  OBJ(PPB6CPL0) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)
             CRTDUPOBJ  OBJ(PPB6CPL1) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)
             CRTDUPOBJ  OBJ(PPB6CPL2) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)

/*------------------------------------------------------------------*/
/* WORKFILE FOR EMAILING THE XLS VERSION                        */
/*------------------------------------------------------------------*/
             CRTDUPOBJ  OBJ(PDM7CPP) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)
             CRTDUPOBJ  OBJ(PDM7CPL0) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)
             CRTDUPOBJ  OBJ(PDM7CPL1) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)
/*-------------------------------------------------------------------*/
/* CREATE OPEN QUERY FILE TO SELECT BY REQUESTED DELIVERY DATE       */
/* AND/OR COMPANY NUMBER OR BY A DATE RANGE BASED ON THE QUARTER.    */
/* IF A QUARTER WAS ENTERED THEN THE FROM AND THRU DATES ARE THE     */
/* DATE RANGE FOR THE QUARTER, IF A WEEK END DATE WAS ENTERED THEN   */
/* THE DATE RANGE IS FOR ONE WEEK.                                   */
/*-------------------------------------------------------------------*/
             IF         COND(&COMPA *GT '000') THEN(DO)
  /*PIO      CHGVAR     VAR(&A) VALUE('FJAIC3 *EQ ' *CAT + +
                         &COMPA *BCAT '*AND')             */
  /*PIO*/    CHGVAR     VAR(&A) VALUE('FJAIC3  =  ' *CAT +
                         &COMPA *BCAT ' AND')
                         ENDDO

  /*PIO      CHGVAR     VAR(&B) VALUE('(FJEIDT *GE ' *CAT + +
                         &FRMDATA *CAT ' *AND FJEIDT *LE +  +
                         ' *CAT &THRDATA *CAT ')')        */
  /*PIO*/    CHGVAR     VAR(&B) VALUE('(FJEIDT >=  ' *CAT +
                         &FRMDATA *CAT '  AND FJEIDT <=  +
                         ' *CAT &THRDATA *CAT ')')

             CHGVAR     VAR(&D) VALUE(&A *BCAT &B *BCAT &C)

/********************************************************************/
/*  RUN QUERY TO READ LOAD HEADER BY DATE RANGE                      */
/********************************************************************/

  /*PIO      OVRDBF     FILE(OMFJCPLQ) SHARE(*YES)   +
             OPNQRYF    FILE((OMFJCPLQ)) QRYSLT(&D) KEYFLD(*FILE) */

  /*PIO*/    OVRDBF     FILE(OMFJCPP) TOFILE(OMFJCPP) LVLCHK(*NO)
             OPNSQLF    SQL('Select * from OMFJCPP Where  ' *BCAT &D +
                          *BCAT ' ORDER BY FJEIDT ASC, FJBZNA ASC') +
                          OPNID(OMFJCPLQ) OPTION(*ALL) SEQONLY(*NO) +
                          RCDFMT(@FJCPVQ) ALWCPY(*IFRQD) /*PIO*/
  /*PIO*/    OVRDBF     FILE(OMFJCPLQ) TOFILE(OMFJCPP) LVLCHK(*NO) +
                          OVRSCOPE(*JOB) SHARE(*YES) OPNSCOPE(*JOB)


             OVRPRTF    FILE(PPY4PFR$) OUTQ(&OUTQ) COPIES(&COPY) +
                          HOLD(&HOLD) SAVE(&SAVE)

             IF         COND(&EMAIL *NE '                   ') THEN(DO)
             CHGVAR     VAR(&HOLD) VALUE(*YES)
             CHGVAR     VAR(&SAVE) VALUE(*YES)
             ENDDO

/*-------------------------------------------------------------------*/
/*  CALL THE REPORT PROGRAM                                          */
/*     THRDAT = REQUESTED DELIVERY DATE AND ALSO THE EITHER THE      */
/*              WEEK END DATE OR THE PERIOD END DATE                 */
/*-------------------------------------------------------------------*/
             CALL       PGM(PPY4PFR) PARM(' ' &LOAD &COMPANY +
                          &CARRIER  &LOADT &THRDAT &UOM &QTR  &YEARN +
                          &FRMDATN &THRDATN &SALESP &CUST &EXPORTYN +
                 &EMXLS   &OTREAS &OTRGROUP &OTRDEPT)

             CHGVAR     VAR(&EMAIL) VALUE(&EMAIL1 *TCAT &EMAIL2)
             IF         COND(&EMAIL1 *NE '                   ') THEN(DO)
             IF         COND(&EMXLS *NE 'Y') +
                          THEN(ESEND/ESNDMAIL RECIPIENT(&EMAIL) +
                          SUBJECT('Late Delivery Report') +
                          ATTLIST((* *DFT *N PPY4PFR$)))

             IF         COND(&EMXLS *EQ 'Y') THEN(EXECUTE +
                          VIEW(LDRQSDV) PCFMT(*XLS) +
                          RECIPIENT(&EMAIL) EMLMSG('Late Delivery +
                          Report- by Requested Delivery'))

                          ENDDO

             CLOF       OPNID(OMFJCPLQ)
  /*PIO      DLTOVR     FILE(OMFJCPLQ)  */
             DLTOVR     FILE(OMFJCPLQ) LVL(*JOB) /*PIO*/

/**** FOR TESTING ONLY - SAVE WORKFILE CONTENTS  ****/
GOTO END
             IF         COND(&GRPPRF *EQ 'SBDPGMR') THEN(CPYF +
                          FROMFILE(PPB6CPP) +
                          TOFILE(OMSDEVGEN/PPB6CPPSV2) +
                          MBROPT(*REPLACE) CRTFILE(*YES))

 END:        ENDPGM
