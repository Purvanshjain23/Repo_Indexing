/********************************************************************/
/*                                                                  */
/*  SYNOPSIS - BUILT THE AGRIMETRIC FILE AND EMAIL IT               */
/*                                                                  */
/*  COMPANY   - SEABOARD COPRORATION                                */
/*  SYSTEM    - ORDER MANAGEMENT                                    */
/*  USER NAME - ROSE CENTONZE                                       */
/*  DATE      - 04/28/00                                            */
/*                                                                  */
/*      PARAMETERS RECEIVED:                                        */
/*                                                                  */
/*          &PGM        - PROGRAM NAME                              */
/********   &COMPL      - COMPANY NUMBER - BLANK FOR ALL            */
/*          &COMPL      - COMPANY NUMBER - WILL HAVE A COMPANY      */
/*                           BECAUSE REQUIRE ON SCREEN              */
/*** SLM 031607 - COMPL WAS NOT BEING USED ON SELECT PER PURVA      */
/***              CHANGED CL TO SEL ON COMPL                        */
/*          &FDATEL     - FROM DATE                                 */
/*          &TDATEL     - TO DATE                                   */
/*          &DOCUM      - DOCUMENT NAME                            */
/*          &DOCUMENT   - PARM DOCUMENT                             */
/*                                                                  */
/********************************************************************/
/* MODIFIED BY:  RMC 12/01/01 SEND THE FILE AS .XLS A LIEU .CSV     */
/*               RMC 04/17/02 IF BILLING ACTIVITY IS CRDMEMO (2)   */
/*                            MAKE WT BILLED AND QTY NEGATIVE        */
/*               RMC 04/22/02 IF AFFECT SALES PNDS=N & AFFECT SALES */
/*                            PNDS=Y, WT BILLED=0  (SAME AS SALES   */
/*                            HISTORY DOWNLOAD ROUTINE)             */
/*               SLM 8/11/04  REPLACE PRKFLIB WITH *LIBL            */
/*               RMC 12/22/5  ADDED NEW FIELDS PER BOBBY MOORE @    */
/*                            AGRIMETRICS: FRT AMT , MKT ACCRUAL    */
/*               RMC 10/30/12 E2309:ADDED COUNTRY PER AGRISTAT -  F4KXCD */
/*               RMC 06/25/13 C2661:USE EXPORT COUNTRY IF ENTERED F4UMCD */
/*               RMC 07/18/13 C2661:ADD PRICE TYPE FROM PMD0CPP SLS HST EXT */
/*               RMC 11/01/13 E2860:SEL OR ONLY, EXCLUDE SAMPLE CUSTS    */
/*                            1655001,1655002                            */
/*               RMC 04/03/15 E4054:EXCLUDE NEW PRICE TYPE "DST" DISTRESSED */
/*                            AND COPACK CUSTS IF NEP2SX STS IS "C"  */
/*   RMC R14015 10/29/18 CHANGED TO NEW SERVER - SBMJOB THAT LOGS ON WITH   */
/*            A USER WITH ACCESS TO //ENTKCPRKDFIL1          */
/********************************************************************/

 POFGUPC:   PGM        PARM(&RTN &COMPL &FDATEL &TDATEL &DOCUM)


             DCL        VAR(&RTN) TYPE(*CHAR) LEN(7) /*  RETURN +
                          CODE   */
        DCL    &COMP      *DEC    (3 0)           /*  COMPANY #     */
        DCL    &COMPL     *DEC                    /*  FOR PASSING   */
        DCL    &FDATE     *DEC    (7 0)          /*  FROM DATE      */
        DCL    &FDATEL    *DEC                   /*  FOR PASSING    */
        DCL    &FDATEX    *CHAR   (7)          /*  FROM DATE      */
        DCL    &TDATE     *DEC    (7 0)          /*  THROUGH DATE   */
        DCL    &TDATEL    *DEC                   /*  FOR PASSING    */
        DCL    &TDATEX    *CHAR   (7)          /*  TO   DATE      */
        DCL    &DOCUMENT  *CHAR   (10)
        DCL    &PCFILE    *CHAR   (32)
        DCL    &DOCUM     *CHAR   (08)
        DCL    &DOCEXT    *CHAR   (12)

             DCL        VAR(&DIR1) TYPE(*CHAR) LEN(32)
             DCL        VAR(&DIR) TYPE(*CHAR) LEN(12)
             DCL        VAR(&IDIR) TYPE(*CHAR) LEN(44)
             DCL        VAR(&IDIRNM) TYPE(*CHAR) LEN(90)

/* SEND PROGRAM MESSAGE PARAMETERS  */

             /* Internal Fields */
             DCL  VAR(&ALREADY)  TYPE(*CHAR) LEN(1)

             DCL        VAR(&SEL)  TYPE(*CHAR) LEN(1500)
             DCL    &COMPA     *CHAR   (3)      /*  COMPANY #     */
             DCL        &CM         *CHAR    20  /* QRY SELECT   */
             DCL        &CU         *CHAR    40  /* QRY SELECT   */
             DCL        &OT         *CHAR    20  /* QRY SELECT   */
             DCL        &PT         *CHAR    20  /* QRY SELECT   */
             DCL        &KT         *CHAR    20  /* QRY SELECT   */

             CHGVAR    VAR(&COMP) VALUE(&COMPL) /* Change to length +
                          for print program */
             CHGVAR    VAR(&COMPA) VALUE(&COMP) /* Change to alpha +
                          for message data */
             CHGVAR    VAR(&FDATE) VALUE(&FDATEL) /* Change to length +
                          for print program */
             CHGVAR    VAR(&FDATEX) VALUE(&FDATE) /* Change to CHAR  */
             CHGVAR    VAR(&TDATE) VALUE(&TDATEL) /* Change to length +
                          for print program */
             CHGVAR    VAR(&TDATEX) VALUE(&TDATE) /* Change to CHAR  */

             CHGVAR     VAR(&CM) VALUE('AND F4AIC3=' *CAT +
                         &COMPA)
        CHGVAR     VAR(&CU) VALUE('AND F4BKC7<>1655001 AND F4BKC7<>1655002')
        CHGVAR     VAR(&OT) VALUE('AND F4JNCD="OR"')
        CHGVAR     VAR(&PT) VALUE('AND D0JXAA<>"DST"') /* EXCL PRICE TYPE=DST */
        CHGVAR     VAR(&KT) VALUE('AND NEP2SX<>"C"') /* EXCL COPACK CUSTS   */

             ADDLIBLE LIB(SEQUEL) POSITION(*LAST)
             MONMSG MSGID(CPF2103) EXEC(DO)       /* already in libl */
                CHGVAR VAR(&ALREADY) VALUE('Y')
                ENDDO
/*-----------------------------------------------------------------*/
/* NEW PUSH TO SHARED FOLDER - NEW  12.03.18  R14015                    */
/*-----------------------------------------------------------------*/

             CHGVAR     VAR(&DIR1) +
                          VALUE('/QNTC/ENTKCPRDFIL1/FTP_HPE_PORK/')

             CHGVAR     VAR(&DIR) VALUE('AGRIMETRICS/')

             CHGVAR     VAR(&IDIR) VALUE(&DIR1 *TCAT &DIR)
             CHGVAR     VAR(&DOCEXT) VALUE(&DOCUM *TCAT '.xls')
             CHGVAR     VAR(&IDIRNM) VALUE(&IDIR *CAT &DOCEXT)

             MKDIR      DIR('/QNTC/ENTKCPRDFIL1/')
             MONMSG     MSGID(CPFA0A0)
   /*------------------------------------------------*/
   /* EXECUTE SEQUEL TO BUILD THE FILE AND EMAIL IT -*/
   /*-----------------------------------------------*/
             CHGVAR     VAR(&SEL) VALUE('SELECT F4GNDT +
                          COLHDG("SHIPPED DATE"),F4RHNB +
                          COLHDG("GROUP" ), F4S5NB COLHDG("SHIPPED +
                          ITEM"),BZAVNA.BZHGCD +
                          COLHDG("DESCRIPTION"),  F4BKC7.F4S5NB +
                          COLHDG("SHIP TO CUSTOMER"),F4KDVA.F4S5NB +
                          COLHDG("BILLED$"), F4TBNB.F4S5NB +
                          LEN(11,2) COLHDG("FREIGHT $/CWT"),      +
                          F4ULVA COLHDG("FRT AMT"), F4UNVA +
                          COLHDG("MTK ACCRUAL"), CASE  WHEN +
                          EXOBST="2" THEN(0-F4EXQT) ELSE F4EXQT END +
                          NAME(EXQT) LEN(11,2) COLHDG("CONTAINERS +
                          BILLED"), CASE WHEN F4ANST="Y" AND +
                          F4VAST="N" THEN(0) ELSE CASE WHEN +
                          EXOBST="2" THEN(0-F4BYWG) ELSE F4BYWG END +
                        END   NAME(BYWG) LEN(11,2) COLHDG("WEIGHT" "BILLED"), +
   CASE WHEN F4UMCD>"      " THEN F4UMCD ELSE F4KXCD END COLHDG("COUNTRY"), +
   D0JXAA COLHDG("PRICE TYPE")   FROM  *LIBL/OMHSTPP F4S5NB,*LIBL/CABZREP +
               BZHGCD,*LIBL/OPEXREP, *LIBL/PMD0CPP,*LIBL/PDNEREP  JOIN +
                          F4S5NB.F4S5NB=BZHGCD.BZHGCD AND +
                          F4AIC3=BZAIC3 AND F4JNCD=EXJNCD AND   +
      F4AIC3.F4S5NB=D0AIC3.PMD0CPP AND F4C4NB.F4S5NB=D0C4NB.PMD0CPP AND +
          F4DPNB.F4S5NB=D0DPNB.PMD0CPP AND F4UENB.F4S5NB=D0UENB.PMD0CPP +
          AND F4BKC7=NEBKC7.PDNEREP               +
                          WHERE F4GNDT>=' *CAT &FDATEX *BCAT 'AND' +
                          *BCAT 'F4GNDT<=' *CAT &TDATEX *BCAT &CM +
 *BCAT &CU *BCAT &OT *BCAT &PT *BCAT &KT *BCAT 'ORDER BY F4S5NB,F4BKC7,F4GNDT')

    /*       CHGVAR VAR(&PCFILE)   VALUE(&DOCUM *TCAT '.XLS')   */

/*-----------------------------------------------------------------*/
/* WHEN DOING FTP ->NO LONGER USED  10.31.18    R14015                  */
/*-----------------------------------------------------------------*/
  GOTO NEWWAY
             EXECUTE    SQL(&SEL) MBROPT(*REPLACE) NBRRCDS(*ALL) +
                          KEYFLDCNT(*ALL) ALWNULL(*NO) +
                          TOFLR('GUY.IS') TODOC(&DOCUM) +
                          PCFMT(*XLS) REPLACE(*YES) TEXT('SALES +
                          REPORT FOR AGRIMETRICS') OPTIMIZE(*TOTAL) +
                          ALWCPY(*YES) MSG(*YES) UNIQUEKEY(*NONE) +
                          JTYPE(*INNER) JORDER(*ANY) IGNDECERR(*NO) +
                          DTSTYLE(*FIELD '/' *FIELD ':')
/*-----------------------------------------------------------------*/
/* NEW PUSH TO SHARED FOLDER - NEW  10.31.18  R14015                    */
/*-----------------------------------------------------------------*/
 NEWWAY:

             EXECUTE    SQL(&SEL) MBROPT(*ADD) NBRRCDS(*ALL) +
                          KEYFLDCNT(*ALL) ALWNULL(*NO) PCFMT(*XLS) +
                          TOSTMF(&IDIRNM) REPLACE(*YES) +
                          OPTIMIZE(*TOTAL) ALWCPY(*YES) MSG(*YES) +
                          UNIQUEKEY(*NONE) JTYPE(*INNER) +
                          JORDER(*ANY) IGNDECERR(*NO) +
                          DTSTYLE(*FIELD '/' *FIELD ':') +
                          TEXT('SALES REPORT FOR AGRIMETRICS')

         GOTO  END
   /*---------------------------------*/
   /* Remove SEQUEL Library from List */
   /*---------------------------------*/
             IF COND(&ALREADY *EQ 'N') THEN(DO)
                RMVLIBLE   LIB(SEQUEL)
             ENDDO
   /*------------------------------------*/
   /* FTP documents to /PROCURE          */
   /*------------------------------------*/
             CHGVAR VAR(&DOCUMENT) VALUE(&DOCUM)
             CHGVAR VAR(&PCFILE)   VALUE(&DOCUM *TCAT '.XLS')
             CALL PGM(FTPPROCURE) PARM(&DOCUMENT &PCFILE)


 END:        ENDPGM
