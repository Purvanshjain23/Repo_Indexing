// ?------------------------------------------------------------------------------------------------
// ?Synon action diagram for PMM5XFR
// ?Date: 14.08.2025 Time: 03:43:30
// ?------------------------------------------------------------------------------------------------

//?Execute user function

EXECUTE FUNCTION(RTV Purge Files by grp RT) TYPE(RTVOBJ) FILE(PMBEREP)          AC1846599;
PARAMETER(PAR.Purge_Run_Frequency);
PARAMETER(PAR.Return_Code_Usr);
{
 //?USER: Initialize routine

 //?***** Change Log and Comments
 DO;

 //?** LJB 01/30/2008 FP1009 Post install changes
 //?** "To Purge Library" field was added to the control file. Pass this
 //?** to all the following programs. These libraries replace QTEMP.
 ENDDO;

 //?USER: Process Data record

 CASE;

 // IF DB1.Record Status is Active
 IF DB1.Record_Status = 'A';

 // PAR.Return Code Usr = CND.*Blank
 PAR.Return_Code_Usr = *BLANK;

 EXECUTE FUNCTION(RTV Purge By Grp Code  RT) TYPE(RTVOBJ) FILE(PDLPREP)          AC1840915;
 PARAMETER(DB1.PCG_Code);
 PARAMETER(DB1.PCG_From_Library);
 PARAMETER(PAR.Purge_Run_Frequency);
 PARAMETER(DB1.PCG_Purge_To_Library);
 PARAMETER(PAR.Return_Code_Usr);
 {
  //?USER: Initialize routine

  //?***** Change Log and Comments   (This program does all the work!)
  DO;

  //?** 09/01/2009 LJB FP1009
  //?** The copy of backup data to 1st member has been removed.
  //?*****
  //?** 01/29/2008 LJB FP1009 Post Install changes
  //?** Change all processing of QTEMP to write to a new "To Library"
  //?**  Pass this new lib in as a parm from the Purge Control File.
  //?** Create "Z" members for the Tape Files in "To Library", copy
  //?**  file being purged to the 1st member of the Tape File.
  //?** Copy the purged records to the "Z" members of the Tape file
  //?**  being purged to the 1st member of the Tape File in the
  //?**  "To Library" (not QTEMP)
  //?*****
  //?** 08/07/2007 LJB FP1009
  //?** Select only those records with Run Frequency matching
  //?**      the input parameter frequency. (Monthly, Weekly, Yearly)
  //?** Create "Z" members for the Tape Files in QTEMP, copy file
  //?**      being purged to the 1st member of the Tape File.
  //?** Execute the purge program for this application code.
  //?** Copy the purged records to the "Z" members of the Tape file.
  ENDDO;

  //?USER: Processing if Data record not found

  // PGM.*Return code = CND.*Normal
  PGM.*Return_code = *BLANK;

  //?USER: Process Data record

  //?** Only process active records
  CASE;

  // IF DB1.Record Status is Active
  IF DB1.Record_Status = 'A';

  //?** Select by Run Frequency
  CASE;

  // IF DB1.Purge Run Frequency EQ PAR.Purge Run Frequency
  IF DB1.Purge_Run_Frequency = PAR.Purge_Run_Frequency;

  // WRK.Purge Date USR = CON.*ZERO
  WRK.Purge_Date_USR = *ZERO;

  // Call program Clc Purge Date        XF.
  CALL PROGRAM(Clc Purge Date        XF) ('POGGXFR');
  PARAMETER(PAR.PCG_Code);
  PARAMETER(PAR.PCG_From_Library);
  PARAMETER(DB1.Purge_Application_Code);
  PARAMETER(JOB.*Job_date);
  PARAMETER(WRK.Purge_Date_USR);

  //?** Add "Z" member to purge tape file in Purge Library
  //?** Override the purge tape file to the new "Z" member (in PRGPREO)
  //?** If Tape - create "Z" member to contain the purged records
  CASE;

  // IF DB1.PCA Purge Method is Tape
  IF DB1.PCA_Purge_Method = 'T';

  // Call program Pre Prg & Tape Files   XF.
  CALL PROGRAM(Pre Prg & Tape Files   XF) ('POCUXFR');
  PARAMETER(PAR.PCG_Code);
  PARAMETER(DB1.PCG_From_Library);
  PARAMETER(DB1.Purge_Application_Code);
  PARAMETER(PAR.Return_Code_Usr);
  PARAMETER(WRK.Purge_Date_USR);
  PARAMETER(PAR.PCG_Purge_To_Library);

  ENDIF;

  CASE;

  // IF PAR.Return Code Usr is *Blank
  IF PAR.Return_Code_Usr = *BLANK;

  //?** Purge the records from the files
  // Call program RTV & Purge Files      XF.
  CALL PROGRAM(RTV & Purge Files      XF) ('PMNDXFR');
  PARAMETER(PAR.PCG_Code);
  PARAMETER(PAR.PCG_From_Library);
  PARAMETER(DB1.Purge_Application_Code);
  PARAMETER(DB1.Purge_Retention_Period);
  PARAMETER(DB1.Purge_Run_Frequency);
  PARAMETER(DB1.Purge_Last_Run_Date);
  PARAMETER(DB1.PCA_Purge_Method);
  PARAMETER(DB1.PCA_Purge_Program);
  PARAMETER(WRK.Purge_Date_USR);
  PARAMETER(PAR.PCG_Purge_To_Library);

  //?** QTEMP processing is no longer being done   01/29/2008 LJB FP1009
  //?** Copy the files to the tape physical file
  CASE;

  // IF DB1.PCA Purge Method is Tape
  IF DB1.PCA_Purge_Method = 'T';

  // Call program Post Prg & Tape Files  XF.
  CALL PROGRAM(Post Prg & Tape Files  XF) ('POCXXFR');
  PARAMETER(PAR.PCG_Code);
  PARAMETER(PAR.PCG_From_Library);
  PARAMETER(DB1.Purge_Application_Code);
  PARAMETER(JOB.*Job_date);
  PARAMETER(PAR.PCG_Purge_To_Library);

  ENDIF;

  //?** Update the Last Changed Date
  CASE;

  // IF DB1.Record Status is Active
  IF DB1.Record_Status = 'A';

  // Call program CHG Last Run Date      XF.
  CALL PROGRAM(CHG Last Run Date      XF) ('PMM9XFR');
  PARAMETER(PAR.PCG_Code);
  PARAMETER(PAR.PCG_From_Library);
  PARAMETER(DB1.Purge_Application_Code);

  ENDIF;

  ENDIF;

  ENDIF;

  ENDIF;

 }

 ENDIF;

}


