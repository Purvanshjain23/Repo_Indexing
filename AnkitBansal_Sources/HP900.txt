/**************************************************************************/
/*  PROGRAM:       HP900                                                  */
/*  PROGRAM DESC:  TRIGGER PURGE FOR HPS FILES                            */
/*  PROGRAMMER:    DANNY NGUYEN                                           */
/*  CREATE DATE:   01/24/2022                                             */
/*                                                                        */
/*  PURPOSE:       DELETE RECORDS OUT OF ALL DB2 TRIGGERED FILES THAT ARE */
/*                 < LAST WEEK SUNDAY DATE & NOT UNPROCESSED '0'.         */
/*                 WILL KEEP A ROLLING WEEK'S WORTH OF DATA.              */
/*                                                                        */
/*  JOB SCHEDULE:  'PRKPRGTRG2' WILL RUN WEEKLY EVERY SUNDAY @2AM.        */
/* -----------------------------------------------------------------------*/
/*  PARMS:         NONE.                                                  */
/**************************************************************************/
/* MODIFICATION HISTORY                                                   */
/* 04/14/22  BLG WHD88663 Renamed pgm from TRGPURGE to HP900 to adhere    */
/*                        to HPS standards.                               */
/* 09/08/22  E.L SDN736   RECOMPILE                                       */
/**************************************************************************/
/**************************************************************************/

             PGM

             DCL        VAR(&CYMDDTE) TYPE(*CHAR) LEN(7)
             DCL        VAR(&CYMDDTEA) TYPE(*CHAR) LEN(10)
             DCL        VAR(&CCYYMMDD) TYPE(*CHAR) LEN(10)
             DCL        VAR(&CCYYMMDD2) TYPE(*CHAR) LEN(10)
             DCL        VAR(&PURGEDTE) TYPE(*CHAR) LEN(26)
             DCL        VAR(&PURGEDTE2) TYPE(*CHAR) LEN(7)
             DCL        VAR(&PURGEDTE3) TYPE(*CHAR) LEN(8)
             DCL        VAR(&SQLSEL) TYPE(*CHAR) LEN(200)


             RTVJOBA    CYMDDATE(&CYMDDTE)

    /* JS Runs Every Sunday So Get Last Sundays Date */
             ADDDAT2    DAYS(-7) NEWDAT(&CCYYMMDD) FRMDAT(&CYMDDTE) +
                          FRMDATFMT(*CYMD) NEWDATFMT(*ISO)
             ADDDAT2    DAYS(-7) NEWDAT(&CYMDDTEA) FRMDAT(&CYMDDTE) +
                          FRMDATFMT(*CYMD) NEWDATFMT(*CYMD)
             ADDDAT2    DAYS(-7) NEWDAT(&CCYYMMDD2) FRMDAT(&CYMDDTE) +
                          FRMDATFMT(*CYMD) NEWDATFMT(*YYMD)

    /* Format Last Sundays Date in Timestamp, CYMD & YYMD Format */
             CHGVAR     VAR(&PURGEDTE) VALUE(&CCYYMMDD *CAT +
                          '-00.00.00.000000')                   /* ISO */
             CHGVAR     VAR(&PURGEDTE2) VALUE(&CYMDDTEA)        /* CYMD */
             CHGVAR     VAR(&PURGEDTE3) VALUE(&CCYYMMDD2)       /* YYMD */

    /*ˆFOR TESTING ONLY */
         /*  GOTO       CMDLBL(TEST) */

/*********************************************************************/
/*DELETE RECORDS FROM LEGACY DB2 TRIGGERED FILES - WHERE TIMESTAMP DATE +
/*IS LESS THAN LAST SUNDAY DATE & PROCESS STS <> '0' (UNPROCESSED).    +
/*********************************************************************/

         /* HPS Feed Ticket Detail TRG - HSP038TR */
             CHGVAR     VAR(&SQLSEL) VALUE('FROM' *BCAT 'HSP038TR +
                          WHERE FDTTSTMP <"' *TCAT &PURGEDTE *TCAT +
                          '"' *BCAT 'AND FDTPRSTS<>"0"')

             DELETE     SQL(&SQLSEL)

             RGZPFM     FILE(HSP038TR)
             MONMSG     MSGID(CPF2981 CPF3135 CPF3202)

         /* HPS Sales Movement Detail TRG - HSP085TR */
             CHGVAR     VAR(&SQLSEL) VALUE('FROM' *BCAT 'HSP085TR +
                          WHERE SDTTSTMP <"' *TCAT &PURGEDTE *TCAT +
                          '"' *BCAT 'AND SDTPRSTS<>"0"')

             DELETE     SQL(&SQLSEL)

             RGZPFM     FILE(HSP085TR)
             MONMSG     MSGID(CPF2981 CPF3135 CPF3202)


 END:        ENDPGM

