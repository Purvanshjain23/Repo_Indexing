// ?------------------------------------------------------------------------------------------------
// ?Synon action diagram for PPPRXFR
// ?Date: 14.08.2025 Time: 03:41:33
// ?------------------------------------------------------------------------------------------------

//?Execute user function

//?Avg Mkt Price for week * ending inventory
EXECUTE FUNCTION(Rtv Itm MktPr for IVF RT) TYPE(RTVOBJ) FILE(CABZREP)           AC1741216;
PARAMETER(PAR.Company_Number);
PARAMETER(PAR.Item_Code);
PARAMETER(PAR.Market_Price_Date);
PARAMETER(PAR.ISC_Ending_Inventory_Lbs);
PARAMETER(PAR.Price_Weight_USR);
PARAMETER(PAR.Pounds);
{
 //?USER: Initialize routine

 // LCL.Count USR = CON.*ZERO
 LCL.Count_USR = *ZERO;

 // LCL.Price = CON.*ZERO
 LCL.Price = *ZERO;

 //?USER: Process Data record

 // LCL.Market Price Date = PAR.Market Price Date + CON.-6 *DAYS
 LCL.Market_Price_Date = DATEINCR(PAR.Market_Price_Date '-6' 'DY' 1111111 'NONE' 'N' 1);

 //?Calc market price for all days of the week
 // DOW LCL.Market Price Date LE PAR.Market Price Date
 DOW LCL.Market_Price_Date <= PAR.Market_Price_Date;

 EXECUTE FUNCTION(RTV Market Price       RT) TYPE(RTVOBJ) FILE(OMF0CPP)          AC1199313;
 PARAMETER(DB1.Default_Commod_Mark_basis);
 PARAMETER(DB1.Commodity_Price_Group);
 PARAMETER(LCL.Market_Price_Date);
 PARAMETER(WRK.Commodity_Market_Price);
 PARAMETER(LCL.USR_Market_Pricing_Date);
 {
  //?USER: Processing if Data record not found

  // PGM.*Return code = CND.*Record does not exist
  PGM.*Return_code = 'Y2U0005';

  MOVE *ALL (To: PAR From: CON);

  //?USER: Process Data record

  // PAR.Commodity Market Price = DB1.Commodity Market Price
  PAR.Commodity_Market_Price = DB1.Commodity_Market_Price;

  // PAR.USR Date Priced = DB1.Market Price Date
  PAR.USR_Date_Priced = DB1.Market_Price_Date;

  QUIT;

 }

 //?If market price was found for the date ....
 CASE;

 // IF WRK.Commodity Market Price is Entered
 IF WRK.Commodity_Market_Price > *ZERO;

 // WRK.USR Price per Pricing U/M = DB1.Standard Overage/Underage + WRK.Commodity Market Price
 WRK.USR_Price_per_Pricing_U_M = DB1.Standard_Overage_Underage
 + WRK.Commodity_Market_Price;

 // LCL.U/M - Pricing = DB1.U/M - Pricing
 LCL.UOM_Pricing = DB1.UOM_Pricing;

 // Call program CLC Convert Price Qtys XF.
 CALL PROGRAM(CLC Convert Price Qtys XF) ('PDKGXFR');
 PARAMETER(DB1.Company_Number);
 PARAMETER(DB1.Item_Code);
 PARAMETER(LCL.UOM_Pricing);
 PARAMETER(WRK.Price_based_on_U_M1_S);
 PARAMETER(WRK.Price_based_on_U_M2_S);
 PARAMETER(WRK.Price_based_on_U_M3_S);
 PARAMETER(WRK.USR_Price_per_Pricing_U_M);

 CASE;

 // IF WRK.Price based on U/M1 S is Not Zeros
 IF WRK.Price_based_on_U_M1_S <> *ZERO;

 // LCL.USR Price per Pricing U/M = WRK.Price based on U/M1 S / DB1.Unit Weight *
 LCL.USR_Price_per_Pricing_U_M = WRK.Price_based_on_U_M1_S / DB1.Unit_Weight;

 ENDIF;

 // LCL.Price = LCL.Price + LCL.USR Price per Pricing U/M
 LCL.Price = LCL.Price + LCL.USR_Price_per_Pricing_U_M;

 // LCL.Count USR = LCL.Count USR + CON.1
 LCL.Count_USR = LCL.Count_USR + 1;

 ENDIF;

 // LCL.Market Price Date = LCL.Market Price Date + CON.1 *DAYS
 LCL.Market_Price_Date = DATEINCR(LCL.Market_Price_Date 1 'DY' 1111111 'NONE' 'N' 1);

 ENDDO;

 CASE;

 // IF LCL.Count USR is GT 0
 IF LCL.Count_USR > *ZERO;

 // Weight USR =       * Compute: Avg price @ wgt
 PAR.Price_Weight_USR = ( ( LCL.Price / LCL.Count_USR ) * PAR.ISC_Ending_Inventory_Lbs )
 + PAR.Price_Weight_USR;

 // PAR.Pounds = PAR.Pounds + PAR.ISC Ending Inventory Lbs
 PAR.Pounds = PAR.Pounds + PAR.ISC_Ending_Inventory_Lbs;

 ENDIF;

}


