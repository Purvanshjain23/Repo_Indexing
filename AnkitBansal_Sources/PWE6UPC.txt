/***************************************************************** */
/***************************************************************** */
/*                                                                 */
/*  PROGRAM NUMBER:  EDISUMDTTF                                    */
/*  PROGRAM NAME:    EDI CARCASS SUMMARY & DETAIL                  */
/*  PROGRAMMER:      SUSAN MASON                                   */
/*  CREATE DATE:     11/14/05                                      */
/*                                                                 */
/*  FUNCTION:        THIS CL IS SUBMITTED FROM THE PAYMENT         */
/*                   POST XF TO CREATE THE PC FILES FOR DOWNLOAD.  */
/*                   TRIUMPH FOODS PROCESSING.                     */
/*                                                                 */
/*******************************************************************/
/*  Modification History                                           */
/*  E10169 JJH  08/01/17  Reinstate Email processing               */
/*  E10169 JJH  07/17/17  Due to production issue when we went live*/
/*                        re-instate call to PLWCXFR to get FTP    */
/*                        Method; and remove logic for E=Email     */
/*  E10169 JJH  07/10/17  This program will process 960,961,& 440  */
/*                        Add logic to Print Emails during Testing */
/*                        and for 440 until we start using .NET    */
/*                        Add input parm for &FTPMETHOD &COMPANYA  */
/*                        &EMAILADR &TEXT &TEXTDTL                 */
/*  J HIGH      11/06/14  Add logic to allow FTP Methods of F=FTP, */
/*                        S=SFTP, or P=Parallel.  SFTP is Secured  */
/*                        FTP and uitilzes BrickFTP as vendor.     */
/*                        Parallel option is used during intial    */
/*                        testing and implementation.              */
/*                        Retrieve FPTMETHOD with values of F=FTP, */
/*                        S=SFTP, P=Parallel from Trading Partner  */
/*                        file.                                    */
/*  S MASON     08/12/14  On 1/24/14 THIS cl was changed due to    */
/*                        fields that Jerry Lehenbauer wanted zero */
/*                        out on resale hogs.  I placed a sequel in*/
/*                        this cl to zero this out and knew that   */
/*                        when PKLLXFR was installed we would no   */
/*                        longer need to perform this sequel       */
/*  S MASON     01/24/14  Triumph Foods Live - DO Not have the     */
/*                        two fields populated with Carcass Merit  */
/*                        prices on live data                      */
/*  S MASON     11/14/05  CLONE FROM EDISUMDT                      */
/*******************************************************************/

             PGM        PARM(&COMPANYA &AKILL &TRADEPART &FTPMETHOD +
                          &EMAILADR &TEXT &TEXTDTL)

             DCL        VAR(&COMPANYA)  TYPE(*CHAR) LEN(3)
             DCL        VAR(&AKILL)     TYPE(*CHAR) LEN(7)
             DCL        VAR(&TRADEPART) TYPE(*CHAR) LEN(6)
             DCL        VAR(&FTPMETHOD) TYPE(*CHAR) LEN(1)
             DCL        VAR(&EMAILADR)  TYPE(*CHAR) LEN(50)
             DCL        VAR(&TEXT)      TYPE(*CHAR) LEN(50)
             DCL        VAR(&TEXTDTL)   TYPE(*CHAR) LEN(50)

             DCL        VAR(&LIBEXIST) TYPE(*CHAR) LEN(1)
             DCL        VAR(&KILLDT) TYPE(*DEC) LEN(7 0)
             DCL        VAR(&RTNCDE) TYPE(*CHAR) LEN(1)
             DCL        VAR(&KDTE) TYPE(*CHAR) LEN(6)

             DCL        VAR(&LOCALDIR) TYPE(*CHAR) LEN(7)
             DCL        VAR(&URL) TYPE(*CHAR) LEN(20)
             DCL        VAR(&TOSTMF) TYPE(*CHAR) LEN(30)

             DCL        VAR(&TRADENUM) TYPE(*DEC) LEN(6) VALUE(000000)
             DCL        VAR(&TRADENUM8) TYPE(*DEC) LEN(8) +
                          VALUE(00000000)
             DCL        VAR(&RETURNCDE) TYPE(*CHAR) LEN(7)

             DCL        VAR(&TDOCSUM) TYPE(*CHAR) LEN(7)
             DCL        VAR(&TDOCDTL) TYPE(*CHAR) LEN(7)

             CHGVAR     VAR(&KILLDT)  VALUE(&AKILL)

             CHGVAR     VAR(&TRADENUM) VALUE(&TRADEPART)
             CHGVAR     VAR(&TRADENUM8) VALUE(&TRADEPART)

             CHGVAR     VAR(&TDOCSUM)  VALUE('S' *CAT &TRADEPART)
             CHGVAR     VAR(&TDOCDTL)  VALUE('D' *CAT &TRADEPART)


/* INITIALIZE */

             CHGVAR     VAR(&LIBEXIST) VALUE('N')

             ADDLIBLE   LIB(SEQUEL) POSITION(*LAST)

             MONMSG     MSGID(CPF2103) EXEC(CHGVAR VAR(&LIBEXIST) +
                          VALUE('Y'))

/*** ******************************************************************* ****/
/*** ************** This is the Triumph Foods work around fix            ****/
/*** ************** only for a short term fix;  PROGRAM that creates the ****/
/*** carcass summary is already checked out to the mtech project and this****/
/*** is a work around until that program goes in .                       ****/
/*** ******************************************************************* ****/
/********    UPDATE     SET((D3LZA1 0) (D3V1PR 0)) SQL('from pkd3cpp +   ****/
/********                 where D3QMST = ''A'' AND D3J9ST = ''L'' +      ****/
/********                 AND D3EDTP =' +                                ****/
/********                 *CAT &TRADEPART)                               ****/
/********                                                                ****/
/********    MONMSG     MSGID(QRY6004)                                   ****/

/********    GET FTP METHOD FROM TRADING PARTNER FILE                ********/
/********    IF INPUT &FTPMETHOD IS NOT EQUAL E (EMAIL)              ********/
/*                                                                          */
/*           IF         COND(&FTPMETHOD *NE 'E') THEN(DO)                   */
/*                                                                          */
/*           CALL       PGM(PLWCXFR) PARM(&RETURNCDE &TRADENUM8 +           */
/*                        &FTPMETHOD)                                       */
/*                                                                          */
/*           ENDDO                                                          */
/*                                                                          */
/**********  SEND FILES TO IFS FOLDER USING FTP              ************/

             IF         COND(&FTPMETHOD *EQ 'F' *OR &FTPMETHOD +
                          *EQ 'P') THEN(DO)

             EXECUTE    VIEW(EDISUM) PCFMT(*XLS) TOFLR(GUY.IS) +
                          TODOC(&TDOCSUM) REPLACE(*YES) +
                          SETVAR((&TRADENUM &TRADEPART))

             EXECUTE    VIEW(EDIDTL) PCFMT(*XLS) TOFLR(GUY.IS) +
                          TODOC(&TDOCDTL) REPLACE(*YES) +
                          SETVAR((&TRADENUM &TRADEPART))

             CHGVAR     VAR(&KDTE) VALUE(%SST(&AKILL 2 6))
             HPEEDIPCC  CO(&TRADEPART) DATE(&KDTE) FTPMETHOD(F)

             ENDDO

/**********  SEND FILES TO BRICKFTP USING SFTP               ************/

             IF         COND(&FTPMETHOD *EQ 'S' *OR &FTPMETHOD +
                          *EQ 'P') THEN(DO)

             ADDLIBLE   LIB(SFTPREMOTE) POSITION(*LAST)
             MONMSG     MSGID(CPF0000)

             CHGVAR     VAR(&TOSTMF) VALUE('/PORK/SFTP/OUT/' *TCAT +
                          &TRADEPART *TCAT '/' *CAT &TDOCSUM)
             EXECUTE    VIEW(EDISUM) MBROPT(*ADD) PCFMT(*XLS) +
                          TOSTMF(&TOSTMF) SETVAR((&TRADENUM +
                          &TRADEPART))

             CHGVAR     VAR(&TOSTMF) VALUE('/PORK/SFTP/OUT/' *TCAT +
                          &TRADEPART *TCAT '/' *CAT &TDOCDTL)
             EXECUTE    VIEW(EDIDTL) MBROPT(*ADD) PCFMT(*XLS) +
                          TOSTMF(&TOSTMF) SETVAR((&TRADENUM +
                          &TRADEPART))

             RMVLIBLE   LIB(SFTPREMOTE)
             MONMSG     MSGID(CPF0000)

             CHGVAR     VAR(&KDTE) VALUE(%SST(&AKILL 2 6))
             SBMJOB     CMD(HPEEDIPCC CO(&TRADEPART) DATE(&KDTE) +
                          FTPMETHOD(S)) JOB(HPEEDIPCCS) JOBQ(*JOBD) +
                          OUTQ(*USRPRF) USER(TFSFTP) LOG(4 00 +
                          *SECLVL) LOGCLPGM(*YES)

             ENDDO

/**********  SEND FILES TO IFS FOLDER USING EMAIL            ************/

             IF         COND(&FTPMETHOD *EQ 'E') THEN(DO)

             EXECUTE    VIEW(EDISUM) PCFMT(*XLS) REPLACE(*YES) +
                          RECIPIENT(&EMAILADR) EMLMSG(&TEXT) +
                          SETVAR((&TRADENUM &TRADEPART)) TEXT(&TEXT)

/*           Execute statement used to placed EDISUM in a Folder        */
/*           EXECUTE    VIEW(EDISUM) PCFMT(*XLS) TOFLR(GUY.IS) +        */
/*                        TODOC(&TDOCSUM) REPLACE(*YES) +               */
/*                        SETVAR((&TRADENUM &TRADEPART))                */

             EXECUTE    VIEW(EDIDTL) PCFMT(*XLS) REPLACE(*YES) +
                          RECIPIENT(&EMAILADR) EMLMSG(&TEXTDTL) +
                          SETVAR((&TRADENUM &TRADEPART)) TEXT(&TEXTDTL)

/*           Execute statement used to placed EDIDTL in a Folder        */
/*           EXECUTE    VIEW(EDIDTL) PCFMT(*XLS) TOFLR(GUY.IS) +        */
/*                        TODOC(&TDOCDTL) REPLACE(*YES) +               */
/*                        SETVAR((&TRADENUM &TRADEPART))                */

             ENDDO

/**********  UPDATE EDI CARCASS SUMMARY/DETAIL               ************/

             UPDATE     SET((D3QMST '"P"')) SQL('from pkd3cpp where +
                          d3qmst=''A'' and d3edtp=' +
                          *CAT &TRADEPART)
             UPDATE     SET((D4QMST '"P"')) SQL('from pkd4cpp where +
                          d4qmst=''A'' and d4edtp=' +
                          *CAT &TRADEPART)

/*******************************************************************/
ENDPGM:
/*******************************************************************/
/* REMOVE SEQUEL LIBRARY */
             IF         COND(&LIBEXIST *EQ 'N') THEN(RMVLIBLE +
                          LIB(SEQUEL))

             DLTOVR *ALL
             ENDPGM
