     H/TITLE Exc Auto EDI 846  Cmp  XF Execute external functio
     H            Y
     Z* CRTRPGPGM
     Z* CVTOPT(*DATETIME)
      *
     H* SYNOPSIS :
     H*  Perform user function
     H*  As defined by action diagram
      *
     H* Generated by CA 2E release 8.7.1 (1635)
     H* Function type : Execute external function
      *
     H* Company       : OMS Development Model
     H* System        : OMS Development Model
     H* User name     : ISSGOYA
     H* Date          : 05/09/25  Time  : 10:17:35
     H* Copyright     : OMS Development Model
      *
      *================================================================
     M* Maintenance   :
      *================================================================
     FPDJYREL3IF  E           K        DISK
      * RTV : Company Defaults Internal Plant Companies Only CO
      *
     FCAADREL9IF  E           K        DISK
      * RSQ : Warehouse Codes           ShipCo/Warehouse
      *
     FPNG0REL1IF  E           K        DISK
      * RTV : EDI WHS Interchange       Retrieval index
      *
     FOMHCCPL1IF  E           K        DISK
      * RTV : Physical Count Control    Retrieval index
      *
     FECP082L2IF  E           K        DISK
      * RSQ : EDI Whs Inv Inq Adv  NAM  Name Typ Cd, Id Cd
      *
     FECP080L1IF  E           K        DISK
      * RTV : EDI Whs Inv Inq Adv  HDR  Retrieval index
      *
      * Long constants
     E                    @CN#    1  02  6   @CN    25
     E                    YDOW        7  1               *Days of week
     I@JYREEY
      * Company Defaults Internal Plant Companies Only CO
      * Renamed input format fields
     I              JYAIC3                          WAAIC3
     I              JYZ9ST                          WAZ9ST
     I              JYCSST                          WACSST
     I              JYZ8ST                          WAZ8ST
     I              JYCXST                          WACXST
     I              JYSWST                          WASWST
     I              JYXXTM                          WAXXTM
     I              JYUECD                          WAUECD
     I              JYHSST                          WAHSST
     I              JYAMEO                          WAAMEO
     I              JYSSDF                          WASSDF
     I              JYPDFT                          WAPDFT
     I              JYYISX                          WAYISX
     I              JYYJSX                          WAYJSX
     I              JYYKSX                          WAYKSX
     I              JYYLSX                          WAYLSX
     I              JYYMSX                          WAYMSX
     I              JYYNSX                          WAYNSX
     I              JYUVST                          WAUVST
     I              JYUWST                          WAUWST
     I              JYUXST                          WAUXST
     I              JYVSST                          WAVSST
     I              JYAATM                          WAAATM
     I              JYAYNA                          WAAYNA
     I              JYA0NA                          WAA0NA
     I              JYAXDT                          WAAXDT
      *
     I@ADREWA
      * Warehouse Codes           ShipCo/Warehouse
      * Renamed input format fields
     I              ADAJCD                          WBAJCD
     I              ADF8NA                          WBF8NA
     I              ADACNA                          WBACNA
     I              ADADNA                          WBADNA
     I              ADAENA                          WBAENA
     I              ADAJNA                          WBAJNA
     I              ADBTTX                          WBBTTX
     I              ADAOCD                          WBAOCD
     I              ADBGCD                          WBBGCD
     I              ADVHST                          WBVHST
     I              ADMPNA                          WBMPNA
     I              ADWPST                          WBWPST
     I              ADXUST                          WBXUST
     I              ADT0ST                          WBT0ST
     I              ADT1ST                          WBT1ST
     I              ADDBNB                          WBDBNB
     I              ADT2ST                          WBT2ST
     I              ADT3ST                          WBT3ST
     I              ADT4ST                          WBT4ST
     I              ADT6ST                          WBT6ST
     I              ADBWC3                          WBBWC3
     I              ADBTC3                          WBBTC3
     I              ADBUC3                          WBBUC3
     I              ADBVC3                          WBBVC3
     I              ADFCAA                          WBFCAA
     I              ADRQSX                          WBRQSX
     I              ADRRSX                          WBRRSX
     I              ADRSSX                          WBRSSX
     I              ADRTSX                          WBRTSX
     I              ADT7ST                          WBT7ST
     I              ADT8ST                          WBT8ST
     I              ADRNSX                          WBRNSX
     I              ADROSX                          WBROSX
     I              ADRPSX                          WBRPSX
     I              ADUVST                          WBUVST
     I              ADUWST                          WBUWST
     I              ADUXST                          WBUXST
     I              ADVSST                          WBVSST
     I              ADAATM                          WBAATM
     I              ADAYNA                          WBAYNA
     I              ADA0NA                          WBA0NA
     I              ADAXDT                          WBAXDT
     I              ADQDSC                          WBQDSC
      *
     I@G0REJZ
      * EDI WHS Interchange       Retrieval index
      * Renamed input format fields
     I              G0AJCD                          WCAJCD
     I              G0M4AA                          WCM4AA
     I              G0M7AA                          WCM7AA
     I              G0J5NX                          WCJ5NX
     I              G0X2T1                          WCX2T1
     I              G0JBSC                          WCJBSC
     I              G0JCSC                          WCJCSC
     I              G0JDSC                          WCJDSC
     I              G0JESC                          WCJESC
     I              G0QGU1                          WCQGU1
     I              G0F5NZ                          WCF5NZ
     I              G0LSSC                          WCLSSC
     I              G0LTSC                          WCLTSC
     I              G0AHAB                          WCAHAB
     I              G0F6NZ                          WCF6NZ
     I              G0VSST                          WCVSST
     I              G0MJDT                          WCMJDT
     I              G0BETM                          WCBETM
     I              G0CCVN                          WCCCVN
     I              G0CDVN                          WCCDVN
     I              G0MKDT                          WCMKDT
     I              G0BFTM                          WCBFTM
     I              G0CEVN                          WCCEVN
     I              G0CFVN                          WCCFVN
      *
     I@HCCPJ0
      * Physical Count Control    Retrieval index
      * Renamed input format fields
     I              HCAIC3                          WDAIC3
     I              HCAJCD                          WDAJCD
     I              HCDHDT                          WDDHDT
     I              HCOFCD                          WDOFCD
     I              HCTGST                          WDTGST
     I              HCUVST                          WDUVST
     I              HCUWST                          WDUWST
     I              HCUXST                          WDUXST
     I              HCAATM                          WDAATM
     I              HCAYNA                          WDAYNA
     I              HCA0NA                          WDA0NA
     I              HCAXDT                          WDAXDT
      *
     I@A3CPC3
      * EDI Whs Inv Inq Adv  NAM  Name Typ Cd, Id Cd
      * Renamed input format fields
     I              A3H9NY                          WEH9NY
     I              A3TYPC                          WETYPC
     I              A3AMEX                          WEAMEX
     I              A3DCDQ                          WEDCDQ
     I              A3DCDE                          WEDCDE
     I              A3DD1X                          WEDD1X
     I              A3DD2X                          WEDD2X
     I              A3ITYX                          WEITYX
     I              A3TATE                          WETATE
     I              A3IPXX                          WEIPXX
     I              A3WFAA                          WEWFAA
      *
     I@A4CPC5
      * EDI Whs Inv Inq Adv  HDR  Retrieval index
      * Renamed input format fields
     I              A4H9NY                          WFH9NY
     I              A4HPAA                          WFHPAA
     I              A4A0ST                          WFA0ST
     I              A4XVAA                          WFXVAA
     I              A4XWAA                          WFXWAA
     I              A4IYU1                          WFIYU1
     I              A4HHSC                          WFHHSC
     I              A4HISC                          WFHISC
     I              A4ARTH                          WFARTH
      *
      /EJECT
      * Data structures:
     IPGMDS     ESDSY2PGDSP
      * Modified Program data structure
     IJBDTTM      DS
      * Job date/time
     I                                        1   70##JDT
     I                                        1   10##JCC
     I                                        2   30##JYY
     I                                        4   50##JMM
     I                                        6   70##JDD
     I                                        8  130##JTM
     I                                        8   90##JHH
     I                                       10  110##JNN
     I                                       12  130##JSS
      /EJECT
     IXDINT       DS
      * Internal date
     I                                        1   70XDINDT
     I                                        1   30XDINYY
     I                                        4   50XDINMM
     I                                        6   70XDINDD
     I            DS
     I                                        1 132 ZAMSDA
      * Message data for 'Auto EDI 846 Zero Invent'
      * Warehouse Code
     I                                        1   3 ZA0001
      * Message data for 'Auto EDI 846 Error Notify'
      * Warehouse Code
     I                                        1   3 ZA0002
      * Message data for 'ESNDMAIL-AutoInvRest-Co'
      * Email Address
     I                                        1  50 ZA0003
      * Subject Line USR
     I                                       51 150 ZA0004
      * Office Message USR
     I                                      151 282 ZA0005
      /EJECT
      *****************************************************************
      * Entry parameters
     C           *ENTRY    PLIST
     C                     PARM           P0RTN   7
      *****************************************************************
      * Initialize
     C                     EXSR ZZINIT
      *
      * Exc Auto EDI 846  Cmp  XF
      * Rtv Auto Inv EDI846 CmRT - Company Defaults Internal  * 
     C                     EXSR SARVGN
      *----------------------------------------------------------------
      * Exit program
     C           AAEXIT    TAG
     C                     MOVEL*BLANK    P0RTN
     C                     EXSR ZYEXPG
      *================================================================
      /EJECT
     CSR         SARVGN    BEGSR
      *================================================================
      * Rtv Auto Inv EDI846 CmRT - Company Defaults Internal  * 
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * Establish starting position
     C           *LOVAL    SETLL@JYREEY                    *
     C                     READ @JYREEY                  90*
      * Data record not found
     C   90                MOVEL'USR2025' W0RTN   7
     C           *IN90     DOWEQ'0'
      * USER: Process Data record
      * If record is active, process it
      * CASE: DB1.Record Status is Active
     C           WAVSST    IFEQ 'A'                        *IF
      * Determine if Auto Inventory Restoration set up for company
      *   and if it ran today - send email if not
      * RTV WHS Auto EDI846   RT - Warehouse  * 
     C                     EXSR SBRVGN
     C                     END                             *FI
     C                     READ @JYREEY                  90*
     C                     ENDDO
      *================================================================
     CSR         SAEXIT    ENDSR
      /EJECT
     CSR         SBRVGN    BEGSR
      *================================================================
      * RTV WHS Auto EDI846   RT - Warehouse  * 
      *================================================================
      *
     C                     Z-ADD*ZERO     WN0001  60       Day of the Week
      *
     C                     MOVEL*BLANK    W0RTN   7
      * USER: Initialize routine
     C                     Z-ADD*ZERO     YL0001           WHS Auto Inv Re
     C                     Z-ADD##JDT     YL0002           Physical Start
      * Declare restrictor key work fields
     C           *LIKE     DEFN WBBWC3    WQSB01           Shipping Compan
      * Define keylist
     C           KRSSB     KLIST
     C                     KFLD           WQSB01           Shipping Compan
      * Setup key
     C                     Z-ADDWAAIC3    WQSB01           Shipping Compan
      * Establish starting position
     C           KRSSB     SETLL@ADREWA                    *
     C           KRSSB     READE@ADREWA                  90*
      * Data record not found
     C   90                MOVEL'USR0007' W0RTN   7
     C           *IN90     DOWEQ'0'
      * USER: Process Data record
      * Rtv Whs 846 Active    RT - EDI WHS Interchange  * 
     C                     EXSR SCRVGN
      * CASE: LCL.Record Status is Active
     C           YL0003    IFEQ 'A'                        *IF
      * Rtv Auto Inv Rest Cmp  RT - Physical Count Control  * 
     C                     EXSR SDRVGN
      * CASE: PGM.*Return code is *Record already exists
     C           W0RTN     IFEQ @CN,001                    *IF
     C                     ELSE
      * CASE: *OTHERWISE
      * Send Email Message
      * Rtv Alpha Value       XF - Company Values  * 
     C                     CALL 'POMTXFR'              90  Rtv Alpha Value
     C                     PARM *BLANK    W0RTN   7
     C                     PARM WBBWC3    WQ0001  30       Company Number
     C                     PARM @CN,002   WQ0002 10        Company Value C
     C           YL0004    PARM *BLANK    WQ0003 40        System Value Al
      *
     C           *IN90     IFEQ '1'
      * Call to program ended in error
     C                     MOVEL'Y2U0032' W0RTN
     C                     MOVEL*BLANKS   W0CLPG 10
     C                     MOVEL'POMTXFR' W0CLPG
      * Send message '*Error occured on CALL...'
     C                     MOVEL'Y2U0032' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     MOVELW0CLPG    ZAMSDA           Message data
     C                     EXSR ZASNMS
     C                     END
      * Error detected?
     C           W0RTN     IFNE *BLANK
     C                     SETON                     99    *
     C                     END
      * If Email address is found, send email
      * CASE: LCL.Email Address is Entered
     C           YL0004    IFNE *BLANK                     *IF
      * R14364 DN 03/21/19-Send Email Based on EDI Frequency.
      * CASE: *OTHERWISE
     C                     MOVEL'N'       YL0005           Send Email USR
      * Rtv Frequency         RT - EDI WHS Interchange  * 
     C                     EXSR SERVGN
      * Check Frequency.
      * CASE:
      *  - NOTc1
      *   |- c1    : LCL.EDI Frequency is Not Entered
      *   '-
     C                     MOVEL'0'       Y0CX01  1
     C           YL0006    IFEQ *BLANK                     *IF
     C                     ELSE
     C                     MOVEL'1'       Y0CX01
     C                     END                             *FI
     C           Y0CX01    IFEQ '1'                        *IF
      * Send Email If ALL.
      * CASE: LCL.EDI Frequency is All
     C           YL0006    IFEQ 'ALL'                      *IF
     C                     MOVEL'Y'       YL0005           Send Email USR
     C                     END                             *FI
      * Set DOW Value from EDI Frequency.
      * CASE: LCL.EDI Frequency is Monday
     C           YL0006    IFEQ 'MON'                      *IF
     C                     Z-ADD1         WN0001           Day of the Week
     C                     ELSE
      * CASE: LCL.EDI Frequency is Tuesday
     C           YL0006    IFEQ 'TUE'                      *IF
     C                     Z-ADD2         WN0001           Day of the Week
     C                     ELSE
      * CASE: LCL.EDI Frequency is Wednesday
     C           YL0006    IFEQ 'WED'                      *IF
     C                     Z-ADD3         WN0001           Day of the Week
     C                     ELSE
      * CASE: LCL.EDI Frequency is Thurdsday
     C           YL0006    IFEQ 'THU'                      *IF
     C                     Z-ADD4         WN0001           Day of the Week
     C                     ELSE
      * CASE: LCL.EDI Frequency is Friday
     C           YL0006    IFEQ 'FRI'                      *IF
     C                     Z-ADD5         WN0001           Day of the Week
     C                     ELSE
      * CASE: LCL.EDI Frequency is Saturday
     C           YL0006    IFEQ 'SAT'                      *IF
     C                     Z-ADD6         WN0001           Day of the Week
     C                     ELSE
      * CASE: LCL.EDI Frequency is Sunday
     C           YL0006    IFEQ 'SUN'                      *IF
     C                     Z-ADD7         WN0001           Day of the Week
     C                     END                             *FI
     C                     END                             *FI
     C                     END                             *FI
     C                     END                             *FI
     C                     END                             *FI
     C                     END                             *FI
     C                     END                             *FI
      * LCL.Day of the Week # USR = JOB.*Job date *DAY OF WEEK
     C           ##JDT     ADD  1000000   XDINDT
     C                     EXSR XCVTA
     C           XDAY1     ADD  3         XDWK1   80
     C                     DIV  7         XDWK1
     C                     MVR            XDWK1
     C           XDWK1     IFEQ 0
     C                     Z-ADD7         XDWK1
     C                     END
     C           XDAY1     SUB  XDWK1     XDAY2   60
     C                     MOVEL'1'       XDSEL   1
     C                     MOVEL'1111111' XDCDW   7
     C                     EXSR XDOWS
     C                     MOVEL'NONE'    WUDLN  10
     C                     EXSR XDUDY
     C                     MOVE XDURR     YL0007
      * If DOW from Job Date & from EDI Frequency Match Then Send It.
      * CASE: LCL.Day of the Week # USR EQ PAR.Day of the Week # USR
     C           YL0007    IFEQ WN0001                     *IF
     C                     MOVEL'Y'       YL0005           Send Email USR
     C                     END                             *FI
     C                     END                             *FI
      * Send Email?
      * CASE: LCL.Send Email USR is Yes
     C           YL0005    IFEQ 'Y'                        *IF
      * Chk WHS rcvd in 846   RT - EDI Whs Inv Inq Adv  NAM  * 
     C                     EXSR SFRVGN
      * S028761 - If warehouse code is not found, set email subject
      * CASE: LCL.Warehouse Found is Warehouse Not Found
     C           YL0008    IFEQ 'N'                        *IF
      * Setup message data for message
     C                     MOVELWBAJCD    ZA0001           Warehouse Code
      * Retrieve message Auto EDI 846 Zero Invent
     C                     MOVELZADFMF    ZAMSGF
     C                     CALL 'Y2RVMGC'              90  *
     C                     PARM *BLANK    W0RTN   7        Return code
     C                     PARM 'USR5550' ZAMSID  7        Message ID
     C                     PARM           ZAMSGF 10        Message file
     C                     PARM           ZAMSDA           Message data
     C           YL0010    PARM           W0MTX 132        Returned messag
     C                     MOVEL*BLANK    ZAMSDA
     C                     MOVEL*BLANK    ZAMSGF
     C                     ELSE
      * CASE: *OTHERWISE
      * Setup message data for message
     C                     MOVELWBAJCD    ZA0002           Warehouse Code
      * Retrieve message Auto EDI 846 Error Notify
     C                     MOVELZADFMF    ZAMSGF
     C                     CALL 'Y2RVMGC'              90  *
     C                     PARM *BLANK    W0RTN   7        Return code
     C                     PARM 'USR5092' ZAMSID  7        Message ID
     C                     PARM           ZAMSGF 10        Message file
     C                     PARM           ZAMSDA           Message data
     C           YL0010    PARM           W0MTX 132        Returned messag
     C                     MOVEL*BLANK    ZAMSDA
     C                     MOVEL*BLANK    ZAMSGF
     C                     END                             *FI
      * Setup message data for message
     C                     MOVELYL0004    ZA0003           Email Address
     C                     MOVELYL0010    ZA0004           Subject Line US
     C                     MOVEL*BLANK    ZA0005           Office Message
      *
      * Execute message
     C                     MOVELZADFMF    ZAMSGF
     C                     CALL 'Y2EXMCC'              90  *
     C                     PARM *BLANK    W0RTN   7        Return code
     C                     PARM 'USR4974' ZAMSID  7        Message ID
     C                     PARM           ZAMSGF 10        Message file
     C                     PARM           ZAMSDA           Message data
     C                     MOVEL*BLANK    ZAMSDA
     C                     MOVEL*BLANK    ZAMSGF
      *
     C           *IN90     IFEQ '1'
      * Call to program ended in error
     C                     MOVEL'Y2U0032' W0RTN   7
     C                     END
      *
     C           W0RTN     IFNE *BLANK
      * Error detected during execution
     C                     SETON                     99    *
     C                     END
      *
     C                     END                             *FI
     C                     END                             *FI
     C                     END                             *FI
     C                     END                             *FI
     C           KRSSB     READE@ADREWA                  90*
     C                     ENDDO
      *================================================================
     CSR         SBEXIT    ENDSR
      /EJECT
     CSR         SCRVGN    BEGSR
      *================================================================
      * Rtv Whs 846 Active    RT - EDI WHS Interchange  * 
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * Define keylist
     C           KRSSC     KLIST
     C                     KFLD           WCAJCD           Warehouse Code
     C                     KFLD           WCM4AA           Interchange Cod
      * Setup key
     C                     MOVELWBAJCD    WCAJCD           Warehouse Code
     C                     MOVEL'WHSRST'  WCM4AA           Interchange Cod
      * Establish starting position
     C           KRSSC     CHAIN@G0REJZ              90    *
     C           *IN90     IFEQ '1'
      * Data record not found
     C                     MOVEL'USR4409' W0RTN   7
      * USER: Processing if Data record not found
      * PAR = CON By name
     C                     MOVEL*BLANK    YL0003           Record Status
     C                     GOTO SCEXIT
     C                     ENDIF
      *
     C           *IN90     IFEQ '0'
      * USER: Process Data record
      * PAR = DB1 By name
     C                     MOVELWCVSST    YL0003           Record Status
     C                     ENDIF
      *================================================================
     CSR         SCEXIT    ENDSR
      /EJECT
     CSR         SDRVGN    BEGSR
      *================================================================
      * Rtv Auto Inv Rest Cmp  RT - Physical Count Control  * 
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * Declare restrictor key work fields
     C           *LIKE     DEFN WDAIC3    WQSD01           Company Number
     C           *LIKE     DEFN WDAJCD    WQSD02           Warehouse Code
     C           *LIKE     DEFN WDDHDT    WQSD03           Physical Start
      * Define keylist
     C           KRSSD     KLIST
     C                     KFLD           WQSD01           Company Number
     C                     KFLD           WQSD02           Warehouse Code
     C                     KFLD           WQSD03           Physical Start
      * Setup key
     C                     Z-ADDWBBWC3    WQSD01           Company Number
     C                     MOVELWBAJCD    WQSD02           Warehouse Code
     C                     Z-ADDYL0002    WQSD03           Physical Start
      * Establish starting position
     C           KRSSD     SETLL@HCCPJ0                    *
     C           KRSSD     READE@HCCPJ0                  90*
     C           *IN90     IFEQ '1'
      * Data record not found
     C                     MOVEL'USR1487' W0RTN   7
      * USER: Processing if Data record not found
     C                     MOVEL'Y2U0005' W0RTN            *Return code
     C                     GOTO SDEXIT
     C                     ENDIF
      *
     C           *IN90     DOWEQ'0'
      * USER: Process Data record
     C                     MOVEL'Y2U0003' W0RTN            *Return code
     C           KRSSD     READE@HCCPJ0                  90*
     C                     ENDDO
      *================================================================
     CSR         SDEXIT    ENDSR
      /EJECT
     CSR         SERVGN    BEGSR
      *================================================================
      * Rtv Frequency         RT - EDI WHS Interchange  * 
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * USER: Initialize routine
      * PAR = CON By name
     C                     MOVEL*BLANK    YL0006           EDI Frequency
      * Define keylist
     C           KRSSE     KLIST
     C                     KFLD           WCAJCD           Warehouse Code
     C                     KFLD           WCM4AA           Interchange Cod
      * Setup key
     C                     MOVELWBAJCD    WCAJCD           Warehouse Code
     C                     MOVEL'WHSRST'  WCM4AA           Interchange Cod
      * Establish starting position
     C           KRSSE     CHAIN@G0REJZ              90    *
      * Data record not found
     C   90                MOVEL'USR4409' W0RTN   7
     C           *IN90     IFEQ '0'
      * USER: Process Data record
      * PAR = DB1 By name
     C                     MOVELWCJBSC    YL0006           EDI Frequency
     C                     ENDIF
      *================================================================
     CSR         SEEXIT    ENDSR
      /EJECT
     CSR         SFRVGN    BEGSR
      *================================================================
      * Chk WHS rcvd in 846   RT - EDI Whs Inv Inq Adv  NAM  * 
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * USER: Initialize routine
     C                     MOVEL'N'       YL0008           Warehouse Found
      * Declare restrictor key work fields
     C           *LIKE     DEFN WETYPC    WQSF01           N101-NAME TYPE
     C           *LIKE     DEFN WEDCDE    WQSF02           N104-ID CODE
      * Define keylist
     C           KRSSF     KLIST
     C                     KFLD           WQSF01           N101-NAME TYPE
     C                     KFLD           WQSF02           N104-ID CODE
      * Setup key
     C                     MOVE *BLANK    WQSF01           N101-NAME TYPE
     C                     MOVEL'WH'      WQSF01           N101-NAME TYPE
     C                     MOVELWBAJCD    WQSF02           N104-ID CODE
      * Establish starting position
     C           KRSSF     SETLL@A3CPC3                    *
     C           KRSSF     READE@A3CPC3                  90*
      * Data record not found
     C   90                MOVEL'USR5064' W0RTN   7
     C           *IN90     DOWEQ'0'
      * USER: Process Data record
      * Chk whs for 846 latest RT - EDI Whs Inv Inq Adv  HDR  * 
     C                     EXSR SGRVGN
     C                     GOTO SFEXIT                     *QUIT
     C           KRSSF     READE@A3CPC3                  90*
     C                     ENDDO
      *================================================================
     CSR         SFEXIT    ENDSR
      /EJECT
     CSR         SGRVGN    BEGSR
      *================================================================
      * Chk whs for 846 latest RT - EDI Whs Inv Inq Adv  HDR  * 
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * USER: Initialize routine
     C                     MOVEL'N'       YL0008           Warehouse Found
     C           YL0002    ADD  19000000  YL0009           BAI04 Adjustmen
      * Define keylist
     C           KRSSG     KLIST
     C                     KFLD           WFH9NY           EDI SURROGATE N
      * Setup key
     C                     Z-ADDWEH9NY    WFH9NY           EDI SURROGATE N
      * Establish starting position
     C           KRSSG     CHAIN@A4CPC5              90    *
      * Data record not found
     C   90                MOVEL'USR5066' W0RTN   7
     C           *IN90     IFEQ '0'
      * USER: Process Data record
      * CASE: DB1.BAI04 Adjustment Date EQ LCL.BAI04 Adjustment Date
     C           WFHHSC    IFEQ YL0009                     *IF
     C                     MOVEL'Y'       YL0008           Warehouse Found
     C                     END                             *FI
     C                     GOTO SGEXIT                     *QUIT
     C                     ENDIF
      *================================================================
     CSR         SGEXIT    ENDSR
      /EJECT
     CSR         XCVTA     BEGSR
      *================================================================
      * Convert date to absolute day (from 01/01/01)
      *================================================================
      * Absolute day =
      * 365*(YY-1)+(YY-1)/4 (past years w/extra days of leap ones) ...
     C           XDINYY    SUB  1         XDWK1   80
     C           XDWK1     MULT 365.25    XDAY1   60
     C           XDWK1     IFGE 300
     C                     SUB  2         XDAY1
     C                     ELSE
     C           XDWK1     IFGE 100
     C                     SUB  1         XDAY1
     C                     END
     C                     END
      * (from the beginning of the year to the beginning of the month:)
     C           XDINMM    SUB  1         XDWK1
     C           XDINMM    IFLT 3
      *     ...+31*(MM-1) (for January-February) ...
     C                     MULT 31        XDWK1
     C                     ADD  XDWK1     XDAY1
     C                     ELSE
      *     ...+30*(MM-1) (for March-December) ...
     C                     MULT 30        XDWK1
     C                     ADD  XDWK1     XDAY1
      *         ...-2 (for preceding February) ...
     C                     SUB  2         XDAY1
     C           XDINYY    IFNE 100
     C           XDINYY    ANDNE300
      *         ...+1 (for preceding February, if leap year) ...
     C           XDINYY    DIV  4         XDWK1
     C                     MVR            XDWK1
     C           XDWK1     IFEQ 0
     C                     ADD  1         XDAY1
     C                     END
     C                     END
     C           XDINMM    IFLT 8
      *         ...+MM/2 (preceding 31-sts for March-July) ...
     C           XDINMM    MULT .5        XDWK1
     C                     ADD  XDWK1     XDAY1
     C                     ELSE
      *         ...+(MM+1)/2 (same for August-December) ...
     C           XDINMM    ADD  1         XDWK1
     C                     MULT .5        XDWK1
     C                     ADD  XDWK1     XDAY1
     C                     END
     C                     END
      * ...+DD (days in the month up to the ending date)
     C                     ADD  XDINDD    XDAY1
      *================================================================
     CSR         XCVTAE    ENDSR
      /EJECT
     CSR         XDOWS     BEGSR
      *================================================================
      * Setup days of week array
      *================================================================
     C                     MOVEAXDCDW     YDOW
     C                     Z-ADD0         XDWSL   10
     C                     Z-ADD1         YY
     C           YY        DOWLE7
     C           YDOW,YY   IFEQ XDSEL
     C                     ADD  1         XDWSL
     C                     END
     C                     ADD  1         YY
     C                     END
      *================================================================
     CSR         XDOWSE    ENDSR
      /EJECT
     CSR         XDUDY     BEGSR
      *================================================================
      * Calculate duration, *DAYS
      *================================================================
     C           XDAY1     IFLT 1
     C           XDAY2     ORLT 1
     C                     Z-ADD0         XDURR
     C                     MOVEL'Y2U0006' W0RTN   7
     C                     GOTO XDUDYE
     C                     END
     C           XDAY1     IFGE XDAY2
      * From date2 to date1
     C                     Z-ADDXDAY2     XABEG   60
     C                     Z-ADDXDAY1     XAEND   60
     C                     ELSE
      * From date1 to date2
     C                     Z-ADDXDAY1     XABEG   60
     C                     Z-ADDXDAY2     XAEND   60
     C                     END
     C           XDWSL     IFEQ 0
      * None days of week selected
     C                     Z-ADD0         XDURR
     C                     GOTO XDUDYC
     C                     END
     C           XAEND     SUB  XABEG     XDURR   80
     C           XDWSL     IFEQ 7
      * All days of week selected
     C                     GOTO XDUDYC
     C                     END
      * Some days of week selected
     C                     DIV  7         XDURR
     C                     MVR            XDLSW   10
     C                     MULT XDWSL     XDURR
     C           XDLSW     IFNE 0
      * Determine day of week of the beginning date
     C           XABEG     ADD  3         YY      60
     C                     DIV  7         YY
     C                     MVR            YY
      * Loop: Increment the date by the last week
     C           XDLSW     DOWGT0
      * Increment the day of week
     C                     ADD  1         YY
     C                     SUB  1         XDLSW
      * Put day of week into the range 1-7
     C           YY        IFEQ 8
     C                     Z-ADD1         YY
     C                     END
      * Selected day of the last week has been processed
     C           YDOW,YY   IFEQ XDSEL
      * Increment duration
     C                     ADD  1         XDURR
     C                     END
      * End of loop
     C                     END
     C                     END
     C           XDUDYC    TAG
     C           XDURR     IFEQ 0
      * Return Code: Unable to calculate duration
     C                     MOVEL'Y2U0060' W0RTN   7
     C                     ELSE
     C                     MOVEL*BLANK    W0RTN   7
     C                     END
      *================================================================
     CSR         XDUDYE    ENDSR
      /EJECT
     CSR         ZASNMS    BEGSR
      *================================================================
      * Send message to program's message queue
      *================================================================
     C           ZAPGMQ    IFEQ *BLANK
     C                     MOVEL##PGM     ZAPGMQ
     C                     END
      * If no message file specified, use default
     C           ZAMSGF    IFEQ *BLANK
     C                     MOVELZADFMF    ZAMSGF
     C                     END
     C                     CALL 'Y2SNMGC'
     C                     PARM           ZAPGMQ 10        Program queue
     C                     PARM           ZAPGRL  5        Rel queue
     C                     PARM           ZAMSID  7        Message ID
     C                     PARM           ZAMSGF 10        Message file
     C                     PARM           ZAMSDA           Message data
     C                     PARM           ZAMSTP  7        Message type
      * Clear all fields for default mechanism next time
     C                     MOVEL*BLANK    ZAPGMQ
     C                     MOVEL*BLANK    ZAPGRL
     C                     MOVEL*BLANK    ZAMSID
     C                     MOVEL*BLANK    ZAMSGF
     C                     MOVEL*BLANK    ZAMSDA
     C                     MOVEL*BLANK    ZAMSTP
      *================================================================
     CSR         ZAEXIT    ENDSR
      /EJECT
     CSR         ZXEXPG    BEGSR
      *================================================================
      * Exit program: Normal
      *================================================================
     C                     EXSR ZYEXPG
      *================================================================
     CSR         ZXEXIT    ENDSR
      /EJECT
     CSR         ZYEXPG    BEGSR
      *================================================================
      * Exit program: Direct
      *================================================================
      * Terminate program
     C                     SETON                     LR
      *
      * Exit program
     C                     RETRN
      *
      *================================================================
     CSR         ZYEXIT    ENDSR
      /EJECT
     CSR         ZZINIT    BEGSR
      *================================================================
      * Initialisation
      *================================================================
     C           W0ICL     IFEQ *BLANK
     C                     MOVEL'Y'       W0ICL   1        *Initial call
     C                     ELSE
     C                     MOVEL'N'       W0ICL
     C                     END
     C                     MOVE *BLANK    P0RTN
     C                     MOVE *BLANK    W0RTN   7
     C                     MOVEL*BLANK    W0RSL   1
     C                     MOVEL*BLANK    W0RSF   1
     C                     MOVEL*ZEROS    W0RTW   90
     C                     MOVEL'400'     W0ENV   3
      *
      *
      * Retrieve job attributes
     C                     CALL 'Y2RTJCR'
     C                     PARM           PGMDS
      * Setup job date/time
     C                     Z-ADD##SD7     ##JDT
     C                     TIME           ##JTM
      * Update screen time
     C                     TIME           ##TME   60
      * Initialize renamed input format fields
     C                     Z-ADD*ZERO     WAAIC3           Company Number
     C                     Z-ADD*ZERO     WAXXTM           Departure Time
     C                     Z-ADD*ZERO     WAAATM           Job Time
     C                     Z-ADD*ZERO     WAAXDT           Job Date
      * Initialize renamed input format fields
     C                     Z-ADD*ZERO     WBDBNB           Warehouse Chill
     C                     Z-ADD*ZERO     WBBWC3           Shipping Compan
     C                     Z-ADD*ZERO     WBBTC3           Accounting Comp
     C                     Z-ADD*ZERO     WBBUC3           WHS Sched Prod
     C                     Z-ADD*ZERO     WBBVC3           WHS Inventory C
     C                     Z-ADD*ZERO     WBAATM           Job Time
     C                     Z-ADD*ZERO     WBAXDT           Job Date
      * Initialize renamed input format fields
     C                     Z-ADD*ZERO     WCF5NZ           EDI Company # 9
     C                     Z-ADD*ZERO     WCF6NZ           Hold til ship w
     C                     Z-ADD*ZERO     WCMJDT           Create Date
     C                     Z-ADD*ZERO     WCBETM           Create Time
     C                     Z-ADD*ZERO     WCMKDT           Change Date
     C                     Z-ADD*ZERO     WCBFTM           Change Time
      * Initialize renamed input format fields
     C                     Z-ADD*ZERO     WDAIC3           Company Number
     C                     Z-ADD*ZERO     WDDHDT           Physical Start
     C                     Z-ADD*ZERO     WDAATM           Job Time
     C                     Z-ADD*ZERO     WDAXDT           Job Date
      * Initialize renamed input format fields
     C                     Z-ADD*ZERO     WEH9NY           EDI SURROGATE N
      * Initialize renamed input format fields
     C                     Z-ADD*ZERO     WFH9NY           EDI SURROGATE N
     C                     Z-ADD*ZERO     WFHHSC           BAI04 Adjustmen
     C                     Z-ADD*ZERO     WFARTH           BAI05 Adjustmen
      * Obtain default message file
     C           *NAMVAR   DEFN CAMGFLA   ZADFMF 10
     C                     IN   ZADFMF
      * Dummy move for compiler
     C                     MOVE '0'       @CN#,1
     C                     MOVEL@CN,1     @CN,1
     C                     MOVEL'N'       W0PMT   1
      * Define local work field WHS Auto Inv Rest Cnt USR
     C                     Z-ADD*ZERO     YL0001  30
      * Define local work field Physical Start Date
     C                     Z-ADD*ZERO     YL0002  70
      * Define local work field Record Status
     C                     MOVEL*BLANK    YL0003  1
      * Define local work field Email Address
     C                     MOVEL*BLANK    YL0004 50
      * Define local work field Send Email USR
     C                     MOVEL*BLANK    YL0005  1
      * Define local work field EDI Frequency
     C                     MOVEL*BLANK    YL0006  3
      * Define local work field Day of the Week # USR
     C                     Z-ADD*ZERO     YL0007  60
      * Define local work field Warehouse Found
     C                     MOVEL*BLANK    YL0008  1
      * Define local work field BAI04 Adjustment Date
     C                     Z-ADD*ZERO     YL0009  80
      * Define local work field Subject Line USR
     C                     MOVEL*BLANK    YL0010100
      *================================================================
     CSR         ZZEXIT    ENDSR
** @CN
00001 Y2U0003
00002 EDI846CMP
