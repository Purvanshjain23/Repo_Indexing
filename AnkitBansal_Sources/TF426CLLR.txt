/***************************************************************** */
/*                                                                 */
/*  SYSTEM:          TRIUMPH FOODS                                 */
/*  PROGRAM NUMBER:  TF426CL                                       */
/*  PROGRAM NAME:    AR ADJUSTMENT LISTING                         */
/*  PROGRAMMER:      LEANNE RAMSEY                                 */
/*  CREATE DATE:     01/23/08                                      */
/*                                                                 */
/*  FUNCTION:        THIS REPORT IS GENERATED:                     */
/*                    1) ON-DEMAND                                 */
/*                    2) FROM THE WEEKLY REVENUE CLOSE FUNCTION    */
/*                                                                 */
/*******************************************************************/
/* MODIFIED:                                                       */
/*                                                                 */
/* 01/29/08  LEANNE RAMSEY                                         */
/*           WE HAVE ADDED MORE SELECTIONS TO THE LISTING. SO,     */
/*           WE WILL NOW DO AN OPEN QUERY TO SELECT RECORDS.       */
/*                                                                 */
/* 05/06/09  LEANNE RAMSEY                                         */
/*           CHANGED PRINT LOGIC TO MATCH MEAT COSTING.            */
/*                                                                 */
/* 09/10/09  LEANNE RAMSEY                                         */
/*           ADDED REPORT SELECTIONS: DETAIL/SUMMARY               */
/*                                    AR CUSTOMER                  */
/*                                                                 */
/* 10/01/09  LEANNE RAMSEY                                         */
/*           ADDED REPORT SELECTIONS: G/L POST METHOD CODE         */
/*                                    PAYOUT CODE                  */
/*                                                                 */
/* 07/01/10  LEANNE RAMSEY                                         */
/*           Replaced POCD (Payout Code) with POFL (Payout Flag).  */
/*******************************************************************/

             PGM

             DCL        VAR(&QDATA) TYPE(*CHAR) LEN(235)

             DCL        VAR(&OUTQ) TYPE(*CHAR) LEN(10)
             DCL        VAR(&HOLD) TYPE(*CHAR) LEN(4)
             DCL        VAR(&SAVE) TYPE(*CHAR) LEN(4)
             DCL        VAR(&COPY) TYPE(*DEC)  LEN(1)

             DCL        VAR(&EMAIL)     TYPE(*CHAR) LEN(38)
             DCL        VAR(&LDPFCD)    TYPE(*CHAR) LEN(1)
             DCL        VAR(&TSTPRDFL)  TYPE(*CHAR) LEN(1)

             DCL        VAR(&LDFWECYMD) TYPE(*DEC)  LEN(8)
             DCL        VAR(&LDTWECYMD) TYPE(*DEC)  LEN(8)
             DCL        VAR(&LDCONO)    TYPE(*DEC)  LEN(3)
             DCL        VAR(&LDAJTY)    TYPE(*CHAR) LEN(3)
             DCL        VAR(&LDCC)      TYPE(*CHAR) LEN(12)
             DCL        VAR(&LDOBJ)     TYPE(*CHAR) LEN(6)
             DCL        VAR(&LDSUB)     TYPE(*CHAR) LEN(8)
             DCL        VAR(&LDCUNO)    TYPE(*DEC)  LEN(7)
             DCL        VAR(&LDDSFL)    TYPE(*CHAR) LEN(1)
             DCL        VAR(&LDPMCD)    TYPE(*CHAR) LEN(1)
             DCL        VAR(&LDPOFL)    TYPE(*CHAR) LEN(1)

             CHGVAR     VAR(&LDPFCD)    VALUE(%SST(*LDA 37 1))
             CHGVAR     VAR(&LDFWECYMD) VALUE(%SST(*LDA 52 8))
             CHGVAR     VAR(&LDTWECYMD) VALUE(%SST(*LDA 60 8))
             CHGVAR     VAR(&LDCONO)    VALUE(%SST(*LDA 71 3))
             CHGVAR     VAR(&LDAJTY)    VALUE(%SST(*LDA 74 3))
             CHGVAR     VAR(&LDCC)      VALUE(%SST(*LDA 77 12))
             CHGVAR     VAR(&LDOBJ)     VALUE(%SST(*LDA 89 6))
             CHGVAR     VAR(&LDSUB)     VALUE(%SST(*LDA 95 8))
             CHGVAR     VAR(&LDCUNO)    VALUE(%SST(*LDA 103 7))
             CHGVAR     VAR(&LDDSFL)    VALUE(%SST(*LDA 140 1))
             CHGVAR     VAR(&LDPMCD)    VALUE(%SST(*LDA 141 1))
             CHGVAR     VAR(&LDPOFL)    VALUE(%SST(*LDA 172 1))

/*----------------------------------------------------------------*/
/* FOR SENDING EMAILS:                                            */
/* RETRIEVE DATA AREA THAT LETS US KNOW WHETHER WE ARE IN TEST    */
/* OR PRODUCTION (ALWAYS DEFAULT TO THE "TEST" DISTRIBUTION LIST.)*/
/*----------------------------------------------------------------*/

             CHGVAR     VAR(&EMAIL) VALUE('TF Test')
             RTVDTAARA  DTAARA(DATSTPRD (1 1)) RTNVAR(&TSTPRDFL)

/*----------------------------------------------------------------*/
/* RETRIEVE/SET PRINT DEFAULTS                                    */
/*----------------------------------------------------------------*/

 OUTQ:       CHGVAR     VAR(&OUTQ) VALUE(%SST(*LDA 401 10))
             IF         COND(&OUTQ = '          ') THEN(CHGVAR +
                          VAR(&OUTQ) VALUE(*JOB))

 HOLD:       CHGVAR     VAR(&HOLD) VALUE(%SST(*LDA 411 4))
             IF         COND(&LDPFCD = 'F') THEN(CHGVAR VAR(&HOLD) +
                          VALUE(*YES))
             IF         COND(&HOLD *NE '*YES' *AND &HOLD *NE '*NO ') +
                          THEN(CHGVAR VAR(&HOLD) VALUE(*NO))

 SAVE:       CHGVAR     VAR(&SAVE) VALUE(%SST(*LDA 415 4))
             IF         COND(&LDPFCD *NE 'D') THEN(DO)
             CHGVAR     VAR(&SAVE) VALUE(*YES)
             ENDDO
             IF         COND(&SAVE *NE '*YES' *AND &SAVE *NE '*NO ') +
                          THEN(CHGVAR VAR(&SAVE) VALUE(*NO))

 COPY:       CHGVAR     VAR(&COPY) VALUE(%SST(*LDA 419 1))
             IF         COND(&COPY = 0) THEN(CHGVAR VAR(&COPY) +
                          VALUE(1))

/*--------------------------------------------------------------------------*/
/*  Extract data from the TFS AR Adjustments file                           */
/*--------------------------------------------------------------------------*/

             CHGVAR     VAR(&QDATA) VALUE(' ')

             CHGVAR     VAR(%SST(&QDATA 1 11)) VALUE('AJRWEDT *GE')
             CHGVAR     VAR(%SST(&QDATA 13 8)) VALUE(&LDFWECYMD)
             CHGVAR     VAR(%SST(&QDATA 22 16)) VALUE('*AND AJRWEDT +
                          *LE')
             CHGVAR     VAR(%SST(&QDATA 39 8)) VALUE(&LDTWECYMD)

/* IF COMPANY                                                       */

             IF         COND(&LDCONO *NE 0) THEN(DO)
             CHGVAR     VAR(%SST(&QDATA 48 15)) VALUE('*AND AJCONO *EQ')
             CHGVAR     VAR(%SST(&QDATA 64 3)) VALUE(&LDCONO)
             ENDDO

/* IF ADJUSTMENT TYPE                                               */

             IF         COND(&LDAJTY *NE ' ') THEN(DO)
             CHGVAR     VAR(%SST(&QDATA 68 17)) VALUE('*AND AJAJTY *EQ "')
             CHGVAR     VAR(%SST(&QDATA 85 3)) VALUE(&LDAJTY)
             CHGVAR     VAR(%SST(&QDATA 88 1)) VALUE('"')
             ENDDO

/* IF COST CENTER                                                   */

             IF         COND(&LDCC *NE ' ') THEN(DO)
             CHGVAR     VAR(%SST(&QDATA 90 15)) VALUE('*AND AJCC *EQ "')
             CHGVAR     VAR(%SST(&QDATA 105 12)) VALUE(&LDCC)
             CHGVAR     VAR(%SST(&QDATA 117 1)) VALUE('"')
             ENDDO

/* IF OBJECT                                                        */
             IF         COND(&LDOBJ *NE ' ') THEN(DO)
             CHGVAR     VAR(%SST(&QDATA 119 16)) VALUE('*AND AJOBJ *EQ "')
             CHGVAR     VAR(%SST(&QDATA 135 6)) VALUE(&LDOBJ)
             CHGVAR     VAR(%SST(&QDATA 141 1)) VALUE('"')
             ENDDO

/* IF SUBSIDIARY                                                    */
             IF         COND(&LDSUB *NE ' ') THEN(DO)
             CHGVAR     VAR(%SST(&QDATA 143 16)) VALUE('*AND AJSUB *EQ "')
             CHGVAR     VAR(%SST(&QDATA 159 8)) VALUE(&LDSUB)
             CHGVAR     VAR(%SST(&QDATA 167 1)) VALUE('"')
             ENDDO

/* IF A/R CUSTOMER                                                  */
             IF         COND(&LDCUNO *NE 0) THEN(DO)
             CHGVAR     VAR(%SST(&QDATA 169 17)) VALUE('*AND AJARCUNO *EQ')
             CHGVAR     VAR(%SST(&QDATA 187 7)) VALUE(&LDCUNO)
             ENDDO

/* IF G/L POST METHOD CODE                                          */
             IF         COND(&LDPMCD *NE ' ') THEN(DO)
             CHGVAR     VAR(%SST(&QDATA 195 17)) VALUE('*AND AJPMCD *EQ "')
             CHGVAR     VAR(%SST(&QDATA 212 1)) VALUE(&LDPMCD)
             CHGVAR     VAR(%SST(&QDATA 213 1)) VALUE('"')
             ENDDO

/* IF PAYOUT FLAG                                                   */
             IF         COND(&LDPOFL *NE ' ') THEN(DO)
             CHGVAR     VAR(%SST(&QDATA 215 17)) VALUE('*AND AJPOFL *EQ "')
             CHGVAR     VAR(%SST(&QDATA 232 1)) VALUE(&LDPOFL)
             CHGVAR     VAR(%SST(&QDATA 233 1)) VALUE('"')
             ENDDO

             OVRDBF     FILE(TFL026A)  SHARE(*YES)
             OPNQRYF    FILE((TFL026A)) QRYSLT(&QDATA) KEYFLD(*FILE)  +
                          SEQONLY(*YES)

/*--------------------------------------------------------------------------*/
/*  Run the Detail or Summary or Both the Detail and Summary Versions       */
/*--------------------------------------------------------------------------*/

             OVRPRTF    FILE(PRINT198) OUTQ(&OUTQ) COPIES(&COPY) +
                          HOLD(&HOLD) SAVE(&SAVE)

/* Detail */
             IF         COND(&LDDSFL *EQ 'D' *OR &LDDSFL *EQ 'B') +
                          THEN(DO)
             CALL       PGM(TF626) PARM('D')
             ENDDO

/* Summary */
             IF         COND(&LDDSFL *EQ 'S' *OR &LDDSFL *EQ 'B') +
                          THEN(DO)
             CALL       PGM(TF626) PARM('S')
             ENDDO

             CLOF       OPNID(TFL026A)
             DLTOVR     FILE(TFL026A)

/*--------------------------------------------------------------------------*/
/* If this is a "Final" run out of the Weekly Revenue Close                 */
/* (and you are in the "production" environment),                           */
/*    e-mail the report to a distribution list                              */
/*    dup the report to another spool file                                  */
/*--------------------------------------------------------------------------*/

             IF         COND(&LDPFCD *EQ 'F') THEN(DO)          /* If Final */

             IF         COND(&TSTPRDFL *EQ 'P') THEN(CHGVAR +
                        VAR(&EMAIL) VALUE('TF Revenue Close-Admin'))

             ESNDMAIL   RECIPIENT(&EMAIL) SUBJECT('AR Adjustment +
                          Listing') MSG('Distribution List: TF +
                          Revenue Close-Admin') ATTLIST((* *PDF *N +
                          PRINT198 *))
             MONMSG     MSGID(CPF0000)

             IF         COND(&TSTPRDFL *EQ 'P') THEN(DO)
             DUPSPLF    FILE(PRINT198) OUTQ(TFPRTDUP) SPLNBR(*LAST) +
                          HOLD(*NO)
             MONMSG     MSGID(CPF0000)
             ENDDO

             ENDDO                                              /* If Final */

             DLTOVR     FILE(*ALL)

             ENDPGM

