// ?------------------------------------------------------------------------------------------------
// ?Synon action diagram for PPVTPVR
// ?Date: 14.08.2025 Time: 03:42:03
// ?------------------------------------------------------------------------------------------------

//?USER: Validate fields

//?R9083 02/05/17 DN-Modify to Read By Grouping/WE Date.
EXECUTE FUNCTION(Rtv Post Status-Both  RT) TYPE(RTVOBJ) FILE(PPBSCPP)           AC1768440;
PARAMETER(DTL.ISC_Valuation_Grouping);
PARAMETER(DTL.ISC_Week_Ending_Date);
PARAMETER(WRK.ISC_Warehouse_Company);
PARAMETER(WRK.ISC_Post_Balance_Sts);
PARAMETER(WRK.ISC_Post_Warehouse_Sts);
{
 //?USER: Initialize routine

 // WRK.Record Found USR = CND.Record Found
 WRK.Record_Found_USR = 'Y';

 //?USER: Processing if Data record not found

 MOVE *ALL (To: PAR From: CON);

 // PGM.*Return code = CND.*Record does not exist
 PGM.*Return_code = 'Y2U0005';

 //?USER: Process Data record

 CASE;

 // IF DB1.ISC Post Balance Sts is Open
 IF DB1.ISC_Post_Balance_Sts = 'O';

 // OR DB1.ISC Post Warehouse Sts is Open
 OR ( DB1.ISC_Post_Warehouse_Sts = 'O';

 // AND DB1.ISC Item Type is Finished Good
 AND DB1.ISC_Item_Type = 'FG' );

 // PAR.ISC Post Balance Sts = DB1.ISC Post Balance Sts
 PAR.ISC_Post_Balance_Sts = DB1.ISC_Post_Balance_Sts;

 // PAR.ISC Post Warehouse Sts = DB1.ISC Post Warehouse Sts
 PAR.ISC_Post_Warehouse_Sts = DB1.ISC_Post_Warehouse_Sts;

 // PAR.ISC Warehouse Company = DB1.ISC Warehouse Company
 PAR.ISC_Warehouse_Company = DB1.ISC_Warehouse_Company;

 QUIT;

 // IF *OTHERWISE
 IF *OTHERWISE;

 // PAR.ISC Post Balance Sts = DB1.ISC Post Balance Sts
 PAR.ISC_Post_Balance_Sts = DB1.ISC_Post_Balance_Sts;

 // PAR.ISC Post Warehouse Sts = DB1.ISC Post Warehouse Sts
 PAR.ISC_Post_Warehouse_Sts = DB1.ISC_Post_Warehouse_Sts;

 // PAR.ISC Warehouse Company = DB1.ISC Warehouse Company
 PAR.ISC_Warehouse_Company = DB1.ISC_Warehouse_Company;

 ENDIF;

}


CASE;

// IF PGM.*Return code is *Record does not exist
IF PGM.*Return_code = 'Y2U0005';

// Send error message - 'Inventory Stock Closing not found.'
ERROR(USR3529);

ENDIF;

// LCL.ISC Week Ending Date = DTL.ISC Week Ending Date + CON.-7 *DAYS
LCL.ISC_Week_Ending_Date = DATEINCR(DTL.ISC_Week_Ending_Date '-7' 'DY' 1111111 'NONE'              +
'N' 1);

//?R9083 02/05/17 DN-Modify to Read By Grouping/WE Date.
EXECUTE FUNCTION(Rtv Post Status-Both  RT) TYPE(RTVOBJ) FILE(PPBSCPP)           AC1768440;
PARAMETER(DTL.ISC_Valuation_Grouping);
PARAMETER(LCL.ISC_Week_Ending_Date);
PARAMETER(LCL.ISC_Warehouse_Company);
PARAMETER(LCL.ISC_Post_Balance_Sts);
PARAMETER(LCL.ISC_Post_Warehouse_Sts);
{
 //?USER: Initialize routine

 // WRK.Record Found USR = CND.Record Found
 WRK.Record_Found_USR = 'Y';

 //?USER: Processing if Data record not found

 MOVE *ALL (To: PAR From: CON);

 // PGM.*Return code = CND.*Record does not exist
 PGM.*Return_code = 'Y2U0005';

 //?USER: Process Data record

 CASE;

 // IF DB1.ISC Post Balance Sts is Open
 IF DB1.ISC_Post_Balance_Sts = 'O';

 // OR DB1.ISC Post Warehouse Sts is Open
 OR ( DB1.ISC_Post_Warehouse_Sts = 'O';

 // AND DB1.ISC Item Type is Finished Good
 AND DB1.ISC_Item_Type = 'FG' );

 // PAR.ISC Post Balance Sts = DB1.ISC Post Balance Sts
 PAR.ISC_Post_Balance_Sts = DB1.ISC_Post_Balance_Sts;

 // PAR.ISC Post Warehouse Sts = DB1.ISC Post Warehouse Sts
 PAR.ISC_Post_Warehouse_Sts = DB1.ISC_Post_Warehouse_Sts;

 // PAR.ISC Warehouse Company = DB1.ISC Warehouse Company
 PAR.ISC_Warehouse_Company = DB1.ISC_Warehouse_Company;

 QUIT;

 // IF *OTHERWISE
 IF *OTHERWISE;

 // PAR.ISC Post Balance Sts = DB1.ISC Post Balance Sts
 PAR.ISC_Post_Balance_Sts = DB1.ISC_Post_Balance_Sts;

 // PAR.ISC Post Warehouse Sts = DB1.ISC Post Warehouse Sts
 PAR.ISC_Post_Warehouse_Sts = DB1.ISC_Post_Warehouse_Sts;

 // PAR.ISC Warehouse Company = DB1.ISC Warehouse Company
 PAR.ISC_Warehouse_Company = DB1.ISC_Warehouse_Company;

 ENDIF;

}


//?Post Balance Sts is Open
CASE;

// IF WRK.ISC Post Balance Sts is Open
IF WRK.ISC_Post_Balance_Sts = 'O';

//?R12069 11/20/17 DN-Added ISC Warehouse Company Txt to Message.
// LCL.ISC Warehouse Company Txt = CVTVAR(LCL.ISC Warehouse Company)
LCL.ISC_Warehouse_Company_Txt = CVTVAR(LCL.ISC_Warehouse_Company);

// Send error message - 'Error Post not allowed. Stock Close not posted for &2, group &3.'
ERROR(USR3546);
MSGPARM(LCL.ISC_Week_Ending_Date);
MSGPARM(DTL.ISC_Valuation_Grouping);
MSGPARM(LCL.ISC_Warehouse_Company_Txt);

ENDIF;

//?Check last week's post sts
CASE;

// IF LCL.ISC Post Warehouse Sts is Open
IF LCL.ISC_Post_Warehouse_Sts = 'O';

//?R9083 02/20/17 DN-Modified to Add Grouping to Message.
// Send error message - 'Error: Post has not been done for previous week &1, group &2.'
ERROR(USR3540);
MSGPARM(LCL.ISC_Week_Ending_Date);
MSGPARM(DTL.ISC_Valuation_Grouping);

ENDIF;

//?USER: User defined action

//?R9083 02/05/17 DN-Modify to Also Process by Grouping/WE Date.
//?Added parms:Warehouse Company, Week end date, Date Sun USR(N)
// Call program Exc Post Whse Prices  XF.
CALL PROGRAM(Exc Post Whse Prices  XF) ('PPORXFR');
PARAMETER(DTL.ISC_Week_Ending_Date);
PARAMETER(WRK.ISC_Warehouse_Company);
PARAMETER(DTL.ISC_Valuation_Grouping);
PARAMETER(PAR.Week_End_Date);

// PAR.Post Flag USR = CND.Yes
PAR.Post_Flag_USR = 'Y';

