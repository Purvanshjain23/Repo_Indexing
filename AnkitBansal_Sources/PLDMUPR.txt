/***************************************************************** */
/*                                                                 */
/*  PROGRAM NUMBER:  PLDMUPR                                       */
/*  PROGRAM NAME:    UPL EVAL TRANS UPL TO FTP SITE        */
/*  PROGRAMMER:      ROSE CENTONZE                                 */
/*  CREATE DATE:     07/22/03                                      */
/*                                                                 */
/*  FUNCTION:        THIS CL IS CALLED FROM THE HOT SCALE UPL PROC */
/*                                                                 */
/*******************************************************************/
/*  Modification History                                           */
/*  RMC  03/18/04  USE THE MORRISON HOT SCALE FORMULA INSTEAD OF THE FOM */
/*  RMC  04/09/04  USE SQL VIEW FOMUPL - ADDED NEW FIELDS          */
/*  RMC  04/15/04  IF SHIFT IS ENTERED, DO 1ST SQL ELSE DO  THE AFTER      */
/*                 PAYMENT POST SQL                                */
/*  RMC  05/11/04  IF HOT WEIGHT < 100 DONT DO CALC                */
/*  RMC  05/20/21  DONT DO IF TEST - CHK DTAARA DATSTPRD           */
/*******************************************************************/
             PGM        PARM(&RTNCDE &KILLDT &SHIFT)
             DCL        VAR(&RTNCDE) TYPE(*CHAR) LEN(7)
             DCL        VAR(&KILLDT) TYPE(*DEC) LEN(7 0)
             DCL        VAR(&KILLDA) TYPE(*CHAR) LEN(7)
             DCL        VAR(&KILLMD) TYPE(*CHAR) LEN(4)
             DCL        VAR(&SHIFT) TYPE(*CHAR) LEN(1)
             DCL        VAR(&SEL) TYPE(*CHAR) LEN(500)
             DCL        VAR(&DOCUM) TYPE(*CHAR) LEN(08)
             DCL        VAR(&REC) TYPE(*CHAR) LEN(50)
             DCL        VAR(&TSTPRDFL)   TYPE(*CHAR) LEN(1)
             CHGVAR     VAR(&KILLDA) VALUE(&KILLDT)
             CHGVAR     VAR(&KILLMD) VALUE(%SST(&KILLDA 4 4))
             RTVDTAARA  DTAARA(DATSTPRD (1 1)) RTNVAR(&TSTPRDFL)

             IF         COND(&TSTPRDFL *EQ 'T')  THEN(GOTO ENDPGM)

  /* ORIGINAL FORMULA BEFORE   03/18/04                              */
  /* CHGVAR     VAR(&DOCUM) VALUE('FOM' *CAT &KILLMD *CAT &SHIFT) */
             GOTO       CMDLBL(WHENUPL)
             CHGVAR     VAR(&SEL) VALUE('SELECT   CPB7DT +
                          COLHDG("KILL" "DATE"), CPAOTM +
                          COLHDG("TIME"),  +
                  CPKHNB  COLHDG("TATTOO" "NUMBER"),  +
                          CPKJNB COLHDG("HOT" "WEIGHT"),         +
                  CPX6NB  COLHDG("BACKFAT" "MM"), CPFQPC +
                          COLHDG("LOINEYE" "MM"), +
                          58.86-(.61*CPX6NB)+(.12*CPFQPC) LEN(7,2)  +
                          NAME(LEAN)   COLHDG("LEAN %"),            +
                   CPX7ST COLHDG("BROKEN" "BACK STS"), CPHMST +
                          COLHDG("TRIM" "AREA") FROM     +
                          PKCPCPP    WHERE    CPB7DT=' *CAT +
             &KILLDA *CAT 'AND CPHLST=' *CAT '"' *CAT &SHIFT *CAT '"')

  /* NEW FORMULA AS OF   03/18/04                              */

 WHENUPL:   IF COND(&SHIFT = ' ') THEN(GOTO PAYMPOST)

     CHGVAR     VAR(&DOCUM) VALUE('FOM' *CAT &KILLMD *CAT &SHIFT)
             CHGVAR     VAR(&SEL) VALUE('SELECT   CPB7DT +
                          COLHDG("KILL" "DATE"), CPAOTM +
                          COLHDG("TIME"),  +
                  CPKHNB  COLHDG("TATTOO" "NUMBER"),  +
                          CPKJNB COLHDG("HOT" "WEIGHT"),         +
                  CPX6NB  COLHDG("BACKFAT" "MM"), CPFQPC +
                          COLHDG("LOINEYE" "MM"), +
                          CASE  WHEN CPKJNB<100 THEN 0 ELSE   +
     ((2.827+(.469*CPKJNB)-(.7271657*CPX6NB)+(.3867718*CPFQPC))/CPKJNB)*100 +
               END        NAME(LEAN)   COLHDG("LEAN %") LEN(4,2),   +
                   CPX7ST COLHDG("BROKEN" "BACK STS"), CPHMST +
                          COLHDG("TRIM" "AREA") FROM     +
                          PKCPCPP    WHERE    CPB7DT=' *CAT +
             &KILLDA *CAT 'AND CPHLST=' *CAT '"' *CAT &SHIFT *CAT '"')
             CHGVAR     VAR(&REC) VALUE('FTP:DOWNLOAD.PORK%FOM/' +
                          *CAT &DOCUM *TCAT '.xls')
             EXECUTE    SQL(&SEL) PCFMT(*XLS) RECIPIENT(&REC)

             GOTO ENDPGM

/* NEW AS OF   04/09/04                              */
PAYMPOST:
             CHGVAR     VAR(&DOCUM) VALUE('FOM' *CAT &KILLMD)
             CHGVAR     VAR(&REC) VALUE('FTP:DOWNLOAD.PORK%FOM/' +
                          *CAT &DOCUM *TCAT '.xls')
             EXECUTE    VIEW(PRKPLIB/FOMUPL) PCFMT(*XLS) +
                          RECIPIENT(&REC) SETVAR((&KILLDT &KILLDA))
             SNDPGRMSG  TOPGR(PRKFOMUPL) MSG('FOM Upload Complete +
                          for Kill Date' *BCAT &KILLMD) CONFMSG(*NO)
             ENDPGM:
                          ENDPGM
