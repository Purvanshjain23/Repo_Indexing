/***************************************************************** */
/*                                                                 */
/*  PROGRAM NUMBER:  HP4034CL                                      */
/*  PROGRAM NAME:    SIRE LINE DOWNLOAD                            */
/*  PROGRAMMER:      LEANNE RAMSEY                                 */
/*  CREATE DATE:     12/19/08                                      */
/*                                                                 */
/*  FUNCTION:        THIS CL IS SUBMITTED WITH QCMDEXC FROM        */
/*                   HP4034-SPECIFY OPTIONS FOR SIRE LINE DOWNLOAD */
/*                                                                 */
/*                   OPTIONS ARE PASSED THROUGH THE LDA.           */
/*                                                                 */
/*-----------------------------------------------------------------*/
/*  MODIFICATIONS LOG:                                             */
/*-----------------------------------------------------------------*/
/*‚06/12/24  Jagdish Mistry (JM-WI628),                            */
/*‚          Project 628-RabApp Bypass to Agview                   */
/*‚          a. Added parameter to HP3034                          */
/*‚          b. Deactivate ESND email notifications                */
/*‚08/01/24  Jagdish Mistry (JM-WI628),                            */
/*‚          1)Changed .CSV to .XLSX to get back Header for user   */
/*‚08/21/24  Jagdish Mistry (JM-S027448) Reactivate ESND           */
/*******************************************************************/

             PGM

             DCL        VAR(&QDATA)  TYPE(*CHAR) LEN(100)

             DCL        VAR(&LDFWEDT) TYPE(*DEC)  LEN(8)
             DCL        VAR(&LDTWEDT) TYPE(*DEC)  LEN(8)
             DCL        VAR(&LDFSCD)  TYPE(*DEC)  LEN(5)
             DCL        VAR(&LDSICD)  TYPE(*CHAR) LEN(5)
             DCL        VAR(&LDEMAIL) TYPE(*CHAR) LEN(50)
/*‚JM-WI628-START                                                        */
/*           DCL        VAR(&FLAG)    TYPE(*CHAR) LEN(1)                 */
             DCL        VAR(&TOTALCNT) TYPE(*DEC) LEN(8 0)
/*‚JM-WI628-END                                                          */

             CHGVAR     VAR(&LDFWEDT) VALUE(%SST(*LDA 1 8))
             CHGVAR     VAR(&LDTWEDT) VALUE(%SST(*LDA 9 8))
             CHGVAR     VAR(&LDFSCD)  VALUE(%SST(*LDA 17 5))
             CHGVAR     VAR(&LDSICD)  VALUE(%SST(*LDA 22 5))
             CHGVAR     VAR(&LDEMAIL) VALUE(%SST(*LDA 300 50))

/*-----------------------------------------------------------------*/
/* CREATE THE WORKFILE                                             */
/*-----------------------------------------------------------------*/

             CRTDUPOBJ  OBJ(HSP3034) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)

/*-------------------------------------------------------------------*/
/* BUILD/RUN QUERY OVER FILE: WEEKLY SIRE LINE DOSES                 */
/*-------------------------------------------------------------------*/

/* ALWAYS SELECT ONLY RECORDS WITH A WEEK-ENDING DATE IN THE SELECTED */
/* DATE RANGE.                                                        */

             CHGVAR     VAR(%SST(&QDATA 1 10)) VALUE('SWWEDT *GE')
             CHGVAR     VAR(%SST(&QDATA 12 8)) VALUE(&LDFWEDT)
             CHGVAR     VAR(%SST(&QDATA 21 15)) VALUE('*AND SWWEDT +
                          *LE')
             CHGVAR     VAR(%SST(&QDATA 37 8)) VALUE(&LDTWEDT)

/* FARM                                                                   */
             IF         COND(&LDFSCD *NE 0) THEN(DO)
             CHGVAR     VAR(%SST(&QDATA 46 15)) VALUE('*AND SWFSCD +
                          *EQ')
             CHGVAR     VAR(%SST(&QDATA 62 5)) VALUE(&LDFSCD)
             ENDDO

/* SIRE LINE                                                              */
             IF         COND(&LDSICD *NE ' ') THEN(DO)
             CHGVAR     VAR(%SST(&QDATA 68 17)) VALUE('*AND SWSICD +
                          *EQ "')
             CHGVAR     VAR(%SST(&QDATA 85 5)) VALUE(&LDSICD)
             CHGVAR     VAR(%SST(&QDATA 90 1)) VALUE('"')
             ENDDO

             OVRDBF     FILE(HSL081D) SHARE(*YES)
             OPNQRYF    FILE((HSL081D)) FORMAT(*FILE) +
                          QRYSLT(&QDATA) KEYFLD(*FILE) SEQONLY(*YES)

/*-----------------------------------------------------------------*/
/* BUILD THE WORKFILE                                              */
/*-----------------------------------------------------------------*/

/*‚JM-WI628-START                                                        */
/*           CALL       PGM(HP3034) PARM(&FLAG)                          */
             CALL       PGM(HP3034) PARM((&TOTALCNT))
/*‚JM-WI628-END                                                          */

             CLOF       OPNID(HSL081D)
             DLTOVR     FILE(HSL081D)

/*-------------------------------------------------------------------*/
/* DOWNLOAD                                                          */
/*-------------------------------------------------------------------*/

/*‚JM-WI628-START-Decommission &FLAG                               */
/*           IF         COND(&FLAG = 'Z')     THEN(DO)               */
             IF         COND(&TOTALCNT *EQ 0) THEN(DO)
/*‚JM-WI628-END                                                    */
/*‚JM-WI628-START-Deactivate notifications                               */
/*‚JM-S027448-START-Reactivate notifications                             */
             ESNDMAIL   RECIPIENT(&LDEMAIL) SUBJECT('Sire Line +
                          Download') MSG('Your selections on +
                          HP4034-Specify Options for Sire Line +
                          Download did not extract any data for the +
                          spreadsheet download.  Please change your +
                          selections and submit the Download again.')
             MONMSG     MSGID(CPF0000)
/*‚JM-S027448-END                                                        */
/*‚JM-WI628-END                                                    */
             ENDDO

/*‚JM-WI628-START-Decommission &FLAG                               */
/*           IF         COND(&FLAG = 'T')     THEN(DO)             */
/*           ESNDMAIL   RECIPIENT(&LDEMAIL) SUBJECT('Sire Line +   */
/*                        Download') MSG('Your selections on +     */
/*                        HP4034-Specify Options for Sire Line +   */
/*                        Download extracted over 66,000 +         */
/*                        records--which is too many records for + */
/*                        the spreadsheet to handle. Change your + */
/*                        selections to extract fewer records and +*/
/*                        submit the Download again.')             */
/*           MONMSG     MSGID(CPF0000)                             */
/*           ENDDO                                                 */
/*‚JM-WI628-END                                                    */

/*‚JM-WI628-START-Decommission &FLAG                               */
             IF         COND(&TOTALCNT *GT 0) THEN(DO)
/*           IF         COND(&FLAG = ' ')     THEN(DO)                   */
/*‚JM-WI628-END                                                    */
/*‚JM-WI628-START-Send XLSX to user with Header                     */
/*           EXECUTE    SQL('SELECT * FROM HSP3034') PCFMT(*XLS) + */
             EXECUTE    SQL('SELECT * FROM HSP3034') PCFMT(*XLS) +
                          REPLACE(*YES) RECIPIENT(&LDEMAIL) +
                          EMLMSG('HP4034 Sire Line Download') +
                          TEXT('HPS Sire Line Download')
/*‚JM-WI628-END                                                    */
             MONMSG     MSGID(CPF0000)
             ENDDO

             ENDPGM

