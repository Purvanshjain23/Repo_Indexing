// ?------------------------------------------------------------------------------------------------
// ?Synon action diagram for PNQ8XFR
// ?Date: 14.08.2025 Time: 03:46:15
// ?------------------------------------------------------------------------------------------------

//?Execute user function

//?Conversion Documentation
DO;

//?Market Price will be converted to CWT because Overages will be
//?by CWT if it is Customer Overage, and Market Price may not be.
ENDDO;

//?*** Price Routine was call on or after Shipping, Calculate Price
CASE;

// IF PAR.Event Called From is All Values
IF PAR.Event_Called_From = '02'/'99'/**/'AO'/'AI';

//?*** Load Date used for calculation (to retrieve Market date)
CASE;

// IF PAR.Market Pricing Date is NE Zero
IF PAR.Market_Pricing_Date <> *ZERO;

// PAR.Date Used for Calculation = PAR.Market Pricing Date
PAR.Date_Used_for_Calculation = PAR.Market_Pricing_Date;

//?*** Load Date used for calculation (to retrieve Market date)
// IF *OTHERWISE
IF *OTHERWISE;

CASE;

// IF PAR.Date Used for Calculation is not entered
IF PAR.Date_Used_for_Calculation = *ZERO;

CASE;

// IF PAR.Actual Shipped Date is entered
IF PAR.Actual_Shipped_Date <> *ZERO;

// PAR.Date Used for Calculation = PAR.Actual Shipped Date
PAR.Date_Used_for_Calculation = PAR.Actual_Shipped_Date;

// IF *OTHERWISE
IF *OTHERWISE;

// PAR.Date Used for Calculation = PAR.Requested Ship Date
PAR.Date_Used_for_Calculation = PAR.Requested_Ship_Date;

ENDIF;

ENDIF;

ENDIF;

EXECUTE FUNCTION(Rtv Cust Item Price   RT) TYPE(RTVOBJ) FILE(PNF5CPP)           AC1981055;
PARAMETER(PAR.Ship_To_Customer);
PARAMETER(PAR.Commodity_Market_Code);
PARAMETER(PAR.Item_Code);
PARAMETER(PAR.Date_Used_for_Calculation);
PARAMETER(PAR.Pricing_Retrieved_Amount);
PARAMETER(PAR.Pricing_Date_Used);
{
 //?USER: Processing if Data record not found

 // PGM.*Return code = CND.*Record does not exist
 PGM.*Return_code = 'Y2U0005';

 MOVE *ALL (To: PAR From: CON);

 //?USER: Process Data record

 CASE;

 // IF DB1.CIP Item Price Override is Not Zeros
 IF DB1.CIP_Item_Price_Override <> *ZERO;

 // PAR.CIP Item Price = DB1.CIP Item Price Override
 PAR.CIP_Item_Price = DB1.CIP_Item_Price_Override;

 // IF *OTHERWISE
 IF *OTHERWISE;

 // PAR.CIP Item Price = DB1.CIP Item Price
 PAR.CIP_Item_Price = DB1.CIP_Item_Price;

 ENDIF;

 // PAR.USR Date Priced = DB1.CIP Price Date
 PAR.USR_Date_Priced = DB1.CIP_Price_Date;

 QUIT;

}


//?Flag as Unpriced if Price Date doesn't match Market date entered
CASE;

// IF PAR.Pricing Date Used NE PAR.Date Used for Calculation
IF PAR.Pricing_Date_Used <> PAR.Date_Used_for_Calculation;

// OR PGM.*Return code is *Record does not exist
OR PGM.*Return_code = 'Y2U0005';

// PAR.Price Status = CND.Unpriced
PAR.Price_Status = 'U';

//?If no pricing record was found then flag as pricing error.
CASE;

// IF PGM.*Return code is *Record does not exist
IF PGM.*Return_code = 'Y2U0005';

// PAR.Error Return = CND.MKTPRC Error
PAR.Error_Return = 'MKT';

ENDIF;

ENDIF;

//?If record not found use default commodity market from company/item
CASE;

// IF PGM.*Return code is *Record does not exist
IF PGM.*Return_code = 'Y2U0005';

// Call program RTV Dflt Comm Mrkt     XF.
CALL PROGRAM(RTV Dflt Comm Mrkt     XF) ('PDMNXFR');
PARAMETER(PAR.Company_Number);
PARAMETER(PAR.Item_Code);
PARAMETER(PAR.Default_Commod_Mark_basis);

EXECUTE FUNCTION(Rtv Market Details    RT) TYPE(RTVOBJ) FILE(PNGBREP)           AC1989084;
PARAMETER(PAR.Item_Code);
PARAMETER(PAR.Default_Commod_Mark_basis);
PARAMETER(LCL.Commodity_Price_Group);
PARAMETER(NLL.Market_Percent);
PARAMETER(NLL.Market_Prem_Ded);
{
 //?USER: Processing if Data record not found

 MOVE *ALL (To: PAR From: CON);

 //?USER: Process Data record

 MOVE *ALL (To: PAR From: DB1);

}


CASE;

// IF PAR.Commodity Market Code NE PAR.Default Commod Mark basis
IF PAR.Commodity_Market_Code <> PAR.Default_Commod_Mark_basis;

EXECUTE FUNCTION(RTV Market Price       RT) TYPE(RTVOBJ) FILE(OMF0CPP)          AC1199313;
PARAMETER(PAR.Default_Commod_Mark_basis);
PARAMETER(LCL.Commodity_Price_Group);
PARAMETER(PAR.Date_Used_for_Calculation);
PARAMETER(PAR.Pricing_Retrieved_Amount);
PARAMETER(PAR.Pricing_Date_Used);
{
 //?USER: Processing if Data record not found

 // PGM.*Return code = CND.*Record does not exist
 PGM.*Return_code = 'Y2U0005';

 MOVE *ALL (To: PAR From: CON);

 //?USER: Process Data record

 // PAR.Commodity Market Price = DB1.Commodity Market Price
 PAR.Commodity_Market_Price = DB1.Commodity_Market_Price;

 // PAR.USR Date Priced = DB1.Market Price Date
 PAR.USR_Date_Priced = DB1.Market_Price_Date;

 QUIT;

}


ENDIF;

ENDIF;

ENDIF;

//?Convert Price to CWT
CASE;

// IF PAR.Pricing Retrieved Amount is Not Zeros
IF PAR.Pricing_Retrieved_Amount <> *ZERO;

// Call program CLC Convert Price - CW XF.
CALL PROGRAM(CLC Convert Price - CW XF) ('PDKUXFR');
PARAMETER(PAR.Company_Number);
PARAMETER(PAR.Item_Code);
PARAMETER(PAR.Pricing_Retrieved_Amount);
PARAMETER(PAR.Price_Adjustment_Amount);

// PAR.Pricing Retrieved Amount = PAR.Price Adjustment Amount
PAR.Pricing_Retrieved_Amount = PAR.Price_Adjustment_Amount;

ENDIF;

