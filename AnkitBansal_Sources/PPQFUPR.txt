/***************************************************************** */
/*  PROGRAM NUMBER:  PPQFUPR                                       */
/*  PROGRAM NAME:    SEND PFS BOX                                  */
/*  PROGRAMMER:      PURVA DROGE                                   */
/*  CREATE DATE:     06/21/05                                      */
/*                                                                 */
/*  FUNCTION:        THIS CLP CREATES A FILE IN QTEMP FOR SENDING  */
/*                   TO THE PLANT FLOOR SYSTEM SERVER              */
/*                                                                 */
/*******************************************************************/
/* Modification History                                            */
/*                                                                 */
/* MM/DD/YY PGMR EXPLANATION OF CHANGE                             */
/* -------- ---- ------------------------------------------------- */
/*                                                                 */
/*******************************************************************/
             PGM

/*-----------------------------------------------------------------*/
/* PARAMETER                                                       */
/*-----------------------------------------------------------------*/
/* *NONE */

/*-----------------------------------------------------------------*/
/* PROGRAM VARIABLES                                               */
/*-----------------------------------------------------------------*/
             DCL        VAR(&NBRCURRCD) TYPE(*DEC) LEN(10 0)

/*-----------------------------------------------------------------*/
/* QTEMP SETUP                                                     */
/*-----------------------------------------------------------------*/
/* PHYSICAL FILE */
             CRTDUPOBJ  OBJ(PPA7REP) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP) NEWOBJ(PPA7REP)
             MONMSG     MSGID(CPF0000) EXEC(GOTO CMDLBL(CRTDUPPF))

/* UPDATE INDEX  */
             CRTDUPOBJ  OBJ(PPA7REL4) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP) NEWOBJ(PPA7REL4)
             MONMSG     MSGID(CPF0000) EXEC(GOTO CMDLBL(CRTDUPLF))

/*-----------------------------------------------------------------*/
/* CREATE RECORDS IN QTEMP                                         */
/*-----------------------------------------------------------------*/

             CALL       PGM(PPQGXFR) PARM(' ')
             MONMSG     MSGID(CPF0000) EXEC(GOTO CMDLBL(PGMCALL))

/*-----------------------------------------------------------------*/
/* POST PROCESS                                                    */
/*-----------------------------------------------------------------*/
/* SEND QTEMP FILE TO FLOOR SYSTEM SERVER */
             ADDLIBLE   LIB(SEQUEL) POSITION(*LAST)
             MONMSG     MSGID(CPF0000)
/*           EXECUTE    SQL('select * from qtemp/ppa7rep') +
                          PCFMT(*DELIMITED) +
                          RECIPIENT('ftp:download.pork/ppa7rep.csv') */
/*           MONMSG     MSGID(CPF0000) EXEC(GOTO CMDLBL(SNDFTP)) */

/* COPY QTEMP RECORDS TO DOWNLOAD FILE */
 DOWNLOAD:
             RTVMBRD    FILE(PPA7REPDWN) NBRCURRCD(&NBRCURRCD)
             IF COND(&NBRCURRCD *EQ 0) THEN(DO)
               CPYF       FROMFILE(QTEMP/PPA7REP) TOFILE(PPA7REPDWN) +
                          MBROPT(*ADD) FMTOPT(*MAP *DROP)
               MONMSG     MSGID(CPF0000) EXEC(GOTO CMDLBL(CPYSNT))
               ENDDO
             ELSE DO
               UPDATE     SET((A7UXSX 0)) SQL('from prktestf/ppa7rep +
                          where A7UXSX=1')
               MONMSG     MSGID(CPF0000) EXEC(GOTO CMDLBL(UPDRCD))
               SNDMSG     MSG('WARNING: PFS Box (PPA7REP) not +
                          downloaded.') TOUSR(SEABOARD)
               GOTO       CMDLBL(ENDPGM)
/*             DLYJOB     DLY(60) /* SECONDS */
/*             GOTO       CMDLBL(DOWNLOAD) */
             ENDDO

/* ADD QTEMP RECORDS TO PPA7REPSNT        */
             CPYF       FROMFILE(QTEMP/PPA7REP) TOFILE(PPA7REPSNT) +
                          MBROPT(*ADD) FMTOPT(*MAP *DROP)
             MONMSG     MSGID(CPF0000) EXEC(GOTO CMDLBL(CPYSNT))

/* DELETE PROCESSED RECORDS FROM FILE     */
             DELETE     SQL('from PRKTESTF/ppa7reP where A7Y1NX=360 +
                          and A7UXSX=1')
             MONMSG     MSGID(CPF0000) EXEC(GOTO CMDLBL(DELRCD))

             GOTO       CMDLBL(ENDPGM)
/*-----------------------------------------------------------------*/
/*                      ERROR                                      */
/*-----------------------------------------------------------------*/
 CRTDUPPF:
             SNDPGRMSG  TOPGR(PRKPFSDWN) MSG('ERROR:  Create +
                          duplicate file in qtemp for PFS Box +
                          Physical File (PPA7REP).') CONFMSG(*NO)
             CHGJOB     LOG(4 00 *SECLVL)
             GOTO       CMDLBL(ENDPGM)

 CRTDUPLF:
             SNDPGRMSG  TOPGR(PRKPFSDWN) MSG('ERROR:  Create +
                          duplicate file in qtemp for PFS Box +
                          Update Index (PPA7REL4).') CONFMSG(*NO)
             CHGJOB     LOG(4 00 *SECLVL)
             GOTO       CMDLBL(ENDPGM)

 PGMCALL:
             SNDPGRMSG  TOPGR(PRKPFSDWN) MSG('ERROR:  Call to create +
                          QTEMP file for PFS Box (PPA7REP).') +
                          CONFMSG(*NO)
             CHGJOB     LOG(4 00 *SECLVL)
             GOTO       CMDLBL(ENDPGM)

 SNDFTP:
             SNDPGRMSG  TOPGR(PRKPFSDWN) MSG('ERROR:  Send QTEMP +
                          file to Server for PFS Box Phyaical +
                          File(PPA7REP).') CONFMSG(*NO)
             CHGJOB     LOG(4 00 *SECLVL)
             GOTO       CMDLBL(ENDPGM)

 CPYSNT:
             SNDPGRMSG  TOPGR(PRKPFSDWN) MSG('ERROR:  Copy QTEMP +
                          records to sent file for PFS Box +
                          (PPA7REPSNT).') CONFMSG(*NO)
             CHGJOB     LOG(4 00 *SECLVL)
             GOTO       CMDLBL(ENDPGM)

 DELRCD:
             SNDPGRMSG  TOPGR(PRKPFSDWN) MSG('ERROR:  Delete +
                          processed records from file for PFS Box +
                          (PPA7REPSNT).') CONFMSG(*NO)
             CHGJOB     LOG(4 00 *SECLVL)
             GOTO       CMDLBL(ENDPGM)

 UPDRCD:
             SNDPGRMSG  TOPGR(PRKPFSDWN) MSG('ERROR:  Update process +
                          status back to unprocessed for PFS Box +
                          (PPA7REP).') CONFMSG(*NO)
             CHGJOB     LOG(4 00 *SECLVL)
             GOTO       CMDLBL(ENDPGM)
/*-----------------------------------------------------------------*/
/*                      PROGRAM END                                */
/*-----------------------------------------------------------------*/
 PGMMSG:
/*           SNDPGRMSG  TOPGR(PRKBLDSC) MSG('Nightly Build of the +
                          Production Schedule and Plan ended +
                          Normally.') CONFMSG(*NO) */

 ENDPGM:
             DLTOVR     FILE(*ALL)

             ENDPGM
