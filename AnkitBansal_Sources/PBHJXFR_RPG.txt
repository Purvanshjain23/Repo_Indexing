     H/TITLE Exc PFS Mrk/Proc f/inv XF Execute external functio
     H            Y
     Z* CRTRPGPGM
     Z* CVTOPT(*DATETIME)
      *
     H* SYNOPSIS :
     H*  Perform user function
     H*  As defined by action diagram
      *
     H* Generated by CA 2E release 8.5 (1351)
     H* Function type : Execute external function
      *
     H* Company       : OMS Development Model
     H* System        : OMS Development Model
     H* User name     : ISRCENT
     H* Date          : 01/03/13  Time  : 11:35:59
     H* Copyright     : OMS Development Model
      *
      *================================================================
     M* Maintenance   :
      *================================================================
     FOPBFCPNKIF  E           K        DISK
      * RSQ : Order Header TRG          InvDt/Cust#/Order#
      *
     FPPBGCPL3IF  E           K        DISK
      * RSQ : PFS Inventory Adjustment  Co/Ord/OrdDtl/Sub# P=0
      *
     FPPBGCPL0UF  E           K        DISK
      * UPD : PFS Inventory Adjustment  Update index
      *
      * Long constants
     E                    @CN#    1  01  6   @CN    25
     E                    YDOW        7  1               *Days of week
     I@BFCPPF
      * Order Header TRG          InvDt/Cust#/Order#
      * Renamed input format fields
     I              BEAIC3                          WAAIC3
     I              BEC4NB                          WAC4NB
     I              BEJNCD                          WAJNCD
     I              BEANC7                          WAANC7
     I              BEBKC7                          WABKC7
     I              BEBRTX                          WABRTX
     I              BEHMNA                          WAHMNA
     I              BEHONA                          WAHONA
     I              BEHPNA                          WAHPNA
     I              BEHNNA                          WAHNNA
     I              BEDBCD                          WADBCD
     I              BECKTX                          WACKTX
     I              BEB0C7                          WAB0C7
     I              BEAETX                          WAAETX
     I              BEB1NA                          WAB1NA
     I              BEB3NA                          WAB3NA
     I              BEB4NA                          WAB4NA
     I              BEB2NA                          WAB2NA
     I              BEBHCD                          WABHCD
     I              BEC8TX                          WAC8TX
     I              BEBCNA                          WABCNA
     I              BEA0DT                          WAA0DT
     I              BEA5DT                          WAA5DT
     I              BEGNDT                          WAGNDT
     I              BEACDT                          WAACDT
     I              BEAQCD                          WAAQCD
     I              BEB6NA                          WAB6NA
     I              BEBYNA                          WABYNA
     I              BEBZNA                          WABZNA
     I              BEGTST                          WAGTST
     I              BEGVST                          WAGVST
     I              BEGUST                          WAGUST
     I              BEQFST                          WAQFST
     I              BECQCD                          WACQCD
     I              BEGJST                          WAGJST
     I              BEGWST                          WAGWST
     I              BEGXST                          WAGXST
     I              BEGYST                          WAGYST
     I              BEAODT                          WAAODT
     I              BEAIVN                          WAAIVN
     I              BECXDT                          WACXDT
     I              BEJZVA                          WAJZVA
     I              BEA1WG                          WAA1WG
     I              BEXIST                          WAXIST
     I              BEXJST                          WAXJST
     I              BEXKST                          WAXKST
     I              BEEIDT                          WAEIDT
     I              BEAFTM                          WAAFTM
     I              BEE8CD                          WAE8CD
     I              BEE9CD                          WAE9CD
     I              BERMNB                          WARMNB
     I              BETBNB                          WATBNB
     I              BER1NB                          WAR1NB
     I              BEPJST                          WAPJST
     I              BEU0ST                          WAU0ST
     I              BEU1ST                          WAU1ST
     I              BEQ2CD                          WAQ2CD
     I              BEU2ST                          WAU2ST
     I              BEVEST                          WAVEST
     I              BEVFST                          WAVFST
     I              BEVGST                          WAVGST
     I              BERPCD                          WARPCD
     I              BERNNB                          WARNNB
     I              BEVDST                          WAVDST
     I              BEATIN                          WAATIN
     I              BEU4ST                          WAU4ST
     I              BEU5ST                          WAU5ST
     I              BERSRN                          WARSRN
     I              BEMHNA                          WAMHNA
     I              BEMINA                          WAMINA
     I              BEWBST                          WAWBST
     I              BER4CD                          WAR4CD
     I              BEBFCD                          WABFCD
     I              BEQ4CD                          WAQ4CD
     I              BET3NB                          WAT3NB
     I              BESICD                          WASICD
     I              BECONB                          WACONB
     I              BECEST                          WACEST
     I              BEAWDT                          WAAWDT
     I              BEJPCD                          WAJPCD
     I              BEXUST                          WAXUST
     I              BEZ1ST                          WAZ1ST
     I              BEVRVA                          WAVRVA
     I              BEOBST                          WAOBST
     I              BEBCST                          WABCST
     I              BEBDST                          WABDST
     I              BEB7VL                          WAB7VL
     I              BEGASX                          WAGASX
     I              BEGBSX                          WAGBSX
     I              BEGCSX                          WAGCSX
     I              BEGDSX                          WAGDSX
     I              BEFNSX                          WAFNSX
     I              BEFOSX                          WAFOSX
     I              BEFPSX                          WAFPSX
     I              BEFQSX                          WAFQSX
     I              BEFRSX                          WAFRSX
     I              BEFSSX                          WAFSSX
     I              BEFTSX                          WAFTSX
     I              BEFUSX                          WAFUSX
     I              BEFVSX                          WAFVSX
     I              BEFWSX                          WAFWSX
     I              BEFXSX                          WAFXSX
     I              BEFYSX                          WAFYSX
     I              BENODT                          WANODT
     I              BENPDT                          WANPDT
     I              BENQDT                          WANQDT
     I              BENRDT                          WANRDT
     I              BENSDT                          WANSDT
     I              BEBPTM                          WABPTM
     I              BEBQTM                          WABQTM
     I              BEBRTM                          WABRTM
     I              BEBSTM                          WABSTM
     I              BEBTTM                          WABTTM
     I              BEH0NX                          WAH0NX
     I              BEH1NX                          WAH1NX
     I              BEH2NX                          WAH2NX
     I              BEH3NX                          WAH3NX
     I              BEH4NX                          WAH4NX
     I              BEC0C7                          WAC0C7
     I              BEUVST                          WAUVST
     I              BEUWST                          WAUWST
     I              BEUXST                          WAUXST
     I              BEAATM                          WAAATM
     I              BEAYNA                          WAAYNA
     I              BEA0NA                          WAA0NA
     I              BEAXDT                          WAAXDT
      *
     I@BGCPD8
      * PFS Inventory Adjustment  Co/Ord/OrdDtl/Sub# P=0
      * Renamed input format fields
     I              BGY1NX                          WBY1NX
     I              BGC0NY                          WBC0NY
     I              BGAID8                          WBAID8
     I              BGAFTS                          WBAFTS
     I              BGBCNY                          WBBCNY
     I              BGVLSX                          WBVLSX
     I              BGVMSX                          WBVMSX
     I              BGY2NX                          WBY2NX
     I              BGU4SX                          WBU4SX
     I              BGADNY                          WBADNY
     I              BGU1SX                          WBU1SX
     I              BGP7DT                          WBP7DT
     I              BGZ4NX                          WBZ4NX
     I              BGACNY                          WBACNY
     I              BGVKSX                          WBVKSX
     I              BGZ2NX                          WBZ2NX
     I              BGZ6NX                          WBZ6NX
     I              BGBDNY                          WBBDNY
     I              BGABNY                          WBABNY
     I              BGBENY                          WBBENY
     I              BGZ9NX                          WBZ9NX
     I              BGGBAA                          WBGBAA
     I              BGANNY                          WBANNY
     I              BGZPNX                          WBZPNX
     I              BGZXNX                          WBZXNX
     I              BGZYNX                          WBZYNX
     I              BGALNY                          WBALNY
     I              BGAGNY                          WBAGNY
     I              BGUWSX                          WBUWSX
     I              BGUXSX                          WBUXSX
     I              BGV3SX                          WBV3SX
     I              BGAHNY                          WBAHNY
     I              BGAINY                          WBAINY
     I              BGAJNY                          WBAJNY
     I              BGAKNY                          WBAKNY
      *
     I@BGCPZF
      * PFS Inventory Adjustment  Update index
      * Renamed input format fields
     I              BGY1NX                          WCY1NX
     I              BGC0NY                          WCC0NY
     I              BGAID8                          WCAID8
     I              BGAFTS                          WCAFTS
     I              BGBCNY                          WCBCNY
     I              BGVLSX                          WCVLSX
     I              BGVMSX                          WCVMSX
     I              BGY2NX                          WCY2NX
     I              BGU4SX                          WCU4SX
     I              BGADNY                          WCADNY
     I              BGU1SX                          WCU1SX
     I              BGP7DT                          WCP7DT
     I              BGZ4NX                          WCZ4NX
     I              BGACNY                          WCACNY
     I              BGVKSX                          WCVKSX
     I              BGZ2NX                          WCZ2NX
     I              BGZ6NX                          WCZ6NX
     I              BGBDNY                          WCBDNY
     I              BGABNY                          WCABNY
     I              BGBENY                          WCBENY
     I              BGZ9NX                          WCZ9NX
     I              BGGBAA                          WCGBAA
     I              BGANNY                          WCANNY
     I              BGZPNX                          WCZPNX
     I              BGZXNX                          WCZXNX
     I              BGZYNX                          WCZYNX
     I              BGALNY                          WCALNY
     I              BGAGNY                          WCAGNY
     I              BGUWSX                          WCUWSX
     I              BGUXSX                          WCUXSX
     I              BGV3SX                          WCV3SX
     I              BGAHNY                          WCAHNY
     I              BGAINY                          WCAINY
     I              BGAJNY                          WCAJNY
     I              BGAKNY                          WCAKNY
      *
      /EJECT
      * Data structures:
     IPGMDS     ESDSY2PGDSP
      * Modified Program data structure
     IJBDTTM      DS
      * Job date/time
     I                                        1   70##JDT
     I                                        1   10##JCC
     I                                        2   30##JYY
     I                                        4   50##JMM
     I                                        6   70##JDD
     I                                        8  130##JTM
     I                                        8   90##JHH
     I                                       10  110##JNN
     I                                       12  130##JSS
      /EJECT
     IXDINT       DS
      * Internal date
     I                                        1   70XDINDT
     I                                        1   30XDINYY
     I                                        4   50XDINMM
     I                                        6   70XDINDD
      /EJECT
     IXD2T        DS
      * Internal date
     I                                        1   70XDINT2
     I                                        1   30XDINY2
     I                                        4   50XDINM2
     I                                        6   70XDIND2
     IQPPBG1    E DSPPBGCPL0
      * UPD : PFS Inventory Adjustment  Update index
      * Renamed input format fields
     I              BGY1NX                          WCY1NX
     I              BGC0NY                          WCC0NY
     I              BGAID8                          WCAID8
     I              BGAFTS                          WCAFTS
     I              BGBCNY                          WCBCNY
     I              BGVLSX                          WCVLSX
     I              BGVMSX                          WCVMSX
     I              BGY2NX                          WCY2NX
     I              BGU4SX                          WCU4SX
     I              BGADNY                          WCADNY
     I              BGU1SX                          WCU1SX
     I              BGP7DT                          WCP7DT
     I              BGZ4NX                          WCZ4NX
     I              BGACNY                          WCACNY
     I              BGVKSX                          WCVKSX
     I              BGZ2NX                          WCZ2NX
     I              BGZ6NX                          WCZ6NX
     I              BGBDNY                          WCBDNY
     I              BGABNY                          WCABNY
     I              BGBENY                          WCBENY
     I              BGZ9NX                          WCZ9NX
     I              BGGBAA                          WCGBAA
     I              BGANNY                          WCANNY
     I              BGZPNX                          WCZPNX
     I              BGZXNX                          WCZXNX
     I              BGZYNX                          WCZYNX
     I              BGALNY                          WCALNY
     I              BGAGNY                          WCAGNY
     I              BGUWSX                          WCUWSX
     I              BGUXSX                          WCUXSX
     I              BGV3SX                          WCV3SX
     I              BGAHNY                          WCAHNY
     I              BGAINY                          WCAINY
     I              BGAJNY                          WCAJNY
     I              BGAKNY                          WCAKNY
      *
     IYARDCS      DS                            204
      * Message data for message Y2U0009.
     IMD0009      DS
     I                                        1  10 MDPGM
     I                                       11  20 MDACP
     I                                       21  30 MDFMT
     I                                       31  34 MDACT
     I                                       35  40 MDLBL
      /EJECT
      * Parameter declarations
     IP1PARM      DS
      * I :  Invoice Date
     I                                    P   1   40P1AWDT
     I            DS
     I                                        1 132 ZAMSDA
      /EJECT
      *****************************************************************
      * Entry parameters
     C           *ENTRY    PLIST
     C                     PARM           P0RTN   7
     C           P1AWDT    PARM           WP0001  70       Invoice Date
      *****************************************************************
      * Initialize
     C                     EXSR ZZINIT
      *
      * Exc PFS Mrk/Proc f/inv XF
      * E2378 RMC 01/03/13 Mark unprocessed PFS Shipping Trans for Invcd
      *   as processed so other pgms wont read old records.
     C                     Z-ADDP1AWDT    YL0001           Invoice Date
      * CASE: LCL.Invoice Date is not entered
     C           YL0001    IFEQ *ZERO                      *IF
      * LCL.Invoice Date = JOB.*Job date + CON.-1 *DAYS
     C           ##JDT     ADD  1000000   XDINDT
     C                     EXSR XCVTA
     C                     Z-ADDXDAY1     XDAY2   60
     C                     Z-ADD-1        XDURR   80
     C                     MOVEL'1'       XDSEL   1
     C                     MOVEL@CN,001   XDCDW   7
     C                     EXSR XDOWS
     C                     EXSR XDADY
     C                     EXSR XCVFA
     C           XDINDT    IFLT 010101
     C           XDINDT    ORGT 4000000
     C                     Z-ADD*ZERO     YL0001
     C                     ELSE
     C           XDINDT    SUB  1000000   YL0001
     C                     END
     C                     END                             *FI
      * RTV by inv dte f/PFS  RT - Order Header TRG  * 
     C                     EXSR SARVGN
      *----------------------------------------------------------------
      * Exit program
     C           AAEXIT    TAG
     C                     MOVEL*BLANK    P0RTN
     C                     EXSR ZYEXPG
      *================================================================
      /EJECT
     CSR         SARVGN    BEGSR
      *================================================================
      * RTV by inv dte f/PFS  RT - Order Header TRG  * 
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * Define keylist
     C           KPSSA     KLIST
     C                     KFLD           WAAWDT           Invoice Date
      * Setup key
     C                     Z-ADDYL0001    WAAWDT           Invoice Date
      * Establish starting position
     C           KPSSA     SETLL@BFCPPF                    *
     C                     READ @BFCPPF                  90*
      * Data record not found
     C   90                MOVEL'USR0176' W0RTN   7
     C           *IN90     DOWEQ'0'
      * USER: Process Data record
      * (chk invoice date>0 in case this gets ran with a -0- date)
      * CASE: DB1.Invoice Date is entered
     C           WAAWDT    IFNE *ZERO                      *IF
      * PFS Inv Adj f/Inv ORD RT - PFS Inventory Adjustment  * 
     C                     EXSR SBRVGN
     C                     END                             *FI
     C                     READ @BFCPPF                  90*
     C                     ENDDO
      *================================================================
     CSR         SAEXIT    ENDSR
      /EJECT
     CSR         SBRVGN    BEGSR
      *================================================================
      * PFS Inv Adj f/Inv ORD RT - PFS Inventory Adjustment  * 
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * USER: Initialize routine
      * Declare restrictor key work fields
     C           *LIKE     DEFN WBY1NX    WQSB01           PFS Company Num
     C           *LIKE     DEFN WBZPNX    WQSB02           PFS Order Numbe
      * Define keylist
     C           KRSSB     KLIST
     C                     KFLD           WQSB01           PFS Company Num
     C                     KFLD           WQSB02           PFS Order Numbe
      * Setup key
     C                     Z-ADDWAAIC3    WQSB01           PFS Company Num
     C                     Z-ADDWAC4NB    WQSB02           PFS Order Numbe
      * Establish starting position
     C           KRSSB     SETLL@BGCPD8                    *
     C           KRSSB     READE@BGCPD8                  90*
      * Data record not found
     C   90                MOVEL'USR3496' W0RTN   7
     C           *IN90     DOWEQ'0'
      * USER: Process Data record
      * Mark rcd as processed -- the order is already invoiced
     C                     Z-ADD1         YL0002           PFS Process Sta
     C                     MOVEL*BLANK    YL0003           PFS Error Reaso
      * Chg PrcSts/ErrRsn     CH - PFS Inventory Adjustment  * 
     C                     EXSR SCCHRC
     C           KRSSB     READE@BGCPD8                  90*
     C                     ENDDO
      *================================================================
     CSR         SBEXIT    ENDSR
      /EJECT
     CSR         SCCHRC    BEGSR
      *================================================================
      * Chg PrcSts/ErrRsn     CH - PFS Inventory Adjustment  * 
      *================================================================
      *
     C                     MOVEL*BLANK    WN0001  3        PFS Transaction
     C                     MOVEL*BLANK    WN0002  2        PFS Inv Adj Rea
     C                     Z-ADD*ZERO     WN0003  70       PFS Item Code
     C                     MOVEL*BLANK    WN0004  3        PFS Warehouse C
     C                     Z-ADD*ZERO     WN0005  40       PFS Location Co
     C                     MOVEL*BLANK    WN0006 13        PFS Department
     C                     Z-ADD*ZERO     WN0007  80       PFS Production
     C                     Z-ADD*ZERO     WN0008  80       PFS Label Date
     C                     Z-ADD*ZERO     WN0009  80       PFS Receive/Loc
     C                     MOVEL*BLANK    WN0010  1        PFS Shift
     C                     Z-ADD*ZERO     WN0011 100       PFS Serial Numb
     C                     Z-ADD*ZERO     WN0012  10       PFS Tracking Ty
     C                     Z-ADD*ZERO     WN0013  50       PFS Transaction
     C                     Z-ADD*ZERO     WN0014  82       PFS Transaction
     C                     Z-ADD*ZERO     WN0015  82       PFS Transaction
     C                     Z-ADD*ZERO     WN0016  82       PFS Total Tare
     C                     MOVEL*BLANK    WN0017  3        PFS To Warehous
     C                     Z-ADD*ZERO     WN0018  40       PFS To Location
     C                     Z-ADD*ZERO     WN0019  70       PFS Order Numbe
     C                     Z-ADD*ZERO     WN0020  30       PFS Order Line
     C                     Z-ADD*ZERO     WN0021  30       PFS Substitutio
     C                     Z-ADD*ZERO     WN0022  50       PFS Co-Pack Lot
     C                     Z-ADD*ZERO     WN0023  90       PFS Pallet Numb
     C                     MOVEL*BLANK    WN0024  1        PFS Record Stat
     C                     Z-ADD*ZERO     WN0025  80       PFS Create Date
     C                     Z-ADD*ZERO     WN0026  60       PFS Create Time
     C                     Z-ADD*ZERO     WN0027  80       PFS Change Date
     C                     Z-ADD*ZERO     WN0028  60       PFS Change time
      *
     C                     MOVEL*BLANK    W0RTN   7
      * Set PGM.*Record Data Changed flag
     C                     MOVE *BLANK    YARDC   1
      *
      * Move key fields to @BGCPZF
     C                     Z-ADDWBY1NX    WCY1NX           PFS Company Num
     C                     Z-ADDWBC0NY    WCC0NY           PFS Inv Adj Seq
     C                     Z-ADDWBAID8    WCAID8           PFS Transaction
     C                     Z-ADDWBAFTS    WCAFTS           PFS Transaction
     C                     Z-ADDWBBCNY    WCBCNY           PFS Transaction
      *
     C           KLCHSC    KLIST
     C                     KFLD           WCY1NX           PFS Company Num
     C                     KFLD           WCC0NY           PFS Inv Adj Seq
     C                     KFLD           WCAID8           PFS Transaction
     C                     KFLD           WCAFTS           PFS Transaction
     C                     KFLD           WCBCNY           PFS Transaction
     C           KLCHSC    CHAIN@BGCPZF              9091  *
      *
     C           *IN90     IFEQ '1'
      * Record not found
     C                     MOVEL'Y2U0009' W0RTN   7
     C                     MOVEL##PGM     MDPGM
     C                     MOVEL'PPBGCPL0'MDACP
     C                     MOVEL'@BGCPZF' MDFMT
     C                     MOVEL'*CHG'    MDACT
      * Record not found label: LBL001.
     C                     MOVEL'LBL001'  MDLBL
      * Send message '*Record no longer on file'
     C                     MOVEL'Y2U0009' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     MOVELMD0009    ZAMSDA           Message data
     C                     EXSR ZASNMS
     C                     MOVEL*BLANKS   MD0009
     C                     GOTO SCEXIT
     C                     ENDIF
      *
     C           *IN91     IFEQ '1'
      * Record locked
     C                     MOVEL'Y2U0004' W0RTN   7
      * Send message '*Database operation error'
     C                     MOVEL'Y2U0004' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     EXSR ZASNMS
     C                     GOTO SCEXIT
     C                     ENDIF
      *
      * Store record data for null update check
     C                     MOVE QPPBG1    YARDCS
      * Move non-key fields to @BGCPZF
     C                     Z-ADDYL0002    WCUXSX           PFS Process Sta
     C                     MOVELYL0003    WCV3SX    P      PFS Error Reaso
      *
      * Set PGM.*Record Data Changed flag
     C           QPPBG1    IFNE YARDCS
     C           YARDC     ANDNE'N'
     C                     MOVE 'Y'       YARDC
     C                     ENDIF
      * USER: Processing before Data update
      * Set Change Stamp      IF
     C                     Z-ADD##JDT     WCAJNY           PFS Change Date
     C                     Z-ADD##JTM     WCAKNY           PFS Change time
      * Set PGM.*Record Data Changed flag
     C           QPPBG1    IFNE YARDCS
     C           YARDC     ANDNE'N'
     C                     MOVE 'Y'       YARDC
     C                     ENDIF
      * If changed update record otherwise release record
     C           YARDC     IFEQ 'Y'
     C                     UPDAT@BGCPZF                91  *
     C                     ELSE
      * Release record lock
     C                     UNLCKPPBGCPL0               91  *
     C                     ENDIF
     C           *IN91     IFEQ '1'
      * Change error detected
     C                     MOVEL'Y2U0004' W0RTN   7
     C                     ELSE
      *
      * DBF change successful
     C                     ENDIF
      *================================================================
     CSR         SCEXIT    ENDSR
      /EJECT
     CSR         XCVFA     BEGSR
      *================================================================
      * Convert absolute day to date
      *================================================================
     C           XDAY1     IFGT 109267
     C                     ADD  2         XDAY1
     C                     ELSE
     C           XDAY1     IFGT 36218
     C                     ADD  1         XDAY1
     C                     END
     C                     END
      * Full years (up to the date)
     C           XDAY1     DIV  365.25    XDWK1   80
     C                     MVR            XDWK3   71
     C                     Z-ADDXDWK1     XDINYY
     C           XDWK3     IFEQ 0
      * The date is the end of a year
     C                     Z-ADD12        XDINMM
     C                     Z-ADD31        XDINDD
     C                     ELSE
      * Year days up to the date
     C           XDWK1     MULT 365.25    XDWK2   60
     C                     SUB  XDWK2     XDAY1
     C                     ADD  1         XDINYY
      * Leap year ?
     C           XDINYY    DIV  4         XDWK1
     C                     MVR            XDWK1
      * March 1 (relative day of the year)
     C           XDWK1     IFEQ 0
     C                     Z-ADD60        XDWK1
     C                     ELSE
     C                     Z-ADD59        XDWK1
     C                     END
      * Define date base month and offset day -
     C           XDAY1     IFLE XDWK1
      *  - January (thru February)
     C                     Z-ADD1         XDINMM
     C                     ELSE
     C                     SUB  XDWK1     XDAY1
     C           XDAY1     IFLE 153
      *  - March (thru July)
     C                     Z-ADD3         XDINMM
     C                     ELSE
      *  - August (thru December)
     C                     Z-ADD8         XDINMM
     C                     SUB  153       XDAY1
     C                     END
      * Calculate 2 month base and offset day
     C           XDAY1     SUB  1         XDWK1
     C                     DIV  61        XDWK1
     C                     MVR            XDAY1
     C                     ADD  1         XDAY1
     C                     MULT 2         XDWK1
     C                     ADD  XDWK1     XDINMM
     C                     END
      * Calculate date increment,
     C           XDAY1     IFGT 31
     C                     ADD  1         XDINMM
     C                     SUB  31        XDAY1
     C                     END
     C                     Z-ADDXDAY1     XDINDD
     C                     END
      *================================================================
     CSR         XCVFAE    ENDSR
      /EJECT
     CSR         XCVTA     BEGSR
      *================================================================
      * Convert date to absolute day (from 01/01/01)
      *================================================================
      * Absolute day =
      * 365*(YY-1)+(YY-1)/4 (past years w/extra days of leap ones) ...
     C           XDINYY    SUB  1         XDWK1   80
     C           XDWK1     MULT 365.25    XDAY1   60
     C           XDWK1     IFGE 300
     C                     SUB  2         XDAY1
     C                     ELSE
     C           XDWK1     IFGE 100
     C                     SUB  1         XDAY1
     C                     END
     C                     END
      * (from the beginning of the year to the beginning of the month:)
     C           XDINMM    SUB  1         XDWK1
     C           XDINMM    IFLT 3
      *     ...+31*(MM-1) (for January-February) ...
     C                     MULT 31        XDWK1
     C                     ADD  XDWK1     XDAY1
     C                     ELSE
      *     ...+30*(MM-1) (for March-December) ...
     C                     MULT 30        XDWK1
     C                     ADD  XDWK1     XDAY1
      *         ...-2 (for preceding February) ...
     C                     SUB  2         XDAY1
     C           XDINYY    IFNE 100
     C           XDINYY    ANDNE300
      *         ...+1 (for preceding February, if leap year) ...
     C           XDINYY    DIV  4         XDWK1
     C                     MVR            XDWK1
     C           XDWK1     IFEQ 0
     C                     ADD  1         XDAY1
     C                     END
     C                     END
     C           XDINMM    IFLT 8
      *         ...+MM/2 (preceding 31-sts for March-July) ...
     C           XDINMM    MULT .5        XDWK1
     C                     ADD  XDWK1     XDAY1
     C                     ELSE
      *         ...+(MM+1)/2 (same for August-December) ...
     C           XDINMM    ADD  1         XDWK1
     C                     MULT .5        XDWK1
     C                     ADD  XDWK1     XDAY1
     C                     END
     C                     END
      * ...+DD (days in the month up to the ending date)
     C                     ADD  XDINDD    XDAY1
      *================================================================
     CSR         XCVTAE    ENDSR
      /EJECT
     CSR         XDADY     BEGSR
      *================================================================
      * Calculate date increment, *DAYS
      *================================================================
     C           XDURR     IFEQ 0
     C           XDWSL     OREQ 0
      * None days of week selected
     C                     Z-ADDXDAY2     XDAY1
     C           XDURR     IFNE *ZERO
      * Return Code: Unable to increment date.
     C                     MOVEL'Y2U0059' W0RTN   7
     C                     ENDIF
     C                     GOTO XDADYE
     C                     ENDIF
     C           XDWSL     IFEQ 7
      * All days of week selected
     C           XDAY2     ADD  XDURR     XDAY1
     C                     GOTO XDADYM
     C                     ENDIF
      * Some days of week selected
     C           XDURR     IFGE 0
     C                     Z-ADD1         XDSTP   10
     C                     ELSE
     C                     Z-ADD-1        XDSTP
     C                     ENDIF
      * Get number of full weeks in the duration
     C           XDURR     DIV  XDWSL     XDWNB   60
      * Isolate the last week
     C                     MVR            XDLSW   10
     C           XDLSW     IFEQ 0
     C           XDWSL     MULT XDSTP     XDLSW
     C                     SUB  XDSTP     XDWNB
     C                     ENDIF
      * Increment the date by the full weeks
     C           XDWNB     MULT 7         XDWK1   80
     C           XDAY2     ADD  XDWK1     XDAY1   60
      * Determine day of week of the beginning date
     C           XDAY2     ADD  3         YY      60
     C                     DIV  7         YY
     C                     MVR            YY
     C           YY        IFEQ 0
     C                     Z-ADD7         YY
     C                     ENDIF
      * Loop: Increment the date by the last week
     C           XDLSW     DOWNE0
      * Increment the date
     C                     ADD  XDSTP     XDAY1
      * Increment the day of week
     C                     ADD  XDSTP     YY
      * Put day of week into the range 1-7
     C           YY        IFEQ 0
     C                     Z-ADD7         YY
     C                     ELSE
     C           YY        IFEQ 8
     C                     Z-ADD1         YY
     C                     ELSE
     C           YY        IFEQ -1
     C                     Z-ADD6         YY
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C           YDOW,YY   IFEQ XDSEL
      * Selected day of the last week has been processed
     C                     SUB  XDSTP     XDLSW
     C                     ENDIF
      * End of loop
     C                     ENDDO
     C           XDADYM    TAG
     C           XDINDD    IFLT 1
     C                     Z-ADD1         XDINDD
     C                     MOVEL'Y2U0006' W0RTN   7
     C                     ENDIF
      *================================================================
     CSR         XDADYE    ENDSR
      /EJECT
     CSR         XDOWS     BEGSR
      *================================================================
      * Setup days of week array
      *================================================================
     C                     MOVEAXDCDW     YDOW
     C                     Z-ADD0         XDWSL   10
     C                     Z-ADD1         YY
     C           YY        DOWLE7
     C           YDOW,YY   IFEQ XDSEL
     C                     ADD  1         XDWSL
     C                     END
     C                     ADD  1         YY
     C                     END
      *================================================================
     CSR         XDOWSE    ENDSR
      /EJECT
     CSR         ZASNMS    BEGSR
      *================================================================
      * Send message to program's message queue
      *================================================================
     C           ZAPGMQ    IFEQ *BLANK
     C                     MOVEL##PGM     ZAPGMQ
     C                     END
     C                     CALL 'Y2SNMGC'
     C                     PARM           ZAPGMQ 10        Program queue
     C                     PARM           ZAPGRL  5        Rel queue
     C                     PARM           ZAMSID  7        Message ID
     C                     PARM           ZAMSGF 10        Message file
     C                     PARM           ZAMSDA           Message data
     C                     PARM           ZAMSTP  7        Message type
      * Clear all fields for default mechanism next time
     C                     MOVEL*BLANK    ZAPGMQ
     C                     MOVEL*BLANK    ZAPGRL
     C                     MOVEL*BLANK    ZAMSID
     C                     MOVEL*BLANK    ZAMSGF
     C                     MOVEL*BLANK    ZAMSDA
     C                     MOVEL*BLANK    ZAMSTP
      *================================================================
     CSR         ZAEXIT    ENDSR
      /EJECT
     CSR         ZXEXPG    BEGSR
      *================================================================
      * Exit program: Normal
      *================================================================
     C                     EXSR ZYEXPG
      *================================================================
     CSR         ZXEXIT    ENDSR
      /EJECT
     CSR         ZYEXPG    BEGSR
      *================================================================
      * Exit program: Direct
      *================================================================
      * Terminate program
     C                     SETON                     LR
      *
      * Exit program
     C                     RETRN
      *
      *================================================================
     CSR         ZYEXIT    ENDSR
      /EJECT
     CSR         ZZINIT    BEGSR
      *================================================================
      * Initialisation
      *================================================================
     C           W0ICL     IFEQ *BLANK
     C                     MOVEL'Y'       W0ICL   1        *Initial call
     C                     ELSE
     C                     MOVEL'N'       W0ICL
     C                     END
     C                     MOVE *BLANK    P0RTN
     C                     MOVE *BLANK    W0RTN   7
     C                     MOVEL*BLANK    W0RSL   1
     C                     MOVEL*BLANK    W0RSF   1
     C                     MOVEL*ZEROS    W0RTW   90
     C                     MOVEL'400'     W0ENV   3
      * Retrieve job attributes
     C                     CALL 'Y2RTJCR'
     C                     PARM           PGMDS
      * Setup job date/time
     C                     Z-ADD##SD7     ##JDT
     C                     TIME           ##JTM
      * Update screen time
     C                     TIME           ##TME   60
      * Initialize renamed input format fields
     C                     Z-ADD*ZERO     WAAIC3           Company Number
     C                     Z-ADD*ZERO     WAC4NB           Order Number
     C                     Z-ADD*ZERO     WAANC7           A/R Customer Nu
     C                     Z-ADD*ZERO     WABKC7           Ship To Custome
     C                     Z-ADD*ZERO     WAB0C7           Bill to Custome
     C                     Z-ADD*ZERO     WAA0DT           Order Date
     C                     Z-ADD*ZERO     WAA5DT           Requested Ship
     C                     Z-ADD*ZERO     WAGNDT           Actual Shipped
     C                     Z-ADD*ZERO     WAACDT           Cancel Date
     C                     Z-ADD*ZERO     WAAODT           Scheduled Ship
     C                     Z-ADD*ZERO     WACXDT           Date of Origina
     C                     Z-ADD*ZERO     WAJZVA           Order Value Tot
     C                     Z-ADD*ZERO     WAA1WG           Order Weight To
     C                     Z-ADD*ZERO     WAEIDT           Requested Deliv
     C                     Z-ADD*ZERO     WAAFTM           Requested Deliv
     C                     Z-ADD*ZERO     WARMNB           Load ID
     C                     Z-ADD*ZERO     WATBNB           Absorbed Freigh
     C                     Z-ADD*ZERO     WAR1NB           Rated Freight
     C                     Z-ADD*ZERO     WARNNB           Reefer Temperat
     C                     Z-ADD*ZERO     WAATIN           Attach to Invoi
     C                     Z-ADD*ZERO     WARSRN           Resell Referenc
     C                     Z-ADD*ZERO     WAT3NB           Attach to Order
     C                     Z-ADD*ZERO     WACONB           Invoice Number
     C                     Z-ADD*ZERO     WAAWDT           Invoice Date
     C                     Z-ADD*ZERO     WAVRVA           A/R order Value
     C                     Z-ADD*ZERO     WAB7VL           Invoice Order V
     C                     Z-ADD*ZERO     WANODT           OH Appt Confirm
     C                     Z-ADD*ZERO     WANPDT           JPN Invoice Iss
     C                     Z-ADD*ZERO     WANQDT           OH Unused Date
     C                     Z-ADD*ZERO     WANRDT           OH Unused Date
     C                     Z-ADD*ZERO     WANSDT           OH Unused Date
     C                     Z-ADD*ZERO     WABPTM           Maximum Gross W
     C                     Z-ADD*ZERO     WABQTM           Time of Origina
     C                     Z-ADD*ZERO     WABRTM           OH Appt Confirm
     C                     Z-ADD*ZERO     WABSTM           OH Unused Time
     C                     Z-ADD*ZERO     WABTTM           OH Unused Time
     C                     Z-ADD*ZERO     WAH0NX           Act Frt Referen
     C                     Z-ADD*ZERO     WAH1NX           Act Non-Ref Frt
     C                     Z-ADD*ZERO     WAH2NX           OH Fuel Surchar
     C                     Z-ADD*ZERO     WAH3NX           OH Total Non-Re
     C                     Z-ADD*ZERO     WAH4NX           OH Total Ref Fr
     C                     Z-ADD*ZERO     WAC0C7           Claim Number
     C                     Z-ADD*ZERO     WAAATM           Job Time
     C                     Z-ADD*ZERO     WAAXDT           Job Date
      * Initialize renamed input format fields
     C                     Z-ADD*ZERO     WBY1NX           PFS Company Num
     C                     Z-ADD*ZERO     WBC0NY           PFS Inv Adj Seq
     C                     Z-ADD*ZERO     WBAID8           PFS Transaction
     C                     Z-ADD*ZERO     WBAFTS           PFS Transaction
     C                     Z-ADD*ZERO     WBBCNY           PFS Transaction
     C                     Z-ADD*ZERO     WBY2NX           PFS Item Code
     C                     Z-ADD*ZERO     WBADNY           PFS Location Co
     C                     Z-ADD*ZERO     WBP7DT           PFS Production
     C                     Z-ADD*ZERO     WBZ4NX           PFS Label Date
     C                     Z-ADD*ZERO     WBACNY           PFS Receive/Loc
     C                     Z-ADD*ZERO     WBZ2NX           PFS Serial Numb
     C                     Z-ADD*ZERO     WBZ6NX           PFS Tracking Ty
     C                     Z-ADD*ZERO     WBBDNY           PFS Transaction
     C                     Z-ADD*ZERO     WBABNY           PFS Transaction
     C                     Z-ADD*ZERO     WBBENY           PFS Transaction
     C                     Z-ADD*ZERO     WBZ9NX           PFS Total Tare
     C                     Z-ADD*ZERO     WBANNY           PFS To Location
     C                     Z-ADD*ZERO     WBZPNX           PFS Order Numbe
     C                     Z-ADD*ZERO     WBZXNX           PFS Order Line
     C                     Z-ADD*ZERO     WBZYNX           PFS Substitutio
     C                     Z-ADD*ZERO     WBALNY           PFS Co-Pack Lot
     C                     Z-ADD*ZERO     WBAGNY           PFS Pallet Numb
     C                     Z-ADD*ZERO     WBUXSX           PFS Process Sta
     C                     Z-ADD*ZERO     WBAHNY           PFS Create Date
     C                     Z-ADD*ZERO     WBAINY           PFS Create Time
     C                     Z-ADD*ZERO     WBAJNY           PFS Change Date
     C                     Z-ADD*ZERO     WBAKNY           PFS Change time
      * Dummy move for compiler
     C                     MOVE '0'       @CN#,1
     C                     MOVEL'N'       W0PMT   1
      * Define local work field Invoice Date
     C                     Z-ADD*ZERO     YL0001  70
      * Define local work field PFS Process Status
     C                     Z-ADD*ZERO     YL0002  10
      * Define local work field PFS Error Reason
     C                     MOVEL*BLANK    YL0003  6
      *================================================================
     CSR         ZZEXIT    ENDSR
** @CN
00001 1111100
