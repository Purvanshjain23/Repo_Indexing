// ?------------------------------------------------------------------------------------------------
// ?Synon action diagram for PKWQXFR
// ?Date: 14.08.2025 Time: 02:50:42
// ?------------------------------------------------------------------------------------------------

//?Execute user function

//?MODIFICATIONS
//?11/02/2020 ISE H16853 - CHANGE BUY ORDER NUMBER FIELD LENGTH FROM 5 TO 7
//?Run this at the beginning of a new year.
//?Some files are kept Y-T-D, some are kept 2 years.
//?For files kept Y-T-D, load the last year end date into the
//?Roll_off date. Read the files in descending kill date seq positioning
//?on the Roll_off date.  Delete the records found.
// WRK.Year 3 USR = JOB.*Job year - CON.1
WRK.Year_3_USR = JOB.*Job_year - 1;

//?Add century digit (1nn) to the year if it is a 20th century date
CASE;

// IF WRK.Year 3 USR is Less than 40 = 20nn
IF WRK.Year_3_USR < 40;

// WRK.Year 3 USR = WRK.Year 3 USR + CON.100
WRK.Year_3_USR = WRK.Year_3_USR + 100;

ENDIF;

// WRK.Year 3 Alpha  USr = CVTVAR(WRK.Year 3 USR)
WRK.Year_3_Alpha_USr = CVTVAR(WRK.Year_3_USR);

// WRK.Date Alpha USR = CONCAT(WRK.Year 3 Alpha  USr,CON.1231,CON.*ZERO)
WRK.Date_Alpha_USR = WRK.Year_3_Alpha_USr + '1231' (*ZERO);

// WRK.Date USR = CVTVAR(WRK.Date Alpha USR)
WRK.Date_USR = CVTVAR(WRK.Date_Alpha_USR);

EXECUTE FUNCTION(Rtv/Dlt f/yrly purge  RT) TYPE(RTVOBJ) FILE(PKC3CPP)           AB1163896;
PARAMETER(WRK.Date_USR);
{
 //?USER: Process Data record

 EXECUTE FUNCTION(Del Co Wgt Lot YTD    DL) TYPE(DLTOBJ) FILE(PKC3CPP)           AB1146618;
 PARAMETER(DB1.CC_Company_Number);
 PARAMETER(DB1.CWL_Min_Adj_Live_Wgt);
 PARAMETER(DB1.CWL_Max_Adj_Live_Wgt);
 PARAMETER(DB1.CWLY_Week_Ending_Date);
}


EXECUTE FUNCTION(Rtv/Dlt f/yrly purge  RT) TYPE(RTVOBJ) FILE(PKCZCPP)           AB1163903;
PARAMETER(WRK.Date_USR);
{
 //?USER: Process Data record

 EXECUTE FUNCTION(Del Crc Sum Prd YTD   DL) TYPE(DLTOBJ) FILE(PKCZCPP)           AB1146609;
 PARAMETER(DB1.CC_Company_Number);
 PARAMETER(DB1.PD_Producer_Code);
 PARAMETER(DB1.PY_As_of_Kill_Date);
}


EXECUTE FUNCTION(Rtv/Dlt f/yrly purge  RT) TYPE(RTVOBJ) FILE(PKC0CPP)           AB1163911;
PARAMETER(WRK.Date_USR);
{
 //?USER: Process Data record

 EXECUTE FUNCTION(Del CrcSum Prd Ln Dst DL) TYPE(DLTOBJ) FILE(PKC0CPP)           AB1146612;
 PARAMETER(DB1.CC_Company_Number);
 PARAMETER(DB1.PD_Producer_Code);
 PARAMETER(DB1.PY_As_of_Kill_Date);
 PARAMETER(DB1.PLDY_Lean);
}


//?For files kept 2 years, load the 3 years ago end date into the
//?Roll_off date. Read the files in descending kill date seq positioning
//?on the Roll_off date.  Delete the records found.
// WRK.Year 3 USR = JOB.*Job year - CON.3
WRK.Year_3_USR = JOB.*Job_year - 3;

//?Add century digit (1nn) to the year if it is a 20th century date
CASE;

// IF WRK.Year 3 USR is Less than 40 = 20nn
IF WRK.Year_3_USR < 40;

// WRK.Year 3 USR = WRK.Year 3 USR + CON.100
WRK.Year_3_USR = WRK.Year_3_USR + 100;

ENDIF;

// WRK.Year 3 Alpha  USr = CVTVAR(WRK.Year 3 USR)
WRK.Year_3_Alpha_USr = CVTVAR(WRK.Year_3_USR);

// WRK.Date Alpha USR = CONCAT(WRK.Year 3 Alpha  USr,CON.1231,CON.*ZERO)
WRK.Date_Alpha_USR = WRK.Year_3_Alpha_USr + '1231' (*ZERO);

// WRK.Date USR = CVTVAR(WRK.Date Alpha USR)
WRK.Date_USR = CVTVAR(WRK.Date_Alpha_USR);

//?Delete Buy order files and tattoos if they have been paid
EXECUTE FUNCTION(zzv/Dlt f/yrly purge  zz) TYPE(RTVOBJ) FILE(PKAXCPP)           AB1164002;
PARAMETER(WRK.Date_USR);
{
 //?USER: Process Data record

 //?Delete BOL if existing freight has been paid
 CASE;

 // IF DB1.BOL Freight Amt is Not Zeros
 IF DB1.BOL_Freight_Amt <> *ZERO;

 // AND DB1.BOL Trucker Payment Sts is Not Paid including Blank
 AND DB1.BOL_Trucker_Payment_Sts = *BLANK/'MT'/'ST';

 //?Delete BOL if existing freight has been paid
 // IF *OTHERWISE
 IF *OTHERWISE;

 EXECUTE FUNCTION(Chk BOL for unpaid TH RT) TYPE(RTVOBJ) FILE(PKA1CPP)           AB1164065;
 PARAMETER(DB1.BOH_Company_Number);
 PARAMETER(DB1.BOH_Buy_Order_Number);
 PARAMETER(DB1.BOL_Load_Number);
 PARAMETER(DB1.BOL_Kill_Date);
 PARAMETER(WRK.@Status_Yes_No);
 {
  //?USER: Initialize routine

  // *MO.VE             1183529*Bu = ilt. in functions
  PAR.@Status_Yes_No = 'N';

  //?USER: Process Data record

  CASE;

  // IF DB1.TH Payment Sts is Unpaid Producer
  IF DB1.TH_Payment_Sts = 'ML'/'SL'/'SC'/'IC'/'IL'/*BLANK;

  // *MO.VE             1183529*Bu = ilt. in functions
  PAR.@Status_Yes_No = 'Y';

  QUIT;

  ENDIF;

 }

 //?Delete BOL,BOH,BOC, TH,TD THC if all tattoos have been paid
 CASE;

 // IF WRK.@Status (Yes/No) is Yes
 IF WRK.@Status_Yes_No = 'Y';

 //?Delete BOL,BOH,BOC, TH,TD THC if all tattoos have been paid
 // IF *OTHERWISE
 IF *OTHERWISE;

 EXECUTE FUNCTION(Dlt Buy Order Detail  DL) TYPE(DLTOBJ) FILE(PKAXCPP)           AB1100532;
 PARAMETER(DB1.BOH_Company_Number);
 PARAMETER(DB1.BOH_Buy_Order_Number);
 PARAMETER(DB1.BOL_Load_Number);
 EXECUTE FUNCTION(Rtv/Dlt f/yrly purge   RT) TYPE(RTVOBJ) FILE(PKAWCPP)          AB1164013;
 PARAMETER(DB1.BOH_Company_Number);
 PARAMETER(DB1.BOH_Buy_Order_Number);
 {
  //?USER: Process Data record

  EXECUTE FUNCTION(Dlt Buy Order Header  DL) TYPE(DLTOBJ) FILE(PKAWCPP)           AB1100516;
  PARAMETER(DB1.BOH_Company_Number);
  PARAMETER(DB1.BOH_Buy_Order_Number);
 }

 EXECUTE FUNCTION(Del Account Balances) TYPE(RTVOBJ) FILE(PKAYCPP)               AA1100943;
 PARAMETER(DB1.BOH_Company_Number);
 PARAMETER(DB1.BOH_Buy_Order_Number);
 EXECUTE FUNCTION(Rtv/Dlt F/yrly purge  RT) TYPE(RTVOBJ) FILE(PKA1CPP)           AB1164066;
 PARAMETER(DB1.BOH_Company_Number);
 PARAMETER(DB1.BOH_Buy_Order_Number);
 PARAMETER(DB1.BOL_Load_Number);
 PARAMETER(DB1.BOL_Kill_Date);
 {
  //?USER: Process Data record

  EXECUTE FUNCTION(Rtv/Dlt f/yrly purge  RT) TYPE(RTVOBJ) FILE(PKA2CPP)           AB1164071;
  PARAMETER(DB1.BOH_Company_Number);
  PARAMETER(DB1.BOH_Buy_Order_Number);
  PARAMETER(DB1.BOL_Load_Number);
  PARAMETER(DB1.TH_Tattoo_Number);
  PARAMETER(DB1.TH_Kill_Date);
  {
   //?USER: Process Data record

   EXECUTE FUNCTION(Delete Tattoo Detail) TYPE(DLTOBJ) FILE(PKA2CPP)               AB1101752;
   PARAMETER(DB1.BOH_Company_Number);
   PARAMETER(DB1.BOH_Buy_Order_Number);
   PARAMETER(DB1.BOL_Load_Number);
   PARAMETER(DB1.TH_Tattoo_Number);
   PARAMETER(DB1.TH_Kill_Date);
   PARAMETER(DB1.TD_Sequence_Number);
  }

  EXECUTE FUNCTION(Rtv/Dlt f/yrly purge  RT) TYPE(RTVOBJ) FILE(PKA4CPP)           AB1164076;
  PARAMETER(DB1.BOH_Company_Number);
  PARAMETER(DB1.BOH_Buy_Order_Number);
  PARAMETER(DB1.BOL_Load_Number);
  PARAMETER(DB1.TH_Tattoo_Number);
  PARAMETER(DB1.TH_Kill_Date);
  {
   //?USER: Process Data record

   EXECUTE FUNCTION(Delete Tattoo Header Comm) TYPE(DLTOBJ) FILE(PKA4CPP)          AB1113203;
   PARAMETER(DB1.BOH_Company_Number);
   PARAMETER(DB1.BOH_Buy_Order_Number);
   PARAMETER(DB1.BOL_Load_Number);
   PARAMETER(DB1.TH_Tattoo_Number);
   PARAMETER(DB1.TH_Kill_Date);
   PARAMETER(DB1.THC_Comment_Line);
  }

  EXECUTE FUNCTION(Rtv/Dlt f/yrly purge  RT) TYPE(RTVOBJ) FILE(PKB3CPP)           AB1164084;
  PARAMETER(DB1.BOH_Company_Number);
  PARAMETER(DB1.BOH_Buy_Order_Number);
  PARAMETER(DB1.BOL_Load_Number);
  PARAMETER(DB1.TH_Tattoo_Number);
  PARAMETER(DB1.TH_Kill_Date);
  {
   //?USER: Process Data record

   EXECUTE FUNCTION(Delete Tattoo Scale Ticke) TYPE(DLTOBJ) FILE(PKB3CPP)          AB1113771;
   PARAMETER(DB1.BOH_Company_Number);
   PARAMETER(DB1.BOH_Buy_Order_Number);
   PARAMETER(DB1.BOL_Load_Number);
   PARAMETER(DB1.TH_Tattoo_Number);
   PARAMETER(DB1.TH_Kill_Date);
   PARAMETER(DB1.TST_Sequence_Number);
  }

  EXECUTE FUNCTION(Rtv/Dlt f/yrly purge  RT) TYPE(RTVOBJ) FILE(PKBSCPP)           AB1163724;
  PARAMETER(DB1.BOH_Company_Number);
  PARAMETER(DB1.BOH_Buy_Order_Number);
  PARAMETER(DB1.BOL_Load_Number);
  PARAMETER(DB1.TH_Tattoo_Number);
  PARAMETER(DB1.TH_Kill_Date);
  //?04/12/2006 Add the Tattoo Header Ext
  EXECUTE FUNCTION(Rtv/Dlt f/yrly purge  RT) TYPE(RTVOBJ) FILE(PKDNCPP)           AB1271976;
  PARAMETER(DB1.BOH_Company_Number);
  PARAMETER(DB1.BOH_Buy_Order_Number);
  PARAMETER(DB1.BOL_Load_Number);
  PARAMETER(DB1.TH_Tattoo_Number);
  PARAMETER(DB1.TH_Kill_Date);
  {
   //?USER: Process Data record

   EXECUTE FUNCTION(Dlt Tattoo Hdr Ext    DO) TYPE(DLTOBJ) FILE(PKDNCPP)           AB1271812;
   PARAMETER(DB1.BOH_Company_Number);
   PARAMETER(DB1.BOH_Buy_Order_Number);
   PARAMETER(DB1.BOL_Load_Number);
   PARAMETER(DB1.TH_Tattoo_Number);
   PARAMETER(DB1.TH_Kill_Date);
  }

  EXECUTE FUNCTION(Delete Tattoo Header) TYPE(DLTOBJ) FILE(PKA1CPP)               AB1101745;
  PARAMETER(DB1.BOH_Company_Number);
  PARAMETER(DB1.BOH_Buy_Order_Number);
  PARAMETER(DB1.BOL_Load_Number);
  PARAMETER(DB1.TH_Tattoo_Number);
  PARAMETER(DB1.TH_Kill_Date);
 }

 ENDIF;

 ENDIF;

}


//?Delete voucher header, detail, tattoo d/a
EXECUTE FUNCTION(zzv/Dlt f/yrly purge  RT) TYPE(RTVOBJ) FILE(PKBKCPP)           AB1164092;
PARAMETER(WRK.Date_USR);
{
 //?USER: Process Data record

 //?Delete voucher detail and tattoo d/a
 EXECUTE FUNCTION(Rtv/Dlt f/yrly purge  RT) TYPE(RTVOBJ) FILE(PKBLCPP)           AB1164087;
 PARAMETER(DB1.VCH_Company_number);
 PARAMETER(DB1.VCH_Batch_Number);
 PARAMETER(DB1.VCH_Header_Number);
 {
  //?USER: Process Data record

  EXECUTE FUNCTION(Rtv/Dlt f/yrly purge  RT) TYPE(RTVOBJ) FILE(PKCDCPP)           AB1164094;
  PARAMETER(DB1.BOH_Company_Number);
  PARAMETER(DB1.BOH_Buy_Order_Number);
  PARAMETER(DB1.BOL_Load_Number);
  PARAMETER(DB1.TH_Tattoo_Number);
  PARAMETER(DB1.TH_Kill_Date);
  EXECUTE FUNCTION(Delete Voucher Detail) TYPE(DLTOBJ) FILE(PKBLCPP)              AB1102233;
  PARAMETER(DB1.VCH_Company_number);
  PARAMETER(DB1.VCH_Batch_Number);
  PARAMETER(DB1.VCH_Header_Number);
  PARAMETER(DB1.VCD_Line);
  {
   //?USER: Processing after Data update

   CASE;

   // IF DB1.VCD Split Percent is 100 %
   IF DB1.VCD_Split_Percent = 100;

   // Call program Crt Tattoo Action Comm XF.
   CALL PROGRAM(Crt Tattoo Action Comm XF) ('PKV4XFR');
   PARAMETER(DB1.BOH_Company_Number);
   PARAMETER(DB1.BOH_Buy_Order_Number);
   PARAMETER(DB1.BOL_Load_Number);
   PARAMETER(DB1.TH_Tattoo_Number);
   PARAMETER(DB1.TH_Kill_Date);
   PARAMETER(*ZERO);
   PARAMETER(*ZERO);
   PARAMETER(*ZERO);
   PARAMETER(*ZERO);
   PARAMETER('DV');
   PARAMETER(*BLANK);

   ENDIF;

  }

 }

}


//?Sbmjob to Reoganize purged files to remove deleted records.
// Execute command - 'SBM Rgzpfm files yearly'
EXECUTE COMMAND(PRK0558);

