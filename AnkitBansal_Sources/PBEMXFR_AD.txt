// ?------------------------------------------------------------------------------------------------
// ?Synon action diagram for PBEMXFR
// ?Date: 14.08.2025 Time: 03:47:37
// ?------------------------------------------------------------------------------------------------

//?Execute user function

//?Modification -
DO;

//?E02201 - Susan Mason - 7/25/2012
//?E02201 Allow the selection of Commission and Non Commission Orders
//?Change the Broker process to read the Customer Accrual
//?Instead of using the History Dtl Accrual, replace with the
//?Customer Accrual by Broker, and then the Sales history
//?by Ship to Customer and Invoice Date
//?the Customer Accrual Beg and End Accrual Dates.
//?Then the Sales history rt will build the WF Fax/Email Header
ENDDO;

//?DEFAULT: Invoice Date
CASE;

// IF PAR.Invoice Date is not entered
IF PAR.Invoice_Date = *ZERO;

// PAR.Invoice Date = JOB.*Job date
PAR.Invoice_Date = JOB.*Job_date;

ENDIF;

//?*** BUILD:  Brokered Orders
EXECUTE FUNCTION(Bld WF Fax/EmlHdr Com/NRT) TYPE(RTVOBJ) FILE(POC5REP)          AC2048540;
PARAMETER(PAR.Invoice_Date);
PARAMETER(PAR.Accrual_Type);
{
 //?USER: Process Data record

 // PGM.*Record selected = CND.*YES
 PGM.*Record_selected = 'Y';

 //?SEL: Record Status
 CASE;

 // IF DB1.Record Status is Not Active
 IF DB1.Record_Status = *BLANK/'D'/'I';

 // PGM.*Record selected = CND.*NO
 PGM.*Record_selected = 'N';

 ENDIF;

 //?SEL: Broker Code
 CASE;

 // IF PAR.Accrual Type is Commission
 IF PAR.Accrual_Type = 'CM';

 CASE;

 // IF DB1.Payee Type is Buyer Group
 IF DB1.Payee_Type = 'BG';

 // PGM.*Record selected = CND.*NO
 PGM.*Record_selected = 'N';

 ENDIF;

 //?SEL: Broker Code
 // IF PAR.Accrual Type is Buyer Group/Prod Rebate
 IF PAR.Accrual_Type = 'BG'/'PR';

 CASE;

 // IF DB1.Payee Type is Broker
 IF DB1.Payee_Type = 'BR';

 // PGM.*Record selected = CND.*NO
 PGM.*Record_selected = 'N';

 ENDIF;

 ENDIF;

 //?SEL: Email Only
 CASE;

 // IF DB1.Broker Fax/Email Inv is Not Email
 IF DB1.Broker_Fax_Email_Inv = 'B'/'F'/*BLANK;

 // PGM.*Record selected = CND.*NO
 PGM.*Record_selected = 'N';

 ENDIF;

 CASE;

 // IF PGM.*Record selected is *YES
 IF PGM.*Record_selected = 'Y';

 //?This is research of e02201
 //?After the Broker is read then read the Customer Accrual
 //?by Broker code
 //?The Broker is select above for the Commission processing
 EXECUTE FUNCTION(Bld WF Fax/Email Hdr  RT) TYPE(RTVOBJ) FILE(OMHOREP)           AC2048542;
 PARAMETER(DB1.Broker_Code);
 PARAMETER(PAR.Invoice_Date);
 PARAMETER(LCL.Create_Requested);
 {
  //?USER: Initialize routine

  // LCL.Order Number = CON.*ZERO
  LCL.Order_Number = *ZERO;

  // PAR.Create Requested = CND.N
  PAR.Create_Requested = 'N';

  //?USER: Process Data record

  EXECUTE FUNCTION(Bld WF Fax/Email Hdr  RT) TYPE(RTVOBJ) FILE(OMHSTPP)           AC2048549;
  PARAMETER(DB1.Ship_To_Customer);
  PARAMETER(PAR.Invoice_Date);
  PARAMETER(DB1.Accrual_Code);
  PARAMETER(DB1.Period_Beginning_Date);
  PARAMETER(DB1.Period_Ending_Date);
  PARAMETER(DB1.Broker_Code);
  PARAMETER(PAR.Create_Requested);
  {
   //?USER: Process Data record

   CASE;

   // IF DB1.Actual Shipped Date GE PAR.Period Beginning Date
   IF DB1.Actual_Shipped_Date >= PAR.Period_Beginning_Date;

   // AND DB1.Actual Shipped Date LE PAR.Period Ending Date
   AND DB1.Actual_Shipped_Date <= PAR.Period_Ending_Date;

   CASE;

   // IF DB1.Order Number NE LCL.Order Number
   IF DB1.Order_Number <> LCL.Order_Number;

   EXECUTE FUNCTION(Crt WF Fax/Email Hdr  RT) TYPE(RTVOBJ) FILE(PMEQCPP)           AC2048917;
   PARAMETER(DB1.Order_Number);
   PARAMETER(DB1.Company_Number);
   PARAMETER(PAR.Broker_Code);
   {
    //?USER: Processing if Data record not found

    EXECUTE FUNCTION(Crt WF Fax/Email Hdr  CR) TYPE(CRTOBJ) FILE(PMEQCPP)           AC1902016;
    PARAMETER(PAR.Order_Number);
    PARAMETER(PAR.Company_Number);
    PARAMETER(PAR.Brk_Rgn_Code);
    // PGM.*Return code = CND.*Normal
    PGM.*Return_code = *BLANK;

    //?USER: Process Data record

    // PGM.*Return code = CND.*Normal
    PGM.*Return_code = *BLANK;

   }

   // PAR.Create Requested = CND.Yes
   PAR.Create_Requested = 'Y';

   // LCL.Order Number = DB1.Order Number
   LCL.Order_Number = DB1.Order_Number;

   ENDIF;

   ENDIF;

  }

 }

 CASE;

 // IF LCL.Create Requested is Yes
 IF LCL.Create_Requested = 'Y';

 EXECUTE FUNCTION(Create WF Fax/Email Drive) TYPE(CRTOBJ) FILE(PPARCPP)          AC1718583;
 PARAMETER(DB1.Broker_Code);
 PARAMETER('B');
 PARAMETER(DB1.Broker_Fax_Number);
 PARAMETER(DB1.Broker_Email_Address);
 PARAMETER(LCL.Fax_Driver_Unused_1);
 PARAMETER(LCL.Fax_Driver_Unused_2);
 PARAMETER(LCL.Fax_Driver_Unused_3);
 PARAMETER(LCL.Fax_Driver_Unused_4);
 ENDIF;

 ENDIF;

}


// Call program Bld WF Fax/Email Dtl  XF.
CALL PROGRAM(Bld WF Fax/Email Dtl  XF) ('PMY5XFR');

