/***************************************************************** */
/* êNOTE: PROGRAM CLONED FROM HP4761CL.                            */
/*                                                                 */
/*  PROGRAM NUMBER --> HP4762CL                                    */
/*  PROGRAM NAME ----> ACTUAL MOVEMENT LOG FOR AGVIEW - RESEND     */
/*  DATE:------------> 12/23/2021                                  */
/*  PROGRAMMER ------> DANNY NGUYEN    (W90045)                    */
/*  PURPOSE ---------> Generate workfile for NCSU to pick up from  */
/*                     the IFS Directory & email XLS results to DL.*/
/*                     TEST DIRECTORY:                             */
/*                     /AGVIEW/TEST/                               */
/*                                                                 */
/*                     PROD DIRECTORY:                             */
/*                     /AGVIEW/PROD/                               */
/*                                                                 */
/*  PARMS:           &FRDATE = FROM DATE                           */
/*                   &TODATE = TO DATE                             */
/*                                                                 */
/*  CALLED FROM:     MENU=2.8.21                                   */
/*                                                                 */
/*-----------------------------------------------------------------*/
/*  MODIFICATIONS LOG:                                             */
/*-----------------------------------------------------------------*/
/*Ç06/11/24  Jagdish Mistry (JM-WI628),                            */
/*Ç          Project 628-RabApp Bypass to Agview                   */
/*Ç          Resends will be sent from LiveOps database but in     */
/*Ç          the event we need to regenerate the file so it can be */
/*Ç          resent, this program will do that.                    */
/*Ç          Added parameter to get count for HP370                */
/*Ç          Comment call of program HP374.                        */
/*Ç          We will no longer use work file HSP374,count of       */
/*Ç          records is fetched using HP370.Hence we will not use  */
/*Ç          HP374 & HSP374 from now onwards.                      */
/*Ç          Change query over HSP058 from checking MEMEDT to use  */
/*Ç          MEUPDT.                                               */
/*Ç          Will be called from new JS-HPSAGVIEWR                 */
/*Ç          Deactivate ESND email notifications                   */
/*Ç07/30/24  Jagdish Mistry (JM-WI628),                            */
/*Ç          1)Changed .CSV to .XLSX to get back Header for user   */
/*Ç          2)Send .CSV without header to IFS folder of /AGVIEW/  */
/*Ç08/21/24  Jagdish Mistry (JM-S027448) Reactivate ESND           */
/*******************************************************************/

             PGM        PARM(&BUSOFF &FRDATE &TODATE)

             DCL        VAR(&BUSOFF) TYPE(*CHAR) LEN(5)
             DCL        VAR(&FRDATE) TYPE(*CHAR) LEN(8)
             DCL        VAR(&TODATE) TYPE(*CHAR) LEN(8)
             DCL        VAR(&CURDTE)  TYPE(*CHAR) LEN(6)
             DCL        VAR(&CURDTE2) TYPE(*CHAR) LEN(8)
             DCL        VAR(&CURDTETME) TYPE(*CHAR) LEN(20)
             DCL        VAR(&CURDTETME2) TYPE(*CHAR) LEN(14)
             DCL        VAR(&CCYYMMDD) TYPE(*DEC) LEN(8 0)
             DCL        VAR(&WBDTE) TYPE(*DEC) LEN(8 0)
             DCL        VAR(&WBDTEA) TYPE(*CHAR) LEN(8)
             DCL        VAR(&WEDTE) TYPE(*DEC) LEN(8 0)
             DCL        VAR(&WEDTEA) TYPE(*CHAR) LEN(8)
             DCL        VAR(&DTALIB) TYPE(*CHAR) LEN(10)
             DCL        VAR(&EMLSBJ) TYPE(*CHAR) LEN(200)
             DCL        VAR(&EMLMSG) TYPE(*CHAR) LEN(200)
             DCL        VAR(&EMAILDL) TYPE(*CHAR) LEN(50)
             DCL        VAR(&IFSDIR) TYPE(*CHAR) LEN(48)
             DCL        VAR(&FILENM) TYPE(*CHAR) LEN(29) +
                          VALUE('MVMNTLOG')
             DCL        VAR(&TOSTMF) TYPE(*CHAR) LEN(200)
             DCL        VAR(&MSGTXT) TYPE(*CHAR) LEN(150)
             DCL        VAR(&QDATA) TYPE(*CHAR) LEN(250)
/*ÇJM-WI628-START-To Validate duration of days between From/To Dates     */
             DCL        VAR(&ERRFLAG) TYPE(*CHAR) LEN(1) VALUE('N')
             DCL        VAR(&FRMDATC) TYPE(*CHAR) LEN(6)
             DCL        VAR(&TODATC)  TYPE(*CHAR) LEN(6)
             DCL        VAR(&FRMDATN) TYPE(*DEC) LEN(6 0)
             DCL        VAR(&TODATN)  TYPE(*DEC) LEN(6 0)
             DCL        VAR(&TOTALCNT) TYPE(*DEC) LEN(8 0)
             DCL        VAR(&FILENAME) TYPE(*CHAR) LEN(30)
/*ÇJM-WI628-END                                                          */

/*ÇJM-WI628-START-Rewrite version as per WI628                     */
/*ÇGet System Value For Data File Library to Determine Whether     */
/*Ç       in PROD or TEST Environment                              */
             CALL       PGM(PPJXXFR) PARM(' ' 'DTALIB' &DTALIB)

/*ÇSet Constant Defaults                                           */
             IF         COND(&DTALIB *NE 'PRKFLIB') THEN(DO)
             CHGVAR     VAR(&EMAILDL) VALUE('dl agview test')
             CHGVAR     VAR(&EMLSBJ) VALUE('HPS: HP4762CL-Actual +
                          Movement Log Agview-RESEND Data' *BCAT +
                          '- TEST')
             CHGVAR     VAR(&IFSDIR) VALUE('/AGVIEW/TEST/')
             ENDDO
             ELSE       CMD(DO)
             CHGVAR     VAR(&EMAILDL) VALUE('dl agview')
             CHGVAR     VAR(&EMLSBJ) VALUE('HPS: HP4762CL-Actual +
                          Movement Log Agview-RESEND Data')

/*ÇMake IFS PROD Directory If Not Found                            */
             CHGVAR     VAR(&IFSDIR) VALUE('/AGVIEW/PROD/')
             ENDDO
/*-------------------------------------------------------------------*/
/*ÇCreate Work files                                               */
/*-------------------------------------------------------------------*/
             CRTDUPOBJL OBJ(HSP370) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)
/*-------------------------------------------------------------------*/
/*ÇUSE FROM DATE & TO DATE FROM PARM.                              */
/*-------------------------------------------------------------------*/
             RTVSYSVAL  SYSVAL(QDATE) RTNVAR(&CURDTE)
             RTVSYSVAL  SYSVAL(QDATETIME) RTNVAR(&CURDTETME)
/*ÇSet &CURDTETME2 as CCYYMMDDHHMMSS Format                        */
             CHGVAR     VAR(&CURDTETME2) VALUE(%SST(&CURDTETME 1 14))

             CVTDAT     DATE(&CURDTE) TOVAR(&CURDTE2) FROMFMT(*MDY) +
                          TOFMT(*YYMD) TOSEP(*NONE)

             CHGVAR     VAR(&CCYYMMDD) VALUE(&CURDTE2)

             CHGVAR     VAR(&WBDTE) VALUE(&FRDATE)
             CHGVAR     VAR(&WEDTE) VALUE(&TODATE)

             CHGVAR     VAR(&WBDTEA) VALUE(&WBDTE)
             CHGVAR     VAR(&WEDTEA) VALUE(&WEDTE)
/*ÇValidate to date is greater than equal to from date             */
             CALLSUBR   SUBR(VALDAYS)
             IF         COND(&ERRFLAG *EQ 'Y') THEN(GOTO CMDLBL(EXIT))
/*-------------------------------------------------------------------*/
/*ÇSETUP QUERY OVER THE MOVEMENT EVENT FILE                          */
/*ÇJM-WI628-START-Select all sales & transfer records in date range  */
/*-------------------------------------------------------------------*/
             CHGVAR     VAR(%SST(&QDATA 1 10)) VALUE('MEUPDT *GE')
             CHGVAR     VAR(%SST(&QDATA 12 8)) VALUE(&WBDTE)
             CHGVAR     VAR(%SST(&QDATA 21 15)) VALUE('*AND MEUPDT +
                          *LE')
             CHGVAR     VAR(%SST(&QDATA 37 8)) VALUE(&WEDTE)
             CHGVAR     VAR(%SST(&QDATA 46 40)) VALUE('*AND (MEMTCD +
                          *EQ "T" *OR MEMTCD *EQ "S")')

             OVRDBF     FILE(HSP058) SHARE(*YES)
             OPNQRYF    FILE((HSP058)) QRYSLT(&QDATA) KEYFLD(*FILE) +
                          SEQONLY(*YES)
/*-------------------------------------------------------------------*/
/*ÇBuild the workfile                                                */
/*ÇJM-WI628-START- Get Count of total new records                    */
/*-------------------------------------------------------------------*/
             CALL       PGM(HP370) PARM((&TOTALCNT))

             CLOF       OPNID(HSP058)
             DLTOVR     FILE(HSP058)

             CHGVAR     VAR(&QDATA) VALUE(' ')

/*------------------------------------------------------------------*/
/*ÇEMAIL SPREADSHEET & SAVE XLSX TO IFS DIRECTORY                   */
/*------------------------------------------------------------------*/
             IF         COND(&TOTALCNT *EQ 0) THEN(DO)
             CALLSUBR   SUBR(SENDERR)
             ENDDO

             IF         COND(&TOTALCNT *GT 0) THEN(DO)
             CHGVAR     VAR(&EMLMSG) VALUE('Date Range:' *BCAT +
                          &WBDTEA *BCAT 'to' *BCAT &WEDTEA *BCAT +
                          'for Bus. Office' *BCAT &BUSOFF)
/*ÇSet File Name to Save to IFS Directory                           */
             IF         COND(&BUSOFF *EQ 'OKLIV') THEN(DO)
             CHGVAR     VAR(&FILENAME) VALUE(&FILENM *TCAT 'OK' +
                          *TCAT &CURDTETME2 *TCAT '.CSV')
             ENDDO
             ELSE       CMD(DO)
             CHGVAR     VAR(&FILENAME) VALUE(&FILENM *TCAT 'IF' +
                          *TCAT &CURDTETME2 *TCAT '.CSV')
             ENDDO

/*ÇSet IFS Stream File Path                                         */
/*           CHGVAR     VAR(&TOSTMF) VALUE(&IFSDIR *TCAT &FILENM)   */

/*ÇJM-WI628-START-Send XLSX to user with Header                     */
             EXECUTE    SQL('SELECT * FROM HSP370') PCFMT(*XLSX) +
                          REPLACE(*YES) RECIPIENT(&EMAILDL) +
                          EMLMSG(&EMLMSG) TEXT(&EMLSBJ)
             MONMSG     MSGID(CPF0000)

/*ÇJM-WI628-Send CSV to AGVIEW without Header                      */
             CHGVAR     VAR(&TOSTMF) VALUE(&IFSDIR *TCAT &FILENAME)
             EXECUTE    SQL('SELECT * FROM HSP370') +
                          PCFMT(*DELIMITED) TOSTMF(&TOSTMF) +
                          REPLACE(*YES)
             MONMSG     MSGID(CPF0000)
             ENDDO

             DLTF       FILE(QTEMP/HSP370)
             DLTOVR     FILE(*ALL)
/*Ç--------------------------------------------------------------- */
/*ÇValidate To date is greater than from date                       */
/*Ç--------------------------------------------------------------- */
             SUBR       SUBR(VALDAYS)
             CVTDAT     DATE(&WBDTEA) TOVAR(&FRMDATC) FROMFMT(*YYMD) +
                          TOFMT(*JUL) TOSEP(*NONE)
             CVTDAT     DATE(&WEDTEA) TOVAR(&TODATC) FROMFMT(*YYMD) +
                          TOFMT(*JUL) TOSEP(*NONE)
             CHGVAR     VAR(&FRMDATN) VALUE(&FRMDATC)
             CHGVAR     VAR(&TODATN) VALUE(&TODATC)
             IF         COND((&TODATN - &FRMDATN) *LT 0) THEN(DO)
             CALLSUBR   SUBR(SENDERR)
             CHGVAR     VAR(&ERRFLAG) VALUE('Y')
             ENDDO
             ENDSUBR
/*Ç--------------------------------------------------------------- */
/*ÇSend error email if dates duration exceeds 90 days              */
/*Ç--------------------------------------------------------------- */
             SUBR       SUBR(SENDERR)
             CHGVAR     VAR(&MSGTXT) VALUE('Actual Movement Log for +
                          Agview Resend did not extract any data +
                          for the spreadsheet for Date Range:' +
                          *BCAT &WBDTEA *BCAT 'to' *BCAT &WEDTEA +
                          *BCAT 'for Bus. Office' *BCAT &BUSOFF)
/*ÇJM-WI628-START Deactivate notifications                               */
/*ÇJM-S027448-START-Reactivate notifications                             */
             ESNDMAIL   RECIPIENT(&EMAILDL) SUBJECT(&EMLSBJ) +
                          MSG(&MSGTXT)
             MONMSG     MSGID(CPF0000)
/*ÇJM-S027448-END                                                        */
/*ÇJM-WI628-END                                                          */
             ENDSUBR
 EXIT:       ENDPGM
/*Ç--------------------------------------------------------------- */
/*ÇJM-WI628-START-Commented old program as it is                   */
/*Ç--------------------------------------------------------------- */
/*           DCL        VAR(&ACYR) TYPE(*DEC) LEN(4 0)                   */
/*           DCL        VAR(&ACPE) TYPE(*DEC) LEN(2 0)                   */
/*           DCL        VAR(&ACQR) TYPE(*DEC) LEN(1 0)                   */
/*           DCL        VAR(&ACWK) TYPE(*DEC) LEN(2 0)                   */
/*           DCL        VAR(&PICDT) TYPE(*DEC) LEN(5 0)                  */
/*           DCL        VAR(&CDYR) TYPE(*DEC) LEN(4 0)                   */
/*           DCL        VAR(&CDWK) TYPE(*DEC) LEN(2 0)                   */
/*           DCL        VAR(&FLAG)    TYPE(*CHAR) LEN(1)                 */
     /* Get System Value For Data File Library to Determine Whether +
               in PROD or TEST Environment */
/*           CALL       PGM(PPJXXFR) PARM(' ' 'DTALIB' &DTALIB)    */

     /* Set Constant Defaults */
/*           IF         COND(&DTALIB *NE 'PRKFLIB') THEN(DO)             */
/*           CHGVAR     VAR(&EMAILDL) VALUE('dl agview test')            */
/*           CHGVAR     VAR(&EMLSBJ) VALUE('HPS: HP4762CL-Actual +       */
/*                        Movement Log Agview-RESEND Data' *BCAT +       */
/*                        '- TEST')                                      */
/*           CHGVAR     VAR(&IFSDIR) VALUE('/AGVIEW/TEST/')              */
/*           ENDDO                                                       */
/*           ELSE       CMD(DO)                                          */
/*           CHGVAR     VAR(&EMAILDL) VALUE('dl agview')                 */
/*           CHGVAR     VAR(&EMLSBJ) VALUE('HPS: HP4762CL-Actual +       */
/*                        Movement Log Agview-RESEND Data')              */

    /* Make IFS PROD Directory If Not Found */

/*           CHGVAR     VAR(&IFSDIR) VALUE('/AGVIEW/PROD/')              */
/*           ENDDO                                                       */

/*-------------------------------------------------------------------*/
/* CREATE WORKFILES                                                  */
/*-------------------------------------------------------------------*/

/*           CRTDUPOBJL OBJ(HSP370) FROMLIB(*LIBL) OBJTYPE(*FILE) +      */
/*                        TOLIB(QTEMP)                                   */
/*                                                                       */
/*           CRTDUPOBJL OBJ(HSP374) FROMLIB(*LIBL) OBJTYPE(*FILE) +      */
/*                        TOLIB(QTEMP) /* For Download */                */

/*-------------------------------------------------------------------*/
/*  USE FROM DATE & TO DATE FROM PARM.                               */
/*-------------------------------------------------------------------*/

/*           RTVSYSVAL  SYSVAL(QDATE) RTNVAR(&CURDTE)                    */
/*           RTVSYSVAL  SYSVAL(QDATETIME) RTNVAR(&CURDTETME)             */

    /* Set &CURDTETME2 as CCYYMMDDHHMMSS Format  */
/*           CHGVAR     VAR(&CURDTETME2) VALUE(%SST(&CURDTETME 1 14))    */
/*                                                                       */
/*           CVTDAT     DATE(&CURDTE) TOVAR(&CURDTE2) FROMFMT(*MDY) +    */
/*                        TOFMT(*YYMD) TOSEP(*NONE)                      */

/*           CHGVAR     VAR(&CCYYMMDD) VALUE(&CURDTE2)                   */

         /*  CALL       PGM(HP8017) PARM(&CCYYMMDD &ACYR &ACPE &ACQR +
                          &ACWK &PICDT &CDYR &CDWK)                  */

         /*  CALL       PGM(HP8016) PARM(&CDYR &CDWK &WBDTE &WEDTE)  */

/*           CHGVAR     VAR(&WBDTE) VALUE(&FRDATE)                       */
/*           CHGVAR     VAR(&WEDTE) VALUE(&TODATE)                       */

/*           CHGVAR     VAR(&WBDTEA) VALUE(&WBDTE)                       */
/*           CHGVAR     VAR(&WEDTEA) VALUE(&WEDTE)                       */

/*-------------------------------------------------------------------*/
/*  SETUP QUERY OVER THE MOVEMENT EVENT FILE                         */
/*-------------------------------------------------------------------*/
/*  SELECT ALL SALES AND TRANSFER EVENT RECORDS FOR THE GIVEN        */
/*  WEEK BEGINNING & ENDING DATE.                                    */

/*           CHGVAR     VAR(%SST(&QDATA 1 10)) VALUE('MEMEDT *GE')       */
/*           CHGVAR     VAR(%SST(&QDATA 12 8)) VALUE(&WBDTE)             */
/*           CHGVAR     VAR(%SST(&QDATA 21 15)) VALUE('*AND MEMEDT +     */
/*                        *LE')                                          */
/*           CHGVAR     VAR(%SST(&QDATA 37 8)) VALUE(&WEDTE)             */
/*           CHGVAR     VAR(%SST(&QDATA 46 40)) VALUE('*AND (MEMTCD +    */
/*                        *EQ "T" *OR MEMTCD *EQ "S")')                  */

/*           OVRDBF     FILE(HSP058) SHARE(*YES)                         */
/*           OPNQRYF    FILE((HSP058)) QRYSLT(&QDATA) KEYFLD(*FILE) +    */
/*                        SEQONLY(*YES)                                  */

/*-------------------------------------------------------------------*/
/*  BUILD THE WORKFILE                                               */
/*-------------------------------------------------------------------*/

/*           CALL PGM(HP370)                                             */

/*           CLOF       OPNID(HSP058)                                    */
/*           DLTOVR     FILE(HSP058)                                     */

/*           CHGVAR     VAR(&QDATA) VALUE(' ')                           */

/*-------------------------------------------------------------------*/
/* ORIGIN REPORT - By Default, Process will pick up only 'OR' seq.   */
/*                 Match Business Office to Parameter Bus. Office.   */
/*-------------------------------------------------------------------*/

/*           CHGVAR     VAR(%SST(&QDATA 1 12)) VALUE('WFORBO *EQ "')     */
/*           CHGVAR     VAR(%SST(&QDATA 13 5)) VALUE(&BUSOFF)            */
/*           CHGVAR     VAR(%SST(&QDATA 18 1)) VALUE('"')                */

/*  OPEN QUERY FILE FOR ORIGIN REPORT                            */

/*           OVRDBF     FILE(HSP370) SHARE(*YES)                         */
/*           OPNQRYF    FILE((HSP370)) QRYSLT(&QDATA) +                  */
/*                        KEYFLD((WFORPP) (WFORFS) (WFRCDT) +            */
/*                        (WFORHG)) SEQONLY(*YES)                        */

/*------------------------------------------------------------------*/
/* EMAIL SPREADSHEET & SAVE XLSX TO IFS DIRECTORY                   */
/*------------------------------------------------------------------*/

/*           CALL PGM(HP374) PARM(&FLAG)                                 */

/*           IF         COND(&FLAG = 'Z')     THEN(DO)                   */
/*           CHGVAR     VAR(&MSGTXT) VALUE('Actual Movement Log for +    */
/*                        Agview Resend did not extract any data +       */
/*                        for the spreadsheet for Date Range:' +         */
/*                        *BCAT &WBDTEA *BCAT 'to' *BCAT &WEDTEA +       */
/*                        *BCAT 'for Bus. Office' *BCAT &BUSOFF)         */
/*           ESNDMAIL   RECIPIENT(&EMAILDL) SUBJECT(&EMLSBJ) +           */
/*                        MSG(&MSGTXT)                                   */
/*           MONMSG     MSGID(CPF0000)                                   */
/*           ENDDO                                                       */

/*           CHGVAR     VAR(&EMLMSG) VALUE('Date Range:' *BCAT +         */
/*                        &WBDTEA *BCAT 'to' *BCAT &WEDTEA *BCAT +       */
/*                        'for Bus. Office' *BCAT &BUSOFF)               */
/*           IF         COND(&FLAG = 'T')     THEN(DO)                   */
    /*êP2098 - We should never hit this since process will be build weekly +
              êand will not have more than 7 days worth of data. */
/*           ESNDMAIL   RECIPIENT(&EMAILDL) SUBJECT(&EMLSBJ) +           */
/*                        MSG('Actual Movement Log for Agview +          */
/*                        Resend extracted over 66,000 +                 */
/*                        records--which is too many records for +       */
/*                        the spreadsheet to handle. Please notify +     */
/*                        AS400 personnel to fix this problem.')         */
/*           MONMSG     MSGID(CPF0000)                                   */
/*           ENDDO                                                       */

/*           IF         COND(&FLAG = ' ')     THEN(DO)                   */
/*           CHGVAR     VAR(&EMLMSG) VALUE('Date Range:' *BCAT +         */
/*                        &WBDTEA *BCAT 'to' *BCAT &WEDTEA *BCAT +       */
/*                        'for Bus. Office' *BCAT &BUSOFF)               */

    /* Set File Name to Save to IFS Directory */
/*           IF         COND(&BUSOFF *EQ 'OKLIV') THEN(DO)               */
/*           CHGVAR     VAR(&FILENM) VALUE(&FILENM *TCAT 'OK' *TCAT +    */
/*                        &CURDTETME2 *TCAT '.XLSX')                     */
/*           ENDDO                                                       */
/*           ELSE       CMD(DO)                                          */
/*           CHGVAR     VAR(&FILENM) VALUE(&FILENM *TCAT 'IF' *TCAT +    */
/*                        &CURDTETME2 *TCAT '.XLSX')                     */
/*           ENDDO                                                       */

   /* Set IFS Stream File Path */
/*           CHGVAR     VAR(&TOSTMF) VALUE(&IFSDIR *TCAT &FILENM)        */
/*                                                                       */
/*           EXECUTE    SQL('SELECT * FROM HSP374') PCFMT(*XLSX) +       */
/*                        TOSTMF(&TOSTMF) REPLACE(*YES) +                */
/*                        RECIPIENT(&EMAILDL) EMLMSG(&EMLMSG) +          */
/*                        TEXT(&EMLSBJ)                                  */

/*           MONMSG     MSGID(CPF0000)                                   */
/*           ENDDO                                                       */

/*           CLOF       OPNID(HSP370)                                    */
/*           DLTF       FILE(QTEMP/HSP370)                               */
/*           DLTF       FILE(QTEMP/HSP374)                               */
/*           DLTOVR     FILE(*ALL)                                       */


/*           ENDPGM                                                      */

