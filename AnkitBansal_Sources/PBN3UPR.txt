/********************************************************************/
/*  PROGRAM  - PBN3UPR                                              */
/*  SYNOPSIS - POPULATE THE DP ACTUAL FILE FOR THE IHUB                */
/*                                                                  */
/*  SYSTEM    - ORDER MANAGEMENT SYSTEM                             */
/*  DATE      -  07/22/2014                                        */
/*                                                                  */
/*   INPUT:  SELECT ORDERS BY REQUESTED SHIP DATE BY THIS RULE:   */
/*    CALCULATE 10 DAYS BACK, AND SELECT ORDERS FROM THAT PERIOD'S */
/*       BEGIN DATE THRU THE CURRENT DATE.   THIS WILL GIVE DP A  */
/*       10 DAY GRACE PERIOD IN WHICH TO RUN THE EOP.                */
/*   OUTPUT FILE:  PBBRCPP                                      */
/********************************************************************/
/* RMC E3884  1/27/15  EMAIL SQL OF ORDERS WITH CUSTS NOT CLASSIFIED */
/* RMC E3884  2/26/15  USE CALENDAR SUMMARY COMP 445 FOR PERIOD DATES*/
/* RMC S12847 3/27/18  445 NOT SETUP FOR 2018, USE CALCAL           */
/********************************************************************/
PBN3UPR:    PGM  PARM(&RTNCDE)

/* PARMS */
            DCL        VAR(&RTNCDE) TYPE(*CHAR) LEN(7)
            DCL        VAR(&FDATE) TYPE(*DEC) LEN(7 0)
            DCL        VAR(&TDATE) TYPE(*DEC) LEN(7 0)
            DCL        VAR(&FDAT) TYPE(*DEC) LEN(7 0)
            DCL        VAR(&TDAT) TYPE(*DEC) LEN(7 0)
            DCL        VAR(&CURDAT) TYPE(*DEC) LEN(7 0)
            DCL        VAR(&FDATEA) TYPE(*CHAR) LEN(7)
            DCL        VAR(&TDATEA) TYPE(*CHAR) LEN(7)
            DCL        VAR(&JOBDATE) TYPE(*CHAR) LEN(6)
            DCL        VAR(&JOBDTE) TYPE(*CHAR) LEN(7)
            DCL        VAR(&NODAYS) TYPE(*DEC) LEN(5 0)  VALUE(10)
            DCL        VAR(&WEEK) TYPE(*DEC) LEN(2 0)
            DCL        VAR(&PDATE) TYPE(*DEC) LEN(7 0)

  /* GET CURRENT DATE TO GET PERIOD BEGIN/END DATES    */

             RTVJOBA    DATE(&JOBDATE)
             CVTDAT     DATE(&JOBDATE) TOVAR(&JOBDTE) FROMFMT(*MDY)   +
                          TOFMT(*CYMD) TOSEP(*NONE)
             CHGVAR     VAR(&CURDAT) VALUE(&JOBDTE)

   /* Send Actuals FOR THE PERIOD THAT (CURR DATE-10 DAYS) IS IN  */
       CALL    PGM(PBPHXFR) PARM('' &CURDAT &NODAYS &PDATE) /* 10 DYS PRIOR */

 /*  GET PERIOD begin DATE TO SEL REQ SHIP DATES   */
    CALL       PGM(PBOZUPR) PARM(&RTNCDE 'C'  &PDATE  &FDAT  &TDAT &WEEK)
 /* FROM CALENDAR SUMMARY COMPANY 445   */
        /*   CALL       PGM(PBQMXFR) PARM(&RTNCDE X'445F' &PDATE +
                          &FDAT &TDAT)                              */
             CHGVAR     VAR(&FDATEA) VALUE(&FDAT)

             CHGVAR     VAR(&TDATEA) VALUE(&CURDAT)

  /* CREATE DPACTUAL FILE ON AS400 FOR INPUT TO NEXT STEP  */

             EXECUTE    VIEW(DPDEMAND) OUTFILE(QTEMP/DPACTUAL) +
                          SETVAR((&FDATE &FDATEA) (&TDATE &TDATEA)) +
                          MSG(*NO)

  /* RECREATE DP ACTUAL FILE WITH REQ SHIP DATE RANGED ORDERS */

             CLRPFM     FILE(PBBRCPP)
             CALL       PGM(PBN1XFR) PARM(&RTNCDE)

  /* EMAIL SQL OF ORDERS WITH ITEMS NOT IN DP PRODUCT      */
  /* EMAIL SQL OF ORDERS WITH CUSTS NOT CLASSIFIED          */

             EXECUTE    VIEW(DPEXCEPT) PCFMT(*XLS) RECIPIENT(DPEXCEPT)
             EXECUTE    VIEW(DPEXCEPT2) PCFMT(*XLS) RECIPIENT(DPEXCEPT)

END:         ENDPGM
