/***************************************************************** */
/*                                                                 */
/*  SYSTEM:          TRIUMPH FOODS                                 */
/*  PROGRAM NUMBER:  TF460CL                                       */
/*  PROGRAM NAME:    LISTING OF ADJUSTMENTS FROM ARS               */
/*  PROGRAMMER:      LEANNE RAMSEY                                 */
/*  CREATE DATE:     05/23/2008                                    */
/*                                                                 */
/*  FUNCTION:        THIS REPORT IS GENERATED:                     */
/*                    1) ON-DEMAND                                 */
/*                                                                 */
/*******************************************************************/
/* MODIFICATIONS                                                   */
/*                                                                 */
/* 05/06/09  LeAnne Ramsey                                         */
/*           Changed print logic to match Meat Costing.            */
/*                                                                 */
/* 09/20/16  Danny Nguyen - E6933                                  */
/*           Change Open Query selection criteria to exclude       */
/*           Adjustment Type Code='RB' (Rebill) before calling     */
/*           TF360. This will prevent 'RB' records being created   */
/*           in the Workfile AR Adjustments (TFP360) ARS file.     */
/*           Change &QDATA length from 202 to 223.                 */
/*                                                                 */
/* 03/24/17  Brad Baden                                            */
/*           Added logic in the open query file logic to restrict  */
/*           the companies selected to be only 360 and 960.        */
/*           Increased the size of field QDATA to 265 for the      */
/*           additional query selection.                           */
/*                                                                 */
/* 03/02/18  Danny Nguyen - S12308                                 */
/*           Change Open Query selection criteria to exclude 440   */
/*           G/L ID Code JDE. Also, do NOT select Adj Type of 'STP'*/
/*           (Stop Payment).                                       */
/*           Change &QDATA length from 265 to 320.                 */
/*           Added TFL360A file to create in QTEMP.                */
/*           If Company is 440, call TF6600 report for 440 only.   */
/*                                                                 */
/* 05/12/21  DANNY NGUYEN    (R17061)                              */
/*           Get E1LIVE flag from Company Values. If E1LIVE=Y      */
/*           then call cloned program TF6600E which will no longer */
/*           use/print M3 DIMS.                                    */
/*           FOR M3 -- IF LIVE/PARALLEL  PRINT TF6600 STILL        */
/*                                                                 */
/* 07/30/21  ROSE CENTONZE   (R17061)                              */
/*           FOR E1 -- EXCLUDE THE 440 ARREGTRD GL ACCT ID 02693697 */
/* 11/30/21  ADDED TO EXCLUDE 960.1411 GLID 02690233   (SDN440)     */
/*           AND LEFT TO EXCLUDE 960.1410 02495224 SINCE PRIOR ADJ HAVE IT */
/* 04/29/24  REPLACE OPNQRYF WITH OPNSQLF                          */
/*           ADDED NEEDED OVRDBF AROUND THE COMMAND                */
/*           CHANGE *AND TO AND, *EQ TO =, *GE TO >=, *LE TO <= ,  */
/*           *GT TO > IN &QDATA                                    */
/*                                                                 */
/*******************************************************************/

             PGM

/*R9717      DCL        VAR(&QDATA) TYPE(*CHAR) LEN(265)        */
/*S12308     DCL        VAR(&QDATA) TYPE(*CHAR) LEN(345)        */
/*R17061     DCL        VAR(&QDATA) TYPE(*CHAR) LEN(371)        */
/*SDN440*/   DCL        VAR(&QDATA) TYPE(*CHAR) LEN(397)
             DCL        VAR(&E1LIVE) TYPE(*CHAR) LEN(1)  /* R17061 */
             DCL        VAR(&M3LIVE) TYPE(*CHAR) LEN(1)  /* R17061 */

             DCL        VAR(&OUTQ) TYPE(*CHAR) LEN(10)
             DCL        VAR(&HOLD) TYPE(*CHAR) LEN(4)
             DCL        VAR(&SAVE) TYPE(*CHAR) LEN(4)
             DCL        VAR(&COPY) TYPE(*DEC)  LEN(1)

             DCL        VAR(&LDFSYNDT)  TYPE(*DEC)  LEN(7)
             DCL        VAR(&LDTSYNDT)  TYPE(*DEC)  LEN(7)
             DCL        VAR(&LDCONO)    TYPE(*DEC)  LEN(3)
             DCL        VAR(&LDAJTY)    TYPE(*CHAR) LEN(3)
             DCL        VAR(&LDAJACT)   TYPE(*CHAR) LEN(1)

             CHGVAR     VAR(&LDFSYNDT)  VALUE(%SST(*LDA 29 7))
             CHGVAR     VAR(&LDTSYNDT)  VALUE(%SST(*LDA 36 7))
             CHGVAR     VAR(&LDCONO)    VALUE(%SST(*LDA 70 3))
             CHGVAR     VAR(&LDAJTY)    VALUE(%SST(*LDA 73 3))
             CHGVAR     VAR(&LDAJACT)   VALUE(%SST(*LDA 76 1))

/*----------------------------------------------------------------*/
/* RETRIEVE/SET PRINT DEFAULTS                                    */
/*----------------------------------------------------------------*/

 OUTQ:       CHGVAR     VAR(&OUTQ) VALUE(%SST(*LDA 401 10))
             IF         COND(&OUTQ = '          ') THEN(CHGVAR +
                          VAR(&OUTQ) VALUE(*JOB))

 HOLD:       CHGVAR     VAR(&HOLD) VALUE(%SST(*LDA 411 4))
             IF         COND(&HOLD *NE '*YES' *AND &HOLD *NE '*NO ') +
                          THEN(CHGVAR VAR(&HOLD) VALUE(*NO))

 SAVE:       CHGVAR     VAR(&SAVE) VALUE(%SST(*LDA 415 4))
             IF         COND(&SAVE *NE '*YES' *AND &SAVE *NE '*NO ') +
                          THEN(CHGVAR VAR(&SAVE) VALUE(*NO))

 COPY:       CHGVAR     VAR(&COPY) VALUE(%SST(*LDA 419 1))
             IF         COND(&COPY = 0) THEN(CHGVAR VAR(&COPY) +
                          VALUE(1))

/*--------------------------------------------------------------------------*/
/*  Extract data from the SYNON AR Detail file                              */
/*--------------------------------------------------------------------------*/

             CHGVAR     VAR(&QDATA) VALUE(' ')

             CHGVAR     VAR(&QDATA) VALUE(' ')
   /*PIO     CHGVAR     VAR(%SST(&QDATA 1 10)) VALUE('BFDVDT *GE')  */
   /*PIO*/   CHGVAR     VAR(%SST(&QDATA 1 10)) VALUE('BFDVDT  >= ')
             CHGVAR     VAR(%SST(&QDATA 12 7)) VALUE(&LDFSYNDT)
    /*PIO    CHGVAR     VAR(%SST(&QDATA 20 15)) VALUE('*AND BFDVDT +  +
                          *LE')                                   */
    /*PIO*/  CHGVAR     VAR(%SST(&QDATA 20 15)) VALUE(' AND BFDVDT +
                           <= ')
             CHGVAR     VAR(%SST(&QDATA 36 7)) VALUE(&LDTSYNDT)

   /*PIO     CHGVAR     VAR(%SST(&QDATA 44 21)) VALUE('*AND BFA5ST +  +
                          *EQ "ADJ"')                                */
   /*PIO*/   CHGVAR     VAR(%SST(&QDATA 44 21)) VALUE(' AND BFA5ST +
                           =  "ADJ"')

    /*PIO    CHGVAR     VAR(%SST(&QDATA 66 19)) VALUE('*AND BFAJST +  +
                          *EQ "P"')                                 */
    /*PIO*/  CHGVAR     VAR(%SST(&QDATA 66 19)) VALUE(' AND BFAJST +
                            = "P"')

   /*PIO     CHGVAR     VAR(%SST(&QDATA 86 26)) VALUE('*AND BFIZTX +  +
                          *NE "00443012"')                           */
   /*PIO*/   CHGVAR     VAR(%SST(&QDATA 86 26)) VALUE(' AND BFIZTX +
                          <>  "00443012"')

    /*PIO    CHGVAR     VAR(%SST(&QDATA 113 26)) VALUE('*AND BFIZTX + +
                          *NE "02495224"')                           */
    /*PIO*/  CHGVAR     VAR(%SST(&QDATA 113 26)) VALUE(' AND BFIZTX +
                           <> "02495224"')
/* IF COMPANY <> 000                                                 */
             IF         COND(&LDCONO *NE 0) THEN(DO)
   /*PIO     CHGVAR     VAR(%SST(&QDATA 140 15)) VALUE('*AND BFAIC3 *EQ') */
   /*PIO*/   CHGVAR     VAR(%SST(&QDATA 140 15)) VALUE(' AND BFAIC3  = ')
             CHGVAR     VAR(%SST(&QDATA 156 3)) VALUE(&LDCONO)
             ENDDO

/* IF EXCLUDING A SPECIFIC ADJUSTMENT TYPE                          */

             IF         COND(&LDAJTY *NE ' ' *AND &LDAJACT = 'E') THEN(DO)
   /*PIO     CHGVAR     VAR(%SST(&QDATA 160 17)) VALUE('*AND BFUHCD *NE "') */
   /*PIO*/   CHGVAR     VAR(%SST(&QDATA 160 17)) VALUE(' AND BFUHCD <>  "')
             CHGVAR     VAR(%SST(&QDATA 177 3)) VALUE(&LDAJTY)
             CHGVAR     VAR(%SST(&QDATA 180 1)) VALUE('"')
             ENDDO

/* IF PRINTING ONLY A SPECIFIC ADJUSTMENT TYPE                      */

             IF         COND(&LDAJTY *NE ' ' *AND &LDAJACT = 'O') THEN(DO)
  /*PIO      CHGVAR     VAR(%SST(&QDATA 182 17)) VALUE('*AND BFUHCD *EQ "')  */
  /*PIO*/    CHGVAR     VAR(%SST(&QDATA 182 17)) VALUE(' AND BFUHCD  =  "')
             CHGVAR     VAR(%SST(&QDATA 199 3)) VALUE(&LDAJTY)
             CHGVAR     VAR(%SST(&QDATA 202 1)) VALUE('"')
             ENDDO

/*E6933:     Exclude Adjustment Type Code='RB' (Rebill).                      */
  /*PIO      CHGVAR     VAR(%SST(&QDATA 204 20)) VALUE('*AND BFUHCD + +
                          *NE "RB"')                               */
  /*PIO*/    CHGVAR     VAR(%SST(&QDATA 204 20)) VALUE(' AND BFUHCD +
                           <> "RB"')

/* IF COMPANY = 000                                                 */
             IF         COND(&LDCONO *EQ 0) THEN(DO)
  /*PIO      CHGVAR     VAR(%SST(&QDATA 225 40)) VALUE('*AND (BFAIC3 + +
                          *EQ 360 *OR BFAIC3 *EQ 960)')               */
  /*PIO*/    CHGVAR     VAR(%SST(&QDATA 225 40)) VALUE(' AND (BFAIC3 +
                           =  360  OR BFAIC3 = 960)')
             ENDDO

/*S12308:    Exclude 440 G/L ID Code JDE                                      */
   /*PIO     CHGVAR     VAR(%SST(&QDATA 266 26)) VALUE('*AND BFIZTX + +
                          *NE "ARREGTRD"')                          */
   /*PIO*/   CHGVAR     VAR(%SST(&QDATA 266 26)) VALUE(' AND BFIZTX +
                           <> "ARREGTRD"')                   /* 440 1410 */
   /*PIO     CHGVAR     VAR(%SST(&QDATA 293 26)) VALUE('*AND BFIZTX +  +
                          *NE "ARREG440"')                        */
   /*PIO*/   CHGVAR     VAR(%SST(&QDATA 293 26)) VALUE(' AND BFIZTX +
                           <> "ARREG440"')                   /* 440 ALSO 1410 */
   /*PIO     CHGVAR     VAR(%SST(&QDATA 320 26)) VALUE('*AND BFIZTX +  +
                          *NE "02693697"')                            */
   /*PIO*/   CHGVAR     VAR(%SST(&QDATA 320 26)) VALUE(' AND BFIZTX +
                           <> "02693697"')                   /* 440 GL ACCT ID*/

/*SDN440     Exclude 960 G/L ID Code JDE FOR 960.1411                         */
  /*PIO      CHGVAR     VAR(%SST(&QDATA 347 26)) VALUE('*AND BFIZTX + +
                          *NE "02690233"')                          */
  /*PIO*/    CHGVAR     VAR(%SST(&QDATA 347 26)) VALUE(' AND BFIZTX +
                          <>  "02690233"')

    /*       Exclude Adjustment Type 'STP' (Stop Payment)                     */
   /*PIO     CHGVAR     VAR(%SST(&QDATA 374 21)) VALUE('*AND BFUHCD +  +
                          *NE "STP"')                                */
   /*PIO*/   CHGVAR     VAR(%SST(&QDATA 374 21)) VALUE(' AND BFUHCD +
                           <> "STP"')


   /*PIO     OVRDBF     FILE(ARBECPL1) SHARE(*YES)      +
             OPNQRYF    FILE((ARBECPL1)) QRYSLT(&QDATA) +   +
                          KEYFLD((BFAIC3) (BFW3SX)) SEQONLY(*YES) */

   /*PIO*/    OVRDBF     FILE(ARBECPP) TOFILE(ARBECPP) LVLCHK(*NO)
             OPNSQLF    SQL('Select * from ARBECPP where  ' *BCAT +
                          &QDATA  *BCAT ' Order by BFAIC3 asc, +
                          BFCONB asc, BFCEST asc, BFDXNB asc') +
                          OPNID(ARBECPL1) OPTION(*ALL) SEQONLY(*NO) +
                          RCDFMT(@BFCPFO) ALWCPY(*IFRQD) /*PIO*/
     /*PIO*/  OVRDBF     FILE(ARBECPL1) TOFILE(ARBECPP) LVLCHK(*NO) +
                         OVRSCOPE(*JOB) SHARE(*YES) OPNSCOPE(*JOB)


/*--------------------------------------------------------------------------*/
/* Create/build workfile                                                    */
/*--------------------------------------------------------------------------*/

             CRTDUPOBJL OBJ(TFP360) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)
/*S12308*/   CRTDUPOBJL OBJ(TFL360A) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)

             CALL       PGM(TF360)

             CLOF       OPNID(ARBECPL1)
    /*PIO    DLTOVR     FILE(*ALL)    */
             DLTOVR     FILE(*ALL) LVL(*JOB) /*PIO*/

/*--------------------------------------------------------------------------*/
/*  Run listing                                                             */
/*--------------------------------------------------------------------------*/

             OVRPRTF    FILE(PRINT198) OUTQ(&OUTQ) COPIES(&COPY) +
                          HOLD(&HOLD) SAVE(&SAVE)

/* S12308-Call TF6600 Report for 440 only if Company 440 Selected.         */
             IF         COND(&LDCONO *NE 440) THEN(DO)
             CALL       PGM(TF660)
             ENDDO
             ELSE       CMD(DO)
/* R17061 - Get E1LIVE Flag from Company Values */
             CALL       PGM(POMTXFR) PARM('' &LDCONO 'E1LIVE' &E1LIVE)
             CALL       PGM(POMTXFR) PARM('' &LDCONO 'M3LIVE' &M3LIVE)

             IF         COND(&M3LIVE *EQ 'Y' *OR &M3LIVE *EQ 'P') THEN(DO)
             CALL       PGM(TF6600)
             ENDDO
             IF         COND(&E1LIVE *EQ 'Y') THEN(DO)
             CALL       PGM(TF6600E)
             ENDDO
             ENDDO

             DLTOVR     FILE(*ALL)

             ENDPGM

