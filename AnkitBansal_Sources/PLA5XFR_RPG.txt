     H/TITLE Gen DS Template Slots XF  Execute external functio
     H            Y
     Z* CRTRPGPGM
     Z* CVTOPT(*DATETIME)
      *
     H* SYNOPSIS :
     H*  Perform user function
     H*  As defined by action diagram
      *
     H* Generated by CA 2E release 8.6 (1547)
     H* Function type : Execute external function
      *
     H* Company       : HPEDEVMDL
     H* System        : HPEDEVMDL
     H* User name     : ISJBADE
     H* Date          : 04/20/17  Time  : 15:25:15
     H* Copyright     : HPEDEVMDL
      *
      *================================================================
     M* Maintenance   :
      *================================================================
     FPLACREL0IF  E           K        DISK                      A
      * UPD : Delivery Sched Template   Update index
      *
     I@ACREIO
      * Delivery Sched Template   Update index
      * Renamed input format fields
     I              ACHONB                          WAHONB
     I              ACWVST                          WAWVST
     I              ACAFTH                          WAAFTH
     I              ACHWA1                          WAHWA1
     I              ACXRST                          WAXRST
     I              ACIMA1                          WAIMA1
     I              ACH9A1                          WAH9A1
     I              ACIAA1                          WAIAA1
     I              ACXAST                          WAXAST
     I              ACXFST                          WAXFST
     I              ACXOST                          WAXOST
     I              ACWWST                          WAWWST
     I              ACABCD                          WAABCD
     I              ACAECD                          WAAECD
     I              ACAACD                          WAAACD
     I              ACDMT1                          WADMT1
     I              ACDNT1                          WADNT1
     I              ACIMSS                          WAIMSS
     I              ACAAVN                          WAAAVN
     I              ACAADT                          WAAADT
     I              ACAMTM                          WAAMTM
     I              ACAJST                          WAAJST
     I              ACAHVN                          WAAHVN
     I              ACAGVN                          WAAGVN
     I              ACABVN                          WAABVN
     I              ACABDT                          WAABDT
     I              ACABTM                          WAABTM
      *
      /EJECT
      * Data structures:
     IPGMDS     ESDSY2PGDSP
      * Modified Program data structure
     IJBDTTM      DS
      * Job date/time
     I                                        1   70##JDT
     I                                        1   10##JCC
     I                                        2   30##JYY
     I                                        4   50##JMM
     I                                        6   70##JDD
     I                                        8  130##JTM
     I                                        8   90##JHH
     I                                       10  110##JNN
     I                                       12  130##JSS
      /EJECT
     IXTCK        DS
      * Time: hours, minutes, seconds
     I                                        1   60XTTIM
     I                                        1   20XTHH
     I                                        3   40XTNN
     I                                        5   60XTSS
     IQPLAC1    E DSPLACREL0
      * UPD : Delivery Sched Template   Update index
      * Renamed input format fields
     I              ACHONB                          WAHONB
     I              ACWVST                          WAWVST
     I              ACAFTH                          WAAFTH
     I              ACHWA1                          WAHWA1
     I              ACXRST                          WAXRST
     I              ACIMA1                          WAIMA1
     I              ACH9A1                          WAH9A1
     I              ACIAA1                          WAIAA1
     I              ACXAST                          WAXAST
     I              ACXFST                          WAXFST
     I              ACXOST                          WAXOST
     I              ACWWST                          WAWWST
     I              ACABCD                          WAABCD
     I              ACAECD                          WAAECD
     I              ACAACD                          WAAACD
     I              ACDMT1                          WADMT1
     I              ACDNT1                          WADNT1
     I              ACIMSS                          WAIMSS
     I              ACAAVN                          WAAAVN
     I              ACAADT                          WAAADT
     I              ACAMTM                          WAAMTM
     I              ACAJST                          WAAJST
     I              ACAHVN                          WAAHVN
     I              ACAGVN                          WAAGVN
     I              ACABVN                          WAABVN
     I              ACABDT                          WAABDT
     I              ACABTM                          WAABTM
      *
      /EJECT
      * Parameter declarations
     IP1PARM      DS
      * FLD: Delivery Sched Template
      * I :  CC Company Number
     I                                    P   1   20P1HONB
      * I :  DST Delivery Day of Week
     I                                        3   3 P1WVST
      * I :  DST Delivery Time
     I                                    P   4   60P1AFTH
      * I :  DST Kill Day of Week
     I                                        7   7 P1XRST
     IP2PARM      DS
      * I :  End Day of Week USR
     I                                        1   1 P2XQST
     IP3PARM      DS
      * I :  End Delivery Time USR
     I                                    P   1   30P3BMTH
     IP4PARM      DS
      * I :  Time MM USR
     I                                    P   1   20P4TMMM
     I            DS
     I                                        1 132 ZAMSDA
      /EJECT
      *****************************************************************
      * Entry parameters
     C           *ENTRY    PLIST
     C                     PARM           P0RTN   7
     C           P1HONB    PARM           WP0001  30       CC Company Numb
     C           P1WVST    PARM           WP0002  1        DST Delivery Da
     C           P1AFTH    PARM           WP0003  40       DST Delivery Ti
     C           P1XRST    PARM           WP0004  1        DST Kill Day of
     C           P2XQST    PARM           WP0005  1        End Day of Week
     C           P3BMTH    PARM           WP0006  40       End Delivery Ti
     C           P4TMMM    PARM           WP0007  20       Time MM USR
      *****************************************************************
      * Initialize
     C                     EXSR ZZINIT
      *
      * Gen DS Template Slots XF
      * Modification historu
     C                     EXSR UASUBR                     Modification hi
      * Move to numeric field
     C                     MOVE P1WVST    WUHANB           Day of Week USR
     C                     MOVE P2XQST    YL0001           Day of Week USR
      * DO WHILE: WRK.Day of Week USR LE LCL.Day of Week USR
     C           WUHANB    DOWLEYL0001                     *DOW
     C                     MOVELWUHANB    YL0002           DST Delivery Da
      * DOW is the start DOW
      * CASE: LCL.DST Day of Week EQ PAR.DST Day of Week
     C           YL0002    IFEQ P1WVST                     *IF
     C           P1AFTH    MULT 100       WUA8TM           Time Beg USR
     C                     END                             *FI
      * DOW is the Start Day of week, & not the end DOW
      * CASE:
      *  - c1ORc2
      *   |- c1    : LCL.DST Day of Week EQ PAR.DST Day of Week
      *   |- c2    : LCL.DST Day of Week NE PAR.End Day of Week USR
      *   '-
     C           YL0002    IFEQ P1WVST                     *IF
     C           YL0002    ORNE P2XQST                     *OR
     C                     Z-ADD240000    WUA9TM           Time End USR
     C                     END                             *FI
      * DOW is not Start Day of week, & not the end DOW
      * CASE:
      *  - c1ANDc2
      *   |- c1    : LCL.DST Day of Week NE PAR.DST Day of Week
      *   |- c2    : LCL.DST Day of Week NE PAR.End Day of Week USR
      *   '-
     C                     MOVEL'0'       Y0CX01  1
     C           YL0002    IFNE P1WVST                     *IF
     C           YL0002    IFNE P2XQST                     *IF
     C                     MOVEL'1'       Y0CX01
     C                     END                             *FI
     C                     END                             *FI
     C           Y0CX01    IFEQ '1'                        *IF
     C                     Z-ADD000000    WUA8TM           Time Beg USR
      * WRK.Time Beg USR = WRK.Time Beg USR + PAR.Time MM USR *MINUTES
     C                     Z-ADDWUA8TM    XTTIM
     C                     Z-ADD*ZERO     XASC    80
     C                     EXSR XTAD1
     C           60        MULT P4TMMM    XDWK1   80
     C                     ADD  XDWK1     XASC    80
     C                     EXSR XTCT1
     C                     Z-ADDXTTIM     WUA8TM
     C                     Z-ADD240000    WUA9TM           Time End USR
     C                     END                             *FI
      * DOW is the end DOW and not the start
      * CASE:
      *  - c1ANDc2
      *   |- c1    : LCL.DST Day of Week EQ PAR.End Day of Week USR
      *   |- c2    : LCL.DST Day of Week NE PAR.DST Day of Week
      *   '-
     C                     MOVEL'0'       Y0CX01  1
     C           YL0002    IFEQ P2XQST                     *IF
     C           YL0002    IFNE P1WVST                     *IF
     C                     MOVEL'1'       Y0CX01
     C                     END                             *FI
     C                     END                             *FI
     C           Y0CX01    IFEQ '1'                        *IF
     C                     Z-ADD000000    WUA8TM           Time Beg USR
      * WRK.Time Beg USR = WRK.Time Beg USR + PAR.Time MM USR *MINUTES
     C                     Z-ADDWUA8TM    XTTIM
     C                     Z-ADD*ZERO     XASC    80
     C                     EXSR XTAD1
     C           60        MULT P4TMMM    XDWK1   80
     C                     ADD  XDWK1     XASC    80
     C                     EXSR XTCT1
     C                     Z-ADDXTTIM     WUA8TM
     C                     END                             *FI
      * DOW is the end DOW
      * CASE: LCL.DST Day of Week EQ PAR.End Day of Week USR
     C           YL0002    IFEQ P2XQST                     *IF
     C           P3BMTH    MULT 100       WUA9TM           Time End USR
     C                     END                             *FI
     C                     Z-ADDWUA8TM    WUA7TM           Time 6.0 USR
      * DO WHILE:
      *  - c1ANDc2
      *   |- c1    : WRK.Time 6.0 USR GE WRK.Time Beg USR
      *   |- c2    : WRK.Time 6.0 USR LE WRK.Time End USR
      *   '-
     C                     DO   *HIVAL                     *DOW
     C                     MOVEL'0'       Y0CX01  1
     C           WUA7TM    IFGE WUA8TM                     *IF
     C           WUA7TM    IFLE WUA9TM                     *IF
     C                     MOVEL'1'       Y0CX01
     C                     END                             *FI
     C                     END                             *FI
     C           Y0CX01    IFEQ '1'                        *IF
     C                     ELSE
     C                     LEAVE
     C                     END                             *FI
     C           WUA7TM    DIV  100       YL0003           DST Delivery Ti
      * Crt Delv Sched Templt CR - Delivery Sched Template  * 
     C                     EXSR SACRRC
     C                     Z-ADDWUA7TM    WUA6TM           Time Out USR
      * WRK.Time 6.0 USR = WRK.Time 6.0 USR + PAR.Time MM USR *MINUTES
     C                     Z-ADDWUA7TM    XTTIM
     C                     Z-ADD*ZERO     XASC    80
     C                     EXSR XTAD1
     C           60        MULT P4TMMM    XDWK1   80
     C                     ADD  XDWK1     XASC    80
     C                     EXSR XTCT1
     C                     Z-ADDXTTIM     WUA7TM
      * Force fallout if time turns from 23:nn to 00:nn
      * CASE: WRK.Time 6.0 USR LT WRK.Time Out USR
     C           WUA7TM    IFLT WUA6TM                     *IF
     C                     Z-ADD0         WUA7TM           Time 6.0 USR
     C                     END                             *FI
     C                     END                             *ITR
     C                     ADD  1         WUHANB           Day of Week USR
     C                     END                             *ITR
      *----------------------------------------------------------------
      * Exit program
     C           AAEXIT    TAG
     C                     MOVEL*BLANK    P0RTN
     C                     EXSR ZYEXPG
      *================================================================
      /EJECT
     CSR         SACRRC    BEGSR
      *================================================================
      * Crt Delv Sched Templt CR - Delivery Sched Template  * 
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * Move all fields to @ACREIO
     C                     Z-ADDP1HONB    WAHONB           CC Company Numb
     C                     MOVELYL0002    WAWVST           DST Delivery Da
     C                     Z-ADDYL0003    WAAFTH           DST Delivery Ti
     C                     Z-ADD1         WAHWA1           DST Delivery Ti
     C                     MOVELP1XRST    WAXRST           DST Kill Day of
     C                     Z-ADD*ZERO     WAIMA1           DST Unused Head
     C                     Z-ADD*ZERO     WAH9A1           DST Scheduled D
     C                     Z-ADD*ZERO     WAIAA1           DST Scheduled K
     C                     MOVELWUJ6TX    WAXAST           DST Receiving S
     C                     MOVELWUJ6TX    WAXFST           DST Kill Shift
     C                     MOVELWUJ6TX    WAXOST           DST BOL Kill Sh
     C                     MOVELWUJ6TX    WAWWST           DST Source Type
     C                     MOVEL*BLANK    WAABCD           PD Producer Cod
     C                     MOVEL*BLANK    WAAECD           PL Location Cod
     C                     MOVELWUJ6TX    WAAACD           SR Source Code
     C                     MOVEL*BLANK    WADMT1           DST Ref 1
     C                     MOVEL*BLANK    WADNT1           DST Ref 2
     C                     MOVEL*BLANK    WAIMSS           DST Ref Status
     C                     MOVEL*BLANK    WAAAVN           RS User Changed
     C                     Z-ADD*ZERO     WAAADT           RS Date Changed
     C                     Z-ADD*ZERO     WAAMTM           RS Time Changed
     C                     MOVEL'A'       WAAJST           RS Record Statu
     C                     MOVEL*BLANK    WAAHVN           RS Job
     C                     MOVEL*BLANK    WAAGVN           RS Program
     C                     MOVEL*BLANK    WAABVN           RS User Added
     C                     Z-ADD*ZERO     WAABDT           RS Date Added
     C                     Z-ADD*ZERO     WAABTM           RS Time Added
      *
      * USER: Processing before Data update
      * Rtv Add Stamp         IF
     C                     MOVEL'A'       WAAJST           RS Record Statu
     C                     MOVEL##USR     WAABVN           RS User Added
     C                     Z-ADD##JDT     WAABDT           RS Date Added
     C                     Z-ADD##JTM     WAABTM           RS Time Added
     C                     MOVEL##PGM     WAAGVN           RS Program
     C                     MOVEL##JOB     WAAHVN           RS Job
     C           KLCRSA    KLIST
     C                     KFLD           WAHONB           CC Company Numb
     C                     KFLD           WAWVST           DST Delivery Da
     C                     KFLD           WAAFTH           DST Delivery Ti
     C                     KFLD           WAHWA1           DST Delivery Ti
      * Check for duplicate primary key
     C           KLCRSA    SETLL@ACREIO                  90*
     C           *IN90     IFEQ '1'
     C                     MOVEL'PRK1025' W0RTN   7
      * Send message 'Delivery Sched Templat EX'
     C                     MOVEL'PRK1025' ZAMSID
     C                     EXSR ZASNMS
     C                     GOTO SAEXIT
     C                     ENDIF
      *
     C                     WRITE@ACREIO                91  *
      *
     C           *IN91     IFEQ '1'
      * Write error detected
     C                     MOVEL'Y2U0004' W0RTN   7
     C                     ELSE
     C                     ENDIF
      *================================================================
     CSR         SAEXIT    ENDSR
      /EJECT
     CSR         UASUBR    BEGSR
      *================================================================
      * Modification historu
      *================================================================
      *  4/17/17 JBB C9426 - Accept new Ref fields on Template file.
      *                      Populate values on file create to blanks.
      *================================================================
     CSR         UAEXIT    ENDSR
      /EJECT
     CSR         XTAD1     BEGSR
      *================================================================
      * Add TME to absolute time (seconds)
      *================================================================
     C           XTHH      MULT 3600      XDWK1   80
     C                     ADD  XDWK1     XASC
     C           XTNN      MULT 60        XDWK1
     C                     ADD  XDWK1     XASC
     C                     ADD  XTSS      XASC
      *================================================================
     CSR         XTAD1E    ENDSR
      /EJECT
     CSR         XTCT1     BEGSR
      *================================================================
      * Convert absolute time (seconds) to TME
      *================================================================
     C                     EXSR XTFCT
     C           XASC      DIV  60        XASC
     C                     MVR            XTSS
     C           XASC      DIV  60        XASC
     C                     MVR            XTNN
     C                     Z-ADDXASC      XTHH
      *================================================================
     CSR         XTCT1E    ENDSR
      /EJECT
     CSR         XTFCT     BEGSR
      *================================================================
      * Factorize absolute date (seconds) by 24 hours
      *================================================================
     C           XASC      IFGE 86400
     C                     DIV  86400     XASC    80
     C                     MVR            XASC
     C                     ELSE
     C           XASC      IFLE *ZERO
     C                     DIV  86400     XASC
     C                     MVR            XASC
     C           XASC      IFNE *ZERO
     C                     ADD  86400     XASC
     C                     END
     C                     END
     C                     END
      *================================================================
     CSR         XTFCTE    ENDSR
      /EJECT
     CSR         ZASNMS    BEGSR
      *================================================================
      * Send message to program's message queue
      *================================================================
     C           ZAPGMQ    IFEQ *BLANK
     C                     MOVEL##PGM     ZAPGMQ
     C                     END
      * If no message file specified, use default
     C           ZAMSGF    IFEQ *BLANK
     C                     MOVELZADFMF    ZAMSGF
     C                     END
     C                     CALL 'Y2SNMGC'
     C                     PARM           ZAPGMQ 10        Program queue
     C                     PARM           ZAPGRL  5        Rel queue
     C                     PARM           ZAMSID  7        Message ID
     C                     PARM           ZAMSGF 10        Message file
     C                     PARM           ZAMSDA           Message data
     C                     PARM           ZAMSTP  7        Message type
      * Clear all fields for default mechanism next time
     C                     MOVEL*BLANK    ZAPGMQ
     C                     MOVEL*BLANK    ZAPGRL
     C                     MOVEL*BLANK    ZAMSID
     C                     MOVEL*BLANK    ZAMSGF
     C                     MOVEL*BLANK    ZAMSDA
     C                     MOVEL*BLANK    ZAMSTP
      *================================================================
     CSR         ZAEXIT    ENDSR
      /EJECT
     CSR         ZXEXPG    BEGSR
      *================================================================
      * Exit program: Normal
      *================================================================
     C                     EXSR ZYEXPG
      *================================================================
     CSR         ZXEXIT    ENDSR
      /EJECT
     CSR         ZYEXPG    BEGSR
      *================================================================
      * Exit program: Direct
      *================================================================
      * Copy any undisplayed messages back to caller
     C                     CALL 'Y2CPMSC'
     C                     PARM           ##PGM
      *
      * Terminate program
     C                     SETON                     LR
      *
      * Exit program
     C                     RETRN
      *
      *================================================================
     CSR         ZYEXIT    ENDSR
      /EJECT
     CSR         ZZINIT    BEGSR
      *================================================================
      * Initialisation
      *================================================================
     C           W0ICL     IFEQ *BLANK
     C                     MOVEL'Y'       W0ICL   1        *Initial call
     C                     ELSE
     C                     MOVEL'N'       W0ICL
     C                     END
     C                     MOVE *BLANK    P0RTN
     C                     MOVE *BLANK    W0RTN   7
     C                     MOVEL*BLANK    W0RSL   1
     C                     MOVEL*BLANK    W0RSF   1
     C                     MOVEL*ZEROS    W0RTW   90
     C                     MOVEL'400'     W0ENV   3
      * Retrieve job attributes
     C                     CALL 'Y2RTJCR'
     C                     PARM           PGMDS
      * Setup job date/time
     C                     Z-ADD##SD7     ##JDT
     C                     TIME           ##JTM
      * Update screen time
     C                     TIME           ##TME   60
      * Define work field Day of Week USR
     C                     Z-ADD*ZERO     WUHANB  10
      * Define work field Time Beg USR
     C                     Z-ADD*ZERO     WUA8TM  60
      * Define work field Time End USR
     C                     Z-ADD*ZERO     WUA9TM  60
      * Define work field Time 6.0 USR
     C                     Z-ADD*ZERO     WUA7TM  60
      * Define work field Blank Usr 2
     C                     MOVEL*BLANK    WUJ6TX  1
      * Initialize renamed input format fields
     C                     Z-ADD*ZERO     WAHONB           CC Company Numb
     C                     Z-ADD*ZERO     WAAFTH           DST Delivery Ti
     C                     Z-ADD*ZERO     WAHWA1           DST Delivery Ti
     C                     Z-ADD*ZERO     WAIMA1           DST Unused Head
     C                     Z-ADD*ZERO     WAH9A1           DST Scheduled D
     C                     Z-ADD*ZERO     WAIAA1           DST Scheduled K
     C                     Z-ADD*ZERO     WAAADT           RS Date Changed
     C                     Z-ADD*ZERO     WAAMTM           RS Time Changed
     C                     Z-ADD*ZERO     WAABDT           RS Date Added
     C                     Z-ADD*ZERO     WAABTM           RS Time Added
      * Obtain default message file
     C           *NAMVAR   DEFN PKMGFLA   ZADFMF 10
     C                     IN   ZADFMF
      * Define work field Time Out USR
     C                     Z-ADD*ZERO     WUA6TM  60
     C                     MOVEL'N'       W0PMT   1
      * Define local work field Day of Week USR
     C                     Z-ADD*ZERO     YL0001  10
      * Define local work field DST Delivery Day of Week
     C                     MOVEL*BLANK    YL0002  1
      * Define local work field DST Delivery Time
     C                     Z-ADD*ZERO     YL0003  40
      *================================================================
     CSR         ZZEXIT    ENDSR
