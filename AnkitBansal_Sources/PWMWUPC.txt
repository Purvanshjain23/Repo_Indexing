/***************************************************************** */
/*                                                                 */
/*  PROGRAM NUMBER:  PWMWUPC                                       */
/*  PROGRAM NAME:    Backup Data files for a Repayment             */
/*  PROGRAMMER:      Brad Baden                                    */
/*  CREATE DATE:      5/04/2021                                    */
/*                                                                 */
/*  FUNCTION:        This CL program backs up the data files that  */
/*                   are changed during a repayment.  The file     */
/*                   names of the backed up files are in the       */
/*                   format of llmmddffff.                         */
/*                   ffff = first 4 characters of the file name    */
/*                   ll   = location initials (GU, ST, or TF)      */
/*                   mm   = month                                  */
/*                   dd   = day                                    */
/*                                                                 */
/*                   This program is called from the Pmt Create    */
/*                   Repay Hdr PV screen PWMTPVR.  The From and    */
/*                   To library names, file suffix, current date,  */
/*                   and From and To Dates are passed into this    */
/*                   program.                                      */
/*                                                                 */
/*                   The files backed up are:                      */
/*                   PKAWCPP - Buy Order                           */
/*                   PKAXCPP - Buy Order Load                      */
/*                   PKA1CPP - Tattoo Header                       */
/*                   PKA2CPP - Tattoo Detail                       */
/*                   PKCDCPP - Tattoo Ded/Add                      */
/*                   PKDNCPP - Tattoo Header EXT                   */
/*                   PKB3CPP - Tattoo Scale Ticket                 */
/*                   PKB1CPP - Carcass Detail                      */
/*                                                                 */
/*******************************************************************/
/*  Modification History                                           */
/*                                                                 */
/*   5/04/2021 JBB SDD619 - Repayments by Business Users           */
/*   TFS: 17058    Program created.                                */
/*                                                                 */
/*   8/13/2021 JBB SDN619 - Repayments by Business Users           */
/*                 Remove CHKOBJ to determine if files already     */
/*                 exist.                                          */
/*                                                                 */
/*******************************************************************/
             PGM        PARM(&COMPANY &LIBRFROM &LIBRTO &PREFIX +
                          &JOBDATE &DATEFROM &DATETO)

             DCL        VAR(&COMPANY)  TYPE(*DEC)  LEN(3 0)
             DCL        VAR(&LIBRFROM) TYPE(*CHAR) LEN(10)
             DCL        VAR(&LIBRTO)   TYPE(*CHAR) LEN(10)
             DCL        VAR(&PREFIX)   TYPE(*CHAR) LEN(6)
             DCL        VAR(&JOBDATE)  TYPE(*DEC)  LEN(7 0)
             DCL        VAR(&DATEFROM) TYPE(*DEC)  LEN(7 0)
             DCL        VAR(&DATETO)   TYPE(*DEC)  LEN(7 0)

             DCL        VAR(&PREFIXDT) TYPE(*CHAR) LEN(4)
             DCL        VAR(&RETURN)   TYPE(*CHAR) LEN(7)
             DCL        VAR(&PRODFILE) TYPE(*CHAR) LEN(10)
             DCL        VAR(&SAVEFILE) TYPE(*CHAR) LEN(10)
             DCL        VAR(&PKAXFILE) TYPE(*CHAR) LEN(10)
             DCL        VAR(&SVFILENM) TYPE(*CHAR) LEN(10)
             DCL        VAR(&DATEJ)    TYPE(*CHAR) LEN(7)
             DCL        VAR(&DATEF)    TYPE(*CHAR) LEN(7)
             DCL        VAR(&DATET)    TYPE(*CHAR) LEN(7)
             DCL        VAR(&COMPVALA) TYPE(*CHAR) LEN(40)
             DCL        VAR(&CMPVALCD) TYPE(*CHAR) LEN(10) +
                          VALUE(HPEREPAYBU)
             DCL        VAR(&BACKUPSTS) TYPE(*CHAR) LEN(1)
             DCL        VAR(&BACKUPPRFX) TYPE(*CHAR) LEN(6)
             DCL        VAR(&PKAXSAVEF) TYPE(*CHAR) LEN(10)

             MONMSG     MSGID(CPF0000) EXEC(GOTO CMDLBL(ERROR))

/* Convert numeric dates to alpha dates */
             CHGVAR     VAR(&DATEJ) VALUE(&JOBDATE)
             CHGVAR     VAR(&DATEF) VALUE(&DATEFROM)
             CHGVAR     VAR(&DATET) VALUE(&DATETO)

/* Strip out prefix date from save file prefix */
             CHGVAR     VAR(&PREFIXDT) VALUE(%SST(&PREFIX 3 4))

/* Retrieve current backup status from Company Values */
             CALL       PGM(POMTXFR) PARM(&RETURN &COMPANY &CMPVALCD +
                          &COMPVALA)
             CHGVAR     VAR(&BACKUPSTS) VALUE(%SST(&COMPVALA 1 1))
             CHGVAR     VAR(&BACKUPPRFX) VALUE(%SST(&COMPVALA 5 4))

/* If files already backed up, exit program */
             IF         COND((&BACKUPPRFX *EQ &PREFIXDT) *AND +
                          (&BACKUPSTS = 'C')) THEN(GOTO CMDLBL(ENDIT))

/* Backup PKAWCPP - Buy Order */
             CHGVAR     VAR(&PRODFILE) VALUE('PKAWCPP   ')
             CHGVAR     VAR(&SAVEFILE) VALUE(&PREFIX *CAT 'PKAW')
             CHGVAR     VAR(&COMPVALA) VALUE('P' *TCAT &DATEJ *TCAT +
                          &PRODFILE)

/* Perform backups is not previously done for the day               */
/**********  CHKOBJ     OBJ(&LIBRTO/&SAVEFILE) OBJTYPE(*FILE) *******/
/**********  MONMSG     MSGID(CPF9801) EXEC(DO)               *******/

             /* Update Company Values record HPEREPAYBU with &COMPVALA */
             CALL       PGM(PUKMXFR) PARM(&RETURN &COMPANY &CMPVALCD +
                          &COMPVALA)

             /* Copy records within date range                         */
             CPYF       FROMFILE(&LIBRFROM/&PRODFILE) +
                          TOFILE(&LIBRTO/&SAVEFILE) MBROPT(*REPLACE) +
                          CRTFILE(*YES) INCREL((*IF AWASDT *GE +
                          &DATEF) (*AND AWASDT *LE &DATET))

/* Backup PKAXCPP - Buy Order Load */
             CHGVAR     VAR(&PRODFILE) VALUE('PKAXCPP   ')
             CHGVAR     VAR(&SAVEFILE) VALUE(&PREFIX *CAT 'PKAX')
             CHGVAR     VAR(&PKAXFILE) VALUE(&SAVEFILE) /* For PKAX */
             CHGVAR     VAR(&COMPVALA) VALUE('P' *TCAT &DATEJ *TCAT +
                          &PRODFILE)

             /* Update Company Values record HPEREPAYBU with &COMPVALA */
             CALL       PGM(PUKMXFR) PARM(&RETURN &COMPANY &CMPVALCD +
                          &COMPVALA)

             /* Copy records within date range                         */
             CPYF       FROMFILE(&LIBRFROM/&PRODFILE) +
                          TOFILE(&LIBRTO/&SAVEFILE) MBROPT(*REPLACE) +
                          CRTFILE(*YES) INCREL((*IF AXCQDT *GE +
                          &DATEF) (*AND AXCQDT *LE &DATET))


/* Backup PKA1CPP - Tattoo Header */
             CHGVAR     VAR(&PRODFILE) VALUE('PKA1CPP   ')
             CHGVAR     VAR(&SAVEFILE) VALUE(&PREFIX *CAT 'PKA1')
             CHGVAR     VAR(&COMPVALA) VALUE('P' *TCAT &DATEJ *TCAT +
                          &PRODFILE)

             /* Update Company Values record HPEREPAYBU with &COMPVALA */
             CALL       PGM(PUKMXFR) PARM(&RETURN &COMPANY &CMPVALCD +
                          &COMPVALA)

             /* Copy records within date range                         */
             CPYF       FROMFILE(&LIBRFROM/&PRODFILE) +
                          TOFILE(&LIBRTO/&SAVEFILE) MBROPT(*REPLACE) +
                          CRTFILE(*YES) INCREL((*IF A1B0DT *GE +
                          &DATEF) (*AND A1B0DT *LE &DATET))

/* Backup PKA2CPP - Tattoo Detail */
             CHGVAR     VAR(&PRODFILE) VALUE('PKA2CPP   ')
             CHGVAR     VAR(&SAVEFILE) VALUE(&PREFIX *CAT 'PKA2')
             CHGVAR     VAR(&COMPVALA) VALUE('P' *TCAT &DATEJ *TCAT +
                          &PRODFILE)

             /* Update Company Values record HPEREPAYBU with &COMPVALA */
             CALL       PGM(PUKMXFR) PARM(&RETURN &COMPANY &CMPVALCD +
                          &COMPVALA)

             /* Copy records within date range                         */
             CPYF       FROMFILE(&LIBRFROM/&PRODFILE) +
                          TOFILE(&LIBRTO/&SAVEFILE) MBROPT(*REPLACE) +
                          CRTFILE(*YES) INCREL((*IF A2B0DT *GE +
                          &DATEF) (*AND A2B0DT *LE &DATET))

/* Backup PKDNCPP - Tattoo Header EXT */
             CHGVAR     VAR(&PRODFILE) VALUE('PKDNCPP   ')
             CHGVAR     VAR(&SAVEFILE) VALUE(&PREFIX *CAT 'PKDN')
             CHGVAR     VAR(&COMPVALA) VALUE('P' *TCAT &DATEJ *TCAT +
                          &PRODFILE)

             /* Update Company Values record HPEREPAYBU with &COMPVALA */
             CALL       PGM(PUKMXFR) PARM(&RETURN &COMPANY &CMPVALCD +
                          &COMPVALA)

             /* Copy records within date range                         */
             CPYF       FROMFILE(&LIBRFROM/&PRODFILE) +
                          TOFILE(&LIBRTO/&SAVEFILE) MBROPT(*REPLACE) +
                          CRTFILE(*YES) INCREL((*IF DNB0DT *GE +
                          &DATEF) (*AND DNB0DT *LE &DATET))

/* Backup PKCDCPP - Tattoo Ded/Add */
             CHGVAR     VAR(&PRODFILE) VALUE('PKCDCPP   ')
             CHGVAR     VAR(&SAVEFILE) VALUE(&PREFIX *CAT 'PKCD')
             CHGVAR     VAR(&COMPVALA) VALUE('P' *TCAT &DATEJ *TCAT +
                          &PRODFILE)

             /* Update Company Values record HPEREPAYBU with &COMPVALA */
             CALL       PGM(PUKMXFR) PARM(&RETURN &COMPANY &CMPVALCD +
                          &COMPVALA)

             /* Copy records within date range                         */
             CPYF       FROMFILE(&LIBRFROM/&PRODFILE) +
                          TOFILE(&LIBRTO/&SAVEFILE) MBROPT(*REPLACE) +
                          CRTFILE(*YES) INCREL((*IF CDB0DT *GE +
                          &DATEF) (*AND CDB0DT *LE &DATET))

/* Backup PKB1CPP - Carcass Detail */
             CHGVAR     VAR(&PRODFILE) VALUE('PKB1CPP   ')
             CHGVAR     VAR(&SAVEFILE) VALUE(&PREFIX *CAT 'PKB1')
             CHGVAR     VAR(&COMPVALA) VALUE('P' *TCAT &DATEJ *TCAT +
                          &PRODFILE)

             /* Update Company Values record HPEREPAYBU with &COMPVALA */
             CALL       PGM(PUKMXFR) PARM(&RETURN &COMPANY &CMPVALCD +
                          &COMPVALA)

             /* Copy records within date range                         */
             CPYF       FROMFILE(&LIBRFROM/&PRODFILE) +
                          TOFILE(&LIBRTO/&SAVEFILE) MBROPT(*REPLACE) +
                          CRTFILE(*YES) INCREL((*IF B1B0DT *GE +
                          &DATEF) (*AND B1B0DT *LE &DATET))

/* Backup PKB3CPP - Tattoo Scale Ticket */
             CHGVAR     VAR(&PRODFILE) VALUE('PKB3CPP   ')
             CHGVAR     VAR(&SAVEFILE) VALUE(&PREFIX *CAT 'PKB3')
             CHGVAR     VAR(&COMPVALA) VALUE('P' *TCAT &DATEJ *TCAT +
                          &PRODFILE)

             /* Update Company Values record HPEREPAYBU with &COMPVALA */
             CALL       PGM(PUKMXFR) PARM(&RETURN &COMPANY &CMPVALCD +
                          &COMPVALA)

             /* Copy records within date range                         */
             CPYF       FROMFILE(&LIBRFROM/&PRODFILE) +
                          TOFILE(&LIBRTO/&SAVEFILE) MBROPT(*REPLACE) +
                          CRTFILE(*YES) INCREL((*IF B3B0DT *GE +
                          &DATEF) (*AND B3B0DT *LE &DATET))

/* Backup PKEJCPP - Buy Order Load Weight */
             CHGVAR     VAR(&PRODFILE) VALUE('PKEJCPP   ')
             CHGVAR     VAR(&SAVEFILE) VALUE(&PREFIX *CAT 'PKEJ')
             CHGVAR     VAR(&COMPVALA) VALUE('P' *TCAT &DATEJ *TCAT +
                          &PRODFILE)

             DLTF       FILE(&LIBRTO/&SAVEFILE)
             MONMSG     MSGID(CPF2105)

             /* Update Company Values record HPEREPAYBU with &COMPVALA */
             CALL       PGM(PUKMXFR) PARM(&RETURN &COMPANY &CMPVALCD +
                          &COMPVALA)

             RUNQRY     QRY(BACKUPPKEJ) QRYFILE((&LIBRTO/&PKAXFILE) +
                          (&LIBRFROM/PKEJCPP)) OUTTYPE(*OUTFILE) +
                          PRTDFN(*NO) OUTFILE(&LIBRTO/&SAVEFILE)

/* Update data area for completion */
             CHGVAR     VAR(&COMPVALA) VALUE('C' *TCAT &DATEJ *TCAT +
                          '          ')
             CALL       PGM(PUKMXFR) PARM(&RETURN &COMPANY &CMPVALCD +
                          &COMPVALA)

             GOTO       CMDLBL(ENDIT)

ERROR:       CHGVAR     VAR(&COMPVALA) VALUE('E' *TCAT &DATEJ *TCAT +
                          &SVFILENM)
             CALL       PGM(PUKMXFR) PARM(&RETURN &COMPANY &CMPVALCD +
                          &COMPVALA)

ENDIT:       ENDPGM
