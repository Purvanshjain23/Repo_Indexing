     H/TITLE Cnv Upd Forecast in DP XF Execute external functio
     H DATFMT(*YMD) DATEDIT(*YMD) DEBUG(*YES)
     Z* CRTBNDRPG
     Z* DFTACTGRP(*NO) BNDDIR(YBNDDIR) DBGVIEW(*SOURCE)
     Z* CVTOPT(*DATETIME) ACTGRP(*CALLER) OPTIMIZE(*BASIC)
      *
     H* SYNOPSIS :
     H*  Perform user function
     H*  As defined by action diagram
      *
     H* Generated by CA 2E release 8.6 (1547)
     H* Function type : Execute external function
     H* Object type   : *PGM
      *
     H* Company       : OMS Development Model
     H* System        : OMS Development Model
     H* User name     : ISDNGUY
     H* Date          : 02/04/21  Time  : 11:53:42
     H* Copyright     : OMS Development Model
      *
      *================================================================
     M* Maintenance   :
      *================================================================
     Fitmforecstif   e           k disk                                         Item Forecast
     FPBBTREL1  IF   E           K DISK
      * RTV : Item Default Extension    Retrieval index
      *
     FPBBTREL0  UF   E           K DISK
      * UPD : Item Default Extension    Update index
      *
      /EJECT
      * Data structures:
     D PGMDS         ESDS                  EXTNAME(Y2PGDSP)
      * Modified Program data structure
     D JBDTTM          DS
      * Job date/time
     D  ##JDT                  1      7  0
     D  ##JCC                  1      1  0
     D  ##JYY                  2      3  0
     D  ##JMM                  4      5  0
     D  ##JDD                  6      7  0
     D  ##JTM                  8     13  0
     D  ##JHH                  8      9  0
     D  ##JNN                 10     11  0
     D  ##JSS                 12     13  0
     D QPBBT1        E DS                  EXTNAME(PBBTREL0)
      * UPD : Item Default Extension    Update index
      * Renamed input format fields
     D  WBHGCD       E                     EXTFLD(BTHGCD)
     D  WBCUU1       E                     EXTFLD(BTCUU1)
     D  WBALSC       E                     EXTFLD(BTALSC)
     D  WBAMSC       E                     EXTFLD(BTAMSC)
     D  WBANSC       E                     EXTFLD(BTANSC)
     D  WBAOSC       E                     EXTFLD(BTAOSC)
     D  WBAPSC       E                     EXTFLD(BTAPSC)
     D  WBAQSC       E                     EXTFLD(BTAQSC)
     D  WBARSC       E                     EXTFLD(BTARSC)
     D  WBASSC       E                     EXTFLD(BTASSC)
     D  WBCVU1       E                     EXTFLD(BTCVU1)
     D  WBKXU1       E                     EXTFLD(BTKXU1)
     D  WBKYU1       E                     EXTFLD(BTKYU1)
     D  WBKZU1       E                     EXTFLD(BTKZU1)
     D  WBDXNZ       E                     EXTFLD(BTDXNZ)
     D  WBDYNZ       E                     EXTFLD(BTDYNZ)
     D  WBVSST       E                     EXTFLD(BTVSST)
     D  WBMJDT       E                     EXTFLD(BTMJDT)
     D  WBBETM       E                     EXTFLD(BTBETM)
     D  WBCCVN       E                     EXTFLD(BTCCVN)
     D  WBCDVN       E                     EXTFLD(BTCDVN)
     D  WBMKDT       E                     EXTFLD(BTMKDT)
     D  WBBFTM       E                     EXTFLD(BTBFTM)
     D  WBCEVN       E                     EXTFLD(BTCEVN)
     D  WBCFVN       E                     EXTFLD(BTCFVN)
      *
     D YARDCS          DS           228
      * Message data for message Y2U0009.
     D MD0009          DS
     D  MDPGM                  1     10
     D  MDACP                 11     20
     D  MDFMT                 21     30
     D  MDACT                 31     34
     D  MDLBL                 35     40
      *
      * Declared stand-alone variables
     D  P0RTN          S              7
     D  W0ICL          S              1
     D  W0RTN          S              7
     D  W0RSL          S              1
     D  W0RSF          S              1
     D  W0RTW          S              9  0
     D  W0ENV          S              3
     D  ##TME          S              6  0
     D  WN0001         S             14
     D  WN0002         S              1
     D  WN0003         S              2
     D  WN0004         S              2
     D  WN0005         S              2
     D  WN0006         S              2
     D  WN0007         S              3
     D  WN0008         S              3
     D  WN0009         S             40
     D  WN0010         S             40
     D  WN0011         S             40
     D  WN0012         S             10
     D  WN0013         S              5  0
     D  WN0014         S              7  0
     D  WN0015         S              1
     D  WN0016         S              7  0
     D  WN0017         S              6  0
     D  WN0018         S             10
     D  WN0019         S             10
     D  WN0020         S              7  0
     D  WN0021         S              6  0
     D  WN0022         S             10
     D  WN0023         S             10
     D  YARDC          S              1
     D  ZAPGMQ         S             10
     D  ZAPGRL         S              5
     D  ZAMSID         S              7
     D  ZAMSGF         S             10
     D  ZAMSTP         S              7
     D  YILE           S              1
     D  W0PMT          S              1
      /EJECT
      * Parameter declarations
     D P1PARM          DS
      * FLD: Item Default Extension
      * N :  Item Code
     D  P1HGCD                 1      4P 0
      * N :  IDE Forecast in DP
     D  P1ALSC                 5      5
     D                 DS
     D  ZAMSDA                 1    132
     I@BTRETK
      * Item Default Extension    Retrieval index
      * Renamed input format fields
     I              BTHGCD                      WAHGCD
     I              BTCUU1                      WACUU1
     I              BTALSC                      WAALSC
     I              BTAMSC                      WAAMSC
     I              BTANSC                      WAANSC
     I              BTAOSC                      WAAOSC
     I              BTAPSC                      WAAPSC
     I              BTAQSC                      WAAQSC
     I              BTARSC                      WAARSC
     I              BTASSC                      WAASSC
     I              BTCVU1                      WACVU1
     I              BTKXU1                      WAKXU1
     I              BTKYU1                      WAKYU1
     I              BTKZU1                      WAKZU1
     I              BTDXNZ                      WADXNZ
     I              BTDYNZ                      WADYNZ
     I              BTVSST                      WAVSST
     I              BTMJDT                      WAMJDT
     I              BTBETM                      WABETM
     I              BTCCVN                      WACCVN
     I              BTCDVN                      WACDVN
     I              BTMKDT                      WAMKDT
     I              BTBFTM                      WABFTM
     I              BTCEVN                      WACEVN
     I              BTCFVN                      WACFVN
      *
     I@BTRETJ
      * Item Default Extension    Update index
      * Renamed input format fields
     I              BTHGCD                      WBHGCD
     I              BTCUU1                      WBCUU1
     I              BTALSC                      WBALSC
     I              BTAMSC                      WBAMSC
     I              BTANSC                      WBANSC
     I              BTAOSC                      WBAOSC
     I              BTAPSC                      WBAPSC
     I              BTAQSC                      WBAQSC
     I              BTARSC                      WBARSC
     I              BTASSC                      WBASSC
     I              BTCVU1                      WBCVU1
     I              BTKXU1                      WBKXU1
     I              BTKYU1                      WBKYU1
     I              BTKZU1                      WBKZU1
     I              BTDXNZ                      WBDXNZ
     I              BTDYNZ                      WBDYNZ
     I              BTVSST                      WBVSST
     I              BTMJDT                      WBMJDT
     I              BTBETM                      WBBETM
     I              BTCCVN                      WBCCVN
     I              BTCDVN                      WBCDVN
     I              BTMKDT                      WBMKDT
     I              BTBFTM                      WBBFTM
     I              BTCEVN                      WBCEVN
     I              BTCFVN                      WBCFVN
      *
      /EJECT
      *****************************************************************
      * Entry parameters
     C     *ENTRY        PLIST
     C                   PARM                    P0RTN
      *****************************************************************
      * Initialize
     C                   EXSR      ZZINIT
      *
      * Cnv Upd Forecast in DP XF
      * Cnv Read ITMFORECST   US - Item Default Extension  * 
      *
      *
     C                   read      itmforecst
     C                   dow       not %eof(itmforecst)
      *
     C                   eval      P1HGCD = IFITEM                              Item Code
     C                   eval      P1ALSC = IFINDP                              Item Forecst Sts
      *
      * Update IDe Forecast in DP in Item Default Extsn File.
      * CASE: *OTHERWISE
      * Cnv Upd Forecast in DP RT - Item Default Extension  * 
     C                   EXSR      SARVGN
      * Cnv EndDo ITMFORECST  US - Item Default Extension  * 
      *
     C                   read      itmforecst
     C                   enddo                                                  dow not %eof
      *
      *----------------------------------------------------------------
      * Exit program
     C     AAEXIT        TAG
     C                   EVAL      P0RTN = ' '
     C                   EXSR      ZYEXPG
      *================================================================
      /EJECT
     CSR   SARVGN        BEGSR
      *================================================================
      * Cnv Upd Forecast in DP RT - Item Default Extension  * 
      *================================================================
     C                   EVAL      W0RTN = ' '
      * Define keylist
     C     KRSSA         KLIST
     C                   KFLD                    WAHGCD                         Item Code
      * Setup key
     C                   Z-ADD     P1HGCD        WAHGCD                         Item Code
      * Establish starting position
     C     KRSSA         CHAIN     @BTRETK                            90        *
      * Data record not found
     C   90              MOVEL     'USR4745'     W0RTN
      * USER: Process Data record
      * Chg Itm Forecast in DP CH - Item Default Extension  * 
     C                   IF        NOT *IN90
     C                   EXSR      SBCHRC
     C                   ENDIF
      *================================================================
     CSR   SAEXIT        ENDSR
      /EJECT
     CSR   SBCHRC        BEGSR
      *================================================================
      * Chg Itm Forecast in DP CH - Item Default Extension  * 
      *================================================================
      *
     C                   EVAL      WN0001 = ' '                                 IDE GTIN
     C                   EVAL      WN0002 = ' '                                 IDE Unused Sts
     C                   EVAL      WN0003 = ' '                                 IDE Report to U
     C                   EVAL      WN0004 = ' '                                 IDE Unused Sts
     C                   EVAL      WN0005 = ' '                                 IDE Unused Sts
     C                   EVAL      WN0006 = ' '                                 IDE Unused Sts
     C                   EVAL      WN0007 = ' '                                 IDE Unused Sts
     C                   EVAL      WN0008 = ' '                                 IDE Unused Sts
     C                   EVAL      WN0009 = ' '                                 Spanish Descrip
     C                   EVAL      WN0010 = ' '                                 IDE Unused Text
     C                   EVAL      WN0011 = ' '                                 IDE Unused Text
     C                   EVAL      WN0012 = ' '                                 IDE Unused Text
     C                   Z-ADD     *ZERO         WN0013                         IDE Unused Nbr
     C                   Z-ADD     *ZERO         WN0014                         IDE Manufacture
     C                   EVAL      WN0015 = ' '                                 Record Status
     C                   Z-ADD     *ZERO         WN0016                         Create Date
     C                   Z-ADD     *ZERO         WN0017                         Create Time
     C                   EVAL      WN0018 = ' '                                 Create User
     C                   EVAL      WN0019 = ' '                                 Create Program
     C                   Z-ADD     *ZERO         WN0020                         Change Date
     C                   Z-ADD     *ZERO         WN0021                         Change Time
     C                   EVAL      WN0022 = ' '                                 Change User
     C                   EVAL      WN0023 = ' '                                 Change Program
      *
     C                   EVAL      W0RTN = ' '
      * Set PGM.*Record Data Changed flag
     C                   EVALR     YARDC = ' '
      *
      * Move key fields to @BTRETJ
     C                   Z-ADD     WAHGCD        WBHGCD                         Item Code
      *
     C     KLCHSB        KLIST
     C                   KFLD                    WBHGCD                         Item Code
     C     KLCHSB        CHAIN     @BTRETJ                            9091      *
      *
      * Record not found
     C                   IF        *IN90
     C                   MOVEL     'Y2U0009'     W0RTN
     C                   MOVEL     ##PGM         MDPGM
     C                   MOVEL     'PBBTREL0'    MDACP
     C                   MOVEL     '@BTRETJ'     MDFMT
     C                   MOVEL     '*CHG'        MDACT
      * Record not found label: LBL001.
     C                   MOVEL     'LBL001'      MDLBL
      * Send message '*Record no longer on file'
     C                   MOVEL     'Y2U0009'     ZAMSID
     C                   MOVEL     'Y2USRMSG'    ZAMSGF
     C                   MOVEL     MD0009        ZAMSDA                         Message data
     C                   EXSR      ZASNMS
     C                   EVAL      MD0009 = ' '
     C                   GOTO      SBEXIT
     C                   ENDIF
      *
      * Record locked
     C                   IF        *IN91
     C                   MOVEL     'Y2U0004'     W0RTN
      * Send message '*Database operation error'
     C                   MOVEL     'Y2U0004'     ZAMSID
     C                   MOVEL     'Y2USRMSG'    ZAMSGF
     C                   EXSR      ZASNMS
     C                   GOTO      SBEXIT
     C                   ENDIF
      *
      * Store record data for null update check
     C                   MOVE      QPBBT1        YARDCS
      * Move non-key fields to @BTRETJ
     C                   MOVEL(P)  P1ALSC        WBALSC                         IDE Forecast in
      *
      * Set PGM.*Record Data Changed flag
     C                   IF        QPBBT1 <> YARDCS AND
     C                             YARDC <> 'N'
     C                   MOVE      'Y'           YARDC
     C                   ENDIF
      * USER: Processing before Data update
      * Set Chg Date/Time      IF
     C                   Z-ADD     ##JDT         WBMKDT                         Change Date
     C                   Z-ADD     ##JTM         WBBFTM                         Change Time
     C                   MOVEL     ##USR         WBCEVN                         Change User
     C                   MOVEL     ##PGM         WBCFVN                         Change Program
      * Set PGM.*Record Data Changed flag
     C                   IF        QPBBT1 <> YARDCS AND
     C                             YARDC <> 'N'
     C                   MOVE      'Y'           YARDC
     C                   ENDIF
      * If changed update record otherwise release record
     C                   IF        YARDC = 'Y'
     C                   UPDATE    @BTRETJ                              91      *
     C                   ELSE
      * Release record lock
     C                   UNLOCK    PBBTREL0                             91      *
     C                   ENDIF
      * Change error detected
     C                   IF        *IN91
     C                   MOVEL     'Y2U0004'     W0RTN
     C                   ELSE
      *
      * DBF change successful
     C                   ENDIF
      *================================================================
     CSR   SBEXIT        ENDSR
      /EJECT
     CSR   ZASNMS        BEGSR
      *================================================================
      * Send message to program's message queue
      *================================================================
     C                   IF        ZAPGMQ = ' '
     C                   MOVEL     ##PGM         ZAPGMQ
     C                   END
     C                   CALL      'Y2SNMGC'
     C                   PARM                    ZAPGMQ                         Program queue
     C                   PARM                    ZAPGRL                         Rel queue
     C                   PARM                    ZAMSID                         Message ID
     C                   PARM                    ZAMSGF                         Message file
     C                   PARM                    ZAMSDA                         Message data
     C                   PARM                    ZAMSTP                         Message type
     C                   PARM      'Y'           YILE
      * Clear all fields for default mechanism next time
     C                   EVAL      ZAPGMQ = ' '
     C                   EVAL      ZAPGRL = ' '
     C                   EVAL      ZAMSID = ' '
     C                   EVAL      ZAMSGF = ' '
     C                   EVAL      ZAMSDA = ' '
     C                   EVAL      ZAMSTP = ' '
      *================================================================
     CSR   ZAEXIT        ENDSR
      /EJECT
     CSR   ZXEXPG        BEGSR
      *================================================================
      * Exit program: Normal
      *================================================================
     C                   EXSR      ZYEXPG
      *================================================================
     CSR   ZXEXIT        ENDSR
      /EJECT
     CSR   ZYEXPG        BEGSR
      *================================================================
      * Exit program: Direct
      *================================================================
      * Terminate program
     C                   SETON                                        LR
      *
      * Exit program
     C                   RETURN
      *
      *================================================================
     CSR   ZYEXIT        ENDSR
      /EJECT
     CSR   ZZINIT        BEGSR
      *================================================================
      * Initialisation
      *================================================================
     C                   IF        W0ICL = ' '
     C                   MOVEL     'Y'           W0ICL                          *Initial call
     C                   ELSE
     C                   MOVEL     'N'           W0ICL
     C                   END
     C                   EVALR     P0RTN = ' '
     C                   EVALR     W0RTN = ' '
     C                   EVAL      W0RSL = ' '
     C                   EVAL      W0RSF = ' '
     C                   MOVEL     *ZEROS        W0RTW
     C                   MOVEL     '400'         W0ENV
      * Clear all neither parameters
     C                   Z-ADD     *ZERO         P1HGCD                         Item Code
     C                   EVAL      P1ALSC = ' '                                 IDE Forecast in
      *
      * Retrieve job attributes
     C                   CALL      'Y2RTJCR'
     C                   PARM                    PGMDS
      * Setup job date/time
     C                   Z-ADD     ##SD7         ##JDT
     C                   TIME                    ##JTM
      * Update screen time
     C                   TIME                    ##TME
      * Initialize renamed input format fields
     C                   Z-ADD     *ZERO         WAHGCD                         Item Code
     C                   Z-ADD     *ZERO         WADXNZ                         IDE Unused Nbr
     C                   Z-ADD     *ZERO         WADYNZ                         IDE Manufacture
     C                   Z-ADD     *ZERO         WAMJDT                         Create Date
     C                   Z-ADD     *ZERO         WABETM                         Create Time
     C                   Z-ADD     *ZERO         WAMKDT                         Change Date
     C                   Z-ADD     *ZERO         WABFTM                         Change Time
     C                   MOVEL     'N'           W0PMT
      *================================================================
     CSR   ZZEXIT        ENDSR
