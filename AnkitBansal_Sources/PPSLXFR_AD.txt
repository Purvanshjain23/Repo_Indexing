// ?------------------------------------------------------------------------------------------------
// ?Synon action diagram for PPSLXFR
// ?Date: 14.08.2025 Time: 03:41:44
// ?------------------------------------------------------------------------------------------------

//?Execute user function

//?****************************************************************
//?Determine Order Header Exempt code based on
//?          Ship to customer and Item exempt codes
//?Par.Error Status 2 = Y = test for error condition - chk all ord dtls
//?Par.Error Status 2 = N = dont test for error condition, return Value
//? by looking at the 1st order detail to get the ord dtl's tf exempt
//?Par.Error Flag            USR = Y, if error
//?****************************************************************
//?PC = Pre-Commencement = start up
//?EC = Exempt customer = Ship to cust is Exempt,products can be NE/EP
//?EP = Exempt Product = Cust is NE but all Products are exempt
//?NE = Not Exempt = Ship to Cust not exempt and all products NE
//?****************************************************************
//?Order Entry Rule:   If Ship To Cust is Not Exempt,
//?                    then items must be either all NE or all EP
//?This is NOT True in Claims and when adding Ship Line item. Then,
//? If Ord Hdr is NE, and a EP Line item is added, make the Ord Hdr EP
//?****************************************************************
EXECUTE FUNCTION(Rtv Customer TFEx     RT) TYPE(RTVOBJ) FILE(PDNEREP)           AC1747887;
PARAMETER(PAR.Ship_To_Customer);
PARAMETER(PAR.Customer_TF_Exempt_Code);
{
 //?USER: Initialize routine

 // PAR.Customer TF Exempt Code = WRK.BLANK
 PAR.Customer_TF_Exempt_Code = WRK.BLANK;

 //?USER: Processing if Data record not found

 // PAR.Customer TF Exempt Code = WRK.BLANK
 PAR.Customer_TF_Exempt_Code = WRK.BLANK;

 //?USER: Process Data record

 // PAR.Customer TF Exempt Code = DB1.Customer TF Exempt Code
 PAR.Customer_TF_Exempt_Code = DB1.Customer_TF_Exempt_Code;

}


CASE;

// IF PAR.Customer TF Exempt Code is Exempt Customer
IF PAR.Customer_TF_Exempt_Code = 'EC';

// PAR.OH TF Exempt Code = PAR.Customer TF Exempt Code
PAR.OH_TF_Exempt_Code = PAR.Customer_TF_Exempt_Code;

QUIT;

// IF PAR.Customer TF Exempt Code is Not Exempt
IF PAR.Customer_TF_Exempt_Code = 'NE';

//?Check for error
CASE;

// IF PAR.Error Status  2 is Yes
IF PAR.Error_Status_2 = 'Y';

EXECUTE FUNCTION(RTV All Item Cd TF Ex RT) TYPE(RTVOBJ) FILE(OPBGWKP)           AC1750067;
PARAMETER(PAR.Company_Number);
PARAMETER(PAR.Order_Number);
PARAMETER(0);
PARAMETER(0);
PARAMETER(PAR.Error_Flag_USR);
PARAMETER(PAR.Customer_TF_Exempt_Code);
{
 //?USER: Initialize routine

 // LCL.Ord TF Exempt Code = WRK.Blank for 4           USR
 LCL.Ord_TF_Exempt_Code = WRK.Blank_for_4_USR;

 // PAR.Error Flag            USR = WRK.Blank for 4           USR
 PAR.Error_Flag_USR = WRK.Blank_for_4_USR;

 //?USER: Process Data record

 CASE;

 // IF LCL.Ord TF Exempt Code EQ WRK.Blank for 4           USR
 IF LCL.Ord_TF_Exempt_Code = WRK.Blank_for_4_USR;

 // LCL.Ord TF Exempt Code = DB1.Ord TF Exempt Code
 LCL.Ord_TF_Exempt_Code = DB1.Ord_TF_Exempt_Code;

 // IF *OTHERWISE
 IF *OTHERWISE;

 //?If Mixed, check Customer TF exempt
 CASE;

 // IF DB1.Ord TF Exempt Code NE LCL.Ord TF Exempt Code
 IF DB1.Ord_TF_Exempt_Code <> LCL.Ord_TF_Exempt_Code;

 //?Error if ord dtl is mixed and Cust is NE
 CASE;

 // IF PAR.Customer TF Exempt Code is Not Exempt
 IF PAR.Customer_TF_Exempt_Code = 'NE';

 // PAR.Error Flag            USR = CND.Yes
 PAR.Error_Flag_USR = 'Y';

 ENDIF;

 ENDIF;

 ENDIF;

}


ENDIF;

//?If No Error, determine OH TF Exempt
CASE;

// IF PAR.Error Flag            USR is Yes
IF PAR.Error_Flag_USR = 'Y';

//?If No Error, determine OH TF Exempt
// IF *OTHERWISE
IF *OTHERWISE;

//?Look at the 1st order detail to determine the Ord Hdr exempt code
EXECUTE FUNCTION(RTV 1st Item Cd TF Ex RT) TYPE(RTVOBJ) FILE(OPBGWKP)           AC1749974;
PARAMETER(PAR.Company_Number);
PARAMETER(PAR.Order_Number);
PARAMETER(0);
PARAMETER(0);
PARAMETER(PAR.Ord_TF_Exempt_Code);
{
 //?USER: Process Data record

 CASE;

 // IF DB1.Ord TF Exempt Code is Exempt Product
 IF DB1.Ord_TF_Exempt_Code = 'EP';

 MOVE *ALL (To: PAR From: DB1);

 QUIT;

 // IF *OTHERWISE
 IF *OTHERWISE;

 MOVE *ALL (To: PAR From: DB1);

 ENDIF;

}


CASE;

// IF PAR.Ord TF Exempt Code is Item Codes
IF PAR.Ord_TF_Exempt_Code = 'EP'/'NE';

// PAR.OH TF Exempt Code = PAR.Ord TF Exempt Code
PAR.OH_TF_Exempt_Code = PAR.Ord_TF_Exempt_Code;

// IF *OTHERWISE
IF *OTHERWISE;

//?catchall- in case order detail is blank??
// PAR.OH TF Exempt Code = PAR.Customer TF Exempt Code
PAR.OH_TF_Exempt_Code = PAR.Customer_TF_Exempt_Code;

ENDIF;

ENDIF;

// IF *OTHERWISE
IF *OTHERWISE;

// PAR.OH TF Exempt Code = PAR.Customer TF Exempt Code
PAR.OH_TF_Exempt_Code = PAR.Customer_TF_Exempt_Code;

ENDIF;

