/***************************************************************** */
/*                                                                 */
/*  PROGRAM NUMBER:  PLNTUPRCLP                                    */
/*  PROGRAM NAME:    Send the repayment difference sequel          */
/*                   in a xls spread sheet to the user             */
/*  PROGRAMMER:      Susan Mason                                   */
/*  CREATE DATE:     11/17/08                                      */
/*                                                                 */
/*  FUNCTION:        This cl was developed to send the repayment   */
/*                   sequel that is over the tattoo header and     */
/*                   the saved tattoo header and show the user     */
/*                   a difference sequel (within reason)           */
/*                                                                 */
/*                   (WITHIN REASON IS THE FOLLOWING)              */
/*                   JUST A NOTE HERE                              */
/*                   IF THE USER FAILS TO RUN AND THE NEXT DAY     */
/*                   PAYMENT POST HAS BEEN PROCESSED THE SAVE      */
/*                   TATTOO HEADER HAS BEEN REPLACED AND THERE     */
/*                   NOT BE A DIFFERENCE                           */
/*                                                                 */
/*                                                                 */
/*******************************************************************/
/*  Modification History                                           */
/*  2/23/2018 SLM   Add company 961, and company 440               */
/*  2/23/2018 SLM   Add document what company ***** 960 *****      */
/*                                                                 */
/*  2/23/2018 SLM   Add to TATTOODIF                               */
/*                                                                 */
/*  2/26/2018 SLM   Add to TSTTOODIF                               */
/*                                                                 */
/*  2/26/2018 SLM   Add Information for test enviorment PRKFTSTGUP */
/*  2/26/2018 SLM   Add Information for test enviorment PRKFTSTTFP */
/*  2/26/2018 SLM   Add Information for test enviorment PRKFTSTSTP */
/*                                                                 */
/*  6/06/2018 JBB   Created a single sequel TATTOODIF that will    */
/*    E13128        work for any company in either the production  */
/*                  or the test environment.  Only one EXECUTE     */
/*                  statement is needed.  See NEWCODE              */
/*                                                                 */
/*  7/30/2019 JBB   Reverted back to separate sequels because 360  */
/*    E15270        does not use Site ID.  New sequels are         */
/*                  TATTDIF_GU, TATTDIF_ST, and TATTDIF_TF.        */
/*                  Changed TATTDIF_GU to use full Tattoo Header   */
/*                  key values on inner join to avoid joining      */
/*                  PKA1CPP and PKA1CPPPS for multiple Tattoos     */
/*                  on different Buy Order Loads.                  */
/*                                                                 */
/* 02/28/2020 DN    Passed in Email Address for LIVE notification. */
/*    S16226        If Email Address (LIVE) is entered and is for  */
/*                  Co 360 or 440 then call the following SEQUELs: */
/*                  TATTDF2_GU or TATTDF2_ST.                      */
/*                                                                 */
/*******************************************************************/

/*           PGM        PARM(&COMPANY &SQLNAME &EMAIL)             */
             PGM        PARM(&COMPANY &EMAIL &EMAIL2)

             DCL        VAR(&COMPANY) TYPE(*CHAR) LEN(3)
             DCL        VAR(&COMP)   TYPE(*DEC)  LEN(3 0)
             DCL        VAR(&SQLNAME) TYPE(*CHAR) LEN(10)
             DCL        VAR(&EMAIL) TYPE(*CHAR) LEN(50)
             DCL        VAR(&EMAIL2) TYPE(*CHAR) LEN(50)
             DCL        VAR(&TEXT) TYPE(*CHAR) LEN(60)
             DCL        VAR(&LIBRARY) TYPE(*CHAR) LEN(10)
             DCL        VAR(&GRPPRFL) TYPE(*CHAR) LEN(10)
             DCL        VAR(&TESTLIB) TYPE(*CHAR) LEN(3)

/*  6/06/2018 JBB E13128 Skip old code and goto new code           */
             GOTO       CMDLBL(NEWCODE)

             CHGVAR     VAR(&TEXT) VALUE('Re-Payment Difference +
                          sequel for company' *BCAT &COMPANY)

/***** ***********************************************************  *****/
/*****     TSTTGYDIF    Test Enviorment for Guymon                  *****/
/***** 360 PRKFTSTGUP files are pointing to correct library in      *****/
/*****     the sequel                                               *****/
/***** ***********************************************************  *****/
             IF         COND(&SQLNAME = 'TSTTGYDIF') THEN(DO)
             CHGVAR     VAR(&TEXT) VALUE('ReTST Payment Diff +
                          sequel for company' *BCAT &COMPANY)

             EXECUTE    VIEW(*LIBL/TSTTGYDIF) PCFMT(*XLS) +
                          REPLACE(*YES) RECIPIENT(&EMAIL) EMLMSG(&TEXT)

             GOTO ENDPGM
             ENDDO
/***** ***********************************************************  *****/
/*****     TSTTTFDIF    Test Enviorment for Triumph Foods           *****/
/***** 960 PRKFTSTSTP files are pointing to correct library in      *****/
/*****     the sequel                                               *****/
/***** ***********************************************************  *****/
             IF         COND(&SQLNAME = 'TSTTTFDIF') THEN(DO)
             CHGVAR     VAR(&TEXT) VALUE('ReTST Payment Diff +
                          sequel for company' *BCAT &COMPANY)

             EXECUTE    VIEW(*LIBL/TSTTTFDIF) PCFMT(*XLS) +
                          REPLACE(*YES) RECIPIENT(&EMAIL) EMLMSG(&TEXT)

             GOTO ENDPGM
             ENDDO
/***** ***********************************************************  *****/
/*****     TSTTTF2DIF   Test Enviorment for Triumph Foods 2         *****/
/***** 961 PRKFTSTTFP files are pointing to correct library in      *****/
/*****     the sequel                                               *****/
/***** ***********************************************************  *****/
             IF         COND(&SQLNAME = 'TSTTTF2DIF') THEN(DO)
             CHGVAR     VAR(&TEXT) VALUE('ReTST Payment Diff +
                          sequel for company' *BCAT &COMPANY)

             EXECUTE    VIEW(*LIBL/TSTTTF2DIF) PCFMT(*XLS) +
                          REPLACE(*YES) RECIPIENT(&EMAIL) EMLMSG(&TEXT)

             GOTO ENDPGM
             ENDDO
/***** ***********************************************************  *****/
/*****     TSTTSTDIF    Test Enviorment for Triumph Foods           *****/
/***** 440 PRKFTSTSTP files are pointing to correct library in      *****/
/*****     the sequel                                               *****/
/***** ***********************************************************  *****/
             IF         COND(&SQLNAME = 'TSTTSTDIF') THEN(DO)
             CHGVAR     VAR(&TEXT) VALUE('ReTST Payment Diff +
                          sequel for company' *BCAT &COMPANY)

             EXECUTE    VIEW(*LIBL/TSTTGYDIF) PCFMT(*XLS) +
                          REPLACE(*YES) RECIPIENT(&EMAIL) EMLMSG(&TEXT)

             GOTO ENDPGM
             ENDDO

             DMPCLPGM

/***** ***********************************************************  *****/
/*****     TATTTFDIF  Production Env for Triumph Foods              *****/
/***** 960 PRKFTFP    files are pointing to correct library in      *****/
/*****     the sequel                                               *****/
/***** ***********************************************************  *****/
             IF         COND(&SQLNAME = 'TATTTFDIF') THEN(DO)

             CHGVAR     VAR(&TEXT) VALUE('Re-Payment Difference +
                          sequel for company' *BCAT &COMPANY)

             EXECUTE    VIEW(*LIBL/TATTTFDIF) PCFMT(*XLS) +
                          REPLACE(*YES) RECIPIENT(&EMAIL) EMLMSG(&TEXT)

             GOTO ENDPGM
             ENDDO


/***** ***********************************************************  *****/
/*****     TATTTF2DIF Production Env for Triumph Foods              *****/
/***** 961 PRKFTFP    files are pointing to correct library in      *****/
/*****     the sequel                                               *****/
/***** ***********************************************************  *****/
             IF         COND(&SQLNAME = 'TATTTF2DIF') THEN(DO)

             CHGVAR     VAR(&TEXT) VALUE('Re-Payment Difference +
                          sequel for company' *BCAT &COMPANY)

             EXECUTE    VIEW(*LIBL/TATTTF2DIF) PCFMT(*XLS) +
                          REPLACE(*YES) RECIPIENT(&EMAIL) EMLMSG(&TEXT)

             GOTO ENDPGM
             ENDDO
/***** ***********************************************************  *****/
/*****     TATTGYDIF  Production Env for Triumph Foods              *****/
/***** 360 PRKFTFP    files are pointing to correct library in      *****/
/*****     the sequel                                               *****/
/***** ***********************************************************  *****/

             IF         COND(&SQLNAME = 'TATTGYDIF') THEN(DO)

             CHGVAR     VAR(&TEXT) VALUE('Re-Payment Difference +
                          sequel for company' *BCAT &COMPANY)

             EXECUTE    VIEW(*LIBL/TATTGYDIF) PCFMT(*XLS) +
                          REPLACE(*YES) RECIPIENT(&EMAIL) EMLMSG(&TEXT)
             GOTO ENDPGM
             ENDDO

/***** ***********************************************************  *****/
/*****     TATTSTDIF  Production Env for Triumph Foods              *****/
/***** 440 PRKFSTP    files are pointing to correct library in      *****/
/*****     the sequel                                               *****/
/***** ***********************************************************  *****/

             IF         COND(&SQLNAME = 'TATTSTDIF') THEN(DO)

             CHGVAR     VAR(&TEXT) VALUE('Re-Payment Difference +
                          sequel for company' *BCAT &COMPANY)

             EXECUTE    VIEW(*LIBL/TATTSTDIF) PCFMT(*XLS) +
                          REPLACE(*YES) RECIPIENT(&EMAIL) EMLMSG(&TEXT)

             GOTO ENDPGM
             ENDDO

/**********************************************************************/
/*****  6/06/2018 JBB E13128 Skip old code and goto new code      *****/
/***** NEWCODE - New method to execute the sequel views.          *****/
/*****           Uses a single Sequel: TATTOODIF for all          *****/
/*****           companies, either in production or in test.      *****/
/**********************************************************************/
 NEWCODE:    PSHLIBL

/**********************************************************************/
/*  Retrieve the user's Group Profile.  Set the library list          */
/*  based upon the combination of the group profile and company#.     */
/**********************************************************************/

             RTVUSRPRF  GRPPRF(&GRPPRFL)

             SELECT
             /* Set library list to a test library list               */
             WHEN       COND(&GRPPRFL = 'SBDPGMR ') THEN(DO)
             IF         COND(&COMPANY = '360') THEN(SETLIBL +
                          JOBD(PRKTSTGUP))
             IF         COND(&COMPANY = '440') THEN(SETLIBL +
                          JOBD(PRKTSTSTP))
             IF         COND(&COMPANY = '960') THEN(SETLIBL +
                          JOBD(PRKTSTTFP))
             IF         COND(&COMPANY = '961') THEN(SETLIBL +
                          JOBD(PRKTSTTFP))

             ADDLIBLE   LIB(PRKDEVQRY) POSITION(*LAST)

             ENDDO

             /* Set library list to a production library list         */
             OTHERWISE  CMD(DO)
             IF         COND(&COMPANY = '360') THEN(SETLIBL +
                          JOBD(PRKPRDGUP))
             IF         COND(&COMPANY = '440') THEN(SETLIBL +
                          JOBD(PRKPRDSTP))
             IF         COND(&COMPANY = '960') THEN(SETLIBL +
                          JOBD(TFSBDPROD))
             IF         COND(&COMPANY = '961') THEN(SETLIBL +
                          JOBD(TFSBDPROD))
             ENDDO

             ENDSELECT


 /* Move alpha company to numeric value                               */
             CHGVAR     VAR(&COMP) VALUE(&COMPANY)

 /* Retrieve the library that the Tattoo Header is in                 */
             RTVOBJD    OBJ(PKA1CPP) OBJTYPE(*FILE) RTNLIB(&LIBRARY)

 /* Strip out positions 5 - 7 of the library name                     */
             CHGVAR     VAR(&TESTLIB) VALUE(%SST(&LIBRARY 5 3))

 /* If library name contains 'TST', setup &TEXT with prefix of TEST:  */
             SELECT
             WHEN       COND(&TESTLIB *EQ 'TST') THEN(CHGVAR +
                          VAR(&TEXT) VALUE('TEST: Re-Payment Diff +
                          sequel for company' *BCAT &COMPANY))

 /* Otherwise, setup &TEXT with 'Re-Payment...'                       */
               OTHERWISE  CMD(CHGVAR VAR(&TEXT) VALUE('Re-Payment +
                            Difference sequel for company' *BCAT +
                            &COMPANY))
             ENDSELECT

 /* Select sequel name for EXECUTE statement                          */
             SELECT
             WHEN       COND(&COMP *EQ 360) THEN(CHGVAR +
                          VAR(&SQLNAME) VALUE('TATTDIF_GU'))

             WHEN       COND(&COMP *EQ 440) THEN(CHGVAR +
                          VAR(&SQLNAME) VALUE('TATTDIF_ST'))

             WHEN       COND(&COMP *EQ 960) THEN(CHGVAR +
                          VAR(&SQLNAME) VALUE('TATTDIF_TF'))

             WHEN       COND(&COMP *EQ 961) THEN(CHGVAR +
                          VAR(&SQLNAME) VALUE('TATTDIF_TF'))

             ENDSELECT

/* Execute the Sequel and email the results to the requested address  */
             EXECUTE    VIEW(*LIBL/&SQLNAME) PCFMT(*XLS) +
                          REPLACE(*YES) RECIPIENT(&EMAIL) +
                          EMLMSG(&TEXT) SETVAR((&COMP &COMPANY))

/* Commented out sequel TATTOODIF                                     */
/* Execute the Sequel and email the results to the requested address  */
         /*  EXECUTE    VIEW(*LIBL/TATTOODIF) PCFMT(*XLS) +
                          REPLACE(*YES) RECIPIENT(&EMAIL) +
                          EMLMSG(&TEXT) SETVAR((&COMP &COMPANY)) */

/**********************************************************************/
/* S16226 - Notification of Repayment for LIVE Side.                  */
/*          If Email for LIVE is entered and for Co 360/400 then send */
/*          email.                                                    */
/**********************************************************************/
             IF         COND((&EMAIL2 *NE ' ') *AND ((&COMP *EQ 360) +
                          *OR (&COMP *EQ 440))) THEN(DO)

             IF         COND(&TESTLIB *EQ 'TST') THEN(DO)
             CHGVAR     VAR(&TEXT) VALUE('TEST: Re-Payment Diff +
                          sequel for LIVE for Company' *BCAT &COMPANY)
             ENDDO
             ELSE       CMD(DO)
             CHGVAR     VAR(&TEXT) VALUE('Re-Payment Diff sequel for +
                          LIVE for Company' *BCAT &COMPANY)
             ENDDO

 /* Select Sequel Name for EXECUTE Statement                          */
             SELECT
             WHEN       COND(&COMP *EQ 360) THEN(CHGVAR +
                          VAR(&SQLNAME) VALUE('TATTDF2_GU'))

             WHEN       COND(&COMP *EQ 440) THEN(CHGVAR +
                          VAR(&SQLNAME) VALUE('TATTDF2_ST'))
             ENDSELECT

/* Execute the Sequel and email the results to the requested address  */
             EXECUTE    VIEW(*LIBL/&SQLNAME) PCFMT(*XLS) +
                          REPLACE(*YES) RECIPIENT(&EMAIL2) +
                          EMLMSG(&TEXT) SETVAR((&COMP &COMPANY))

             ENDDO      /* &EMAIL2 *NE ' ' */


             POPLIBL

 ENDPGM:     ENDPGM
