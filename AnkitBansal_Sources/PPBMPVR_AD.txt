// ?------------------------------------------------------------------------------------------------
// ?Synon action diagram for PPBMPVR
// ?Date: 14.08.2025 Time: 03:39:51
// ?------------------------------------------------------------------------------------------------

//?USER: Load screen

EXECUTE FUNCTION(RTV Company Name       RT) TYPE(RTVOBJ) FILE(CAABREP)          AC1255767;
PARAMETER(DTL.Company_Number);
PARAMETER(DTL.Company_Name);
{
 //?USER: Processing if Data record not found

 MOVE *ALL (To: PAR From: CON);

 //?USER: Process Data record

 MOVE *ALL (To: PAR From: DB1);

}


// DTL.Text USR 20 = Condition name of PAR.Comm Threshold Period
DTL.Text_USR_20 = RTVCND(PAR.Comm_Threshold_Period);

//?USER: Validate fields

CASE;

// IF PAR.Comm Threshold Period is Calendar Month
IF PAR.Comm_Threshold_Period = 'CM';

// LCL.Year  NBR USR = DTL.Accounting Year
LCL.Year_NBR_USR = DTL.Accounting_Year;

// LCL.Year  (Char) USR = CVTVAR(LCL.Year  NBR USR)
LCL.Year_Char_USR = CVTVAR(LCL.Year_NBR_USR);

// LCL.USR CDE Parm 1 = CONCAT(CON.1,LCL.Year  (Char) USR,CON.*ZERO)
LCL.USR_CDE_Parm_1 = '1' + LCL.Year_Char_USR (*ZERO);

// LCL.Month (Char) USR = CVTVAR(DTL.Accounting Period)
LCL.Month_Char_USR = CVTVAR(DTL.Accounting_Period);

// LCL.TXT MM/YY             USR = CONCAT(LCL.USR CDE Parm 1,LCL.Month (Char) USR,CON.*ZERO)
LCL.TXT_MM_YY_USR = LCL.USR_CDE_Parm_1 + LCL.Month_Char_USR (*ZERO);

// LCL.Date (Alpha) USR = CONCAT(LCL.TXT MM/YY             USR,CON.01,CON.*ZERO)
LCL.Date_Alpha_USR = LCL.TXT_MM_YY_USR + '01' (*ZERO);

// DTL.USR From Date = CVTVAR(LCL.Date (Alpha) USR)
DTL.USR_From_Date = CVTVAR(LCL.Date_Alpha_USR);

// LCL.DD   numeric USR = LCL.Period Beginning Date *MONTH LENGTH
LCL.DD_numeric_USR = DATEDTLS(LCL.Period_Beginning_Date 'ML' 1111111 'NONE' 'N' 1);

// LCL.DD   alpha   USR = CVTVAR(LCL.DD   numeric USR)
LCL.DD_alpha_USR = CVTVAR(LCL.DD_numeric_USR);

// LCL.Date (Alpha) USR = CONCAT(LCL.TXT MM/YY             USR,LCL.DD   alpha   USR,CON.*ZERO)
LCL.Date_Alpha_USR = LCL.TXT_MM_YY_USR + LCL.DD_alpha_USR (*ZERO);

// DTL.USR Through Date = CVTVAR(LCL.Date (Alpha) USR)
DTL.USR_Through_Date = CVTVAR(LCL.Date_Alpha_USR);

// IF PAR.Comm Threshold Period is Accounting Period
IF PAR.Comm_Threshold_Period = 'AP';

EXECUTE FUNCTION(Rtv Period Start/End  RT) TYPE(RTVOBJ) FILE(CAATREP)           AC1666753;
PARAMETER(PAR.Company_Number);
PARAMETER(DTL.Accounting_Year);
PARAMETER(DTL.Accounting_Period);
PARAMETER(DTL.USR_From_Date);
PARAMETER(DTL.USR_Through_Date);
{
 //?USER: Initialize routine

 // LCL.First Time Flag = CND.Yes
 LCL.First_Time_Flag = 'Y';

 //?USER: Processing if Data record not found

 MOVE *ALL (To: PAR From: CON);

 //?USER: Process Data record

 CASE;

 // IF LCL.First Time Flag is Yes
 IF LCL.First_Time_Flag = 'Y';

 // PAR.Period Beginning Date = DB1.Period Beginning Date
 PAR.Period_Beginning_Date = DB1.Period_Beginning_Date;

 // LCL.First Time Flag = CND.NO
 LCL.First_Time_Flag = 'N';

 ENDIF;

 // PAR.Period Ending Date = DB1.Period Ending Date
 PAR.Period_Ending_Date = DB1.Period_Ending_Date;

}


ENDIF;

CASE;

// IF DTL.USR From Date is not entered
IF DTL.USR_From_Date = *ZERO;

// OR DTL.USR Through Date is not entered
OR DTL.USR_Through_Date = *ZERO;

// Send error message - 'Invalid Mo/Year'
ERROR(USR3326);

ENDIF;

CASE;

// IF DTL.USR Through Date GT JOB.*Job date
IF DTL.USR_Through_Date > JOB.*Job_date;

// Send error message - 'Invalid Mo/Year'
ERROR(USR3326);

ENDIF;

// PAR.Period Beginning Date = DTL.USR From Date
PAR.Period_Beginning_Date = DTL.USR_From_Date;

// PAR.Period Ending Date = DTL.USR Through Date
PAR.Period_Ending_Date = DTL.USR_Through_Date;

// PAR.Accounting Period = DTL.Accounting Period
PAR.Accounting_Period = DTL.Accounting_Period;

// PAR.Accounting Year = DTL.Accounting Year
PAR.Accounting_Year = DTL.Accounting_Year;

//?USER: Exit program processing

CASE;

// IF DTL.*CMD key is *Exit
IF DTL.*CMD_key = '03';

PGM.*Return_code = 'Y2U9999';

RETURN;

ENDIF;

