/********************************************************************/
/*                                                                  */
/*  SYNOPSIS - BUILT THE PRODUCTION DOWNLOAD FILE FOR TOM DYE TO FTP*/
/*                                                                  */
/*  COMPANY   - SEABOARD COPRORATION                                */
/*  SYSTEM    - ORDER MANAGEMENT                                    */
/*  USER NAME - ROSE CENTONZE                                       */
/*  DATE      - 05/16/00                                            */
/*                                                                  */
/*      PARAMETERS RECEIVED:                                        */
/*                                                                  */
/*          &PGM        - PROGRAM NAME                              */
/*          &COMPL      - COMPANY NUMBER - BLANK FOR ALL            */
/*          &FDATEL     - PRODUCTION DATE                         */
/*          &TDATEL     - PRODUCTION DATE                         */
/*          &SHIFT      - SHIFT                                   */
/*          &DOCUM      - DOCUMENT NAME                            */
/*          &DOCUMENT   - PARM DOCUMENT                             */
/*          &EMAIL      - EMAIL ADDR 1                             */
/*          &EMAIL2     - EMAIL ADDR 2  OPTIONAL                   */
/********************************************************************/
/* RMC  1/9/2001  CALL FTPPRKSRVR TO PUSH DOCUMENT TO FTP WEBSITE */
/* RMC 7/13/2001  ADD FROM TIME AND THRU TIME (IE. job time)      */
/*                and select from the Transaction Date a leau     */
/*                Production Date                                 */
/* RMC  1/11/2002 CALL FTPPRKSRV3 TO PUSH DOC TO \\PORKCFILE01\\TDYE$  */
/* RMC  6/27/2002 SUM POSITIVE AND NEGATIVE QTYS AND WGTS SEPARATELY.*/
/*                POSITIVE "RR" ARE RECEIPTS, NEGATIVE "RR" ARE   */
/*                REWORK                                          */
/* RMC  6/28/2002 SEND THE FILE AS .XLS A LIEU .CSV     */
/* SLM  8/11/2004 Replace PRKFLIB with *LIBL                      */
/* RMC  1/11/2006 ADDED COMPANY TO SELECT STMT AS &C          */
/* RMC  4/09/2007 CHG FTP TO EMAIL, WITH 2 POSSIBLE ADDRESSES    */
/********************************************************************/

 POFIUPC:    PGM        PARM(&RTN &COMPL &FDATEL &TDATEL &SHIFT +
                          &FTIMEL &TTIMEL &EMAIL &EMAIL2)

             DCL        VAR(&RTN) TYPE(*CHAR) LEN(7) /*  RETURN +
                          CODE   */
        DCL    &COMP      *DEC    (3 0)           /*  COMPANY #     */
        DCL    &COMPL     *DEC                    /*  FOR PASSING   */
        DCL    &FDATE     *DEC    (7 0)          /*  PROD DATE      */
        DCL    &FDATEL    *DEC                   /*  FOR PASSING    */
        DCL    &FDATEX    *CHAR   (7)          /*  PROD DATE      */
        DCL    &TDATE     *DEC    (7 0)          /*  PROD DATE      */
        DCL    &TDATEL    *DEC                   /*  FOR PASSING    */
        DCL    &TDATEX    *CHAR   (7)          /*  PROD DATE      */
        DCL    &SHIFT     *CHAR   (1)          /*  SHIFT          */
        DCL    &DOCUMENT  *CHAR   (10)
        DCL    &PCFILE    *CHAR   (32)
        DCL    &DOCUM     *CHAR   (08)
        DCL    &FTIME     *DEC    (6 0)          /*  FROM TIME      */
        DCL    &FTIMEL    *DEC                   /*  FOR PASSING    */
        DCL    &FTIMEX    *CHAR   (6)          /*  PROD TIME      */
        DCL    &TTIME     *DEC    (6 0)          /*  THRU TIME      */
        DCL    &TTIMEL    *DEC                   /*  FOR PASSING    */
        DCL    &TTIMEX    *CHAR   (6)          /*  PROD TIME      */
        DCL    &COMPA     *CHAR   (3)           /*  COMPANY #     */
        DCL    &EMAIL     *CHAR   (50)
        DCL    &EMAIL2    *CHAR   (50)
             DCL        &A          *CHAR    26 /* QRY SELECT    */
             DCL        &B          *CHAR    36 /* QRY SELECT    */
             DCL        &U          *CHAR    75  /* QRY SELECT   */
             DCL        &V          *CHAR    75  /* QRY SELECT   */
             DCL        &CM         *CHAR    20  /* QRY SELECT   */

/* SEND PROGRAM MESSAGE PARAMETERS  */

             /* Internal Fields */
             DCL  VAR(&ALREADY)  TYPE(*CHAR) LEN(1)

             DCL        VAR(&SEL)  TYPE(*CHAR) LEN(1500)
             DCL        VAR(&SHSEL)  TYPE(*CHAR) LEN(22)

             CHGVAR    VAR(&COMP) VALUE(&COMPL) /* Change to length +
                          for print program */
             CHGVAR    VAR(&COMPA) VALUE(&COMP) /* Change to alpha +
                          for message data */
             CHGVAR    VAR(&FDATE) VALUE(&FDATEL) /* Change to length +
                          for print program */
             CHGVAR    VAR(&FDATEX) VALUE(&FDATE) /* Change to CHAR  */
             CHGVAR    VAR(&TDATE) VALUE(&TDATEL) /* Change to length +
                          for print program */
             CHGVAR    VAR(&TDATEX) VALUE(&TDATE) /* Change to CHAR  */

             CHGVAR    VAR(&FTIME) VALUE(&FTIMEL) /* Change to length +
                          for print program */
             CHGVAR    VAR(&FTIMEX) VALUE(&FTIME) /* Change to CHAR  */
             CHGVAR    VAR(&TTIME) VALUE(&TTIMEL) /* Change to length +
                          for print program */
             CHGVAR    VAR(&TTIMEX) VALUE(&TTIME) /* Change to CHAR  */

             CHGVAR     VAR(&CM) VALUE('B7AIC3 = ' *CAT +
                         &COMPA)
     CHGVAR     VAR(&A) VALUE('((B7B4DT > ' *CAT &FDATEX *CAT ')')
           CHGVAR     VAR(&U) VALUE('OR (B7B4DT = ' *CAT &FDATEX +
                     *CAT ' AND B7AATM >= ' *CAT &FTIMEX *CAT '))')
  CHGVAR     VAR(&B) VALUE('AND ((B7B4DT < ' *CAT &TDATEX *CAT ')')
           CHGVAR     VAR(&V) VALUE('OR (B7B4DT = ' *CAT &TDATEX +
                      *CAT ' AND B7AATM <= ' *CAT &TTIMEX *CAT '))')

SHIFT:       IF         COND(&SHIFT = ' ') THEN(CHGVAR VAR(&SHSEL) +
                          VALUE('                   '))
             ELSE       CMD(CHGVAR VAR(&SHSEL) VALUE('AND B7XLCD ="' +
                          *CAT &SHIFT *CAT '"'))

             ADDLIBLE LIB(SEQUEL) POSITION(*LAST)
             MONMSG MSGID(CPF2103) EXEC(DO)       /* already in libl */
                CHGVAR VAR(&ALREADY) VALUE('Y')
                ENDDO
   /*------------------------------------------------*/
   /* EXECUTE SEQUEL TO BUILD THE FILE AND EMAIL IT -*/
   /*-----------------------------------------------*/
             CHGVAR     VAR(&SEL) VALUE('SELECT B7AIC3 +
                          COLHDG("Company"),  B7B4DT +
                          COLHDG("Transaction" "Date"), B7XLCD +
                          COLHDG("Shift"), B7HGCD EDTCDE(Z) +
                          COLHDG("Item" "Code"), SUM(B7A5QT) +
                          LEN(11,2) COLHDG("Transaction" "Qty") +
                          NAME(QTSUM),  SUM(B7AHWG) LEN(11,2) +
                          NAME(WTSUM) COLHDG("Transaction" +
                          "Weight"),WDATA(CASE WHEN B7A5QT>0 THEN +
                          B7A5QT ELSE 0 END) LEN(11,2) +
                          NAME(POSQTY), WDATA(CASE WHEN B7A5QT<0 +
                          THEN B7A5QT ELSE 0 END) LEN(11,2) +
                          NAME(NEGQTY), SUM(POSQTY) LEN(11,2) +
                          NAME(POSSUM) COLHDG("Receipt Qty"), +
                          wdata(case when B7AHWG>0 THEN B7AHWG ELSE +
                          0 END) len(11,2) name(poswgt), +
                          sum(poswgt) LEN(11,2) NAME(POSWGTSUM) +
                          COLHDG("Receipt Wgt"), SUM(NEGQTY) +
                          LEN(11,2) NAME(NEGSUM) COLHDG("Rework +
                          Qty"), WDATA(CASE WHEN B7AHWG<0 THEN +
                          B7AHWG ELSE 0 END) LEN(11,2) +
                          NAME(NEGWGT),  SUM(NEGWGT) LEN(11,2) +
                          NAME(NEGWGTSUM) COLHDG("Rework Wgt") FROM +
                         *LIBL/CAB7CPP  WHERE   B7BSST=''RR''' +
  *BCAT  'AND' *BCAT  &CM *BCAT &SHSEL *BCAT 'AND' *BCAT &A *BCAT +
                          &U *BCAT &B *BCAT &V *BCAT 'GROUP BY +
                          B7AIC3, B7B4DT, B7XLCD, B7HGCD')

 /*   WAS BEFORE 1/11/06  *LIBL/CAB7CPP  WHERE    B7BSST=''RR''' +
                          *BCAT &SHSEL *BCAT 'AND' *BCAT &A *BCAT +
                          &U *BCAT &B *BCAT &V *BCAT 'GROUP BY +
                          B7AIC3, B7B4DT, B7XLCD, B7HGCD')        */

 EMAIL1:
             EXECUTE    SQL(&SEL) MBROPT(*REPLACE) NBRRCDS(*ALL) +
                          KEYFLDCNT(*ALL) ALWNULL(*NO) PCFMT(*XLS) +
                          RECIPIENT(&EMAIL) EMLMSG('Production +
                          Download') OPTIMIZE(*TOTAL) ALWCPY(*YES) +
                          MSG(*YES) UNIQUEKEY(*NONE) IGNDECERR(*NO) +
                          DTSTYLE(*FIELD '/' *FIELD ':') +
                          TEXT('PRODUCTION DOWNLOAD')
 EMAIL2:     IF         COND(&EMAIL2 > '    ') THEN(DO)
             EXECUTE    SQL(&SEL) MBROPT(*REPLACE) NBRRCDS(*ALL) +
                          KEYFLDCNT(*ALL) ALWNULL(*NO) PCFMT(*XLS) +
                          RECIPIENT(&EMAIL2) EMLMSG('Production +
                          Download') OPTIMIZE(*TOTAL) ALWCPY(*YES) +
                          MSG(*YES) UNIQUEKEY(*NONE) IGNDECERR(*NO) +
                          DTSTYLE(*FIELD '/' *FIELD ':') +
                          TEXT('PRODUCTION DOWNLOAD')
                          ENDDO
 GOTO END   /* 04.09.07   */
   /*---------------------------------*/
   /* Remove SEQUEL Library from List */
   /*---------------------------------*/
             IF COND(&ALREADY *EQ 'N') THEN(DO)
                RMVLIBLE   LIB(SEQUEL)
             ENDDO
   /*------------------------------------*/
   /* PUSH documents to \\PORKCFILE01\TDYE$    */
   /*------------------------------------*/
             CHGVAR VAR(&DOCUMENT) VALUE(&DOCUM)
             CHGVAR VAR(&PCFILE)   VALUE(&DOCUM *TCAT '.XLS')
             CALL PGM(FTPPRKSRV3) PARM(&DOCUMENT &PCFILE)


 END:        ENDPGM
