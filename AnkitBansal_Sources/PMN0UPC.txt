/*                                                                            */
/* CLP Print Pick Slips Driver                                                */
/*                                                                            */
/* This program sets up the OPNQRYF to select Order Header TRG records        */
/* based on selections made in PMT Print Pick Slips   PV (PMNVPVR). It        */
/* then calls Call EXT Print Pick Slips (PMNZXFR) to print a pick list for    */
/* record selected in Order Header TRG                                        */
/******************************************************************************/
/* PIO 07/14/23 REPLACE OPNQRYF WITH OPNSQLF IN OPBFCPP FILE                  */
/*              ADDED NEEDED OVRDBF AROUND THE COMMAND.                       */
/*              CHANGE *AND TO AND, *EQ TO =, *GE TO >=, *LE TO <=, *GT TO >  */
/*              IN &QRYSLT                                                    */
/******************************************************************************/

PGM PARM(&COMPANY15 &ORDER15 &LOAD15 &DATE15 &OUTQ &HOLD &SAVE &NIGHTQ +
         &HOLDJOB &LOGJOB &USER &COPIES15)

/* Parameters */
DCL    &COMPANY15  *DEC                /* Company Number */
DCL    &ORDER15   *DEC                 /* Order Number   */
DCL    &LOAD15   *DEC                  /* Load ID      */
DCL    &DATE15   *DEC                  /* Scheduled Ship Date */
DCL    &COPIES15     *DEC              /* Number of copies          */
DCL    &OUTQ     *CHAR   (10)          /* Output Queue   */
DCL    &HOLD     *CHAR   (4)           /* Hold Status    */
DCL    &SAVE     *CHAR   (4)           /* Save Status    */
DCL    &NIGHTQ   *CHAR   (10)          /* Night Output Queue   */
DCL    &HOLDJOB *CHAR (5)              /* Put job on hold? */
DCL    &LOGJOB *CHAR (17)              /* Job Logging */
DCL    &USER   *CHAR   (10)            /* User who submitted job */

/* Working fields */
DCL    &COMPANY   *DEC  LEN(3 0)
DCL    &ORDER   *DEC  LEN(7 0)
DCL    &LOAD   *DEC  LEN(7 0)
DCL    &SHIPDATE   *DEC  LEN(7 0)
DCL    &COMPANYCHR   *CHAR   (3)
DCL    &ORDERCHR *CHAR   (7)
DCL    &LOADCHR *CHAR   (7)
DCL    &SHIPDATEC    *CHAR   (7)
DCL    &COPIES       *DEC    (2 0)         /* Number of copies          */
DCL    &QRYSLT   *CHAR  LEN(256)           /* OPNQRYF select statement  */
DCLF   OPBFCPL1                            /* Order Header TRG */

/* Move parameters to working fields */
CHGVAR &COMPANY &COMPANY15
CHGVAR &ORDER &ORDER15
CHGVAR &LOAD &LOAD15
CHGVAR &SHIPDATE &DATE15
CHGVAR &COPIES &COPIES15

/* Build QRYSLT parmameter */
/* Orders w/ Header Status of 'Available' and Event Code of 'Load Planned' */
/* or 'Picked'                                                           ' */
         /*  CHGVAR     VAR(&QRYSLT) VALUE('BEGWST *EQ ''A'' *AND +
                          BEJPCD *EQ %VALUES(''02'' ''03'')') */
CHGVAR &COMPANYCHR &COMPANY
         /*  CHGVAR     VAR(&QRYSLT) VALUE(&QRYSLT *BCAT '*AND +
                          BEAIC3 *EQ ' *BCAT &COMPANYCHR) */
  /*PIO      CHGVAR     VAR(&QRYSLT) VALUE('BEAIC3 *EQ ' *BCAT + +
                          &COMPANYCHR)                          */
  /*PIO*/    CHGVAR     VAR(&QRYSLT) VALUE('BEAIC3  =  ' *BCAT +
                          &COMPANYCHR)

/* If Order Number is specified */
IF COND(&ORDER *GT 0) THEN(DO)
     CHGVAR &ORDERCHR &ORDER
 /*PIO  CHGVAR &QRYSLT VALUE(&QRYSLT *BCAT '*AND BEC4NB *EQ ' *BCAT &ORDERCHR)*/
/*PIO*/ CHGVAR &QRYSLT VALUE(&QRYSLT *BCAT ' AND BEC4NB  =  ' *BCAT &ORDERCHR)
ENDDO

/* If Load ID is specified */
IF COND(&LOAD *GT 0) THEN(DO)
     CHGVAR &LOADCHR &LOAD
/*PIO CHGVAR &QRYSLT VALUE(&QRYSLT *BCAT '*AND BERMNB *EQ ' *BCAT &LOADCHR)*/
/*PIO*/ CHGVAR &QRYSLT VALUE(&QRYSLT *BCAT ' AND BERMNB =   ' *BCAT &LOADCHR)
ENDDO

/* If Scheduled Ship Date is specified */
IF COND(&SHIPDATE *GT 0) THEN(DO)
     CHGVAR &SHIPDATEC &SHIPDATE
/*PIO CHGVAR &QRYSLT VALUE(&QRYSLT *BCAT '*AND BEAODT *EQ ' *BCAT &SHIPDATEC)*/
/*PIO*/ CHGVAR &QRYSLT VALUE(&QRYSLT *BCAT ' AND BEAODT  =  ' *BCAT &SHIPDATEC)
ENDDO

             CHGVAR     VAR(&QRYSLT) VALUE(&QRYSLT *BCAT ' AND +
                          BEGJST = "N" AND BEGWST IN +
                          ("L","A","C","R","E","H","I") AND BEU5ST +
                          = "Y" AND BEGYST = "N"  AND BEBCST = +
                          "F"') /*PIO*/


/* Override database file for OPNQRYF */
 /*PIO OVRDBF     FILE(OPBFCPOB) SHARE(*YES) +
             OPNQRYF    FILE((OPBFCPOB)) QRYSLT(&QRYSLT) KEYFLD(*FILE) */

  /*PIO*/    OVRDBF     FILE(OPBFCPP) TOFILE(OPBFCPP) LVLCHK(*NO)
             OPNSQLF    SQL('Select * from OPBFCPP Where  ' *BCAT +
                          &QRYSLT *BCAT ' ORDER BY BERMNB ASC, +
                          BEC4NB ASC') OPNID(OPBFCPOB) OPTION(*ALL) +
                          SEQONLY(*NO) RCDFMT(@BFCPNJ) +
                          ALWCPY(*IFRQD) /*PIO*/
  /*PIO*/    OVRDBF     FILE(OPBFCPOB) TOFILE(OPBFCPP) LVLCHK(*NO) +
                          OVRSCOPE(*JOB) SHARE(*YES) OPNSCOPE(*JOB)


/* Any records selected? */
RCVF
MONMSG     MSGID(CPF0864) EXEC(DO)
     SNDMSG MSG('No records met your criteria for Pick Slip Print') +
            TOUSR(&USER)
     GOTO ENDPGM
ENDDO

/* Call EXT Print Pick Slips */
CALL PMNZXFR PARM(' ' &OUTQ &HOLD &SAVE &COPIES &NIGHTQ &HOLDJOB &LOGJOB )

ENDPGM:

/* Delete overrides and close open data paths */
CLOF OPBFCPOB
 /*PIO  DLTOVR *ALL */
             DLTOVR     FILE(*ALL) LVL(*JOB) /*PIO*/
ENDPGM
