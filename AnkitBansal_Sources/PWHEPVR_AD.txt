// ?------------------------------------------------------------------------------------------------
// ?Synon action diagram for PWHEPVR
// ?Date: 14.08.2025 Time: 02:56:27
// ?------------------------------------------------------------------------------------------------

//?USER: Initialize program

//?Modification history
DO;

//? 9/12/2018 JBB E13669 - Enhancements to the Repayments process
//?- Function created.
//? 2/20/2018 JBB E14234 - Enhancements to the Repayments phase 2
//?- Added a text field for a warning that the files already backed up
//? 9/12/2018 JBB E15428 - Enhancements to the Repayments process
//?- Added Tattoo Scale Ticket file PKB3CPP to the backup list of
//?  files.
ENDDO;

//?Retrieve current Company Value for backup status and date
// Call program Rtv Company Values    XF.
CALL PROGRAM(Rtv Company Values    XF) ('PDGKXFR');
PARAMETER(PAR.BOH_Company_Number);
PARAMETER('HPEREPAYBU');
PARAMETER(LCL.System_Value_Alpha_USR);

//?Breakout Repayment Backup file values
CASE;

// IF *OTHERWISE
IF *OTHERWISE;

//?1. Backup Status (position 1)
// LCL.File Backup Status USR = SUBSTRING(LCL.System Value Alpha    USR,CON.1,CON.1)
LCL.File_Backup_Status_USR = SUBSTRING(LCL.System_Value_Alpha_USR:1:1);

//?2. Date of Backup (positions 2-8)
// LCL.Date Alpha USR = SUBSTRING(LCL.System Value Alpha    USR,CON.2,CON.7)
LCL.Date_Alpha_USR = SUBSTRING(LCL.System_Value_Alpha_USR:2:7);

// LCL.Last Run Date = CVTVAR(LCL.Date Alpha USR)
LCL.Last_Run_Date = CVTVAR(LCL.Date_Alpha_USR);

// LCL.Date From Convert USR = CVTVAR(LCL.Last Run Date)
LCL.Date_From_Convert_USR = CVTVAR(LCL.Last_Run_Date);

//?3. Last file backed up (positions 9 - 18)
// LCL.File = SUBSTRING(LCL.System Value Alpha    USR,CON.9,CON.10)
LCL.File = SUBSTRING(LCL.System_Value_Alpha_USR:9:10);

ENDIF;

//?If not Guymon, set non-display flag to Yes
CASE;

// IF PAR.BOH Company Number is SBD Farms of Guymon, Ok
IF PAR.BOH_Company_Number = 360;

// LCL.Hide field 1 usr = CND.No
LCL.Hide_field_1_usr = 'N';

//?If not Guymon, set non-display flag to Yes
// IF *OTHERWISE
IF *OTHERWISE;

// LCL.Hide field 1 usr = CND.Yes
LCL.Hide_field_1_usr = 'Y';

ENDIF;

//?USER: Load screen

// DTL.BOH Company Number = PAR.BOH Company Number
DTL.BOH_Company_Number = PAR.BOH_Company_Number;

// Call program Rtv Company Values    XF.
CALL PROGRAM(Rtv Company Values    XF) ('PDGKXFR');
PARAMETER(DTL.BOH_Company_Number);
PARAMETER('HPEREPAYLB');
PARAMETER(LCL.Libraries_From_To);

//?If From and To libraries retrieved, break them out
CASE;

// IF LCL.Libraries: From/To is Entered
IF LCL.Libraries_From_To <> *BLANK;

// DTL.Library From USR = SUBSTRING(LCL.Libraries: From/To,CON.1,CON.10)
DTL.Library_From_USR = SUBSTRING(LCL.Libraries_From_To:1:10);

// DTL.Library To USR = SUBSTRING(LCL.Libraries: From/To,CON.11,CON.10)
DTL.Library_To_USR = SUBSTRING(LCL.Libraries_From_To:11:10);

ENDIF;

//?The files will be named as follows: FFFFLLMMDD    ex: PKAWST0912
//?FFFF = first four characters of the file name
//?LL   = Location abreviation:  GU, ST, TF, or T2
//?MM   = Month
//?DD   = Day
//?Breakout date and make it MMDD
CASE;

// IF *OTHERWISE
IF *OTHERWISE;

// LCL.Month USR = JOB.*Job date *MONTH
LCL.Month_USR = DATEDTLS(JOB.*Job_date 'MO' 1111111 'NONE' 'N' 1);

// LCL.Day of Month USR = JOB.*Job date *DAY OF MONTH
LCL.Day_of_Month_USR = DATEDTLS(JOB.*Job_date 'DM' 1111111 'NONE' 'N' 1);

// Month and Day combined
LCL.Month_and_Day_4_0 = ( LCL.Month_USR * 100 ) + LCL.Day_of_Month_USR;

// LCL.@Text 4 = CVTVAR(LCL.Month and Day 4.0)
LCL.@Text_4 = CVTVAR(LCL.Month_and_Day_4_0);

ENDIF;

//?Create file name suffix and build file name
CASE;

// IF *OTHERWISE
IF *OTHERWISE;

//?Build file suffix for specific companies
CASE;

// IF PAR.BOH Company Number is SBD Farms of Guymon, Ok
IF PAR.BOH_Company_Number = 360;

// LCL.File Suffix = CONCAT(CON.GU,LCL.@Text 4,CND.*None)
LCL.File_Suffix = 'GU' + LCL.@Text_4 (*ZERO);

//?Build file suffix for specific companies
// IF PAR.BOH Company Number is Sioux City
IF PAR.BOH_Company_Number = 440;

// LCL.File Suffix = CONCAT(CON.ST,LCL.@Text 4,CND.*None)
LCL.File_Suffix = 'ST' + LCL.@Text_4 (*ZERO);

//?Build file suffix for specific companies
// IF PAR.BOH Company Number is Triumph Foods Market
IF PAR.BOH_Company_Number = 960;

// OR PAR.BOH Company Number is Triumph Foods-2
OR PAR.BOH_Company_Number = 961;

// LCL.File Suffix = CONCAT(CON.TF,LCL.@Text 4,CND.*None)
LCL.File_Suffix = 'TF' + LCL.@Text_4 (*ZERO);

ENDIF;

ENDIF;

//?Load file names to the screen
CASE;

// IF *OTHERWISE
IF *OTHERWISE;

// LCL.Prod File Name 1 = CON.PKAWCPP
LCL.Prod_File_Name_1 = 'PKAWCPP';

// DTL.File Backup Name 1 = CONCAT(CON.PKAW,LCL.File Suffix,CND.*None)
DTL.File_Backup_Name_1 = 'PKAW' + LCL.File_Suffix (*ZERO);

// LCL.Prod File Name 2 = CON.PKAXCPP
LCL.Prod_File_Name_2 = 'PKAXCPP';

// DTL.File Backup Name 2 = CONCAT(CON.PKAX,LCL.File Suffix,CND.*None)
DTL.File_Backup_Name_2 = 'PKAX' + LCL.File_Suffix (*ZERO);

// LCL.Prod File Name 3 = CON.PKA1CPP
LCL.Prod_File_Name_3 = 'PKA1CPP';

// DTL.File Backup Name 3 = CONCAT(CON.PKA1,LCL.File Suffix,CND.*None)
DTL.File_Backup_Name_3 = 'PKA1' + LCL.File_Suffix (*ZERO);

// LCL.Prod File Name 4 = CON.PKA2CPP
LCL.Prod_File_Name_4 = 'PKA2CPP';

// DTL.File Backup Name 4 = CONCAT(CON.PKA2,LCL.File Suffix,CND.*None)
DTL.File_Backup_Name_4 = 'PKA2' + LCL.File_Suffix (*ZERO);

// LCL.Prod File Name 5 = CON.PKDNCPP
LCL.Prod_File_Name_5 = 'PKDNCPP';

// DTL.File Backup Name 5 = CONCAT(CON.PKDN,LCL.File Suffix,CND.*None)
DTL.File_Backup_Name_5 = 'PKDN' + LCL.File_Suffix (*ZERO);

// LCL.Prod File Name 6 = CON.PKCDCPP
LCL.Prod_File_Name_6 = 'PKCDCPP';

// DTL.File Backup Name 6 = CONCAT(CON.PKCD,LCL.File Suffix,CND.*None)
DTL.File_Backup_Name_6 = 'PKCD' + LCL.File_Suffix (*ZERO);

// LCL.Prod File Name 7 = CON.PKB1CPP
LCL.Prod_File_Name_7 = 'PKB1CPP';

// DTL.File Backup Name 7 = CONCAT(CON.PKB1,LCL.File Suffix,CND.*None)
DTL.File_Backup_Name_7 = 'PKB1' + LCL.File_Suffix (*ZERO);

//?If Company = Guymon, load File Name 8 and File Name 9
CASE;

// IF PAR.BOH Company Number is SBD Farms of Guymon, Ok
IF PAR.BOH_Company_Number = 360;

// LCL.Prod File Name 8 = CON.PKB3CPP
LCL.Prod_File_Name_8 = 'PKB3CPP';

// DTL.File Backup Name 8 = CONCAT(CON.PKB3,LCL.File Suffix,CND.*None)
DTL.File_Backup_Name_8 = 'PKB3' + LCL.File_Suffix (*ZERO);

// LCL.Prod File Name 9 = CON.PKEJCPP
LCL.Prod_File_Name_9 = 'PKEJCPP';

// DTL.File Backup Name 9 = CONCAT(CON.PKEJ,LCL.File Suffix,CND.*None)
DTL.File_Backup_Name_9 = 'PKEJ' + LCL.File_Suffix (*ZERO);

ENDIF;

ENDIF;

//?Check if backup already run for current date
CASE;

// IF LCL.Last Run Date EQ JOB.*Job date
IF LCL.Last_Run_Date = JOB.*Job_date;

// DTL.Text description = CONCAT(CON.Warning: Files already ba,CON.cked up for current date,CND.*Non
DTL.Text_description = 'Warning: Files already ba' + 'cked up for current date' (*ZERO);

ENDIF;

//?USER: Validate fields

//?If From and To libraries not entered, send error message
CASE;

// IF LCL.Libraries: From/To is Not entered
IF LCL.Libraries_From_To = *BLANK;

// Send error message - 'Backup library names not found.'
ERROR(PRK1515);

ENDIF;

//?USER: User defined action

// Call program Exc Repay File Backup CL.
SBMJOB;
CALL PROGRAM(Exc Repay File Backup CL) ('PWHOUPC');
PARAMETER(DTL.BOH_Company_Number);
PARAMETER(DTL.Library_From_USR);
PARAMETER(DTL.Library_To_USR);
PARAMETER(LCL.File_Suffix);
PARAMETER(JOB.*Job_date);
SBMJOBOVR JOB(REPAYBAKUP);
SBMJOBOVR JOBQ(QPGMR);
SBMJOBOVR LOG(4;
SBMJOBOVR 00;
SBMJOBOVR *SECLVL);
SBMJOBEND;

//?USER: Exit program processing

//?If user exited screen with out starting the backup
CASE;

// IF DTL.*CMD key is *Exit
IF DTL.*CMD_key = '03';

PGM.*Return_code = 'Y2U9999';

RETURN;

ENDIF;

