/***************************************************************** */
/* êNOTE: PROGRAM CLONED FROM HP4034CL.                            */
/*                                                                 */
/*  PROGRAM:         HP40341CL                                     */
/*  PROGRAM NAME:    SIRE LINE DOWNLOAD AGVIEW                     */
/*  PROGRAMMER:      DANNY NGUYEN                                  */
/*  CREATE DATE:     06/10/2021                                    */
/*                                                                 */
/*  PURPOSE ---------> Generate workfile for NCSU to pick up from  */
/*                     the IFS Directory & email XLS results to DL.*/
/*                     TEST DIRECTORY:                             */
/*                     /AGVIEW/TEST/                               */
/*                                                                 */
/*                     PROD DIRECTORY:                             */
/*                     /AGVIEW/PROD/                               */
/*                                                                 */
/*  Job Schedule that will call this program:                      */
/*                     TEST: HPSAGVIEWT                            */
/*                     PROD: HPSAGVIEW                             */
/*-----------------------------------------------------------------*/
/*  MODIFICATIONS LOG:                                             */
/*-----------------------------------------------------------------*/
/*Ç06/11/24  Jagdish Mistry (JM-WI628),                            */
/*Ç          Project 628-RabApp Bypass to Agview                   */
/*Ç          a. Process will run under JS name HPSAGVIEWS          */
/*Ç          b. Retrieve record count out of HSP3034 to control msg*/
/*Ç             processing and remove the &flag processing.        */
/*Ç          c. Change to send file HSP3034 to the IFS as a .CSV   */
/*Ç             instead of xls.                                    */
/*Ç          d. Deactivate ESND email notifications                */
/*Ç07/30/24  Jagdish Mistry (JM-WI628),                            */
/*Ç          1)Changed .CSV to .XLSX to get back Header for user   */
/*Ç          2)Send .CSV without header to IFS folder of /AGVIEW/  */
/*Ç08/21/24  Jagdish Mistry (JM-S027448) Reactivate ESND           */
/*                                                                 */
/*******************************************************************/

             PGM

             DCL        VAR(&ACYR) TYPE(*DEC) LEN(4 0)
             DCL        VAR(&ACPE) TYPE(*DEC) LEN(2 0)
             DCL        VAR(&ACQR) TYPE(*DEC) LEN(1 0)
             DCL        VAR(&ACWK) TYPE(*DEC) LEN(2 0)
             DCL        VAR(&PICDT) TYPE(*DEC) LEN(5 0)
             DCL        VAR(&CDYR) TYPE(*DEC) LEN(4 0)
             DCL        VAR(&CDWK) TYPE(*DEC) LEN(2 0)
             DCL        VAR(&CURDTE)  TYPE(*CHAR) LEN(6)
             DCL        VAR(&CURDTE2) TYPE(*CHAR) LEN(8)
             DCL        VAR(&CURDTETME) TYPE(*CHAR) LEN(20)
             DCL        VAR(&CURDTETME2) TYPE(*CHAR) LEN(14)
             DCL        VAR(&CCYYMMDD) TYPE(*DEC) LEN(8 0)
             DCL        VAR(&WBDTE) TYPE(*DEC) LEN(8 0)
             DCL        VAR(&WBDTEA) TYPE(*CHAR) LEN(8)
             DCL        VAR(&WEDTE) TYPE(*DEC) LEN(8 0)
             DCL        VAR(&WEDTEA) TYPE(*CHAR) LEN(8)
             DCL        VAR(&DTALIB) TYPE(*CHAR) LEN(10)
             DCL        VAR(&EMLSBJ) TYPE(*CHAR) LEN(80)
             DCL        VAR(&EMLMSG) TYPE(*CHAR) LEN(200)
             DCL        VAR(&EMAILDL) TYPE(*CHAR) LEN(50)
             DCL        VAR(&IFSDIR) TYPE(*CHAR) LEN(48)
             DCL        VAR(&FILENM) TYPE(*CHAR) LEN(30) +
                          VALUE('SIRELINELOG')
             DCL        VAR(&TOSTMF) TYPE(*CHAR) LEN(200)
             DCL        VAR(&MSGTXT) TYPE(*CHAR) LEN(150)

             DCL        VAR(&QDATA)  TYPE(*CHAR) LEN(100)

             DCL        VAR(&LDFWEDT) TYPE(*DEC)  LEN(8)
             DCL        VAR(&LDTWEDT) TYPE(*DEC)  LEN(8)
             DCL        VAR(&LDFSCD)  TYPE(*DEC)  LEN(5)
             DCL        VAR(&LDSICD)  TYPE(*CHAR) LEN(5)
             DCL        VAR(&LDEMAIL) TYPE(*CHAR) LEN(50)
             DCL        VAR(&FLAG)    TYPE(*CHAR) LEN(1)
/*ÇJM-WI628-START                                                        */
             DCL        VAR(&TOTALCNT) TYPE(*DEC) LEN(8 0)
             DCL        VAR(&FILENAME) TYPE(*CHAR) LEN(30)
/*ÇJM-WI628-END                                                          */


     /* Get System Value For Data File Library to Determine Whether +
               in PROD or TEST Environment */
             CALL       PGM(PPJXXFR) PARM(' ' 'DTALIB' &DTALIB)

     /* Set Constant Defaults */
             IF         COND(&DTALIB *NE 'PRKFLIB') THEN(DO)
             CHGVAR     VAR(&EMAILDL) VALUE('dl agview test')
             CHGVAR     VAR(&EMLSBJ) VALUE('HPS: HP40341CL-Sire Line +
                          Log Export for Agview-TEST')

             CHGVAR     VAR(&IFSDIR) VALUE('/AGVIEW/TEST/')
             ENDDO
             ELSE       CMD(DO)
             CHGVAR     VAR(&EMAILDL) VALUE('dl agview')
             CHGVAR     VAR(&EMLSBJ) VALUE('HPS: HP40341CL-Sire Line +
                          Log Export for Agview')

             CHGVAR     VAR(&IFSDIR) VALUE('/AGVIEW/PROD/')
             ENDDO

/*-----------------------------------------------------------------*/
/* CREATE THE WORKFILE                                             */
/*-----------------------------------------------------------------*/

             CRTDUPOBJ  OBJ(HSP3034) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)

/*-------------------------------------------------------------------*/
/*  P2098 - GET CURRENT WEEKS BEGINNING & ENDING DATE                */
/*-------------------------------------------------------------------*/

             RTVSYSVAL  SYSVAL(QDATE) RTNVAR(&CURDTE)
             RTVSYSVAL  SYSVAL(QDATETIME) RTNVAR(&CURDTETME)

    /* Set &CURDTETME2 as CCYYMMDDHHMMSS Format  */
             CHGVAR     VAR(&CURDTETME2) VALUE(%SST(&CURDTETME 1 14))

             CVTDAT     DATE(&CURDTE) TOVAR(&CURDTE2) FROMFMT(*MDY) +
                          TOFMT(*YYMD) TOSEP(*NONE)

             CHGVAR     VAR(&CCYYMMDD) VALUE(&CURDTE2)

             CALL       PGM(HP8017) PARM(&CCYYMMDD &ACYR &ACPE &ACQR +
                          &ACWK &PICDT &CDYR &CDWK)

             CALL       PGM(HP8016) PARM(&CDYR &CDWK &WBDTE &WEDTE)

             CHGVAR     VAR(&WBDTEA) VALUE(&WBDTE)
             CHGVAR     VAR(&WEDTEA) VALUE(&WEDTE)

/*-------------------------------------------------------------------*/
/* BUILD/RUN QUERY OVER FILE: WEEKLY SIRE LINE DOSES                 */
/*-------------------------------------------------------------------*/

/* ALWAYS SELECT ONLY RECORDS WITH A WEEK-ENDING DATE IN THE SELECTED */
/* DATE RANGE.                                                        */

             CHGVAR     VAR(%SST(&QDATA 1 10)) VALUE('SWWEDT *GE')
             CHGVAR     VAR(%SST(&QDATA 12 8)) VALUE(&WBDTE)
             CHGVAR     VAR(%SST(&QDATA 21 15)) VALUE('*AND SWWEDT +
                          *LE')
             CHGVAR     VAR(%SST(&QDATA 37 8)) VALUE(&WEDTE)

             OVRDBF     FILE(HSL081D) SHARE(*YES)
             OPNQRYF    FILE((HSL081D)) FORMAT(*FILE) +
                          QRYSLT(&QDATA) KEYFLD(*FILE) SEQONLY(*YES)

/*-----------------------------------------------------------------*/
/* BUILD THE WORKFILE                                              */
/*-----------------------------------------------------------------*/

/*ÇJM-WI628-START                                                        */
/*           CALL       PGM(HP3034) PARM(&FLAG)                          */
             CALL       PGM(HP3034) PARM((&TOTALCNT))
/*ÇJM-WI628-END                                                          */

             CLOF       OPNID(HSL081D)
             DLTOVR     FILE(HSL081D)

/*-------------------------------------------------------------------*/
/* DOWNLOAD                                                          */
/*-------------------------------------------------------------------*/

/*ÇJM-WI628-START-Decommission &FLAG                               */
/*           IF         COND(&FLAG = 'Z')     THEN(DO)                    */
             IF         COND(&TOTALCNT *EQ 0) THEN(DO)
/*ÇJM-WI628-END                                                    */
             CHGVAR     VAR(&MSGTXT) VALUE('Sire Line Download for +
                          Agview did not extract any data for the +
                          spreadsheet for Date Range:' *BCAT +
                          &WBDTEA *BCAT 'to' *BCAT &WEDTEA)
/*ÇJM-WI628-START  Deactivate notifications                              */
/*ÇJM-S027448-STARTT-Reactivate notifications                            */
             ESNDMAIL   RECIPIENT(&EMAILDL) SUBJECT(&EMLSBJ) +
                          MSG(&MSGTXT)
             MONMSG     MSGID(CPF0000)
/*ÇJM-S027448-END                                                        */
/*ÇJM-WI628-END                                                    */
             ENDDO

             CHGVAR     VAR(&EMLMSG) VALUE('Date Range:' *BCAT +
                          &WBDTEA *BCAT 'to' *BCAT &WEDTEA)

/*ÇJM-WI628-START-Decommission &FLAG                               */
/*           IF         COND(&FLAG = 'T')     THEN(DO)                   */
    /*êP2098 - We should never hit this since process will be build weekly +
              êand will not have more than 7 days worth of data. */
/*           ESNDMAIL   RECIPIENT(&EMAILDL) SUBJECT(&EMLSBJ) +           */
/*                        MSG('Sire Line Download for Agview +           */
/*                        extracted over 66,000 records--which is +      */
/*                        too many records for the spreadsheet to +      */
/*                        handle. Please notify AS400 personnel to +     */
/*                        fix this problem.')                            */
/*           MONMSG     MSGID(CPF0000)                                   */
/*           ENDDO                                                       */
/*ÇJM-WI628-END                                                    */

/*ÇJM-WI628-START-Decommission &FLAG                               */
             IF         COND(&TOTALCNT *GT 0) THEN(DO)
/*           IF         COND(&FLAG = ' ')     THEN(DO)                   */
             CHGVAR     VAR(&EMLMSG) VALUE('Date Range:' *BCAT +
                          &WBDTEA *BCAT 'to' *BCAT &WEDTEA)
/*ÇJM-WI628-END                                                    */

/*ÇJM-WI628-START-Replace xls by csv                               */
    /* Set File Name to Save to IFS Directory */
/*           CHGVAR     VAR(&FILENM) VALUE(&FILENM *TCAT &CURDTETME2 +*/
/*                        *TCAT '.XLSX')                           */
/*ÇJM-WI628-END                                                    */

   /* Set IFS Stream File Path */
/*           CHGVAR     VAR(&TOSTMF) VALUE(&IFSDIR *TCAT &FILENM)  */

/*ÇJM-WI628-START-Send XLSX to user with Header                     */
/*           EXECUTE    SQL('SELECT * FROM HSP3034') PCFMT(*XLSX) +      */
             EXECUTE    SQL('SELECT * FROM HSP3034') PCFMT(*XLSX) +
                          REPLACE(*YES) RECIPIENT(&EMAILDL) +
                          EMLMSG(&EMLMSG) TEXT(&EMLSBJ)
             MONMSG     MSGID(CPF0000)

/*ÇJM-WI628-Send CSV to AGVIEW without Header                      */
             CHGVAR     VAR(&FILENAME) VALUE(&FILENM *TCAT +
                          &CURDTETME2 *TCAT '.CSV')
             CHGVAR     VAR(&TOSTMF) VALUE(&IFSDIR *TCAT &FILENAME)
             EXECUTE    SQL('SELECT * FROM HSP3034') +
                          PCFMT(*DELIMITED) TOSTMF(&TOSTMF) +
                          REPLACE(*YES)
/*ÇJM-WI628-END                                                    */

             MONMSG     MSGID(CPF0000)
             ENDDO

             DLTF       FILE(QTEMP/HSP3034)


             ENDPGM

