/***************************************************************** */
/*                                                                 */
/*  PROGRAM NUMBER:  M3OPNCUT                                      */
/*  PROGRAM NAME:    CREATE M3 INTERFACES FOR AR OPEN ITEM FOR CUTOVER/PILOTS */
/*  PROGRAMMER:      RMC                                        */
/*  CREATE DATE:     01/26/16                                      */
/*                                                                 */
/*  FUNCTION:        THIS CL IS CALLED ON DEMAND                   */
/*                                                                 */
/*                                                                 */
/*                   IT PERFORMS THE FOLLOWING FUNCTIONS:          */
/*                   A) SETS LIB LIST                             */
/*                   B) CREATE FILES IN QTEMP                    */
/*                   C) GETS DATA LIBRARY FOR M3ILIB                 */
/*                   D) GETS EMAIL ADDRESSS TO RECEIVE THE FILES */
/*                   E) CALL PBVUXFR ' ' TO UPDATE OMP300        */
/*                   F) CALL M3OPNSTG (' '  'aa') CREATE PLB9CPP    */
/*                      per order type OR/CM/DM/OA                */
/*                   G) EMAILS IN/CM/DM FILES TO EMAIL ADDR  */
/*                   H) COPY PLB9CPP/PLCGCPP TO M3ILIB         */
/*                                                                 */
/*******************************************************************/
/* MODIFIED:                                                       */
/*  RMC E004055 5.24.2016 ADDED UPDATE TO PLCKCPP FOR ORD/CUST PO */
/*                        CHANGE TO USE QTEMP AND INSTALL TO PRD   */
/*******************************************************************/
             PGM        PARM(&DATE &INVOICE)
             DCL        VAR(&DATE) TYPE(*DEC) LEN(7 0)
             DCL        VAR(&INVOICE) TYPE(*DEC) LEN(7 0)
             DCL        VAR(&KEYVALUE) TYPE(*CHAR) LEN(15)
             DCL        VAR(&EMAILTO) TYPE(*CHAR) LEN(30)
             DCL        VAR(&M3ILIB) TYPE(*CHAR) LEN(10)
             DCL        VAR(&DMLIB) TYPE(*CHAR) LEN(10)  /* DATA MART LIB */
             DCL        VAR(&RETRN) TYPE(*CHAR) LEN(7)

             MONMSG     MSGID(CPF2103 CPF2130)
  /*         ADDLIBLE   LIB(OMSDEVGEN) POSITION(*AFTER COMMON)       +
             ADDLIBLE   LIB(HPEDEVGEN) POSITION(*AFTER COMMON)       +
             ADDLIBLE   LIB(JPRODTST) POSITION(*AFTER COMMON)        */
/* GOTO BUILDIT                        */
 /*          CLRPFM     FILE(JPRODTST/OMP300)                        */
/* ________________________________________________________________________*/

      /* GET SYSTEM VALUE FOR INTERFACE FILE LIBRAY - VALUE M3ILIB    */

             CALL       PGM(PBSHXFR) PARM(' ' &M3ILIB)
             IF         COND(&M3ILIB = '       ') THEN(CHGVAR +
                          VAR(&M3ILIB) VALUE('HPEDEVGEN'))
      /* GET SYSTEM VALUE FOR DATA MART FILE LIBRAY - VALUE DATAMART  */
             CALL       PGM(PPJXXFR) PARM(' ' 'DATAMART' &DMLIB)
             IF         COND(&DMLIB = '       ') THEN(CHGVAR +
                          VAR(&M3ILIB) VALUE('OMSDEVGEN'))

             ADDLIBLE   LIB(PRKFLIB) POSITION(*LAST) /* PLB8REP XFEF +
                          PLB9CPP,PLCGCPP TABLES ARE HERE  */
             MONMSG     MSGID(CPF2103)
  /* SET UP QTEMP FILES                                                 */
             CRTDUPOBJ  OBJ(OMP300) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)
             MONMSG     MSGID(CPF2130) EXEC(CLRPFM FILE(QTEMP/OMP300))
             CRTDUPOBJ  OBJ(OML300D) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)
             MONMSG     MSGID(CPF2130)
             CRTDUPOBJ  OBJ(PLB9CPP) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)
             CRTDUPOBJ  OBJ(PLCGCPP) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)
             CRTDUPOBJ  OBJ(PLCKCPP) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)

             CALL       PGM(*LIBL/PBVUXFR) PARM(''  &DATE &INVOICE)


  /* GET EMAIL ADDRESS TO EMAIL FILES TO                              */
             CALL       PGM(PBWZXFR) PARM(&RETRN 'M3INVEMAIL' &EMAILTO)

  /* CREATE PLCGCPP RECORDS - ONE BATCH FOR EACH TYPE                      */

 BUILDIT:
IN:          CHGVAR     VAR(&KEYVALUE) VALUE('               ')
             CALL       PGM(M3OPNSTG) PARM('' 'OR' 'C' &KEYVALUE)
             IF COND(&KEYVALUE *GT  ' ') THEN(DO)
             EXECUTE    VIEW(AR_INVOICE) +
                          TOSTMF('/TMP/AR_INV.txt') REPLACE(*YES) +
                          RECIPIENT(&EMAILTO) SETVAR((&KEYVALUE +
                          &KEYVALUE))
             ENDDO

CM:          CALL       PGM(M3OPNSTG) PARM('' 'CM' 'C' &KEYVALUE)
             IF COND(&KEYVALUE *GT  ' ') THEN(DO)
             EXECUTE    VIEW(AR_INVOICE) RECIPIENT(&EMAILTO) +
                          TOSTMF('/TMP/AR_CM.txt') REPLACE(*YES) +
                          SETVAR((&KEYVALUE &KEYVALUE))
             ENDDO

DM:          CALL       PGM(M3OPNSTG) PARM('' 'DM' 'C' &KEYVALUE)
             IF COND(&KEYVALUE *GT  ' ') THEN(DO)
             EXECUTE    VIEW(AR_INVOICE) RECIPIENT(&EMAILTO) +
                          TOSTMF('/TMP/AR_DM.txt') REPLACE(*YES) +
                          SETVAR((&KEYVALUE &KEYVALUE))
             ENDDO

OA:          CALL       PGM(M3OPNSTG) PARM('' 'OA' 'C' &KEYVALUE)
             IF COND(&KEYVALUE *GT  ' ') THEN(DO)
             EXECUTE    VIEW(AR_INVOICE) RECIPIENT(&EMAILTO) +
                          TOSTMF('/TMP/AR_OA.txt') REPLACE(*YES) +
                          SETVAR((&KEYVALUE &KEYVALUE))
             ENDDO

CB:          CALL       PGM(M3OPNSTG) PARM('' 'CB' 'C' &KEYVALUE)
             IF COND(&KEYVALUE *GT  ' ') THEN(DO)
             EXECUTE    VIEW(AR_INVOICE) RECIPIENT(&EMAILTO) +
                          TOSTMF('/TMP/AR_DN.txt') REPLACE(*YES) +
                         SETVAR((&KEYVALUE &KEYVALUE))
             ENDDO
PMT:         CALL       PGM(M3PAYSTG) PARM('' &KEYVALUE)
             IF COND(&KEYVALUE *GT  ' ') THEN(DO)
             EXECUTE    VIEW(AR_PAYMENT) RECIPIENT(&EMAILTO) +
                          TOSTMF('/TMP/PMT.txt') REPLACE(*YES) +
                         SETVAR((&KEYVALUE &KEYVALUE))
             ENDDO

   /* COPY TO DATA LIBRARY SO WE KNOW WHAT WAS INTERFACED IN THIS RUN      */

             CPYF       FROMFILE(QTEMP/PLCGCPP) +
                          TOFILE(&M3ILIB/PLCGCPP) MBROPT(*ADD)
             MONMSG     MSGID(CPF2817)
             CPYF       FROMFILE(QTEMP/PLB9CPP) +
                          TOFILE(&M3ILIB/PLB9CPP) MBROPT(*ADD)
             MONMSG     MSGID(CPF2817)
             CPYF       FROMFILE(QTEMP/PLB9CPP) +
                          TOFILE(&M3ILIB/PLB9CPP) MBROPT(*ADD)
             MONMSG     MSGID(CPF2817)
             CPYF       FROMFILE(QTEMP/PLCKCPP) +
                          TOFILE(&DMLIB/PLCKCPP) MBROPT(*REPLACE)
             MONMSG     MSGID(CPF2817)

  END:       ENDPGM
