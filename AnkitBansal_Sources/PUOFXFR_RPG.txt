     H/TITLE EXC Historical-mark Pr XF Execute external functio
     H            Y
     Z* CRTRPGPGM
     Z* CVTOPT(*DATETIME)
      *
     H* SYNOPSIS :
     H*  Perform user function
     H*  As defined by action diagram
      *
     H* Generated by CA 2E release 8.6 (1547)
     H* Function type : Execute external function
      *
     H* Company       : OMS Development Model
     H* System        : OMS Development Model
     H* User name     : ISDNGUY
     H* Date          : 02/24/21  Time  : 14:54:14
     H* Copyright     : OMS Development Model
      *
      *================================================================
     M* Maintenance   :
      *================================================================
     FPBCRCPL2IF  E           K        DISK
      * RSQ : TMS Load                  Load/ExtDtTm/Sel Unproc
      *
     FPBCRCPL0UF  E           K        DISK
      * UPD : TMS Load                  Update index
      *
      * Long constants
     E                    @CN#    1  01  6   @CN    25
     I@CRCPX0
      * TMS Load                  Load/ExtDtTm/Sel Unproc
      * Renamed input format fields
     I              CRTMLD                          WATMLD
     I              CRAYD8                          WAAYD8
     I              CRAFTH                          WAAFTH
     I              CRFSU1                          WAFSU1
     I              CRUPAA                          WAUPAA
     I              CRLTMP                          WALTMP
     I              CRDFSC                          WADFSC
     I              CRDGSC                          WADGSC
     I              CRDHSC                          WADHSC
     I              CRDISC                          WADISC
     I              CRDJSC                          WADJSC
     I              CRDKSC                          WADKSC
     I              CRUQAA                          WAUQAA
     I              CRURAA                          WAURAA
     I              CRUSAA                          WAUSAA
     I              CRCRDS                          WACRDS
     I              CRAZD8                          WAAZD8
     I              CRAGTH                          WAAGTH
     I              CRUTAA                          WAUTAA
     I              CRUUAA                          WAUUAA
     I              CRUVAA                          WAUVAA
     I              CRUWAA                          WAUWAA
     I              CRUXAA                          WAUXAA
     I              CRFJU1                          WAFJU1
     I              CRFKU1                          WAFKU1
     I              CRFLU1                          WAFLU1
     I              CRFMU1                          WAFMU1
     I              CRFNU1                          WAFNU1
     I              CRFOU1                          WAFOU1
     I              CRFPU1                          WAFPU1
     I              CRFQU1                          WAFQU1
     I              CRA7D8                          WAA7D8
     I              CRA8D8                          WAA8D8
     I              CRP4U1                          WAP4U1
     I              CRDLSC                          WADLSC
     I              CRTPRC                          WATPRC
     I              CRUYAA                          WAUYAA
     I              CRA0D8                          WAA0D8
     I              CRD9TM                          WAD9TM
      *
     I@CRCPXL
      * TMS Load                  Update index
      * Renamed input format fields
     I              CRTMLD                          WBTMLD
     I              CRAYD8                          WBAYD8
     I              CRAFTH                          WBAFTH
     I              CRFSU1                          WBFSU1
     I              CRUPAA                          WBUPAA
     I              CRLTMP                          WBLTMP
     I              CRDFSC                          WBDFSC
     I              CRDGSC                          WBDGSC
     I              CRDHSC                          WBDHSC
     I              CRDISC                          WBDISC
     I              CRDJSC                          WBDJSC
     I              CRDKSC                          WBDKSC
     I              CRUQAA                          WBUQAA
     I              CRURAA                          WBURAA
     I              CRUSAA                          WBUSAA
     I              CRCRDS                          WBCRDS
     I              CRAZD8                          WBAZD8
     I              CRAGTH                          WBAGTH
     I              CRUTAA                          WBUTAA
     I              CRUUAA                          WBUUAA
     I              CRUVAA                          WBUVAA
     I              CRUWAA                          WBUWAA
     I              CRUXAA                          WBUXAA
     I              CRFJU1                          WBFJU1
     I              CRFKU1                          WBFKU1
     I              CRFLU1                          WBFLU1
     I              CRFMU1                          WBFMU1
     I              CRFNU1                          WBFNU1
     I              CRFOU1                          WBFOU1
     I              CRFPU1                          WBFPU1
     I              CRFQU1                          WBFQU1
     I              CRA7D8                          WBA7D8
     I              CRA8D8                          WBA8D8
     I              CRP4U1                          WBP4U1
     I              CRDLSC                          WBDLSC
     I              CRTPRC                          WBTPRC
     I              CRUYAA                          WBUYAA
     I              CRA0D8                          WBA0D8
     I              CRD9TM                          WBD9TM
      *
      /EJECT
      * Data structures:
     IPGMDS     ESDSY2PGDSP
      * Modified Program data structure
     IJBDTTM      DS
      * Job date/time
     I                                        1   70##JDT
     I                                        1   10##JCC
     I                                        2   30##JYY
     I                                        4   50##JMM
     I                                        6   70##JDD
     I                                        8  130##JTM
     I                                        8   90##JHH
     I                                       10  110##JNN
     I                                       12  130##JSS
     IQPBCR1    E DSPBCRCPL0
      * UPD : TMS Load                  Update index
      * Renamed input format fields
     I              CRTMLD                          WBTMLD
     I              CRAYD8                          WBAYD8
     I              CRAFTH                          WBAFTH
     I              CRFSU1                          WBFSU1
     I              CRUPAA                          WBUPAA
     I              CRLTMP                          WBLTMP
     I              CRDFSC                          WBDFSC
     I              CRDGSC                          WBDGSC
     I              CRDHSC                          WBDHSC
     I              CRDISC                          WBDISC
     I              CRDJSC                          WBDJSC
     I              CRDKSC                          WBDKSC
     I              CRUQAA                          WBUQAA
     I              CRURAA                          WBURAA
     I              CRUSAA                          WBUSAA
     I              CRCRDS                          WBCRDS
     I              CRAZD8                          WBAZD8
     I              CRAGTH                          WBAGTH
     I              CRUTAA                          WBUTAA
     I              CRUUAA                          WBUUAA
     I              CRUVAA                          WBUVAA
     I              CRUWAA                          WBUWAA
     I              CRUXAA                          WBUXAA
     I              CRFJU1                          WBFJU1
     I              CRFKU1                          WBFKU1
     I              CRFLU1                          WBFLU1
     I              CRFMU1                          WBFMU1
     I              CRFNU1                          WBFNU1
     I              CRFOU1                          WBFOU1
     I              CRFPU1                          WBFPU1
     I              CRFQU1                          WBFQU1
     I              CRA7D8                          WBA7D8
     I              CRA8D8                          WBA8D8
     I              CRP4U1                          WBP4U1
     I              CRDLSC                          WBDLSC
     I              CRTPRC                          WBTPRC
     I              CRUYAA                          WBUYAA
     I              CRA0D8                          WBA0D8
     I              CRD9TM                          WBD9TM
      *
     IYARDCS      DS                            610
      * Message data for message Y2U0009.
     IMD0009      DS
     I                                        1  10 MDPGM
     I                                       11  20 MDACP
     I                                       21  30 MDFMT
     I                                       31  34 MDACT
     I                                       35  40 MDLBL
     I            DS
     I                                        1 132 ZAMSDA
      /EJECT
      *****************************************************************
      * Entry parameters
     C           *ENTRY    PLIST
     C                     PARM           P0RTN   7
      *****************************************************************
      * Initialize
     C                     EXSR ZZINIT
      *
      * EXC Historical-mark Pr XF
      * ** Read for extracts with "Historical" in the file name -mark pro
      * Rtv Historical Unpr   RT - TMS Load  * 
     C                     EXSR SARVGN
      *----------------------------------------------------------------
      * Exit program
     C           AAEXIT    TAG
     C                     MOVEL*BLANK    P0RTN
     C                     EXSR ZYEXPG
      *================================================================
      /EJECT
     CSR         SARVGN    BEGSR
      *================================================================
      * Rtv Historical Unpr   RT - TMS Load  * 
      *================================================================
      *
     C                     MOVEL*BLANK    WN0001 15        TMS Load Status
     C                     Z-ADD*ZERO     WN0002  30       TMS Process Sta
     C                     MOVEL*BLANK    WN0003  6        TMS Error Reaso
     C                     Z-ADD*ZERO     WN0004  80       TMS Change Date
     C                     Z-ADD*ZERO     WN0005  60       TMS Change time
     C                     Z-ADD*ZERO     WN0006  70       Load ID
     C                     Z-ADD*ZERO     WN0007  30       Company Number
     C                     Z-ADD*ZERO     WN0008  70       Scheduled Ship
     C                     MOVEL*BLANK    WN0009  1        Load Status
     C                     Z-ADD*ZERO     WN0010  52       Reefer Temperat
     C                     Z-ADD*ZERO     WN0011  70       Total Load Orde
     C                     Z-ADD*ZERO     WN0012  50       Total Stops
     C                     MOVEL*BLANK    WN0013 20        Trailer Id
     C                     MOVEL*BLANK    WN0014  3        Carrier Code
     C                     Z-ADD*ZERO     WN0015 112       Rated Freight
     C                     MOVEL*BLANK    WN0016  1        Ship Status
     C                     MOVEL*BLANK    WN0017  1        Load Type
     C                     Z-ADD*ZERO     WN0018  52       Product Tempera
     C                     MOVEL*BLANK    WN0019  2        Shipping Method
     C                     MOVEL*BLANK    WN0020  3        Ship From Wareh
     C                     MOVEL*BLANK    WN0021  2        Ship To State C
     C                     Z-ADD*ZERO     WN0022  70       Gross Weight
     C                     MOVEL*BLANK    WN0023  3        Carrier Broker
     C                     MOVEL*BLANK    WN0024  1        Export Status
     C                     MOVEL*BLANK    WN0025  1        LH Carrier Paym
     C                     Z-ADD*ZERO     WN0026  70       Requested Deliv
     C                     Z-ADD*ZERO     WN0027  70       Deadline Depart
     C                     Z-ADD*ZERO     WN0028  60       Deadline Depart
     C                     MOVEL*BLANK    WN0029  1        Load Shag Flag
     C                     MOVEL*BLANK    WN0030  1        Load Wash Flag
     C                     MOVEL*BLANK    WN0031 25        Shipping Temp C
     C                     MOVEL*BLANK    WN0032  1        Multi Company L
     C                     Z-ADD*ZERO     WN0033  70       LPT Load Plan S
     C                     Z-ADD*ZERO     WN0034  60       LPT Load Plan S
     C                     Z-ADD*ZERO     WN0035  60       Job Time
     C                     MOVEL*BLANK    WN0036 10        User Id
     C                     MOVEL*BLANK    WN0037 10        Job Name
     C                     Z-ADD*ZERO     WN0038  70       Job Date
     C                     MOVEL*BLANK    WN0039  1        Add/Change/Dele
     C                     MOVEL*BLANK    WN0040  1        Status Flag 1
     C                     MOVEL*BLANK    WN0041  1        TMS Extra Leg L
     C                     MOVEL*BLANK    WN0042  1        TONU Process On
     C                     MOVEL*BLANK    WN0043  2        Event Code SavU
     C                     MOVEL*BLANK    WN0044  1        Export Status D
     C                     MOVEL*BLANK    WN0045  1        Status Flag 2
      *
     C                     MOVEL*BLANK    W0RTN   7
      * Establish starting position
     C           *LOVAL    SETLL@CRCPX0                    *
     C                     READ @CRCPX0                  90*
      * Data record not found
     C   90                MOVEL'USR4928' W0RTN   7
     C           *IN90     DOWEQ'0'
      * USER: Process Data record
      * CLC Call Qclscan       UP - /UT User Source  * 
     C                     CALL 'QCLSCAN'              90  CLC Call Qclsca
     C                     PARM WAFSU1    WQ0001256        USR Qclscan fie
     C                     PARM 25        WQ0002  30       USR Qclscan Len
     C                     PARM 1         WQ0003  30       USR Qclscan Sta
     C                     PARM @CN,001   WQ0004256        USR Qclscan Mas
     C                     PARM 10        WQ0005  30       USR Qclscan Mas
     C                     PARM *BLANK    WQ0006  1        USR Qclscan Tra
     C                     PARM '1'       WQ0007  1        USR Qclscan Tri
     C                     PARM *BLANK    WQ0008  1        USR Qclscan Wil
     C           WUY8NB    PARM WUY8NB    WQ0009  30       USR Qclscan Res
      *
     C           *IN90     IFEQ '1'
      * Call to program ended in error
     C                     MOVEL'Y2U0032' W0RTN
     C                     MOVEL*BLANKS   W0CLPG 10
     C                     MOVEL'QCLSCAN' W0CLPG
      * Send message '*Error occured on CALL...'
     C                     MOVEL'Y2U0032' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     MOVELW0CLPG    ZAMSDA           Message data
     C                     EXSR ZASNMS
     C                     SETON                     99    *
     C                     END
      * CASE: WRK.USR Qclscan Result ? is Does contain
     C           WUY8NB    IFGT 0                          *IF
      * Upd rcd as processed or error or no change
      * Chg TMS Load          CH - TMS Load  * 
     C                     EXSR SBCHRC
     C                     END                             *FI
     C                     READ @CRCPX0                  90*
     C                     ENDDO
      *================================================================
     CSR         SAEXIT    ENDSR
      /EJECT
     CSR         SBCHRC    BEGSR
      *================================================================
      * Chg TMS Load          CH - TMS Load  * 
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * Set PGM.*Record Data Changed flag
     C                     MOVE *BLANK    YARDC   1
      *
      * Move key fields to @CRCPXL
     C                     Z-ADDWATMLD    WBTMLD           TMS Load ID
     C                     Z-ADDWAAYD8    WBAYD8           TMS Extract Dat
     C                     Z-ADDWAAFTH    WBAFTH           TMS Extract Tim
     C                     MOVELWAFSU1    WBFSU1    P      TMS Extract Fil
      *
     C           KLCHSB    KLIST
     C                     KFLD           WBTMLD           TMS Load ID
     C                     KFLD           WBAYD8           TMS Extract Dat
     C                     KFLD           WBAFTH           TMS Extract Tim
     C                     KFLD           WBFSU1           TMS Extract Fil
     C           KLCHSB    CHAIN@CRCPXL              9091  *
      *
     C           *IN90     IFEQ '1'
      * Record not found
     C                     MOVEL'Y2U0009' W0RTN   7
     C                     MOVEL##PGM     MDPGM
     C                     MOVEL'PBCRCPL0'MDACP
     C                     MOVEL'@CRCPXL' MDFMT
     C                     MOVEL'*CHG'    MDACT
      * Record not found label: LBL001.
     C                     MOVEL'LBL001'  MDLBL
      * Send message '*Record no longer on file'
     C                     MOVEL'Y2U0009' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     MOVELMD0009    ZAMSDA           Message data
     C                     EXSR ZASNMS
     C                     MOVEL*BLANKS   MD0009
     C                     GOTO SBEXIT
     C                     ENDIF
      *
     C           *IN91     IFEQ '1'
      * Record locked
     C                     MOVEL'Y2U0004' W0RTN   7
      * Send message '*Database operation error'
     C                     MOVEL'Y2U0004' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     EXSR ZASNMS
     C                     GOTO SBEXIT
     C                     ENDIF
      *
      * Store record data for null update check
     C                     MOVE QPBCR1    YARDCS
      * Move non-key fields to @CRCPXL
     C                     MOVELWAUPAA    WBUPAA    P      TMS Customer Lo
     C                     Z-ADDWALTMP    WBLTMP           TMS Temperature
     C                     MOVELWADFSC    WBDFSC    P      TMS Temperature
     C                     MOVELWADGSC    WBDGSC    P      TMS Movement Ty
     C                     MOVELWADHSC    WBDHSC    P      TMS Shipment Ty
     C                     MOVELWADISC    WBDISC    P      TMS Payment Met
     C                     MOVELWADJSC    WBDJSC    P      TMS POD Receive
     C                     MOVELWADKSC    WBDKSC    P      TMS Load Status
     C                     MOVELWAUQAA    WBUQAA    P      TMS Load Owner
     C                     MOVELWAURAA    WBURAA    P      TMS Carrier SCA
     C                     MOVELWAUSAA    WBUSAA    P      TMS Carrier Mod
     C                     Z-ADDWACRDS    WBCRDS           TMS Carrier Dis
     C                     Z-ADDWAAZD8    WBAZD8           TMS Deadline De
     C                     Z-ADDWAAGTH    WBAGTH           TMS Deadline De
     C                     MOVELWAUTAA    WBUTAA    P      TMS Trailer Num
     C                     MOVELWAUUAA    WBUUAA    P      TMS Container N
     C                     MOVELWAUVAA    WBUVAA    P      TMS Move Type
     C                     MOVELWAUWAA    WBUWAA    P      TMS Vessel Name
     C                     MOVELWAUXAA    WBUXAA    P      TMS Voyage Numb
     C                     MOVELWAFJU1    WBFJU1    P      TMS Booking Num
     C                     MOVELWAFKU1    WBFKU1    P      TMS OTR Destina
     C                     MOVELWAFLU1    WBFLU1    P      TMS OTR Destina
     C                     MOVELWAFMU1    WBFMU1    P      TMS OTR Destina
     C                     MOVELWAFNU1    WBFNU1    P      TMS OTR Destina
     C                     MOVELWAFOU1    WBFOU1    P      TMS OTR Destina
     C                     MOVELWAFPU1    WBFPU1    P      TMS OTR Destina
     C                     MOVELWAFQU1    WBFQU1    P      TMS OTR Destina
     C                     Z-ADDWAA7D8    WBA7D8           TMS Vessel ETD
     C                     Z-ADDWAA8D8    WBA8D8           TMS Vessel ETA
     C                     MOVELWAP4U1    WBP4U1    P      TMS Carrier Ref
     C                     MOVELWADLSC    WBDLSC    P      TMS Record Stat
     C                     Z-ADD1         WBTPRC           TMS Process Sta
     C                     MOVELWN0003    WBUYAA    P      TMS Error Reaso
     C                     Z-ADD##JDT     WBA0D8           TMS Change Date
     C                     Z-ADD##JTM     WBD9TM           TMS Change time
      *
      * Set PGM.*Record Data Changed flag
     C           QPBCR1    IFNE YARDCS
     C           YARDC     ANDNE'N'
     C                     MOVE 'Y'       YARDC
     C                     ENDIF
      * USER: Processing before Data update
      * Set TMS Record Stampp IF
     C                     Z-ADD##JTM     WBD9TM           TMS Change time
     C                     Z-ADD##JDT     WBA0D8           TMS Change Date
      * Set PGM.*Record Data Changed flag
     C           QPBCR1    IFNE YARDCS
     C           YARDC     ANDNE'N'
     C                     MOVE 'Y'       YARDC
     C                     ENDIF
      * If changed update record otherwise release record
     C           YARDC     IFEQ 'Y'
     C                     UPDAT@CRCPXL                91  *
     C                     ELSE
      * Release record lock
     C                     UNLCKPBCRCPL0               91  *
     C                     ENDIF
     C           *IN91     IFEQ '1'
      * Change error detected
     C                     MOVEL'Y2U0004' W0RTN   7
     C                     ELSE
      *
      * DBF change successful
     C                     ENDIF
      *================================================================
     CSR         SBEXIT    ENDSR
      /EJECT
     CSR         ZASNMS    BEGSR
      *================================================================
      * Send message to program's message queue
      *================================================================
     C           ZAPGMQ    IFEQ *BLANK
     C                     MOVEL##PGM     ZAPGMQ
     C                     END
     C                     CALL 'Y2SNMGC'
     C                     PARM           ZAPGMQ 10        Program queue
     C                     PARM           ZAPGRL  5        Rel queue
     C                     PARM           ZAMSID  7        Message ID
     C                     PARM           ZAMSGF 10        Message file
     C                     PARM           ZAMSDA           Message data
     C                     PARM           ZAMSTP  7        Message type
      * Clear all fields for default mechanism next time
     C                     MOVEL*BLANK    ZAPGMQ
     C                     MOVEL*BLANK    ZAPGRL
     C                     MOVEL*BLANK    ZAMSID
     C                     MOVEL*BLANK    ZAMSGF
     C                     MOVEL*BLANK    ZAMSDA
     C                     MOVEL*BLANK    ZAMSTP
      *================================================================
     CSR         ZAEXIT    ENDSR
      /EJECT
     CSR         ZXEXPG    BEGSR
      *================================================================
      * Exit program: Normal
      *================================================================
     C                     EXSR ZYEXPG
      *================================================================
     CSR         ZXEXIT    ENDSR
      /EJECT
     CSR         ZYEXPG    BEGSR
      *================================================================
      * Exit program: Direct
      *================================================================
      * Terminate program
     C                     SETON                     LR
      *
      * Exit program
     C                     RETRN
      *
      *================================================================
     CSR         ZYEXIT    ENDSR
      /EJECT
     CSR         ZZINIT    BEGSR
      *================================================================
      * Initialisation
      *================================================================
     C           W0ICL     IFEQ *BLANK
     C                     MOVEL'Y'       W0ICL   1        *Initial call
     C                     ELSE
     C                     MOVEL'N'       W0ICL
     C                     END
     C                     MOVE *BLANK    P0RTN
     C                     MOVE *BLANK    W0RTN   7
     C                     MOVEL*BLANK    W0RSL   1
     C                     MOVEL*BLANK    W0RSF   1
     C                     MOVEL*ZEROS    W0RTW   90
     C                     MOVEL'400'     W0ENV   3
      * Retrieve job attributes
     C                     CALL 'Y2RTJCR'
     C                     PARM           PGMDS
      * Setup job date/time
     C                     Z-ADD##SD7     ##JDT
     C                     TIME           ##JTM
      * Update screen time
     C                     TIME           ##TME   60
      * Initialize renamed input format fields
     C                     Z-ADD*ZERO     WATMLD           TMS Load ID
     C                     Z-ADD*ZERO     WAAYD8           TMS Extract Dat
     C                     Z-ADD*ZERO     WAAFTH           TMS Extract Tim
     C                     Z-ADD*ZERO     WALTMP           TMS Temperature
     C                     Z-ADD*ZERO     WACRDS           TMS Carrier Dis
     C                     Z-ADD*ZERO     WAAZD8           TMS Deadline De
     C                     Z-ADD*ZERO     WAAGTH           TMS Deadline De
     C                     Z-ADD*ZERO     WAA7D8           TMS Vessel ETD
     C                     Z-ADD*ZERO     WAA8D8           TMS Vessel ETA
     C                     Z-ADD*ZERO     WATPRC           TMS Process Sta
     C                     Z-ADD*ZERO     WAA0D8           TMS Change Date
     C                     Z-ADD*ZERO     WAD9TM           TMS Change time
      * Define work field USR Qclscan Result ?
     C                     Z-ADD*ZERO     WUY8NB  30
      * Dummy move for compiler
     C                     MOVE '0'       @CN#,1
     C                     MOVEL'N'       W0PMT   1
      *================================================================
     CSR         ZZEXIT    ENDSR
** @CN
00001 Historical
