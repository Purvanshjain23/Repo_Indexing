/********************************************************************/
/*  SYSTEM:     ORDER MANAGEMENT SYSTEM                             */
/*  PROGRAM:    PON0UPC                                             */
/*  TITLE:      LATE BILLINGS EMAIL DRIVER CL                       */
/*  PROGRAMMER: ROSE CENTONZE                                       */
/*  DATE:       11/05/01                                            */
/*                                                                  */
/*  SYNOPSIS:                                                       */
/*              WE PLAN TO KICK THIS OFF THE JOB SCHEDULER EVERY    */
/*              30 MINUTES - ALL WEEK.                              */
/*                                                                  */
/*              IT WILL PROCESS THE LOAD HEADER CHECKING FOR        */
/*              LOADS FINISHED BUT NOT BILLED WITHIN 45 MINUTES OF  */
/*              FINISHING.                                          */
/*                                                                  */
/*              THE MESSAGE WILL BE SENT TO THE SHIPPING MGR AND    */
/*              BILLING CLERKS USING MESSENGER PLUS DISTRIBUTION    */
/*              LIST "PRKNOTBLLD"                                   */
/*                                                                  */
/*  NOTE:                                                           */
/*              YOU HAVE TO HAVE THE LIBRARY ESEND IN YOUR LIBRARY  */
/*              LIST TO COMPILE THIS CL.                            */
/********************************************************************/
/* RMC 11/29/05 ALSO SELECT WAREHOUSE 'SJ1'                         */
/* PIO 07/17/23 REPLACE OPNQRYF WITH OPNSQLF FOR OMFJCPP FILE       */
/*              ADDED NEEDED OVRDBF AROUND THE COMMAND.             */
/*              CHANGE *AND TO AND, *EQ TO =, *GE TO >=, *LE TO <=, */
/*              *GT TO > IN &QDATA                                  */
/********************************************************************/

             PGM

             DCL        VAR(&QDATA)  TYPE(*CHAR) LEN(168)
             DCL        VAR(&ALREADY) TYPE(*CHAR) LEN(1)

  /*         DCL        VAR(&ENDTIME) TYPE(*DEC) LEN(6 0)     +
             DCL        VAR(&TIME) TYPE(*DEC) LEN(6 0)        +
             DCL        VAR(&QTM) TYPE(*CHAR) LEN(6)         */


 /******************************************************************/
 /* DO ONE TIME WHEN THE JOB FIRST KICKS OFF FROM THE SCHEDULER    */
 /******************************************************************/

/* ADD ESEND LIBRARY TO LIBRARY LIST                                 */

             CHGVAR     VAR(&ALREADY) VALUE('N')
             ADDLIBLE   LIB(ESEND) POSITION(*LAST)
             MONMSG     MSGID(CPF2103) EXEC(DO) /* already in libl */
             CHGVAR     VAR(&ALREADY) VALUE('Y')
             ENDDO



 /******************************************************************/
 /* THE FOLLOWING LOGIC IS REPEATED EVERY 30 MINUTES UNTIL THE END  */
 /******************************************************************/

 REPEAT:

/*-------------------------------------------------------------------*/
/* SETUP QUERY FOR LOAD HEADER                                       */
/*-------------------------------------------------------------------*/

 /* EXTRACT LOAD HEADER RECORDS THAT MEET THE FOLLOWING CRITERIA:     */
 /*     1) LOAD FINISHED DATE IS ENTERED                              */
 /*     2) BOL COMPLETE DATE = ZERO                                   */
 /*     3) SHIP FROM WAREHOUSE IS GP1                                 */
 /*     3) LOAD STATUS IS PRIOR TO SHIP (C/E/L/U)                     */


/* ONLY SELECT RECORDS WHERE THE LOAD FINISHED DATE IS ENTERED       */

  /*PIO      CHGVAR     VAR(%SST(&QDATA 1 10)) VALUE('FJJ6DT + +
                          *GT')                               */
  /*PIO*/    CHGVAR     VAR(%SST(&QDATA 1 10)) VALUE('FJJ6DT +
                           > ')
             CHGVAR     VAR(%SST(&QDATA 12 1)) VALUE(0)


/* ONLY SELECT RECORDS WHERE THE BOL COMPLETED DATE IS ZERO          */

  /*PIO      CHGVAR     VAR(%SST(&QDATA 15 15)) VALUE('*AND FJJ7DT + +
                          *EQ')                                    */
  /*PIO*/    CHGVAR     VAR(%SST(&QDATA 15 15)) VALUE(' AND FJJ7DT +
                           = ')
             CHGVAR     VAR(%SST(&QDATA 31 1)) VALUE(0)


/* ONLY SELECT RECORDS WHERE THE LOAD STATUS IS C/E/L/U (NOT I/S)    */

   /*PIO   CHGVAR     VAR(%SST(&QDATA 33 19)) VALUE('*AND FJPKST + +
                       *NE "I"')                                  */
   /*PIO*/   CHGVAR     VAR(%SST(&QDATA 33 19)) VALUE(' AND FJPKST +
                        <> "I"')

   /*PIO     CHGVAR     VAR(%SST(&QDATA 53 19)) VALUE('*AND FJPKST + +
                       *NE "S"')                                   */
   /*PIO*/   CHGVAR     VAR(%SST(&QDATA 53 19)) VALUE(' AND FJPKST +
                        <> "S"')

/* ONLY SELECT RECORDS WHERE THE SHIP FROM WAREHOUSE IS GP1 OR SJ1  */

  /*PIO      CHGVAR     VAR(%SST(&QDATA 74 16)) VALUE('*AND (FJVPCD + +
                         *EQ')                                       */
  /*PIO*/    CHGVAR     VAR(%SST(&QDATA 74 16)) VALUE(' AND (FJVPCD +
                          = ')
             CHGVAR     VAR(%SST(&QDATA  91 05)) VALUE('"GP1"')
  /*PIO      CHGVAR     VAR(%SST(&QDATA 97 16)) VALUE('*OR FJVPCD +  +
                         *EQ')                                     */
  /*PIO*/    CHGVAR     VAR(%SST(&QDATA 97 16)) VALUE(' OR FJVPCD +
                          = ')
             CHGVAR     VAR(%SST(&QDATA 112 6)) VALUE('"SJ1")')


   /*PIO     OVRDBF     FILE(OMFJCPL0) SHARE(*YES)          +
             OPNQRYF    FILE((OMFJCPL0)) QRYSLT(&QDATA) KEYFLD(*FILE) */

   /*PIO*/   OVRDBF     FILE(OMFJCPP) TOFILE(OMFJCPP) LVLCHK(*NO)
             OPNSQLF    SQL('Select * from OMFJCPP Where  ' *BCAT +
                          &QDATA *BCAT ' ORDER BY FJRMNB ASC') +
                          OPNID(OMFJCPL0) OPTION(*ALL) SEQONLY(*NO) +
                          RCDFMT(@FJCPBN) ALWCPY(*IFRQD) /*PIO*/
   /*PIO*/   OVRDBF     FILE(OMFJCPL0) TOFILE(OMFJCPP) LVLCHK(*NO) +
                          OVRSCOPE(*JOB) SHARE(*YES) OPNSCOPE(*JOB)

/*-------------------------------------------------------------------*/
/* CALL RPG PROGRAM TO PROCESS LOAD ID RECORDS AND SEND E-MAILS        */
/*-------------------------------------------------------------------*/

/*           CHGVAR     VAR(&ENDTIME) VALUE(233000)          */
             CALL       PGM(PON1XFR) PARM('')

             CLOF       OPNID(OMFJCPL0)
    /*PIO    DLTOVR     FILE(*ALL)   */
             DLTOVR     FILE(*ALL) LVL(*JOB) /*PIO*/

/*-------------------------------------------------------------------*/
/*  DELAY FOR 30 MINUTES;  THEN, START THE PROCESSING OVER.  STOP       */
/*  PROCESSING AT THE TIME DESIGNATED IN THE COMPANY VALUES FILE.      */
/*  (THIS 'END TIME' IS RETRIEVED/PASSED IN THE RPGLE PROGRAM ABOVE.   */
/*-------------------------------------------------------------------*/

 /*          RTVSYSVAL  SYSVAL(QTIME) RTNVAR(&QTM)          +
             CHGVAR     VAR(&TIME) VALUE(&QTM)              +
             IF         COND(&TIME *GE &ENDTIME) THEN(DO)   +
             GOTO       CMDLBL(END)                        +
             ENDDO                                        */

   /*        DLYJOB     DLY(1800)     Seconds    +
             GOTO       CMDLBL(REPEAT)           */

 /******************************************************************/
/*  END OF JOB PROCESSING                                          */
 /******************************************************************/

 END:

/* REMOVE ESEND LIBRARY FROM LIBRARY LIST */

             IF         COND(&ALREADY *EQ 'N') THEN(DO)
             RMVLIBLE   LIB(ESEND)
             ENDDO

             ENDPGM

