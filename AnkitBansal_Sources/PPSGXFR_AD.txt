// ?------------------------------------------------------------------------------------------------
// ?Synon action diagram for PPSGXFR
// ?Date: 14.08.2025 Time: 03:41:44
// ?------------------------------------------------------------------------------------------------

//?Execute user function

//?Modification Log
DO;

//?PIO 03/06/24 CHANGED FILE NAME FROM OPBGWKMI TO OPBGWKMP
ENDDO;

EXECUTE FUNCTION(Vry Mix Exempt-Cust   RT) TYPE(RTVOBJ) FILE(OPBGWKP)           AC1748764;
PARAMETER(PAR.Ship_To_Customer);
PARAMETER(*YES);
PARAMETER(PAR.Error_Ordtl_TFExp_Usr);
PARAMETER(PAR.Customer_TF_Exempt_Code);
{
 //?USER: Initialize routine

 // LCL.WFO Sequence = CON.*ZERO
 LCL.WFO_Sequence = 0;

 // LCL.WFO Record Error/Ok = CND.*blanks
 LCL.WFO_Record_Error_Ok = *BLANK;

 // PAR.Error Ordtl TFExp Usr = CND.*blanks
 PAR.Error_Ordtl_TFExp_Usr = *BLANK;

 //?USER: Process Data record

 // LCL.WFO Record Error/Ok = CND.*blanks
 LCL.WFO_Record_Error_Ok = *BLANK;

 EXECUTE FUNCTION(RTV Bill Type, Event   RT) TYPE(RTVOBJ) FILE(OPBFCPP)          AC1366339;
 PARAMETER(DB1.Company_Number);
 PARAMETER(DB1.Order_Number);
 PARAMETER(LCL.Event_Code);
 PARAMETER(LCL.Billing_Activity_Type);
 {
  //?USER: Processing if Data record not found

  // PGM.*Return code = CND.*Record does not exist
  PGM.*Return_code = 'Y2U0005';

  //?USER: Process Data record

  MOVE *ALL (To: PAR From: DB1);

 }

 CASE;

 // IF LCL.Billing Activity Type is Not Credit Memo
 IF LCL.Billing_Activity_Type = '3'/'1'/'5'/'4';

 CASE;

 // IF PAR.Customer TF Exempt Code is Exempt Customer
 IF PAR.Customer_TF_Exempt_Code = 'EC';

 //?Going to a Mixed Customer and anything is allowed.
 //?This could be a first time customer, or this cusomter is going
 //?to a mixed
 // LCL.WFO Record Error/Ok = CND.*blanks
 LCL.WFO_Record_Error_Ok = *BLANK;

 // IF *OTHERWISE
 IF *OTHERWISE;

 //?Was a Mixed and going to Not Mixed
 //?Read the Order detail file by Order number and see what the
 //?     current item's TF Exempt are on the Order Detail.
 //?     if there are more then one Item on the Order Detail
 //?     and if the TF for this customer is = to NE
 //?     then the TF for this order must be a NE or EP NOT BOTH
 //?THIS IS WHERE SUSAN IS sleeping
 // LCL.WFO Record Error/Ok = CND.*blanks
 LCL.WFO_Record_Error_Ok = *BLANK;

 EXECUTE FUNCTION(Vry OrdDtl/AllTF-Cust RT) TYPE(RTVOBJ) FILE(OPBGWKP)           AC1749064;
 PARAMETER(DB1.Order_Number);
 PARAMETER(LCL.WFO_Record_Error_Ok);
 PARAMETER(PAR.Customer_TF_Exempt_Code);
 {
  //?USER: Initialize routine

  // PAR.WFO Record Error/Ok = CND.*blanks
  PAR.WFO_Record_Error_Ok = *BLANK;

  // LCL.More TF-Exempt = LCL.More TF-Exempt + CON.*ZERO
  LCL.More_TF_Exempt = LCL.More_TF_Exempt + *ZERO;

  // WRK.Ord TF Exempt Code Sv1 = WRK.BLANK
  WRK.Ord_TF_Exempt_Code_Sv1 = WRK.BLANK;

  // WRK.Ord TF Exempt Code Sv2 = WRK.BLANK
  WRK.Ord_TF_Exempt_Code_Sv2 = WRK.BLANK;

  //?USER: Process Data record

  EXECUTE FUNCTION(RTV Bill Type, Event   RT) TYPE(RTVOBJ) FILE(OPBFCPP)          AC1366339;
  PARAMETER(DB1.Company_Number);
  PARAMETER(DB1.Order_Number);
  PARAMETER(LCL.Event_Code);
  PARAMETER(LCL.Billing_Activity_Type);
  {
   //?USER: Processing if Data record not found

   // PGM.*Return code = CND.*Record does not exist
   PGM.*Return_code = 'Y2U0005';

   //?USER: Process Data record

   MOVE *ALL (To: PAR From: DB1);

  }

  //?ONLY ON NON CREDIT MEMO
  CASE;

  // IF LCL.Billing Activity Type is Not Credit Memo
  IF LCL.Billing_Activity_Type = '3'/'1'/'5'/'4';

  CASE;

  // IF DB1.Ord TF Exempt Code is Exempt Customer
  IF DB1.Ord_TF_Exempt_Code = 'EC';

  // WRK.Ord TF Exempt Code = CND.Not Exempt
  WRK.Ord_TF_Exempt_Code = 'NE';

  // WRK.Ord TF Exempt Code Sv1 = WRK.Ord TF Exempt Code
  WRK.Ord_TF_Exempt_Code_Sv1 = WRK.Ord_TF_Exempt_Code;

  // IF *OTHERWISE
  IF *OTHERWISE;

  // WRK.Ord TF Exempt Code = DB1.Ord TF Exempt Code
  WRK.Ord_TF_Exempt_Code = DB1.Ord_TF_Exempt_Code;

  // WRK.Ord TF Exempt Code Sv2 = WRK.Ord TF Exempt Code
  WRK.Ord_TF_Exempt_Code_Sv2 = WRK.Ord_TF_Exempt_Code;

  ENDIF;

  CASE;

  // IF WRK.Ord TF Exempt Code Sv1 NE WRK.BLANK
  IF WRK.Ord_TF_Exempt_Code_Sv1 <> WRK.BLANK;

  // AND WRK.Ord TF Exempt Code Sv2 NE WRK.BLANK
  AND WRK.Ord_TF_Exempt_Code_Sv2 <> WRK.BLANK;

  // PAR.WFO Record Error/Ok = CND.Error
  PAR.WFO_Record_Error_Ok = 'E';

  // IF *OTHERWISE
  IF *OTHERWISE;

  // PAR.WFO Record Error/Ok = CND.*blanks
  PAR.WFO_Record_Error_Ok = *BLANK;

  ENDIF;

  ENDIF;

 }

 ENDIF;

 CASE;

 // IF PAR.Crt WFO Exempt File Usr is *YES
 IF PAR.Crt_WFO_Exempt_File_Usr = *YES;

 // LCL.WFO Customer Exempt = PAR.Customer TF Exempt Code
 LCL.WFO_Customer_Exempt = PAR.Customer_TF_Exempt_Code;

 // LCL.WFO Item Prv Exempt = DB1.Ord TF Exempt Code
 LCL.WFO_Item_Prv_Exempt = DB1.Ord_TF_Exempt_Code;

 CASE;

 // IF PAR.Customer TF Exempt Code is Exempt Customer
 IF PAR.Customer_TF_Exempt_Code = 'EC';

 // LCL.WFO Item New Exempt = PAR.Customer TF Exempt Code
 LCL.WFO_Item_New_Exempt = PAR.Customer_TF_Exempt_Code;

 // IF *OTHERWISE
 IF *OTHERWISE;

 // LCL.WFO Item New Exempt = DB1.Ord TF Exempt Code
 LCL.WFO_Item_New_Exempt = DB1.Ord_TF_Exempt_Code;

 ENDIF;

 // LCL.WFO Sequence = LCL.WFO Sequence + CON.1
 LCL.WFO_Sequence = LCL.WFO_Sequence + 1;

 EXECUTE FUNCTION(Create WFO Exempt Info) TYPE(CRTOBJ) FILE(PPBXCPP)             AC1748215;
 PARAMETER(JOB.*USER);
 PARAMETER(LCL.WFO_Sequence);
 PARAMETER(DB1.Company_Number);
 PARAMETER(DB1.Order_Number);
 PARAMETER(DB1.Order_Sequence_Number);
 PARAMETER(DB1.Order_Secondary_Line_Seq);
 PARAMETER(DB1.Item_Code);
 PARAMETER(DB1.Ship_To_Customer);
 PARAMETER(LCL.WFO_Customer_Exempt);
 PARAMETER(LCL.WFO_Item_Prv_Exempt);
 PARAMETER(LCL.WFO_Item_New_Exempt);
 PARAMETER(LCL.WFO_Record_Error_Ok);
 CASE;

 // IF LCL.WFO Record Error/Ok is Error
 IF LCL.WFO_Record_Error_Ok = 'E';

 // PAR.Error Ordtl TFExp Usr = CND.Error
 PAR.Error_Ordtl_TFExp_Usr = 'E';

 // IF *OTHERWISE
 IF *OTHERWISE;

 ENDIF;

 ENDIF;

 ENDIF;

}


