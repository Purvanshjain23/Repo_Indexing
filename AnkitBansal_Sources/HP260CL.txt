/***************************************************************** */
/*                                                                 */
/*  SYSTEM:          HOG PRODUCTION SYSTEM                         */
/*  PROGRAM NUMBER:  HP260CL                                       */
/*  PROGRAM NAME:    SAFEDATA: DOWNLOAD FARM SITES AND OPEN GROUPS */
/*  PROGRAMMER:      LEANNE FEDOR                                  */
/*  CREATE DATE:     12/19/00                                      */
/*                                                                 */
/*  FUNCTION:        THIS CL IS SUBMITTED FROM THE AS/400 JOB      */
/*                   SCHEDULER.                                    */
/*                                                                 */
/*******************************************************************/
/*  MODIFIED:                                                      */
/*  PROGRAMMER:      BARB GUTIERREZ    02/16/01                    */
/*                   ADDED FUNCTIONALITY TO FTP TO SAFEDATA        */
/*                   AUTOMATICALLY.                                */
/*  PROGRAMMER:      BARB GUTIERREZ    06/03/21                    */
/*                   TSN602 IBMI MOVE TO THE CLOUD.  ADDED         */
/*                   FUNCTIONALITY TO BE ABLE TO TEST THIS PROCESS.*/
/*                                                                 */
/*                   CURRENTLY EVERYTHING IS SENT TO SAFE DATA IN  */
/*                   A PRODUCTION ENVRIONMENT. THIS WILL ALLOW US  */
/*                   TO SEND TO A TEST FOLDER AT SDI TO TEST       */
/*                   CONNECTIVITY AND VERIFY PERFORMANCE FROM THE  */
/*                   CLOUD PRIOR TO MIGRATING TO THE CLOUD.        */
/*                                                                 */
/*                   DEVOPS # R2091                                */
/*  6/24/22  ERIC LOUCHEZ SDN745 - FTP TO SFTP                       */
/*******************************************************************/

             PGM

/* FTP VARIABLES */

             DCL        VAR(&ALREADY) TYPE(*CHAR) LEN(1)
             DCL        VAR(&DOCUMENT) TYPE(*CHAR) LEN(10)
             DCL        VAR(&PCFILE) TYPE(*CHAR) LEN(32)
             DCL        VAR(&GRPPRFL)  TYPE(*CHAR) LEN(10)
             DCL        VAR(&FIL)  TYPE(*CHAR) LEN(12)     /* 745 */
             DCL        VAR(&MBR)  TYPE(*CHAR) LEN(10)     /* 745 */

/*******************************************************************/
/*  Save the current library list                                  */
/*******************************************************************/

             PSHLIBL35

/*********************************************************************/
/*  Retrieve the user's Group Profile.  Set the library list         */
/*  based on the group profile.                                      */
/*********************************************************************/

             RTVUSRPRF  GRPPRF(&GRPPRFL)

             SELECT
             WHEN       COND(&GRPPRFL = 'SBDPGMR ') THEN(SETLIBL +
                          JOBD(TPMTESTJD))

             OTHERWISE  CMD(SETLIBL JOBD(PRKPRDGUY))

             ENDSELECT

/*-------------------------------------------------------------------*/
/*  CLEAR DOWNLOAD FILES.   THEN BUILD THE DATA                      */
/*-------------------------------------------------------------------*/

             CLRPFM     FILE(HSP259) /* Farm Sites */
             CLRPFM     FILE(HSP260) /* Open Groups */

             CALL       PGM(HP260)

/*-------------------------------------------------------------------*/
/* ADD SEQUEL TO LIBRARY LIST                                        */
/*-------------------------------------------------------------------*/

             ADDLIBLE LIB(SEQUEL) POSITION(*LAST)
             MONMSG     MSGID(CPF2103) EXEC(DO) /* already in libl */
                CHGVAR VAR(&ALREADY) VALUE('Y')
                ENDDO

/*-------------------------------------------------------------------*/
/* CREATE DOCUMENTS AND DOWNLOAD FILES                               */
/*-------------------------------------------------------------------*/

/* HSP259-FARMS */

             EXECUTE    SQL('SELECT * FROM HSP259') MBROPT(*REPLACE) +
                          NBRRCDS(*ALL) TOFLR('GUY.IS') +
                          TODOC('HSP259') PCFMT(*DELIMITED) +
                          REPLACE(*YES) TEXT('FARMS TO SDI') +
                          MSG(*YES) UNIQUEKEY(*NONE) IGNDECERR(*NO)

             CHGVAR     VAR(&DOCUMENT) VALUE('HSP259')
             CHGVAR     VAR(&PCFILE) VALUE('SBFMASTR.CSV')

/* GO AHEAD AND FTP THE FILE TO PORKS FTP SITE (DOWNLOAD.PORK) IN  */
/* CASE WE NEED TO MANUALLY SEND THE FILE TO SAFEDATA.             */

             CALL       PGM(FTPPRKSRVR) PARM(&DOCUMENT &PCFILE)

/* THIS FTP PROGRAM WILL FTP THE FILE DIRECTLY FROM THE AS/400     */

/* 745       CALL       PGM(FTPSDISND) PARM(&DOCUMENT &PCFILE)     */

/* HSP260-GROUPS */


             EXECUTE    SQL('SELECT * FROM HSP260') MBROPT(*REPLACE) +
                          NBRRCDS(*ALL) TOFLR('GUY.IS') +
                          TODOC('HSP260') PCFMT(*DELIMITED) REPLACE(*YES) +
                          TEXT('SDI OPEN GROUPS ') MSG(*YES) +
                          UNIQUEKEY(*NONE) IGNDECERR(*NO)

             CHGVAR     VAR(&DOCUMENT) VALUE('HSP260')
             CHGVAR     VAR(&PCFILE) VALUE('SBGMASTR.CSV')

/* GO AHEAD AND FTP THE FILE TO PORKS FTP SITE (DOWNLOAD.PORK) IN  */
/* CASE WE NEED TO MANUALLY SEND THE FILE TO SAFEDATA.             */

             CALL       PGM(FTPPRKSRVR) PARM(&DOCUMENT &PCFILE)

/* THIS FTP PROGRAM WILL FTP THE FILE DIRECTLY FROM THE AS/400     */

/* 745       CALL       PGM(FTPSDISND) PARM(&DOCUMENT &PCFILE)     */

/*-------------------------------------------------------------------*/
/* REMOVE SEQUEL FROM LIBRARY LIST                                   */
/*-------------------------------------------------------------------*/

             IF         COND(&ALREADY *EQ 'N') THEN(DO)
                RMVLIBLE   LIB(SEQUEL)
             ENDDO

/*********************************************************************/
/*  Restore saved library list in case this CL called interactively  */
/*********************************************************************/
             POPLIBL35

/*-------------------------------------------------------------------*/
/* END PROGRAM                                                       */
/*-------------------------------------------------------------------*/

             ENDPGM

