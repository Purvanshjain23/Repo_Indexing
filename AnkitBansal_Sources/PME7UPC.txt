/********************************************************************/
/*                                                                  */
/*  SYNOPSIS - CAPTURE INVENTORY TRANSACTIONS PER THE DATE/TIME     */
/*             AND ADD TO ISC WORKFILE TO BE DOWNLOADED  */
/*                                                                  */
/*  COMPANY   - SEABOARD COPRORATION                                */
/*  SYSTEM    - ORDER MANAGEMENT                                    */
/*  USER NAME - ROSE CENTONZE                                       */
/*  DATE      - 03/29/07                                            */
/*                                                                  */
/*      PARAMETERS RECEIVED:                                        */
/*          &COMPL      - COMPANY   -- DONT SEL ON COMPANY --        */
/*                        IN ORDER TO GET WHSES WITH DIFF SHP&ACCT COMPANY */
/*          &WHSE       - WAREHOUSE CODE                          */
/*          &FDATEL     - TRANSACTION DATE                        */
/*          &TDATEL     - TRANSACTION DATE                        */
/*          &FTIME      - TRANSACTION TIME =   JOB TIME           */
/*          &TTIME      - TRANSACTION TIME =   JOB TIME           */
/*          &WEEKN      - WEEK ENDING DATE FOR INV STOCK CLOS FIL */
/*          &CMB        - COMBINE WHSE TOTALS IF Y AND WHSE IS BLANK */
/*          &WGTQTY     - EMAIL WEIGHTS (W) OR QTYS (Q) OR BOTH (B)  */
/*          &SELCMP     - CAN THE QRY SELECT ON COMPANY? Y OR N  */
/********************************************************************/
/* RUN FOR MONDAY 6:00 THRU MONDAY 5:59                   */
/********************************************************************/
/* RMC 06/29/07 PASS IN FROM DATE AND TIME FROM CTL FILE  */
/* RMC 04/30/08 USE LF IN TRANS DATE(D) SEQ A LIEU OF OPNQRYF WHICH */
/*              RAN TOO LONG - REPLACE PME8PFR WITH PMULPFR    */
/********************************************************************/

 PME7UPC:    PGM        PARM(&RTN &COMPL &WHSE &FTIME &TTIME &FDATE +
                 &TDATE   &WEEKN &CMB &WGTQTY &SELCMP &EMAIL &EMAIL2)
             DCL        VAR(&RTN) TYPE(*CHAR) LEN(7) /*  RETURN +
                          CODE   */
        DCL    &COMP      *DEC    (3 0)        /*     COMPANY #      */
        DCL    &COMPL     *DEC                  /*    FOR PASSING    */
        DCL    &COMPA     *CHAR   (3)        /*     COMPANY #      */
        DCL    &FDATE     *DEC    (7 0)          /*  TRAN DATE      */
        DCL    &FDATEX    *CHAR   (7)          /*  TRAN DATE      */
        DCL    &TDATE     *DEC    (7 0)          /*  TRAN DATE      */
        DCL    &TDATEX    *CHAR   (7)          /*  TRAN DATE      */
        DCL    &WEEKN     *DEC    (8 0)        /*  ISC WEEK END DATE */
        DCL    &WHSE      *CHAR   (3)          /*  WAREHOUSE      */
        DCL    &CMB       *CHAR   (1)          /*  COMBINE WHSES = Y */
        DCL    &WGTQTY    *CHAR   (1)          /*  DOWNLOAD WGT OR QTY  */
        DCL    &SELCMP    *CHAR   (1)          /*  CAN QRY SEL ON COMPANY */
        DCL    &EMAIL     *CHAR   (50)         /*  EMAIL 1           */
        DCL    &EMAIL2    *CHAR   (50)         /*  EMAIL 2              */
             DCL        VAR(&FTIME) TYPE(*DEC) LEN(6 0)
              /*          VALUE(060000) /*  FROM TIME      */
             DCL        VAR(&TTIME) TYPE(*DEC) LEN(6 0)
             /*           VALUE(055900) /*  THRU TIME      */
             DCL        VAR(&FTIMEX) TYPE(*CHAR) LEN(6) /*  PROD +
                          TIME      */
             DCL        VAR(&TTIMEX) TYPE(*CHAR) LEN(6) /*  PROD +
                          TIME      */
             DCL        &AA         *CHAR    26 /* QRY SELECT-COMPANY    */
             DCL        &WA         *CHAR    26 /* QRY SELECT-WAREHOUSE */
             DCL        &A          *CHAR    26 /* QRY SELECT    */
             DCL        &B          *CHAR    36 /* QRY SELECT    */
             DCL        &U          *CHAR    75  /* QRY SELECT   */
             DCL        &V          *CHAR    75  /* QRY SELECT   */

/* SEND PROGRAM MESSAGE PARAMETERS  */

             /* Internal Fields */

             DCL        VAR(&SEL)  TYPE(*CHAR) LEN(500)

             CHGVAR    VAR(&COMP) VALUE(&COMPL) /* Change to 3,0   */
             CHGVAR    VAR(&COMPA) VALUE(&COMP) /* Change to CHAR  */
             CHGVAR    VAR(&FDATEX) VALUE(&FDATE) /* Change to CHAR  */
             CHGVAR    VAR(&TDATEX) VALUE(&TDATE) /* Change to CHAR  */
             CHGVAR    VAR(&FTIMEX) VALUE(&FTIME) /* Change to CHAR  */
             CHGVAR    VAR(&TTIMEX) VALUE(&TTIME) /* Change to CHAR  */

/* --------------------------------------------------------------------- */
/* --------------------------------------------------------------------- */
/* DONT TO OPNQRY ANY MORE --   RMC 4/30/08 S00215   ----------------- */
/* --------------------------------------------------------------------- */
/* --------------------------------------------------------------------- */
  GOTO SKIPQRY
/* --------------------------------------------------------------------- */
/* --------------------------------------------------------------------- */
 SELCOMP:    IF         COND(&SELCMP *EQ 'Y') THEN(DO)
             CHGVAR     VAR(&AA) VALUE('(B7AIC3 = ' *CAT &COMPA *CAT +
                          ') *AND ')
                ENDDO

SELWHSE:     IF         COND(&WHSE > '   ') THEN(DO)
             CHGVAR     VAR(&WA) VALUE('(B7AJCD = "' *CAT &WHSE +
                          *CAT '") *AND')
             ENDDO

             CHGVAR     VAR(&A) VALUE('((B7B4DT > ' *CAT &FDATEX +
                          *CAT ')')
             CHGVAR     VAR(&U) VALUE('*OR (B7B4DT = ' *CAT &FDATEX +
                          *CAT ' *AND B7AATM >= ' *CAT &FTIMEX *CAT +
                          '))')
             CHGVAR     VAR(&B) VALUE('*AND ((B7B4DT < ' *CAT &TDATEX +
                          *CAT ')')
             CHGVAR     VAR(&V) VALUE('*OR (B7B4DT = ' *CAT &TDATEX +
                          *CAT ' *AND B7AATM <= ' *CAT &TTIMEX *CAT +
                          '))')
  CHGVAR     VAR(&SEL) VALUE(&AA *CAT &WA *CAT &A *CAT &U *CAT &B *CAT &V)

             OVRDBF     FILE(CAB7CPLS) SHARE(*YES)
             OPNQRYF    FILE((*LIBL/CAB7CPLS)) QRYSLT(&SEL) +
                          KEYFLD(*FILE)
/* --------------------------------------------------------------------- */
/* --------------------------------------------------------------------- */
SKIPQRY:
/* --------------------------------------------------------------------- */
/* --------------------------------------------------------------------- */
/* ------------------------ CREATE WORKFILES IN QTEMP  ----------------- */

AGAIN:       CRTDUPOBJL OBJ(PMAKCPP) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)
             MONMSG     MSGID(CPF2130) EXEC(DO)
               DLTF FILE(QTEMP/PMAKC*)
               GOTO AGAIN
               ENDDO
             CRTDUPOBJL OBJ(PMAKCPL0) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)

             CRTDUPOBJL OBJ(PMAKCPL1) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)
 AGAIN2:     CRTDUPOBJL OBJ(PMALCPP) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)
             MONMSG     MSGID(CPF2130) EXEC(DO)
               DLTF FILE(QTEMP/PMALC*)
               GOTO AGAIN2
               ENDDO
             CRTDUPOBJL OBJ(PMALCPL0) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)
             CRTDUPOBJL OBJ(PMALCPL1) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)
/* ------------------------------------------------------------------- */
/*           BUILD WORKFILES  PMALCPP,PKALCPP ----------------------- */
/* ------------------------------------------------------------------- */
  /* OLD PGM THAT USED OPNQRY OVER CAB7CPP -- COMMENTED RMC  4/30/08 */
 /*        CALL PME8PFR ('' &WEEKN &FDATE &TDATE &COMP &WHSE &CMB)   */
/* ------------------------------------------------------------------- */
  /* NEW PGM THAT USES LF ACCESS OVER CAB7CPP --  RMC  4/30/08 */
/* ------------------------------------------------------------------- */
           CALL PMULPFR ('' &TDATE &FDATE &TDATE &WEEKN &COMP &WHSE &CMB +
                             &FTIME &TTIME)

             CALL PMFDPFR ('' &WEEKN &COMP &WHSE &CMB) /* CREATE SUMMARY WF */
             CALL PMGZXFR ('' &WEEKN &COMP &WHSE &CMB)  /* CREATE MISSING SUMM*/
/* ------------------------------------------------------------------- */
/* ------------------------------------------------------------------- */
EMAIL:
             EXECUTE    VIEW(*LIBL/ISCTRANDTL) PCFMT(*XLS) +
                          RECIPIENT(&EMAIL) EMLMSG('ISC Transaction +
                          Total Worksheet')
  /* IF WGTQTY IS Q OR B(OTH), THEN RUN THE SQL BY QTY              */
             IF         COND(&WGTQTY *NE 'W') THEN(DO)
             EXECUTE    VIEW(*LIBL/ISCSUMMQTY) PCFMT(*XLS) +
                          RECIPIENT(&EMAIL) EMLMSG('ISC Stock Close +
                          Worksheet-Qty')
                          ENDDO
  /* IF WGTQTY IS W OR B(OTH), THEN RUN THE SQL BY WGT              */
             IF         COND(&WGTQTY *NE 'Q') THEN(DO)
             EXECUTE    VIEW(*LIBL/ISCSUMMWGT) PCFMT(*XLS) +
                          RECIPIENT(&EMAIL) EMLMSG('ISC Stock +
                          Close Worksheet-Wgt')
                          ENDDO

EMAIL2:     IF COND(&EMAIL2 > '   ') THEN(DO)
             EXECUTE    VIEW(*LIBL/ISCTRANDTL) PCFMT(*XLS) +
                          RECIPIENT(&EMAIL2) EMLMSG('ISC Transaction +
                          Total Worksheet')
  /* IF WGTQTY IS Q OR B(OTH), THEN RUN THE SQL BY QTY              */
             IF         COND(&WGTQTY *NE 'W') THEN(DO)
             EXECUTE    VIEW(*LIBL/ISCSUMMQTY) PCFMT(*XLS) +
                          RECIPIENT(&EMAIL2) EMLMSG('ISC Stock Close +
                          Worksheet-Qty')
                          ENDDO
  /* IF WGTQTY IS W OR B(OTH), THEN RUN THE SQL BY WGT              */
             IF         COND(&WGTQTY *NE 'Q') THEN(DO)
             EXECUTE    VIEW(*LIBL/ISCSUMMWGT) PCFMT(*XLS) +
                          RECIPIENT(&EMAIL2) EMLMSG('ISC Stock +
                          Close Worksheet-Wgt')
                          ENDDO
                 ENDDO

        /*   DLTOVR     FILE(CAB7CPLS)    COMMENTED RMC 4.30.08   +
             CLOF       OPNID(CAB7CPLS)           */
             DLTSPLF    FILE(PMULPFR$)
 END:        ENDPGM
