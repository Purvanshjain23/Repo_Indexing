/***************************************************************** */
/*                                                                 */
/*  SYSTEM:          TRIUMPH FOODS                                 */
/*  PROGRAM NUMBER:  TF410CL                                       */
/*  PROGRAM NAME:    WEEKLY REVENUE CLOSE                          */
/*  PROGRAMMER:      LEANNE FEDOR                                  */
/*  CREATE DATE:     09/20/04                                      */
/*                                                                 */
/*  FUNCTION:        WEEKLY REVENUE CLOSE                          */
/*                                                                 */
/*******************************************************************/
/* MODIFIED:                                                       */
/*                                                                 */
/* 05/21/07  LEANNE RAMSEY                                         */
/*           ADDED NEW PROGRAM TO SPLIT CO-OWNED PRODUCTS.         */
/*           ADDED A NEW DATA AREA (DATSTPRD) TO CONTROL E-MAILS.  */
/*                                                                 */
/* 06/03/07  ALICE BROWNFIELD                                      */
/*           REMOVED PROGRAM TO SPLIT CO-OWNED PRODUCTS            */
/*           ADDED REQUIRED CODE TO TF208                          */
/*                                                                 */
/* 08/01/07  LEANNE RAMSEY                                         */
/*           WE NOW GENERATE A LISTING OUT OF TFJDE270. SO,        */
/*           ADDED THIS NEW LISTING TO EMAIL DISTRIBUTION LIST.    */
/*                                                                 */
/* 08/13/07  LEANNE RAMSEY                                         */
/*           CHANGED QUERY LOGIC TO ONLY SELECT FINISHED GOODS     */
/*           FROM THE SALES HISTORY FILE.                          */
/*                                                                 */
/* 01/24/08  LEANNE RAMSEY                                         */
/*           WE ARE MAKING THE 'AR ADJUSTMENT LISTING' ON-DEMAND.  */
/*           SO, WE MUST NOW CALL A CL (TF426CL) INSTEAD OF JUST   */
/*           CALLING THE PRINT PROGRAM.                            */
/*                                                                 */
/* 01/29/08  LEANNE RAMSEY                                         */
/*           WE HAVE ADDED MORE SELECTIONS TO THE AR ADJUSTMENT    */
/*           LISTING. SO, WE ADDED SOME INITIALIZATION FOR         */
/*           THOSE FIELDS IN THE LDA.                              */
/*                                                                 */
/* 05/19/08  LEANNE RAMSEY                                         */
/*           INCREASED THE EXTRACTION DATE RANGE FOR AR ADJUSTMENTS*/
/*           TO 2 WEEKS AND ADDED A CHECK TO INCLUDE ONLY RECORDS  */
/*           WHERE THE NEW "TFS ADJ WEEK-ENDING DATE" IS ZERO.     */
/*           (THIS AFFECTS THE LOGIC FOR PROGRAM TF213).           */
/*                                                                 */
/* 05/30/08  LEANNE RAMSEY                                         */
/*           ACTIVATED THE NEW ADJUSTMENT DATE. WE HAD TO RUN IT   */
/*           FOR 1 WEEK WITH OUR CHANGES OF 05/19/08 BEFORE        */
/*           SWITCHING TO OUR 2-WEEK EXTRACTION DATE RANGE.        */
/*                                                                 */
/* 06/11/08  LEANNE RAMSEY                                         */
/*           THE LISTING GENERATED IN TFJDE270 WAS NOT BEING       */
/*           GENERATED ON HOLD/SAVE...WE THOUGHT IT WAS.  SO,      */
/*           ADDED AN OVERRIDE TO PRINT198 RIGHT IN FRONT OF       */
/*           THE CALL.                                             */
/*                                                                 */
/* 09/12/08  LEANNE RAMSEY                                         */
/*           CLEAR LDA POSITION 349 TO B=BOTH BEFORE CALLING TF611.*/
/*                                                                 */
/* 03/03/09  LEANNE RAMSEY                                         */
/*           Commented out the call to TF431CL-Claim Expense       */
/*           Distribution Report.                                  */
/*                                                                 */
/* 05/11/09  LeAnne Ramsey                                         */
/*           Make Print logic match Meat Costing.                  */
/*                                                                 */
/* 07/20/09  LeAnne Ramsey                                         */
/*           Added logic for Affiliated/Contract Sales (Mexico).   */
/*                                                                 */
/* 09/10/09  LeAnne Ramsey                                         */
/*           Change the LDA for the new selections on TF426CL:     */
/*             1) have zero for the A/R Customer selection         */
/*             2) D=Detail for the report version                  */
/*                                                                 */
/* 09/30/09  ALICE BROWNFIELD                                      */
/*           E00493 - change to include STP's in AR Adj Process   */
/*                                                                 */
/* 10/01/09  LeAnne Ramsey                                         */
/*           Change the LDA for the new selections on TF426CL:     */
/*             1) Blank for the G/L Post Method Code               */
/*             2) Blank for the Payout Code                        */
/*                                                                 */
/* 10/08/09  ALICE BROWNFIELD                                      */
/*           E00493 - change to add automatic post to JDE for      */
/*                    the AR Adjustments                           */
/*                                                                 */
/* 12/09/09  LeAnne Ramsey                                         */
/*           Replaced TFL026A with TFL026B for the TF261 logic.    */
/*                                                                 */
/* 01/06/11  LeAnne Ramsey                                         */
/*           Before the call to TF612-Claims Adjustment Listing,   */
/*           populate position 109 of the LDA with the new         */
/*           Include/Exclude/Only print flag for claims for        */
/*           Affiliated Sales Customers.                           */
/*                                                                 */
/* 01/06/11  PURVA DROGE                                           */
/*           ADDED CALL TO CAPTURE 3RD PARTY AVERAGE PRICE FOR     */
/*           PRIOR WEEK - CALL PBQOXFR                             */
/*                                                                 */
/* 08/17/16  Danny Nguyen - E6917                                  */
/*           Change Open Query selection criteria to exclude       */
/*           Adjustment Type Code='RB' (Rebill) before calling     */
/*           TF213. This will prevent 'RB' records being created   */
/*           in the AR Adjustments (TFP026) file.                  */
/*           Change &QDATA length from 180 to 200.                 */
/*                                                                 */
/* 01/06/17  Brad Baden - E8287                                    */
/*           Added parameters to determine if plants 360, 362,     */
/*           368, and 960 are live for M3.                         */
/*                                                                 */
/* 02/24/17  Danny Nguyen - R9083                                  */
/*           Added selection of Company 360/960 to open query logic*/
/*           to OPBFCPMB file before calling TF207.                */
/*                                                                 */
/* 03/22/17  Brad Baden - R9717                                    */
/*           Added selection of Company 360/960 to open query logic*/
/*           to OMHSTPMH file before calling PNKNUPC.              */
/* 06/29/17  R CENTONZE               R10999                       */
/*           EMAIL PWA3PFR TO DIST LIST                           */
/*                                                                 */
/* 11/13/17  Danny Nguyen  R12011A-Weekly Product Revenue          */
/*           File TFP010 was changed. 25 STF fields added.         */
/*           File TFP022 was changed. Added 2 fields:              */
/*             CLXRPPC  - STF RESPONSIBILITY %                     */
/*             CLXNCLAM - STF NET CLAIM AMT                        */
/*           Modified open query to select company 440 for TFP022  */
/*           processing.                                           */
/*           Add call to print TF6110 (Revenue: Weekly Product     */
/*           Revenue Report - ALL) which includes STF data.        */
/*                                                                 */
/* 02/14/18  R CENTONZE               S12308                       */
/*           1. added TF2130 to write 440 adj to tfp026. scan START440  */
/*              TF426CL Prints a new report for 440  --> TF6260     */
/*           2. added print of TF661 AR Adjustment Report by G/L Post Account */
/*              by call TF461CL - and email to dist list. scan TF461cl. */
/*              tf661 was not printing from here.                  */
/*           3. TF261 - ALLOW  440 Adjustments to go to tfp025 from tfp026 */
/*                      WHEN THE PAYOUT AND POST METHOD IS KNOWN -- NOT YET!  */
/*                                                                 */
/* 04/23/21  R CENTONZE               SDN440 M3 -> WHEN LIVE WITH E1 -- */
/*           1. added Creating Run Log Workfile E1B9CPP to qtemp,   */
/*              and in tfjde270,,-272,-273, and call pgm to copy to  */
/*              E1IFLIB  tables                                       */
/*           2. IF E1 IS LIVE OR PARALLEL, CALL TF261E INSTEAD OF TF261 */
/* 07/29/21  3. CHANGE COMPANY 362 TO 320 EVERYPLACE.                  */
/* 11/05/21  4. CHANGE COMPANY 368 TO 359 EVERYPLACE.                  */
/* 11/30/21  5. CHANGED 960.1410 02495224 TO 960.1411 GLID 02690233    */
/* 11/30/21  6. CHANGED 440.1411 ARREG440 TO 440.1411 GLID 02693697    */
/* 04/19/22  7. DONT PRINT/EMAIL PWA3PFR,OR CPYF IF M3 LIVE IS NO : M3LV    */
/* 07/19/23  PIO  REPLACE OPNQRYF WITH OPNSQLF IN OPBFCPP FILE         */
/*                ADDED NEEDED OVRDBF AROUND THE COMMAND               */
/*                CHANGE *AND TO AND, *EQ TO =, *GE TO >=, *LE TO <=   */
/*                *GT TO > IN &QDATA                                   */
/* 07/19/23  PIO  REPLACE OPNQRYF WITH OPNSQLF IN OMHSTPMH FILE        */
/*                ADDED NEEDED OVRDBF AROUND THE COMMAND               */
/*                CHANGE *AND TO AND, *EQ TO =, *GE TO >=, *LE TO <=   */
/*                *GT TO > IN &QDATA                                   */
/* 07/19/23  PIO  REPLACE OPNQRYF WITH OPNSQLF IN OMHSTPO6 FILE        */
/*                ADDED NEEDED OVRDBF AROUND THE COMMAND               */
/*                CHANGE *AND TO AND, *EQ TO =, *GE TO >=, *LE TO <=   */
/*                *GT TO > IN &QDATA                                   */
/* 07/19/23  PIO  REPLACE OPNQRYF WITH OPNSQLF IN OMHSTPL4 FILE        */
/*                ADDED NEEDED OVRDBF AROUND THE COMMAND               */
/*                CHANGE *AND TO AND, *EQ TO =, *GE TO >=, *LE TO <=   */
/*                *GT TO > IN &QDATA                                   */
/* 11/02/23  PIO                                                       */
/*           UNDONE THE CHANGES FOR QPNQRYF FOR ALL FILES EXCEPT       */
/*           PDMKCPP.                                                  */
/* 06/12/24 PIO UNDONE THE CHANGES FOR QPNQRYF FOR ALL FILES EXCEPT    */
/*              PDMKCPP AND ARBECPP FILE                               */
/*******************************************************************/

             PGM

/*E6917      DCL        VAR(&QDATA)      TYPE(*CHAR) LEN(180)      */
/*R9717*/    DCL        VAR(&QDATA)      TYPE(*CHAR) LEN(240)

             DCL        VAR(&OUTQ)       TYPE(*CHAR) LEN(10)
             DCL        VAR(&HOLD)       TYPE(*CHAR) LEN(4)
             DCL        VAR(&SAVE)       TYPE(*CHAR) LEN(4)
             DCL        VAR(&COPY)       TYPE(*DEC)  LEN(1)

             DCL        VAR(&FIRST)      TYPE(*CHAR) LEN(1)
             DCL        VAR(&ERROR)      TYPE(*CHAR) LEN(1)
             DCL        VAR(&EMAIL)      TYPE(*CHAR) LEN(38)
             DCL        VAR(&FREEZEFL)   TYPE(*CHAR) LEN(1)
             DCL        VAR(&TSTPRDFL)   TYPE(*CHAR) LEN(1)

             DCL        VAR(&LDPFCD)     TYPE(*CHAR) LEN(1)
             DCL        VAR(&LDWBDT)     TYPE(*DEC) LEN(8)
             DCL        VAR(&LDWEDT)     TYPE(*DEC) LEN(8)
             DCL        VAR(&LDSYNWBDT)  TYPE(*DEC) LEN(7)
             DCL        VAR(&LDSYNWEDT)  TYPE(*DEC) LEN(7)
             DCL        VAR(&ALPHWEDT)   TYPE(*CHAR) LEN(8)
             DCL        VAR(&ADJWBDT)    TYPE(*DEC)  LEN(7)
             DCL        VAR(&FROMDT)     TYPE(*CHAR) LEN(6)

             DCL        VAR(&M3LV360) TYPE(*CHAR) LEN(1)
             DCL        VAR(&M3LV320) TYPE(*CHAR) LEN(1)
             DCL        VAR(&M3LV359) TYPE(*CHAR) LEN(1)
             DCL        VAR(&M3LV960) TYPE(*CHAR) LEN(1)
  /* sdn440  */
             DCL        VAR(&E1LV360) TYPE(*CHAR) LEN(1)     /* sdn440 */
             DCL        VAR(&SOURCE) TYPE(*CHAR) LEN(25) VALUE('TFS')
             DCL        VAR(&BCHDSC)  TYPE(*CHAR) LEN(25) +
                          VALUE('G/L Journal Entry')
             DCL        VAR(&RECIP)   TYPE(*CHAR) LEN(25)
             DCL        VAR(&SUBJECT) TYPE(*CHAR) LEN(40) VALUE('TFS +
                          Journal Entries to JDE')
             DCL        VAR(&USER) TYPE(*CHAR) LEN(10)
  /* end sdn440  */

             DCL        VAR(&CO360) TYPE(*DEC) LEN(3 0)
             DCL        VAR(&CO320) TYPE(*DEC) LEN(3 0)
             DCL        VAR(&CO359) TYPE(*DEC) LEN(3 0)
             DCL        VAR(&CO960) TYPE(*DEC) LEN(3 0)

             DCL        VAR(&RETRN) TYPE(*CHAR) LEN(7)
             DCL        VAR(&DATAS) TYPE(*CHAR) LEN(10)
             DCL        VAR(&OMSSYSVAL) TYPE(*CHAR) LEN(40) +
                          VALUE('TF Revenue Close ')

/* SET PRINT OVERRIDE DEFAULTS OF HOLD=YES AND SAVE=YES IN THE LDA */

             CHGDTAARA  DTAARA(*LDA (411 4)) VALUE('*YES') /* HOLD */
             CHGDTAARA  DTAARA(*LDA (415 4)) VALUE('*YES') /* SAVE */

             CHGVAR     VAR(&ERROR)     VALUE('N')
             CHGVAR     VAR(&LDWBDT)    VALUE(%SST(*LDA 7 8))
             CHGVAR     VAR(&LDWEDT)    VALUE(%SST(*LDA 22 8))
             CHGVAR     VAR(&LDSYNWBDT) VALUE(%SST(*LDA 15 7))
             CHGVAR     VAR(&LDSYNWEDT) VALUE(%SST(*LDA 30 7))
             CHGVAR     VAR(&LDPFCD)    VALUE(%SST(*LDA 37 1))

/*----------------------------------------------------------------*/
/* FOR SENDING EMAILS:                                            */
/* RETRIEVE DATA AREA THAT LETS US KNOW WHETHER WE ARE IN TEST    */
/* OR PRODUCTION (ALWAYS DEFAULT TO THE "TEST" DISTRIBUTION LIST.)*/
/*----------------------------------------------------------------*/

             CHGVAR     VAR(&EMAIL) VALUE('TF Test')
             RTVDTAARA  DTAARA(DATSTPRD (1 1)) RTNVAR(&TSTPRDFL)
             RTVJOBA    USER(&USER)

/*----------------------------------------------------------------*/
/* RETRIEVE/SET PRINT DEFAULTS                                    */
/*----------------------------------------------------------------*/

 OUTQ:       CHGVAR     VAR(&OUTQ) VALUE(%SST(*LDA 401 10))
             IF         COND(&OUTQ = '          ') THEN(CHGVAR +
                          VAR(&OUTQ) VALUE(*JOB))

 HOLD:       CHGVAR     VAR(&HOLD) VALUE(%SST(*LDA 411 4))

 SAVE:       CHGVAR     VAR(&SAVE) VALUE(%SST(*LDA 415 4))

 COPY:       CHGVAR     VAR(&COPY) VALUE(%SST(*LDA 419 1))
             IF         COND(&COPY = 0) THEN(CHGVAR VAR(&COPY) +
                          VALUE(1))

/*---------------------------------------------------------------------*/
/* Call POMTXFR for all companies to determine which ones a M3 live    */
/*---------------------------------------------------------------------*/

             CHGVAR     VAR(&CO360) VALUE(360)
             CHGVAR     VAR(&CO320) VALUE(320)
             CHGVAR     VAR(&CO359) VALUE(359)
             CHGVAR     VAR(&CO960) VALUE(960)

             CHGVAR     VAR(&RETRN) VALUE('       ')
             CALL       PGM(POMTXFR) PARM(&RETRN &CO360 'M3TFSGL   ' +
                          &M3LV360)

             CHGVAR     VAR(&RETRN) VALUE('       ')
             CALL       PGM(POMTXFR) PARM(&RETRN &CO320 'M3TFSGL   ' +
                          &M3LV320)

             CHGVAR     VAR(&RETRN) VALUE('       ')
             CALL       PGM(POMTXFR) PARM(&RETRN &CO359 'M3TFSGL  ' +
                          &M3LV359)

             CHGVAR     VAR(&RETRN) VALUE('       ')
             CALL       PGM(POMTXFR) PARM(&RETRN &CO960 'M3TFSGL   ' +
                          &M3LV960)

             CHGVAR     VAR(&RETRN) VALUE('       ')
             CALL       PGM(POMTXFR) PARM(&RETRN &CO360 'E1LIVE    ' +
                          &E1LV360)

             CHGVAR     VAR(&RETRN) VALUE('       ')
             CALL       PGM(PBSHXFR) PARM(&RETRN &DATAS)

/*---------------------------------------------------------------------*/
/* ALWAYS DELETE ANY/ALL EXISTING WEEKLY RECORDS FOR THE WEEK          */
/*---------------------------------------------------------------------*/

             CALL       PGM(TF210)

/*---------------------------------------------------------------------*/
/* RUN THE EDIT PROGRAM WITH ERROR LISTING OVER THE ORDER HEADER FILE  */
/*---------------------------------------------------------------------*/

             CHGVAR     VAR(&QDATA) VALUE(' ')

   /*PIO     CHGVAR     VAR(%SST(&QDATA 1 10)) VALUE('BEGNDT *GE')  */
   /*PIO*/   CHGVAR     VAR(%SST(&QDATA 1 10)) VALUE('BEGNDT >= ')
             CHGVAR     VAR(%SST(&QDATA 12 7)) VALUE(&LDSYNWBDT)
   /*PIO     CHGVAR     VAR(%SST(&QDATA 20 15)) VALUE('*AND BEGNDT + +
                          *LE')                                  */
   /*PIO*/   CHGVAR     VAR(%SST(&QDATA 20 15)) VALUE(' AND BEGNDT +
                          <= ')
             CHGVAR     VAR(%SST(&QDATA 36 7)) VALUE(&LDSYNWEDT)

    /*PIO    CHGVAR     VAR(%SST(&QDATA 44 19)) VALUE('*AND BEGWST + +
                          *NE "X"')                                 */
    /*PIO*/  CHGVAR     VAR(%SST(&QDATA 44 19)) VALUE(' AND BEGWST +
                           <> "X"')

  /*PIO      CHGVAR     VAR(%SST(&QDATA 64 20)) VALUE('*AND BEJNCD + +
                          *NE "TR"')                                */
  /*PIO*/    CHGVAR     VAR(%SST(&QDATA 64 20)) VALUE(' AND BEJNCD +
                          <>  "TR"')

 /*R9083 - Added Selection of Company 360/960 */
   /*PIO     CHGVAR     VAR(%SST(&QDATA 85 40)) VALUE('*AND (BEAIC3 + +
                          *EQ 360 *OR BEAIC3 *EQ 960)')          */
   /*PIO*/   CHGVAR     VAR(%SST(&QDATA 85 40)) VALUE(' AND (BEAIC3 +
                           =  360  OR BEAIC3  =  960)')
 /* GOTO SKIPOH    */
   /*PIO     OVRDBF     FILE(OPBFCPMB) SHARE(*YES)       +
             OPNQRYF    FILE((OPBFCPMB)) QRYSLT(&QDATA) KEYFLD(*FILE) + +
                          SEQONLY(*YES)                    */

  /*PIO*/    OVRDBF     FILE(OPBFCPP) TOFILE(OPBFCPP) LVLCHK(*NO)
  /*PIO*/    OPNSQLF    SQL('Select * from OPBFCPP Where  ' *BCAT +
                          &QDATA  *BCAT ' Order by BEC4NB asc, +
                          BEGNDT asc') OPNID(OPBFCPMB) +
                          OPTION(*ALL) SEQONLY(*NO) RCDFMT(@BFCPVC) +
                          ALWCPY(*IFRQD)
  /*PIO*/    OVRDBF     FILE(OPBFCPMB) TOFILE(OPBFCPP) LVLCHK(*NO) +
                        OVRSCOPE(*JOB) SHARE(*YES) OPNSCOPE(*JOB)


             OVRPRTF    FILE(PRINT132) OUTQ(&OUTQ) COPIES(&COPY) +
                          HOLD(&HOLD) SAVE(&SAVE)

             CALL       PGM(TF207) PARM(&ERROR)

             CLOF       OPNID(OPBFCPMB)
   /*PIO     DLTOVR     FILE(*ALL)  */
             DLTOVR     FILE(*ALL) LVL(*JOB) /*PIO*/


/****************************************************************************/
/* IF THERE ARE NO ERRORS:                                                  */
/****************************************************************************/

             IF         COND(&ERROR *EQ 'N') THEN(DO)        /* No Error Do */
/*--------------------------------------------------------------------------*/
/*  Logic for: Sales Accruals for Affiliated Sales (aka: Contract Sales)    */
/*  As of October 2009, we have new special Mexico 3rd Party stuff. So, if  */
/*  this is the FIRST time that the Revenue Close is being run for a Week,  */
/*  call the Synon program to do accrual stuff and update Sales History.    */
/*--------------------------------------------------------------------------*/
/*  Note: An email is sent with the attachment from the Synon program. So,  */
/*  the users will get the email/attachment the first time....even if it is */
/*  a Preliminary run.                                                      */

 SKIPOH:     CHGVAR     VAR(&FIRST) VALUE(' ')
             CALL       PGM(TF260) PARM(&FIRST)
             IF         COND(&FIRST *EQ 'Y') THEN(DO)

 /*R9717 - Added Selection of Company 360/960 */
             CHGVAR     VAR(&QDATA) VALUE(' ')
  /*PIO      CHGVAR     VAR(%SST(&QDATA 1 33)) VALUE('F4AIC3 +  +
                          *EQ 360 *OR F4AIC3 *EQ 960')       */
  /*PIO*/    CHGVAR     VAR(%SST(&QDATA 1 60)) VALUE('(F4AIC3 +
                          = 360  OR F4AIC3 = 960) AND F4JNCD = "OR" ')

   /*PIO     OVRDBF     FILE(OMHSTPMH) SHARE(*YES)   +
             OPNQRYF    FILE((OMHSTPMH)) QRYSLT(&QDATA) KEYFLD(*FILE)  + +
                          SEQONLY(*YES)                       */

    /*PIO*/     OVRDBF     FILE(OMHSTPP) TOFILE(OMHSTPP) LVLCHK(*NO)
    /*PIO*/  OPNSQLF    SQL('Select * from OMHSTPP Where  ' *BCAT +
                          &QDATA  *BCAT ' Order by F4BOCD asc, +
                          F4GNDT asc,  F4BKC7 asc, F4CONB asc, +
                          F4S5NB asc') OPNID(OMHSTPMH) +
                          OPTION(*ALL) SEQONLY(*NO) RCDFMT(@HSTPCN) +
                          ALWCPY(*IFRQD)
   /*PIO*/   OVRDBF     FILE(OMHSTPMH) TOFILE(OMHSTPP) LVLCHK(*NO) +
                        OVRSCOPE(*JOB) SHARE(*YES) OPNSCOPE(*JOB)


             CALL       PGM(PNKNUPC) PARM(&LDSYNWEDT)

             CLOF       OPNID(OMHSTPMH)
   /*PIO     DLTOVR     FILE(*ALL)  */
             DLTOVR     FILE(*ALL) LVL(*JOB) /*PIO*/

/*           CALCULATE 3RD PARTY AVERAGE FOR PRIOR WEEK                So,  */

 /*R9717 - Added Selection of Company 360/960 */
             CHGVAR     VAR(&QDATA) VALUE(' ')
   /*PIO     CHGVAR     VAR(%SST(&QDATA 1 33)) VALUE('F4AIC3 + +
                          *EQ 360 *OR F4AIC3 *EQ 960')        */
   /*PIO*/   CHGVAR     VAR(%SST(&QDATA 1 60)) VALUE('(F4AIC3 +
                           = 360 OR F4AIC3  = 960) AND F4JNCD = "OR"')

    /*PIO    OVRDBF     FILE(OMHSTPO6) SHARE(*YES)  +
             OPNQRYF    FILE((OMHSTPO6)) QRYSLT(&QDATA) KEYFLD(*FILE)  + +
                          SEQONLY(*YES)               */

  /*PIO*/    OVRDBF     FILE(OMHSTPP) TOFILE(OMHSTPP) LVLCHK(*NO)
  /*PIO*/    OPNSQLF    SQL('Select * from OMHSTPP Where  ' *BCAT +
                          &QDATA   *BCAT ' Order by F4S5NB asc, +
                          F4GNDT asc, F4AIC3 asc, F4C4NB asc') +
                          OPNID(OMHSTPO6) OPTION(*ALL) SEQONLY(*NO) +
                          RCDFMT(@HSTPEW) ALWCPY(*IFRQD)
  /*PIO*/  OVRDBF     FILE(OMHSTPO6) TOFILE(OMHSTPP) LVLCHK(*NO) +
                      OVRSCOPE(*JOB) SHARE(*YES) OPNSCOPE(*JOB)


             CALL       PGM(PBQOXFR) PARM(' ')

             CLOF       OPNID(OMHSTPO6)
   /*PIO     DLTOVR     FILE(*ALL)  */
             DLTOVR     FILE(*ALL) LVL(*JOB) /*PIO*/

             ENDDO
/****************************************************************************/
/* SALES                                                                    */
/****************************************************************************/

/*  Extract Sales data; build Revenue records                               */

             CHGVAR     VAR(&QDATA) VALUE(' ')
  /*PIO      CHGVAR     VAR(%SST(&QDATA 1 10)) VALUE('F4GNDT *GE') */
  /*PIO*/    CHGVAR     VAR(%SST(&QDATA 1 10)) VALUE('F4GNDT >= ')
             CHGVAR     VAR(%SST(&QDATA 12 7)) VALUE(&LDSYNWBDT)
  /*PIO      CHGVAR     VAR(%SST(&QDATA 20 15)) VALUE('*AND F4GNDT + +
                          *LE')                                     */
  /*PIO*/    CHGVAR     VAR(%SST(&QDATA 20 15)) VALUE(' AND F4GNDT +
                          <= ')
             CHGVAR     VAR(%SST(&QDATA 36 7)) VALUE(&LDSYNWEDT)

   /*PIO     CHGVAR     VAR(%SST(&QDATA 44 20)) VALUE('*AND F4JNCD + +
                          *EQ "OR"')                                */
   /*PIO*/   CHGVAR     VAR(%SST(&QDATA 44 20)) VALUE(' AND F4JNCD +
                           =  "OR"')

 /*R12011 - Added Selection of Company 440 */
   /*PIO     CHGVAR     VAR(%SST(&QDATA 65 59)) VALUE('*AND (F4AIC3 + +
                          *EQ 360 *OR F4AIC3 *EQ 960 *OR F4AIC3 *EQ + +
                          440)')                                     */
   /*PIO*/   CHGVAR     VAR(%SST(&QDATA 65 59)) VALUE(' AND (F4AIC3 +
                           =  360  OR F4AIC3  =  960  OR F4AIC3  =  +
                          440)')

   /*PIO     CHGVAR     VAR(%SST(&QDATA 125 21)) VALUE('*AND F4N0CD + +
                          *EQ "FG "')                              */
   /*PIO*/   CHGVAR     VAR(%SST(&QDATA 125 21)) VALUE(' AND F4N0CD +
                           =  "FG "')

   /*PIO     OVRDBF     FILE(OMHSTPL4) SHARE(*YES)  +
             OPNQRYF    FILE((OMHSTPL4)) QRYSLT(&QDATA) KEYFLD(F4S5NB F4IUSX) ++
                          SEQONLY(*YES)              */

  /*PIO*/    OVRDBF     FILE(OMHSTPP) TOFILE(OMHSTPP) LVLCHK(*NO)
  /*PIO*/    OPNSQLF    SQL('Select * from OMHSTPP Where  ' *BCAT +
                          &QDATA   *BCAT ' Order by F4S5NB asc , +
                          F4IUSX ASC,F4RMCD asc, F4AIC3 asc, F4T3NB asc') +
                          OPNID(OMHSTPL4) OPTION(*ALL) SEQONLY(*NO) +
                          RCDFMT(@HSTPNO) ALWCPY(*IFRQD)
  /*PIO*/    OVRDBF     FILE(OMHSTPL4) TOFILE(OMHSTPP) LVLCHK(*NO) +
                        OVRSCOPE(*JOB) SHARE(*YES) OPNSCOPE(*JOB)

             CALL       PGM(TF208)

             CLOF       OPNID(OMHSTPL4)
  /*PIO      DLTOVR     FILE(OMHSTPL4)  */
             DLTOVR     FILE(OMHSTPL4) LVL(*JOB) /*PIO*/


/****************************************************************************/
/* CLAIMS                                                                   */
/****************************************************************************/

/* Extract Claims from Claims System; write to TFP022-Claim Adjustments file*/

 /*R9718 - Added Selection of Company 360/960 */
 /*R12011 - Added Selection of Company 440 */
             CHGVAR     VAR(&QDATA) VALUE(' ')
  /*PIO      CHGVAR     VAR(%SST(&QDATA 1 52)) VALUE('MKBIC3 *EQ 360 + +
                          *OR MKBIC3 *EQ 960 *OR MKBIC3 *EQ 440')    */
  /*PIO*/    CHGVAR     VAR(%SST(&QDATA 1 52)) VALUE('MKBIC3  =  360 +
                           OR MKBIC3  =  960  OR MKBIC3  =  440')

  /*PIO      OVRDBF     FILE(PDMKCPL7) SHARE(*NO)       +
             OPNQRYF    FILE((PDMKCPL7)) OPTION(*UPD) QRYSLT(&QDATA) + +
                          KEYFLD(*FILE) SEQONLY(*YES)        */

             OVRDBF     FILE(PDMKCPP) TOFILE(PDMKCPP) LVLCHK(*NO)  /*PIO*/

             OPNSQLF    SQL('SELECT * FROM PDMKCPP WHERE  ' *BCAT +
                          &QDATA *BCAT ' ORDER BY MKP6DT ASC, +
                          MKC0C7 ASC') OPNID(PDMKCPL7) OPTION(*ALL) +
                          SEQONLY(*NO) RCDFMT(@MKCPYD) +
                          ALWCPY(*IFRQD) /*PIO*/
             OVRDBF     FILE(PDMKCPL7) TOFILE(PDMKCPP) LVLCHK(*NO) +
                          OVRSCOPE(*JOB) SHARE(*YES) OPNSCOPE(*JOB) /*PIO*/


             CALL       PGM(TF211)

             CLOF       OPNID(PDMKCPL7)
    /*PIO    DLTOVR     FILE(PDMKCPL7)            */
    /*PIO*/  DLTOVR     FILE(PDMKCPL7) LVL(*JOB)

/* Extract Claims from Sales System; write to TFP022-Claim Adjustments file */

             CHGVAR     VAR(&QDATA) VALUE(' ')
    /*PIO    CHGVAR     VAR(%SST(&QDATA 1 10)) VALUE('F4GNDT *GE') */
    /*PIO*/  CHGVAR     VAR(%SST(&QDATA 1 10)) VALUE('F4GNDT >= ')
             CHGVAR     VAR(%SST(&QDATA 12 7)) VALUE(&LDSYNWBDT)
    /*PIO    CHGVAR     VAR(%SST(&QDATA 20 15)) VALUE('*AND F4GNDT ++
                          *LE')                                   */
    /*PIO*/  CHGVAR     VAR(%SST(&QDATA 20 15)) VALUE(' AND F4GNDT +
                          <= ')
             CHGVAR     VAR(%SST(&QDATA 36 7)) VALUE(&LDSYNWEDT)

    /*PIO    CHGVAR     VAR(%SST(&QDATA 44 20)) VALUE('*AND F4JNCD + +
                          *NE "OR"')                               */
    /*PIO*/  CHGVAR     VAR(%SST(&QDATA 44 20)) VALUE(' AND F4JNCD +
                           <> "OR"')

    /*PIO    CHGVAR     VAR(%SST(&QDATA 65 20)) VALUE('*AND F4JNCD + +
                          *NE "TR"')                               */
    /*PIO*/  CHGVAR     VAR(%SST(&QDATA 65 20)) VALUE(' AND F4JNCD +
                          <>  "TR"')

 /*R12011 - Added Selection of Company 440 */
   /*PIO     CHGVAR     VAR(%SST(&QDATA 86 59)) VALUE('*AND (F4AIC3 + +
                          *EQ 360 *OR F4AIC3 *EQ 960 *OR F4AIC3 *EQ + +
                          440)')                                   */
   /*PIO*/   CHGVAR     VAR(%SST(&QDATA 86 59)) VALUE(' AND (F4AIC3 +
                            = 360  OR F4AIC3  =  960  OR F4AIC3  =  +
                          440)')

   /*PIO     CHGVAR     VAR(%SST(&QDATA 146 17)) VALUE('*AND F4C0C7 ++
                          *EQ 0')                                  */
   /*PIO*/   CHGVAR     VAR(%SST(&QDATA 146 17)) VALUE(' AND F4C0C7 +
                            = 0')

   /*PIO     OVRDBF     FILE(OMHSTPL4) SHARE(*YES)    +
             OPNQRYF    FILE((OMHSTPL4)) QRYSLT(&QDATA) KEYFLD(F4S5NB F4IUSX)++
                          SEQONLY(*YES)                          */

   /*PIO*/    OVRDBF     FILE(OMHSTPP) TOFILE(OMHSTPP) LVLCHK(*NO)
   /*PIO*/    OPNSQLF    SQL('Select * from OMHSTPP Where  ' *BCAT +
                          &QDATA  *BCAT ' Order by F4S5NB asc , +
                          F4IUSX ASC, F4RMCD asc, F4AIC3 asc, F4T3NB asc') +
                          OPNID(OMHSTPL4) OPTION(*ALL) SEQONLY(*NO) +
                          RCDFMT(@HSTPNO) ALWCPY(*IFRQD)
   /*PIO*/  OVRDBF     FILE(OMHSTPL4) TOFILE(OMHSTPP) LVLCHK(*NO) +
                       OVRSCOPE(*JOB) SHARE(*YES) OPNSCOPE(*JOB)

             CALL       PGM(TF205)

             CLOF       OPNID(OMHSTPL4)
    /*PIO    DLTOVR     FILE(OMHSTPL4)  */
             DLTOVR     FILE(OMHSTPL4) LVL(*JOB) /*PIO*/

/*  Update Revenue records with Claims data                                 */

             CALL       PGM(TF212)


/****************************************************************************/
/* AR ADJUSTMENTS and CASH DISTRIBUTION BALANCE  360 AND 960                */
/****************************************************************************/

/* We want to pick up the last 2 weeks for the AR Adjustment extract. So,   */
/* call the generic program that subtracts 7 days from a Synon date...pass  */
/* in the Synon WeekBeginning Date.                                         */

             CALL       PGM(TF820) PARM(&LDSYNWBDT &ADJWBDT)
   /*S12308  comment after fix run!!                             */
  /*         CHGVAR     VAR(&ADJWBDT) VALUE('1171126')           */

/* Extract AR Adjustments from the AR Detail file  */

             CHGVAR     VAR(&QDATA) VALUE(' ')

   /*PIO     CHGVAR     VAR(%SST(&QDATA 1 10)) VALUE('BFDVDT *GE') */
   /*PIO*/   CHGVAR     VAR(%SST(&QDATA 1 10)) VALUE('BFDVDT >= ')
             CHGVAR     VAR(%SST(&QDATA 12 7)) VALUE(&ADJWBDT)
   /*PIO     CHGVAR     VAR(%SST(&QDATA 20 15)) VALUE('*AND BFDVDT + +
                          *LE')                                     */
   /*PIO*/   CHGVAR     VAR(%SST(&QDATA 20 15)) VALUE(' AND BFDVDT +
                          <= ')
             CHGVAR     VAR(%SST(&QDATA 36 7)) VALUE(&LDSYNWEDT)

    /*PIO    CHGVAR     VAR(%SST(&QDATA 44 21)) VALUE('*AND BFA5ST + +
                          *EQ "ADJ"')                               */
    /*PIO*/  CHGVAR     VAR(%SST(&QDATA 44 21)) VALUE(' AND BFA5ST +
                           =  "ADJ"')

   /*PIO     CHGVAR     VAR(%SST(&QDATA 66 19)) VALUE('*AND BFAJST + +
                          *EQ "P"')                                */
   /*PIO*/   CHGVAR     VAR(%SST(&QDATA 66 19)) VALUE(' AND BFAJST +
                           =  "P"')

  /*PIO      CHGVAR     VAR(%SST(&QDATA 86 26)) VALUE('*AND BFIZTX + +
                          *NE "00443012"')                          */
  /*PIO*/    CHGVAR     VAR(%SST(&QDATA 86 26)) VALUE(' AND BFIZTX +
                           <> "00443012"')
  /*PIO      CHGVAR     VAR(%SST(&QDATA 113 26)) VALUE('*AND BFIZTX + +
                          *NE "02690233"')                          */
  /*PIO*/    CHGVAR     VAR(%SST(&QDATA 113 26)) VALUE(' AND BFIZTX +
                           <> "02690233"')
  /*                      *NE "02495224"')            CHANGE TO 960.1411  */

  /*PIO      CHGVAR     VAR(%SST(&QDATA 140 17)) VALUE('*AND BFQHDT + +
                          *EQ 0')                                    */
  /*PIO*/    CHGVAR     VAR(%SST(&QDATA 140 17)) VALUE(' AND BFQHDT +
                           =  0')

/*E6917:     Exclude Adjustment Type Code='RB' (Rebill).                      */

/*E6917 PIO   CHGVAR     VAR(%SST(&QDATA 158 20)) VALUE('*AND BFUHCD + +
                          *NE "RB"')                                 */
/*E6917 PIO*/ CHGVAR     VAR(%SST(&QDATA 158 20)) VALUE(' AND BFUHCD +
                           <> "RB"')

/* E00493ON: If/When the users want us to "turn on" the AR Adjustment Post    */
/*           to JDE, REMOVE the STP logic below. At that time, we will want   */
/*           to start processing/including the STP adjustments.               */

/*E6917      CHGVAR     VAR(%SST(&QDATA 158 21)) VALUE('*AND BFUHCD +
                          *NE "STP"')                                         */
/*E6917 PIO  CHGVAR     VAR(%SST(&QDATA 179 21)) VALUE('*AND BFUHCD +  +
                          *NE "STP"')                                 */
/*E6917 PIO*/ CHGVAR     VAR(%SST(&QDATA 179 21)) VALUE(' AND BFUHCD +
                          <>  "STP"')

/*R9717 PIO  CHGVAR     VAR(%SST(&QDATA 201 40)) VALUE('*AND (BFAIC3 + +
                          *EQ 360 *OR BFAIC3 *EQ 960)')               */
/*R9717 PIO*/ CHGVAR     VAR(%SST(&QDATA 201 40)) VALUE(' AND (BFAIC3 +
                           =  360  OR BFAIC3  =  960)')

  /*PIO      OVRDBF     FILE(ARBECPL1) SHARE(*YES)     +
             OPNQRYF    FILE((ARBECPL1)) OPTION(*ALL) QRYSLT(&QDATA) ++
                          KEYFLD((BFW3SX)) SEQONLY(*YES)           */

   /*PIO*/    OVRDBF     FILE(ARBECPP) TOFILE(ARBECPP) LVLCHK(*NO)
   /*PIO*/   OPNSQLF    SQL('Select * from ARBECPP Where  ' *BCAT +
                          &QDATA  *BCAT '  Order by BFAIC3 asc, +
                          BFCONB asc, BFCEST asc, BFDXNB asc') +
                          OPNID(ARBECPL1) OPTION(*ALL) SEQONLY(*NO) +
                          RCDFMT(@BFCPFO) ALWCPY(*IFRQD)
   /*PIO*/  OVRDBF     FILE(ARBECPL1) TOFILE(ARBECPP) LVLCHK(*NO) +
                       OVRSCOPE(*JOB) SHARE(*YES) OPNSCOPE(*JOB)

/* Create the Cash Distribution Balance and write AR Adjustments (TFP026)     */

             CALL       PGM(TF213)
             CLOF       OPNID(ARBECPL1)
   /*PIO     DLTOVR     FILE(*ALL)  */
             DLTOVR     FILE(*ALL) LVL(*JOB) /*PIO*/

/****************************************************************************/
/* AR ADJUSTMENTS and CASH DISTRIBUTION BALANCE  440 ONLY                   */
/****************************************************************************/
START440:   /*  RMC ADDED 2.14.18               */
/* USE SAME QRY SELECTS AS ABOVE EXCEPT SELECT 440 ONLY, CALL DIFFERENT     */
/*  PGM TO WRITE 440 ADJUSTMENTS WITHOUT CALCULATING THE TFS BUCKETS */
/*  TF426CL PRINTS A NEW REPORT FOR 440  --> TF6260                    */

   /*PIO     CHGVAR     VAR(%SST(&QDATA 86 26)) VALUE('*AND BFIZTX + +
                *NE "ARREGTRD"')                                 */
  /*PIO*/    CHGVAR     VAR(%SST(&QDATA 86 26)) VALUE(' AND BFIZTX +
                <>  "ARREGTRD"')                           /* 440 1410 */
  /*PIO      CHGVAR     VAR(%SST(&QDATA 113 26)) VALUE('*AND BFIZTX ++
                          *NE "02693697"')                                */
  /*PIO*/    CHGVAR     VAR(%SST(&QDATA 113 26)) VALUE(' AND BFIZTX +
                          <>  "02693697"')               /* 440 ALSO 1411 */
   /*                     *NE "ARREG440"')               /* 440 ALSO 1410 */
             CHGVAR     VAR(%SST(&QDATA 201 40)) VALUE(*BLANKS)
   /*PIO     CHGVAR     VAR(%SST(&QDATA 201 40)) VALUE('*AND BFAIC3 + +
                          *EQ 440')                                 */
   /*PIO*/   CHGVAR     VAR(%SST(&QDATA 201 40)) VALUE(' AND BFAIC3 +
                           =  440')

   /*PIO     OVRDBF     FILE(ARBECPL1) SHARE(*YES)      +
             OPNQRYF    FILE((ARBECPL1)) OPTION(*ALL) QRYSLT(&QDATA) + +
                          KEYFLD((BFW3SX)) SEQONLY(*YES)            */

   /*PIO*/    OVRDBF     FILE(ARBECPP) TOFILE(ARBECPP) LVLCHK(*NO)
   /*PIO*/   OPNSQLF    SQL('SELECT * FROM ARBECPP WHERE  ' *BCAT +
                          &QDATA  *BCAT '  ORDER BY BFAIC3 ASC, +
                          BFCONB ASC, BFCEST ASC, BFDXNB ASC') +
                          OPNID(ARBECPL1) OPTION(*ALL) SEQONLY(*NO) +
                          RCDFMT(@BFCPFO) ALWCPY(*IFRQD)
   /*PIO*/  OVRDBF     FILE(ARBECPL1) TOFILE(ARBECPP) LVLCHK(*NO) +
                       OVRSCOPE(*JOB) SHARE(*YES) OPNSCOPE(*JOB)

/* Create the Cash Distribution Balance and write AR Adjustments (TFP026)     */

             CALL       PGM(TF2130)
             CLOF       OPNID(ARBECPL1)
   /*PIO     DLTOVR     FILE(*ALL) */
             DLTOVR     FILE(*ALL) LVL(*JOB) /*PIO*/
END440:
/*----------------------------------------------------------------------------*/
/* If it is a FINAL run,                                                      */
/*  Process the TFS AR Adjustments file (TFP026) and build the records in     */
/*  the TFP025-AR Adjustment GL Post file. As of October 2009 the Post logic  */
/*  was not reviewed/approved by Accounting. So, at this time we are building */
/*  the data but not posting it. We can use this data whenever Accounting     */
/*  is ready to Review/Approve the Post logic. Once we have tested and are    */
/*  ready to "turn on" the Post, scan everywhere for E00493ON.                */
/* S12308 ALSO WRITE 440 STF ADJ TO TFP025. THEY WANT THEM ON THE REPORT TF661*/
/*----------------------------------------------------------------------------*/

             IF         COND(&LDPFCD *EQ 'F') THEN(DO)            /* If Final */

             CHGVAR     VAR(&QDATA) VALUE(' ')

             CHGVAR     VAR(%SST(&QDATA 1 11))  VALUE('AJRWBDT *GE')
             CHGVAR     VAR(%SST(&QDATA 13 8))  VALUE(&LDWBDT)
             CHGVAR     VAR(%SST(&QDATA 22 16)) VALUE('*AND AJRWEDT +
                          *LE')
             CHGVAR     VAR(%SST(&QDATA 39 8))  VALUE(&LDWEDT)
             CHGVAR     VAR(%SST(&QDATA 48 19)) VALUE('*AND AJPMCD +
                          *NE "N"')
   CHGVAR     VAR(%SST(&QDATA 68 19))  VALUE('*AND AJCONO *NE 440') /* S12308 */

             OVRDBF     FILE(TFL026B)  SHARE(*YES)
             OPNQRYF    FILE((TFL026B)) QRYSLT(&QDATA) KEYFLD(*FILE)  +
                          SEQONLY(*YES)

   /* SDN440-CALL E1 PGM IF LIVE/PARALLEL WITH E1   - RMC 4-28-2021   */

 LIVEE1X:    IF         COND(&E1LV360 *EQ 'Y' *OR &E1LV360 *EQ 'P') +
       THEN(CALL       PGM(TF261E))     /* Build TFP025-AR Adj GL Post */
             ELSE  CALL       PGM(TF261) /* BUILD TFP025-AR ADJ GL POST */

             CLOF       OPNID(TFL026B)
             DLTOVR     FILE(*ALL)

/* Update JDE with AR Adjustments */
/* E00493ON: If/When the users want us to "turn on" the AR Adjustment Post    */
/*           to JDE, start calling TFJDE273....and add some email stuff       */

/*           OVRPRTF    FILE(PRINT198) OUTQ(&OUTQ) COPIES(&COPY) +            */
/*                        HOLD(&HOLD) SAVE(&SAVE)                             */
/*           CALL       PGM(TFJDE273)                                         */

             ENDDO                                                /* If Final */

/****************************************************************************/
/* REPORTS                                                                  */
/****************************************************************************/

             OVRPRTF    FILE(PRINT198) OUTQ(&OUTQ) COPIES(&COPY) +
                          HOLD(&HOLD) SAVE(&SAVE)

/*---------------------------------------------------------------------*/
/* AR Adjustment Listing  (detail version)                             */
/*---------------------------------------------------------------------*/
/* (Note: Initialize unused LDA fields before calling the CL.)         */
/* If it is a "Final" run, we will (from TF426CL):                     */
/*      1) e-mail the report to a distribution list                    */
/*      2) dup the spool file to another out queue                     */

             CHGDTAARA  DTAARA(*LDA (71 3))    VALUE('000')
             CHGDTAARA  DTAARA(*LDA (74 3))    VALUE(' ')
             CHGDTAARA  DTAARA(*LDA (77 12))   VALUE(' ')
             CHGDTAARA  DTAARA(*LDA (89 6))    VALUE(' ')
             CHGDTAARA  DTAARA(*LDA (95 8))    VALUE(' ')
             CHGDTAARA  DTAARA(*LDA (103 7))   VALUE('0000000')
             CHGDTAARA  DTAARA(*LDA (110 30))  VALUE(' ')
             CHGDTAARA  DTAARA(*LDA (140 1))   VALUE('D')
             CHGDTAARA  DTAARA(*LDA (141 1))   VALUE(' ')
             CHGDTAARA  DTAARA(*LDA (142 30))  VALUE(' ')
             CHGDTAARA  DTAARA(*LDA (172 1))   VALUE(' ')
             CHGDTAARA  DTAARA(*LDA (173 20))  VALUE(' ')

             CALL       PGM(TF426CL)

/*---------------------------------------------------------------------*/
/* Set up some of the common LDA positions that will be used in        */
/* subsequent reports                                                  */
/*---------------------------------------------------------------------*/
             CHGDTAARA  DTAARA(*LDA (71 1))   VALUE('S')
             CHGDTAARA  DTAARA(*LDA (73 10))  VALUE('Summary')
             CHGDTAARA  DTAARA(*LDA (83 3))   VALUE('000')
             CHGDTAARA  DTAARA(*LDA (86 30))  VALUE(' ')
             CHGDTAARA  DTAARA(*LDA (116 3))  VALUE('000')
             CHGDTAARA  DTAARA(*LDA (119 30)) VALUE(' ')
             CHGDTAARA  DTAARA(*LDA (149 3))  VALUE('000')
             CHGDTAARA  DTAARA(*LDA (152 30)) VALUE(' ')
             CHGDTAARA  DTAARA(*LDA (182 7))  VALUE('0000000')
             CHGDTAARA  DTAARA(*LDA (189 80)) VALUE(' ')
             CHGDTAARA  DTAARA(*LDA (300 1))  VALUE(' ')
             CHGDTAARA  DTAARA(*LDA (301 1))  VALUE('I')
             CHGDTAARA  DTAARA(*LDA (302 10)) VALUE('Include')

/*---------------------------------------------------------------------*/
/* Revenue Report: Sort/Print By TF Structure                          */
/*---------------------------------------------------------------------*/

             CHGDTAARA  DTAARA(*LDA (269 1))  VALUE('2')
             CHGDTAARA  DTAARA(*LDA (270 30)) VALUE('Sort/Print by +
                          TF Structure    ')
             CHGDTAARA  DTAARA(*LDA (301 1))  VALUE('B')
             CHGDTAARA  DTAARA(*LDA (329 1))  VALUE('B')
             CHGDTAARA  DTAARA(*LDA (349 1))  VALUE('B')

/* Extract Revenue records for the week                                */

             CHGVAR     VAR(&QDATA) VALUE(' ')
             CHGVAR     VAR(%SST(&QDATA 1 10)) VALUE('PRWEDT *GE')
             CHGVAR     VAR(%SST(&QDATA 12 8)) VALUE(&LDWEDT)
             CHGVAR     VAR(%SST(&QDATA 21 15)) VALUE('*AND PRWEDT +
                          *LE')
             CHGVAR     VAR(%SST(&QDATA 37 8)) VALUE(&LDWEDT)
             OVRDBF     FILE(TFL010B) SHARE(*YES)
             OPNQRYF    FILE((TFL010B)) QRYSLT(&QDATA) KEYFLD(*FILE) +
                          SEQONLY(*YES)
/* Print                                                               */
             CALL       PGM(TF611)

/* E-Mail                                                                     */
             IF         COND(&LDPFCD *EQ 'F') THEN(DO)            /* If Final */

             IF         COND(&TSTPRDFL *EQ 'P') THEN(CHGVAR +
                          VAR(&EMAIL) VALUE('TF Revenue Close-TF'))

             ESNDMAIL   RECIPIENT(&EMAIL) SUBJECT('TF611-Weekly +
                          Product Revenue Report') +
                          MSG('Distribution List: TF Revenue +
                          Close-TF') ATTLIST((* *PDF *N PRINT198 *))
             MONMSG     MSGID(CPF0000)
             ENDDO                                                /* If Final */

      /*------------------------------------------------------------------*/
      /* R12011 - Print Report Revenue: Weekly Product Revenue Report -   */
      /*     ALL; which includes STF data on Legal Size Paper.            */
      /*------------------------------------------------------------------*/
             OVRPRTF    FILE(PRINT198) PAGESIZE(8.5 14 *UOM) LPI(12) +
                          CPI(20) OVRFLW(81) DRAWER(2) PAGRTT(90) +
                          UOM(*INCH) OUTQ(&OUTQ) COPIES(&COPY) +
                          SCHEDULE(*FILEEND) HOLD(&HOLD) SAVE(&SAVE)

             CALL       PGM(TF6110)

      /*------------------------------------------------------------------*/
      /* R12011 - E-Mail TF6110 - Weekly Product Revenue Report - ALL;    */
      /*------------------------------------------------------------------*/
             IF         COND(&LDPFCD *EQ 'F') THEN(DO)            /* If Final */

             IF         COND(&TSTPRDFL *EQ 'P') THEN(CHGVAR +
                          VAR(&EMAIL) VALUE('TF Revenue Close-TF'))

             ESNDMAIL   RECIPIENT(&EMAIL) SUBJECT('TF6110-Weekly +
                          Product Revenue Report - ALL') +
                          MSG('Distribution List: TF Revenue +
                          Close-TF') ATTLIST((* *PDF *N PRINT198 *))
             MONMSG     MSGID(CPF0000)
             ENDDO                                                /* If Final */

             CLOF       OPNID(TFL010B)
             DLTOVR     FILE(TFL010B)


/*-------------------------------------------------------------------*/
/* Claim Adjustments Listing                                         */
/*-------------------------------------------------------------------*/

/* Initialize LDA fields that are used in the on-demand version      */

             CHGDTAARA  DTAARA(*LDA (68 3))  VALUE('000')
             CHGDTAARA  DTAARA(*LDA (71 7))  VALUE('0000000')
             CHGDTAARA  DTAARA(*LDA (78 7))  VALUE('0000000')
             CHGDTAARA  DTAARA(*LDA (85 7))  VALUE('0000000')
             CHGDTAARA  DTAARA(*LDA (92 2))  VALUE('  ')
             CHGDTAARA  DTAARA(*LDA (94 7))  VALUE('0000000')
             CHGDTAARA  DTAARA(*LDA (101 1)) VALUE(' ')
             CHGDTAARA  DTAARA(*LDA (102 3)) VALUE('   ')
             CHGDTAARA  DTAARA(*LDA (105 3)) VALUE('   ')
             CHGDTAARA  DTAARA(*LDA (109 1)) VALUE('I')
             CHGDTAARA  DTAARA(*LDA (300 1)) VALUE(' ')

/* Extract data for the week                                         */

             CHGVAR     VAR(&QDATA) VALUE(' ')
             CHGVAR     VAR(%SST(&QDATA 1 10)) VALUE('CLWEDT *EQ')
             CHGVAR     VAR(%SST(&QDATA 12 8)) VALUE(&LDWEDT)

             OVRDBF     FILE(TFL022C) SHARE(*YES)
             OPNQRYF    FILE((TFL022C)) QRYSLT(&QDATA) KEYFLD(*FILE) +
                          SEQONLY(*YES)
/* Print */
             CALL       PGM(TF612)

/* If it is a Final run:                                                     */
/*  1) e-mail the report to a distribution list                              */
/*  2) dup the spool file to another out queue                               */
/*  3) create the JDE journal entries                                        */

             IF         COND(&LDPFCD *EQ 'F') THEN(DO)            /* If Final */

             IF         COND(&TSTPRDFL *EQ 'P') THEN(CHGVAR +
                          VAR(&EMAIL) VALUE('TF Revenue Close-Claim +
                          Adj'))

             ESNDMAIL   RECIPIENT(&EMAIL) SUBJECT('Claims Adjustment +
                          Listing') MSG('Distribution List: TF +
                          Revenue Close-Claim Adj') ATTLIST((* *PDF *N +
                          PRINT198 *))
             MONMSG     MSGID(CPF0000)

             IF         COND(&TSTPRDFL *EQ 'P') THEN(DO)
             DUPSPLF    FILE(PRINT198) OUTQ(TFPRTDUP) SPLNBR(*LAST) +
                          HOLD(*NO)
             MONMSG     MSGID(CPF0000)
             ENDDO

/* Create JDE Journal Entries for Claim Adjustments                  */

             CRTDUPOBJL OBJ(TFP312) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)

             CALL       PGM(TF312)

/***********************************************************************/
/* Duplicate M3 files into QTEMP                                       */
/***********************************************************************/

/* Duplicate the M3 GL Interface Head PF, Upd Index, and Rtv Index to QTEMP */
             CRTDUPOBJ  OBJ(PLB9CPP) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)

             CRTDUPOBJ  OBJ(PLB9CPL0) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)

             CRTDUPOBJ  OBJ(PLB9CPL1) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)

             CRTDUPOBJ  OBJ(PLB9CPL2) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)

/* Duplicate the M3 GL Interface Line PF, Upd Index, and Rtv Index to QTEMP */
             CRTDUPOBJ  OBJ(PLCACPP) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)

             CRTDUPOBJ  OBJ(PLCACPL0) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)

             CRTDUPOBJ  OBJ(PLCACPL1) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)
/***********************************************************************/
/* Duplicate E1 file  into QTEMP - SDN440                              */
/***********************************************************************/

/*  CREATE E1 RUN LOG WORKFILE - TO USER LATER TO PUSH BATCHES TO E1   */

             CRTDUPOBJ  OBJ(E1B9CPP) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)
             CRTDUPOBJ  OBJ(E1B9CPL0) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)
             CRTDUPOBJ  OBJ(E1B9CPL1) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP)

/* Call TF Upload Claim Adjustments program                                */
             CALL       PGM(TFJDE272) PARM(&M3LV360 &M3LV320 &M3LV960)

/***********************************************************************/
/* Print  M3 BATCH ENTRIES                                             */
/***********************************************************************/
M3LV:        IF         COND(&M3LV360  *NE 'N') THEN(DO)
             OVRPRTF    FILE(PWA3PFR$) OUTQ(&OUTQ) COPIES(1) +
                          HOLD(*YES) SAVE(*YES)

             CALL       PGM(PWA3PFR) PARM(&RETRN &OMSSYSVAL)

R10999:      IF         COND(&TSTPRDFL *EQ 'P') THEN(CHGVAR +
                          VAR(&EMAIL) VALUE('M3TFDIST'))

             ESNDMAIL   RECIPIENT(&EMAIL) SUBJECT('TF Revenue +
                          Close--M3 Journal Entries') +
                          MSG('Distribution List: M3TFDIST') +
                          ATTLIST((* *PDF *N PWA3PFR$ *))
             MONMSG     MSGID(CPF0000)

/***********************************************************************/
/* Copy M3 file records from QTEMP to M3 library and then CLEAR IT     */
/***********************************************************************/

             CPYF       FROMFILE(QTEMP/PLB9CPP) +
                          TOFILE(&DATAS/PLB9CPP) MBROPT(*ADD)
             MONMSG     MSGID(CPF2817)

             CPYF       FROMFILE(QTEMP/PLCACPP) +
                          TOFILE(&DATAS/PLCACPP) MBROPT(*ADD)
             MONMSG     MSGID(CPF2817)
             ENDDO                                           /*  M3LV */

/***********************************************************************/
/* CLEAR  files IN   QTEMP  FOR ANOTHER BATCH                          */
/***********************************************************************/

             CLRPFM     FILE(QTEMP/PLB9CPP)
             CLRPFM     FILE(QTEMP/PLCACPP)
/***********************************************************************/

             IF         COND(&TSTPRDFL *EQ 'P') THEN(CHGVAR +
                          VAR(&EMAIL) VALUE('TF Revenue Close-Admin'))

             ESNDMAIL   RECIPIENT(&EMAIL) SUBJECT('Claim Post +
                          Report') MSG('Distribution List: TF +
                          Revenue Close-Admin') ATTLIST((* *PDF *N +
                          PRINT198 *))
             MONMSG     MSGID(CPF0000)
             ENDDO                                                /* If Final */

             CLOF       OPNID(TFL022C)
             DLTOVR     FILE(TFL022C)
             DLTOVR     FILE(*ALL)

      /*------------------------------------------------------------------*/
      /*------------------------------------------------------------------*/
      /* IF FINAL RUN ONLY:  (RECORDS ARENT IN TFP025 UNTIL FINAL RUN)  */
      /* S12308 - Print TF661 AR Adjustment Report by G/L Post Account-  */
      /*     ALL which includes STF data.This rpt was not printing in this cl */
      /*------------------------------------------------------------------*/

             CHGVAR     VAR(&FROMDT) VALUE(%SST(*LDA 39 6)) /* SAVE FROM DT */

TF461CL:     IF         COND(&LDPFCD *EQ 'F') THEN(DO)            /* If Final */

/* Initialize LDA fields that are used in the on-demand version      */

           CHGDTAARA  DTAARA(*LDA (39 4)) VALUE(%SST(*LDA 26 4)) /* MMDD     */
           CHGDTAARA  DTAARA(*LDA (43 2)) VALUE(%SST(*LDA 24 2)) /*     YY   */
           CHGDTAARA  DTAARA(*LDA (45 4)) VALUE(%SST(*LDA 26 4)) /* MMMDD    */
           CHGDTAARA  DTAARA(*LDA (49 2)) VALUE(%SST(*LDA 24 2)) /*     YY   */
           CHGDTAARA  DTAARA(*LDA (52 8)) VALUE(%SST(*LDA 22 8)) /* YYYYMMDD */
           CHGDTAARA  DTAARA(*LDA (60 8)) VALUE(%SST(*LDA 22 8)) /* YYYYMMDD */

             CHGDTAARA  DTAARA(*LDA (71 3))    VALUE('000')
             CHGDTAARA  DTAARA(*LDA (74 3))    VALUE(' ')
             CHGDTAARA  DTAARA(*LDA (77 12))   VALUE(' ')
             CHGDTAARA  DTAARA(*LDA (89 6))    VALUE(' ')
             CHGDTAARA  DTAARA(*LDA (95 8))    VALUE(' ')
             CHGDTAARA  DTAARA(*LDA (103 7))   VALUE('0000000')
             CHGDTAARA  DTAARA(*LDA (110 30))  VALUE(' ')
             CHGDTAARA  DTAARA(*LDA (140 1))   VALUE('D')     /* DETAIL FIRST */
             CHGDTAARA  DTAARA(*LDA (141 1))   VALUE(' ')
             CHGDTAARA  DTAARA(*LDA (142 30))  VALUE(' ')
             CHGDTAARA  DTAARA(*LDA (172 1))   VALUE(' ')
             CHGDTAARA  DTAARA(*LDA (173 20))  VALUE(' ')

             CALL       PGM(TF461CL)
/* If it is a Final run:                                                     */
/*  1) e-mail the report to a distribution list                              */
/*  2) dup the spool file to another out queue                               */

             IF         COND(&LDPFCD *EQ 'F') THEN(DO)            /* If Final */

             ESNDMAIL   RECIPIENT(&EMAIL) SUBJECT('TF661-Weekly AR +
                          Adjustment Report - DETAIL') +
                          MSG('Distribution List: TF Revenue +
                          Close-TF') ATTLIST((* *PDF *N PRINT198 *))
             MONMSG     MSGID(CPF0000)
             enddo

             IF         COND(&TSTPRDFL *EQ 'P') THEN(DO)
             DUPSPLF    FILE(PRINT198) OUTQ(TFPRTDUP) SPLNBR(*LAST) +
                          HOLD(*NO)
             MONMSG     MSGID(CPF0000)
             enddo
             CHGDTAARA  DTAARA(*LDA (140 1))   VALUE('S')     /* SUMMARY 2ND  */
             CALL       PGM(TF461CL)
/* If it is a Final run:                                                     */
/*  1) e-mail the report to a distribution list                              */
/*  2) dup the spool file to another out queue                               */

             IF         COND(&LDPFCD *EQ 'F') THEN(DO)            /* If Final */

             ESNDMAIL   RECIPIENT(&EMAIL) SUBJECT('TF661-Weekly AR +
                          Adjustment Report - SUMMARY')        +
                          MSG('Distribution List: TF Revenue +
                          Close-TF') ATTLIST((* *PDF *N PRINT198 *))
             MONMSG     MSGID(CPF0000)
             enddo

             IF         COND(&TSTPRDFL *EQ 'P') THEN(DO)
             DUPSPLF    FILE(PRINT198) OUTQ(TFPRTDUP) SPLNBR(*LAST) +
                          HOLD(*NO)
             MONMSG     MSGID(CPF0000)
             enddo

             enddo                                     /*  END TF461CL */

/*-------------------------------------------------------------------*/
/* Revenue Report by GL Sub Code                                     */
/*-------------------------------------------------------------------*/

             CHGDTAARA  DTAARA(*LDA (39 6))  VALUE(&FROMDT) /* RESET FROM DT */

             CALL       PGM(TF409CL)

/* If it is a FINAL run,                                             */
/*  1) Post to JDE                                                   */
/*  2) E-mail                                                        */
/*  3) Freeze Loads (conditionally)                                  */

             IF         COND(&LDPFCD *EQ 'F') THEN(DO)       /* If Final */

             OVRPRTF    FILE(PRINT198) OUTQ(&OUTQ) COPIES(&COPY) +
                          HOLD(&HOLD) SAVE(&SAVE)

/* Update JDE with Revenue Adjustments */

             CALL       PGM(TFJDE270) PARM(&M3LV360 &M3LV320 &M3LV359 &M3LV960)

/***********************************************************************/
/* Print  M3 BATCH ENTRIES                */
/***********************************************************************/
 LIVEM3P:    IF         COND(&M3LV360 *EQ 'Y' *OR &M3LV360 *EQ 'P') +
                          THEN(DO)
             OVRPRTF    FILE(PWA3PFR$) OUTQ(&OUTQ) COPIES(1) +
                          HOLD(*YES) SAVE(*YES)

             CALL       PGM(PWA3PFR) PARM(&RETRN &OMSSYSVAL)


R109992:     IF         COND(&TSTPRDFL *EQ 'P') THEN(CHGVAR +
                          VAR(&EMAIL) VALUE('M3TFDIST'))

             ESNDMAIL   RECIPIENT(&EMAIL) SUBJECT('TF Revenue +
                          Close--M3 Journal Entries') +
                          MSG('Distribution List: M3TFDIST') +
                          ATTLIST((* *PDF *N PWA3PFR$ * *LAST))
             MONMSG     MSGID(CPF0000)
/***********************************************************************/
/* Copy M3 file records from QTEMP to M3 library                       */
/***********************************************************************/

             CPYF       FROMFILE(QTEMP/PLB9CPP) +
                          TOFILE(&DATAS/PLB9CPP) MBROPT(*ADD)
             MONMSG     MSGID(CPF2817)

             CPYF       FROMFILE(QTEMP/PLCACPP) +
                          TOFILE(&DATAS/PLCACPP) MBROPT(*ADD)
             MONMSG     MSGID(CPF2817)

             ENDDO                                   /* end m3lv360  */

/***********************************************************************/
/* DELETE  file in  QTEMP  for next batch                              */
/***********************************************************************/

             DLTF       FILE(QTEMP/PLB9CPL*)
             DLTF       FILE(QTEMP/PLB9CPP)

             DLTF       FILE(QTEMP/PLCACPL*)
             DLTF       FILE(QTEMP/PLCACPP)

/*********************************************************************/
/* Push the Run Log Header records and push the batches to E1-SDN440 */
/*                                                                   */
/* ----------------------------------------------------------------- */
/*********************************************************************/

 LIVEE1P:    IF         COND(&E1LV360 *EQ 'Y' *OR &E1LV360 *EQ 'P') +
                          THEN(DO)

/*  EXECUTE THE PROGRAM TO READ THE QTEMP RUN LOG HEADER             */
/*      E1B9CPP AND PUSH THE BATCHES TO E1                           */

             CALL       PGM(E1LDXFR) PARM(&RETRN)

             /* Send message with all batch numbers created for PO's */
             CHGVAR     VAR(&RECIP) VALUE(&USER)

             CALL       PGM(E1LRXFR) PARM(&RETRN &SOURCE &BCHDSC +
                          &RECIP &SUBJECT)
             ENDDO                                  /*   END LIVEE1P */
/***********************************************************************/

             IF         COND(&TSTPRDFL *EQ 'P') THEN(CHGVAR +
                          VAR(&EMAIL) VALUE('TF Revenue Close-Admin'))

             ESNDMAIL   RECIPIENT(&EMAIL) SUBJECT('TF Revenue +
                          Adjustment Post Report Journal Entries') +
                          MSG('Distribution List: TF Revenue +
                          Close-Admin') ATTLIST((* *PDF *N PRINT198 *))
             MONMSG     MSGID(CPF0000)

/* Determine if this is the last week in the period. */
/* If so, call the CL to Freeze Loads                */

             CALL       PGM(TF229) PARM(&FREEZEFL)
             IF         COND(&FREEZEFL *EQ 'Y') THEN(DO)
             CALL       PGM(TF427CL)
             ENDDO

             ENDDO                                           /* If Final */

             ENDDO                                           /* No Error Do */

/****************************************************************************/
/* ALWAYS UPDATE THE FUNCTION CONTROL FILE                                  */
/****************************************************************************/

             CALL       PGM(TF209) PARM(&ERROR &LDPFCD)

             DLTOVR     FILE(*ALL)

END:         ENDPGM

