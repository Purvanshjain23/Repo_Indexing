/***************************************************************** */
/*                                                                 */
/*  PROGRAM NUMBER:  SHBLDTMS                                      */
/*  PROGRAM NAME:    BUILD DATAMART FILES FOR THE TRANSPORTATION   */
/*                   MANAGEMENT SYSTEM.                            */
/*  PROGRAMMER:      BARB GUTIERREZ                                */
/*  CREATE DATE:     12/13/04                                      */
/*                                                                 */
/*  FUNCTION:        THIS CL IS SUBMITTED NIGHTLY FROM THE JOB     */
/*                   SCHEDULER ON BIGBYTE.                         */
/*                                                                 */
/*                   IT PERFORMS THE FOLLOWING FUNCTIONS:          */
/*                   A) RETRIEVES THE DATE LAST PROCESSED          */
/*                   C) EXTRACTS LOAD DATA FOR DATAMART FILES      */
/*                                                                 */
/*                      THE DATA AREA HAS A LAST PROCESSED DATE    */
/*                      (DATMS)                                    */
/*                                                                 */
/*           NOTE:  IF WE WANT TO REBUILD HISTORY, CHANGE          */
/*                  THE LAST DATE PROCESSED DATA AREA DATMS TO     */
/*                  THE DATE YOU WANT TO BUILD THE HISTORY FROM.   */
/*                                                                 */
/*******************************************************************/
/* Modification history                                            */
/*  8/22/19 JBB E15352 - Add Load Plan Start Dates and Time        */
/*          Modify this program to allow Process to run in a test  */
/*          envirunment.  Only add PRKDMFLIB if running in         */
/*          production, otherwise add library TSTDMFLIB.           */
/*                                                                 */
/*******************************************************************/

             PGM

             DCL        VAR(&ERR)      TYPE(*CHAR) LEN(1) VALUE('N')
             DCL        VAR(&EMAIL)    TYPE(*CHAR) LEN(38)
             DCL        VAR(&TSTPRDFL) TYPE(*CHAR) LEN(1)
             DCL        VAR(&SUBJECT)  TYPE(*CHAR) LEN(60) +
                          VALUE('SHBLDTMS-Build Transportation +
                          .........DIST LIST: prk cognos')

             DCL        VAR(&CORG)    TYPE(*CHAR) LEN(1)
             DCL        VAR(&LSTPRDT) TYPE(*CHAR) LEN(8)

/*------------------------------------------------------------------*/
/* Set up the Email Recipient (either Test or Production)           */
/*------------------------------------------------------------------*/

/* Retrieve the Data Area that lets us know whether we are in TEST  */
/* or PRODUCTION. (Always default to the 'TEST' Distribution List.) */

             CHGVAR     VAR(&EMAIL) VALUE('prk cognos test')
             RTVDTAARA  DTAARA(DATSTPRD (1 1)) RTNVAR(&TSTPRDFL)
             IF         COND(&TSTPRDFL *EQ 'P') THEN(CHGVAR +
                          VAR(&EMAIL) VALUE('prk cognos'))


/*-----------------------------------------------------------------*/
/* PUT THE DATAMART LIBRARY AT THE TOP OF THE LIBRARY LIST.        */
/* AND RETRIEVE THE DATA AREA HOLDING THE LAST PROCESSED DATE.     */
/*-----------------------------------------------------------------*/

/*  8/22/2019 JBB E15352 - Add New Date and Time fields to SHP250  */
/* Commented out automatically setting library to PRKDMFLIB.       */
        /*   ADDLIBLE   LIB(PRKDMFLIB)  */
        /*   MONMSG     MSGID(CPF0000)  */

/*-----------------------------------------------------------------*/
/* Add PRKDMFLIB to the top of the library list when the &TSTPRDFL */
/* value is 'P'.  Otherwise add library TSTDMFLIB to the top of    */
/* the library list.                                               */
/*-----------------------------------------------------------------*/
             IF         COND(&TSTPRDFL *EQ 'P') THEN(DO)
             RMVLIBLE   LIB(PRKDMFLIB)
             MONMSG     MSGID(CPF0000)
             ADDLIBLE   LIB(PRKDMFLIB)
             ENDDO

             RTVDTAARA  DTAARA(DATMS (22 8)) RTNVAR(&LSTPRDT)

/*-----------------------------------------------------------------*/
/* CLEAR SOME DATAMART FILES IN PRKDMFLIB                          */
/*-----------------------------------------------------------------*/

             CLRPFM     FILE(SHP251) /* Freight Charge Codes */

/*-----------------------------------------------------------------*/
/* POPULATE DATAMART FILES IN PRKDMFLIB FOR SEABOARD               */
/*-----------------------------------------------------------------*/

             CHGVAR     VAR(&CORG) VALUE('S')
             CALL       PGM(SH250) PARM(&LSTPRDT &CORG)

/*-----------------------------------------------------------------*/
/* POPULATE DATAMART FILES IN PRKDMFLIB FOR DAILYS                 */
/*-----------------------------------------------------------------*/
/* As of the 09/24/07 install, the Dailys production library/files */
/* have not yet been created. SO, we will comment out the Daily    */
/* stuff until later.                                              */
/*                                                                 */
/*           ADDLIBLE   LIB(DPMFLIB) POSITION(*AFTER PRKDMFLIB)    */
/*           MONMSG     MSGID(CPF0000)                             */
/*                                                                 */
/*           CHGVAR     VAR(&CORG) VALUE('D')                      */
/*           CALL       PGM(SH250) PARM(&LSTPRDT &CORG)            */

/*----------------------------------------------------------------------*/
/* RESET THE LAST DATE PROCESSED TO TODAYS DATE                         */
/*----------------------------------------------------------------------*/

 EXIT:       CHGDTAARA  DTAARA(DATMS (22 8)) VALUE(&LSTPRDT)


/*---------------------------------------------------------------------*/
/* SEND COMPLETION MESSAGE TO I.S. FOLKS                               */
/*---------------------------------------------------------------------*/
/* We are currently not monitoring for any errors. So, &ERR will       */
/* always be No.                                                       */

             IF         COND(&ERR = 'N') THEN(ESNDMAIL +
                          RECIPIENT(&EMAIL) SUBJECT(&SUBJECT) +
                          MSG('The TMS-Transportation Management +
                          data was successfully built in PRKDMFLIB; +
                          the build completed normally.') +
                          IMPORTANCE(*HIGH))
             ENDPGM

